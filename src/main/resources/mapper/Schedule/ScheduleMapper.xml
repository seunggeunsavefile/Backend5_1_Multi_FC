<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.multi.backend5_1_multi_fc.schedule.mapper.ScheduleMapper">

    <!-- username -> user_id ÏñªÍ∏∞ -->
    <select id="findUserIdByUsername" parameterType="string" resultType="long">
        SELECT user_id
        FROM User
        WHERE username = #{username}
            LIMIT 1
    </select>

    <!-- Ï∫òÎ¶∞Îçî/ÏúÑÏ†ØÏö© Í≤∞Í≥º Îß§Ìïë -->
    <resultMap id="DayItemMap" type="com.multi.backend5_1_multi_fc.schedule.dto.ScheduleDto$DayItem">
        <id     property="scheduleId"   column="schedule_id"/>
        <result property="title"        column="title"/>
        <result property="scheduleType" column="schedule_type"/>
        <result property="scheduleDate" column="schedule_date"/>
        <result property="scheduleTime" column="schedule_time"/>
        <!-- Ï∂îÍ∞Ä -->
        <result property="content"      column="content"/>
        <result property="matchId"      column="match_room_id"/>
    </resultMap>

    <!-- Í∞úÏù∏ ÏùºÏ†ï Ï∂îÍ∞Ä  -->
    <insert id="insertPersonal" parameterType="map">
        INSERT INTO Schedule (user_id, title, content, schedule_type, schedule_date, schedule_time)
        VALUES (#{userId}, #{req.title}, #{req.content}, 'Í∞úÏù∏ ÏùºÏ†ï', #{req.scheduleDate}, #{req.scheduleTime})
    </insert>

    <!-- Í∞úÏù∏ ÏùºÏ†ï ÏàòÏ†ï (Î≥∏Ïù∏ + Í∞úÏù∏ ÏùºÏ†ïÎßå) -->
    <update id="updatePersonal" parameterType="map">
        UPDATE Schedule
        SET title = #{req.title},
            content = #{req.content},
            schedule_date = #{req.scheduleDate},
            schedule_time = #{req.scheduleTime}
        WHERE schedule_id = #{scheduleId}
          AND user_id = #{userId}
          AND schedule_type = 'Í∞úÏù∏ ÏùºÏ†ï'
    </update>

    <!-- Í∞úÏù∏ ÏùºÏ†ï ÏÇ≠Ï†ú -->
    <delete id="deletePersonal" parameterType="map">
        DELETE FROM Schedule
        WHERE schedule_id = #{scheduleId}
          AND user_id = #{userId}
          AND schedule_type = 'Í∞úÏù∏ ÏùºÏ†ï'
    </delete>

    <!-- ÌäπÏ†ï Í∏∞Í∞Ñ Ï†ÑÏ≤¥ ÏùºÏ†ï (Ï∫òÎ¶∞Îçî Ïõî Îã®ÏúÑ) -->
    <select id="findAllBetween" parameterType="map" resultMap="DayItemMap">
        SELECT schedule_id, title, schedule_type, schedule_date, schedule_time, content, match_room_id
        FROM Schedule
        WHERE user_id = #{userId}
          AND schedule_date BETWEEN #{startDate} AND #{endDate}
        ORDER BY schedule_date ASC, schedule_time ASC, schedule_id ASC
    </select>


    <!-- Îã¨Î†• ÌïúÏπ∏Ïóê ÎÇ†ÏßúÎ≥Ñ Í∞ÄÏû• Îπ†Î•∏ 2Í∞ú -->
    <select id="findTop2ByDate" parameterType="map" resultMap="DayItemMap">
        SELECT schedule_id, title, schedule_type, schedule_date, schedule_time, content, match_room_id
        FROM Schedule
        WHERE user_id = #{userId}
          AND schedule_date = #{date}
        ORDER BY schedule_time ASC, schedule_id ASC
            LIMIT 2
    </select>

    <!-- ÎÇ†Ïßú Ï†ÑÏ≤¥ Î™©Î°ù -->
    <select id="findAllByDate" parameterType="map" resultMap="DayItemMap">
        SELECT schedule_id, title, schedule_type, schedule_date, schedule_time, content, match_room_id
        FROM Schedule
        WHERE user_id = #{userId}
          AND schedule_date = #{date}
        ORDER BY schedule_time ASC, schedule_id ASC
    </select>

    <!-- Î©îÏù∏ Ïò§Îäò ÌòÑÏû¨ÏãúÍ∞Å Ïù¥ÌõÑ + ÎÇ¥ÏùºÎ∂ÄÌÑ∞Îäî ÌïòÎ£® Ï†ÑÏ≤¥ Ï§ë Îπ†Î•∏ ÏàúÏúºÎ°ú 5Í∞ú -->
    <select id="findUpcoming7d" parameterType="map" resultMap="DayItemMap">
        SELECT
            s.schedule_id,
            s.title,
            s.schedule_type,
            s.schedule_date,
            s.schedule_time,
            s.content,
            s.match_room_id          -- üîπ Í∑∏ÎÉ• Ïª¨Îüº Í∑∏ÎåÄÎ°ú
        FROM Schedule s
        WHERE s.user_id = #{userId}
          AND (
            (s.schedule_date = #{today} AND (s.schedule_time IS NULL OR s.schedule_time >= #{nowTime}))
                OR (s.schedule_date BETWEEN #{tomorrow} AND #{sixDaysLater})
            )
        ORDER BY s.schedule_date ASC, s.schedule_time ASC, s.schedule_id ASC
            LIMIT 5
    </select>

    <!-- Í≤ΩÍ∏∞ ÏûêÎèô Ïó∞Îèô (ÏäπÏù∏ + Î™®ÏßëÏôÑÎ£å/Í≤ΩÍ∏∞ÏôÑÎ£å, Ï§ëÎ≥µ Î∞©ÏßÄ) -->
    <insert id="upsertApprovedMatches" parameterType="map">
        -- 1) ÏäπÏù∏Îêú Ï∞∏Í∞ÄÏûê ÏùºÏ†ï
        INSERT INTO Schedule (user_id, title, schedule_type, schedule_date, schedule_time, match_room_id)
        SELECT
            mp.user_id, st.name, 'Í≤ΩÍ∏∞', mr.match_date, mr.match_time, mr.room_id
        FROM Match_Participant mp
                 JOIN Match_Room mr   ON mr.room_id    = mp.room_id
                 LEFT JOIN Stadium st ON st.stadium_id = mr.stadium_id
        WHERE mp.user_id = #{userId}
          AND mp.status  = 'ÌôïÏ†ï'
          AND mr.status = 'CLOSED'
          AND mr.match_date >= CURDATE()
          AND NOT EXISTS (
            SELECT 1
            FROM Schedule s
            WHERE s.user_id       = mp.user_id
              AND s.schedule_type = 'Í≤ΩÍ∏∞'
              AND s.schedule_date = mr.match_date
              AND s.schedule_time = mr.match_time
        )

        UNION

        -- 2) Îß§Ïπ≠Î∞© Ìò∏Ïä§Ìä∏ ÏùºÏ†ï
        SELECT
            mr.host_id AS user_id, st.name, 'Í≤ΩÍ∏∞', mr.match_date, mr.match_time, mr.room_id
        FROM Match_Room mr
                 LEFT JOIN Stadium st ON st.stadium_id = mr.stadium_id
        WHERE mr.host_id = #{userId}
          AND mr.status = 'CLOSED'
          AND mr.match_date >= CURDATE()
          AND NOT EXISTS (
            SELECT 1
            FROM Schedule s
            WHERE s.user_id       = mr.host_id
              AND s.schedule_type = 'Í≤ΩÍ∏∞'
              AND s.schedule_date = mr.match_date
              AND s.schedule_time = mr.match_time
        );
    </insert>


</mapper>
