<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.multi.backend5_1_multi_fc.user.mapper.UserMapper">

    <resultMap id="userResultMap" type="com.multi.backend5_1_multi_fc.user.dto.UserDto">
        <id property="userId" column="user_id"/>
        <result property="username" column="username"/>
        <result property="password" column="password"/>
        <result property="nickname" column="nickname"/>
        <result property="profileImage" column="profile_image"/>
        <result property="address" column="address"/>
        <result property="email" column="email"/>
        <result property="level" column="level"/>
        <result property="position" column="position"/>
        <result property="gender" column="gender"/>
        <result property="loginFailCount" column="login_fail_count"/>
        <result property="lockedUntil" column="locked_until"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
        <result property="resetCode" column="reset_code"/>
        <result property="resetCodeExpires" column="reset_code_expires"/>
    </resultMap>

    <insert id="insertUser" parameterType="com.multi.backend5_1_multi_fc.user.dto.UserDto">
        INSERT INTO User (username, password, nickname, email, level, position, gender, address, profile_image)
        VALUES (#{username}, #{password}, #{nickname}, #{email}, #{level}, #{position}, #{gender}, #{address}, #{profileImage})
    </insert>

    <select id="countByUsername" parameterType="String" resultType="int">
        SELECT COUNT(*) FROM User WHERE username = #{username}
    </select>
    <select id="countByEmail" parameterType="String" resultType="int">
        SELECT COUNT(*) FROM User WHERE email = #{email}
    </select>
    <select id="countByNickname" parameterType="String" resultType="int">
        SELECT COUNT(*) FROM User WHERE nickname = #{nickname}
    </select>

    <select id="findUserByUsername" parameterType="String" resultMap="userResultMap">
        SELECT * FROM User WHERE username = #{username}
    </select>


    <select id="checkUserByUsernameAndEmail" resultType="boolean">
        SELECT COUNT(*) > 0 FROM User WHERE username = #{username} AND email = #{email}
    </select>

    <update id="updateResetCode">
        UPDATE User
        SET reset_code = #{code}, reset_code_expires = DATE_ADD(NOW(), INTERVAL 5 MINUTE)
        WHERE email = #{email}
    </update>

    <select id="verifyResetCode" resultType="boolean">
        SELECT COUNT(*) > 0 FROM User WHERE email = #{email} AND reset_code = #{code} AND reset_code_expires > NOW()
    </select>

    <update id="updatePasswordByEmail">
        UPDATE User
        SET password = #{newPassword}, reset_code = NULL, reset_code_expires = NULL
        WHERE email = #{email}
    </update>

    <select id="findUserByEmail" parameterType="String" resultMap="userResultMap">
        SELECT * FROM User WHERE email = #{email}
    </select>

    <select id="findUsernameByEmail" parameterType="String" resultType="String">
        SELECT username FROM User WHERE email = #{email}
    </select>
</mapper>