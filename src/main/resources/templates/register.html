<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MULTI FC - 회원가입</title>

    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        .input-group.address-group { display: flex; gap: 10px; align-items: flex-end; }
        .input-group.address-group .input-wrapper { flex-grow: 1; }
        .address-group button { padding: 12px 15px; font-size: 14px; font-weight: 600; color: #fff; background: #95a5a6; border: none; border-radius: 10px; cursor: pointer; transition: background 0.3s; white-space: nowrap; min-width: 80px; }
        .address-group button:hover { background: #7f8c8d; }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.5); display: none; justify-content: center; align-items: center; z-index: 9999; }
        .modal-overlay.show { display: flex; }
        .modal { background: #fff; max-width: 900px; width: 90%; max-height: 80vh; border-radius: 12px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25); display: flex; flex-direction: column; overflow: hidden; }
        .modal-header { padding: 16px 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .modal-header h1 { margin: 0; font-size: 20px; }
        .modal-close-btn { background: none; border: none; font-size: 22px; cursor: pointer; }
        .modal-body { padding: 16px 20px; overflow-y: auto; }
        .modal-body h2 { margin-top: 24px; }
        .modal-body .clause { background: #f4f4f4; border: 1px solid #ddd; padding: 15px; margin-top: 10px; }
        .modal-footer { padding: 16px 20px; border-top: 1px solid #eee; text-align: center; }
        .agree-btn { padding: 12px 24px; font-size: 16px; font-weight: 600; border: none; border-radius: 8px; background: #6c5ce7; color: #fff; cursor: pointer; }
        .agree-btn:hover { background: #574bdb; }
        .terms-link { color: #3498db; text-decoration: underline; cursor: pointer; }

        .info-message {
            font-size: 13px !important;
            font-weight: 500 !important;
            margin-top: 5px !important;
            display: none !important;
            min-height: 0 !important;
        }
        .info-message.success {
            color: #2ecc71 !important;
            display: block !important;
        }
        .info-message.error {
            color: #e74c3c !important;
            display: block !important;
        }
        .profile-upload-container {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-top: 10px;
        }
        .preview-wrapper {
            position: relative;
            width: 100px;
            height: 100px;
            border-radius: 50%;
            border: 2px solid #ddd;
            background-color: #fff;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }
        .preview-text {
            font-size: 14px;
            color: #aaa;
            font-weight: bold;
            z-index: 1;
        }
        .profile-preview {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: none;
            z-index: 2;
        }
        .profile-preview.active {
            display: block;
        }
        .profile-actions {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .reset-img-btn {
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.3s;
        }
        .reset-img-btn:hover { background-color: #c0392b; }
        input[type="text"]:read-only,
        input[type="email"]:read-only {
            background-color: #eee !important;
            color: #777;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
<div th:replace="~{fragments/header :: siteHeader}"></div>

<main class="login-page-main">
    <div class="main-wrapper">
        <div class="main-section">
            <div class="login-container">
                <h1 class="title-login">Sign Up</h1>
                <p style="margin-bottom: 25px; font-size: 15px; color: #555;">
                    MULTI FC 계정을 만들고 매치를 시작하세요.
                </p>

                <p id="error-message" class="error-message" style="display:none;"></p>

                <form id="register-form">

                    <div class="input-group">
                        <label for="email">이메일 (Email)</label>
                        <input type="email" id="email" name="email" placeholder="비밀번호 찾기 등에 사용" required
                               th:value="${socialInfo != null} ? ${socialInfo.email} : ''"
                               th:readonly="${socialInfo != null}">
                        <p id="email-message" class="info-message"></p>
                    </div>

                    <div class="input-group">
                        <label for="username">아이디 (User name)</label>
                        <input type="text" id="username" name="username" placeholder="5~20자 영문 소문자, 숫자, (_)만 사용" required>
                        <p id="username-message" class="info-message"></p>
                    </div>

                    <div class="input-group">
                        <label for="nickname">닉네임</label>
                        <input type="text" id="nickname" name="nickname" placeholder="2~16자 한글, 영문, 숫자" required
                               th:value="${socialInfo != null} ? ${socialInfo.nickname} : ''">
                        <p id="nickname-message" class="info-message"></p>
                    </div>

                    <div class="input-group">
                        <label for="password">비밀번호</label>
                        <div class="password-wrapper">
                            <input type="password" id="password" name="password" placeholder="8자 이상, 영문/숫자/특수문자 조합" required pattern="^(?=.*[A-Za-z])(?=.*\d)(?=.*[@$!%*#?&])[A-Za-z\d@$!%*#?&]{8,}$">
                            <i class="fas fa-eye-slash toggle-password" data-target="password"></i>
                        </div>
                        <p id="password-message" class="info-message"></p>
                    </div>

                    <div class="input-group">
                        <label for="confirm-password">비밀번호 확인</label>
                        <div class="password-wrapper">
                            <input type="password" id="confirm-password" name="confirmPassword" placeholder="********" required>
                            <i class="fas fa-eye-slash toggle-password" data-target="confirm-password"></i>
                        </div>
                    </div>


                    <div class="input-group" style="display: flex; align-items: center; gap: 20px; margin-top: 5px;">
                        <label style="margin: 0; min-width: 100px; font-weight: 700; font-size: 20px;">
                            성별 (Gender)
                        </label>
                        <div style="display: flex; align-items: center; gap: 35px;  margin-top: 7px;">
                            <label style="display: inline-flex; align-items: center; gap: 6px; white-space: nowrap; font-size: 15px;">
                                <input type="radio" name="gender" value="남성" required style="accent-color: #6c5ce7; width: 18px; height: 18px;">
                                남성 (M)
                            </label>
                            <label style="display: inline-flex; align-items: center; gap: 6px; white-space: nowrap; font-size: 15px;">
                                <input type="radio" name="gender" value="여성" required style="accent-color: #e74c3c; width: 18px; height: 18px;">
                                여성 (F)
                            </label>
                        </div>
                    </div>

                    <div class="input-group">
                        <label for="position">선호 포지션</label>
                        <select id="position" name="position" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; font-size: 15px; background: #f7f7f7;">
                            <option value="전체 (ALL)">전체 (ALL)</option>
                            <option value="픽소 (FIXO)">픽소 (FIXO)</option>
                            <option value="비보 (PIVO)">비보 (PIVO)</option>
                            <option value="콜레이로(GOLEIRO)">콜레이로(GOLEIRO)</option>
                        </select>
                    </div>


                    <div class="input-group">
                        <label for="skill-level">나의 실력 레벨</label>
                        <select id="skill-level" name="level" required style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; font-size: 15px; background: #f7f7f7;">
                            <option value="">실력을 선택하세요</option>
                            <option value="초급">초급</option>
                            <option value="중급">중급</option>
                            <option value="고급">고급</option>
                        </select>
                    </div>

                    <div class="input-group address-group">
                        <div class="input-wrapper">
                            <label for="address">주소</label>
                            <input type="text" id="address" name="address" placeholder="주소 검색 버튼을 눌러주세요" required readonly>
                        </div>
                        <button type="button" onclick="searchAddress()">주소 찾기</button>
                    </div>

                    <div class="input-group">
                        <input type="text" id="address-detail" placeholder="상세 주소를 입력하세요 (예: 101동 1004호)">
                    </div>

                    <div class="input-group">
                        <label>프로필 사진</label>

                        <input type="hidden" id="socialProfileUrl"
                               th:value="${socialInfo != null} ? ${socialInfo.profileImage} : ''">

                        <div class="profile-upload-container">
                            <div class="preview-wrapper">
                                <span class="preview-text">미리보기</span>
                                <img id="image-preview" class="profile-preview" src="" alt="프로필 미리보기">
                            </div>

                            <div class="profile-actions">
                                <input type="file" id="profile-pic" name="profile_image_file" accept="image/*">
                                <button type="button" id="reset-image-btn" class="reset-img-btn">
                                    <i class="fas fa-undo"></i> 기본 이미지로 변경
                                </button>
                            </div>
                        </div>
                        <p id="profile-pic-message" class="info-message"></p>
                    </div>


                    <div class="terms-agreement">
                        <input type="checkbox" id="terms-agree" name="termsAgree" value="true" required>
                        <label for="terms-agree">
                            <span id="open-terms-modal" class="terms-link">이용약관</span>에 동의합니다. (필수)
                        </label>
                    </div>

                    <button type="submit" id="register-submit-btn" class="login-button" style="margin-top: 15px;" disabled>
                        Create Account (모든 항목 확인 필요)
                    </button>
                </form>

                <div class="back-to-login" style="margin-top: 20px;">
                    Already have an account? <a href="/login">Login</a>
                </div>
            </div>
        </div>
    </div>
</main>

<!-- ========= 이용약관 모달 ========= -->
<div id="terms-modal-overlay" class="modal-overlay">
    <div class="modal">
        <div class="modal-header">
            <h1>Multi FC 이용약관</h1>
            <button type="button" class="modal-close-btn" id="terms-modal-close">&times;</button>
        </div>
        <div class="modal-body">
            <!-- 약관 내용 (생략: 기존과 동일) -->
            <h2>제 1 조 (목적)</h2>
            <div class="clause">
                <p>본 약관은 Multi FC(이하 "회사")가 제공하는 풋살 매칭 및 관련 제반 서비스의 이용과 관련하여 회사와 회원과의 권리, 의무 및 책임사항 등을 규정함을 목적으로 합니다.</p>
            </div>
            <!-- ... 중간 조항들 그대로 ... -->
            <h2>부칙</h2>
            <div class="clause">
                <p>본 약관은 <span id="terms-date"></span>부터 적용됩니다.</p>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="agree-btn" id="terms-modal-agree">
                위 약관 내용을 확인하였으며, 동의합니다.
            </button>
        </div>
    </div>
</div>
<script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>

<script>
    // 1. 비밀번호 토글
    document.querySelectorAll('.toggle-password').forEach(icon => {
        icon.addEventListener('click', function() {
            const targetInput = document.getElementById(this.dataset.target);
            if (targetInput.type === 'password') {
                targetInput.type = 'text';
                this.classList.remove('fa-eye-slash');
                this.classList.add('fa-eye');
            } else {
                targetInput.type = 'password';
                this.classList.remove('fa-eye');
                this.classList.add('fa-eye-slash');
            }
        });
    });

    // 2. 주소 찾기
    function searchAddress() {
        new daum.Postcode({
            oncomplete: function(data) {
                document.getElementById("address").value = data.roadAddress || data.jibunAddress;
                document.getElementById("address-detail").focus();
                // 강제 이벤트 발생 (유효성 체크용)
                document.getElementById("address").dispatchEvent(new Event('change'));
            }
        }).open();
    }

    // 3. 약관 모달
    const modalOverlay = document.getElementById('terms-modal-overlay');
    document.getElementById('open-terms-modal').addEventListener('click', () => modalOverlay.classList.add('show'));
    document.getElementById('terms-modal-close').addEventListener('click', () => modalOverlay.classList.remove('show'));
    document.getElementById('terms-modal-agree').addEventListener('click', () => {
        document.getElementById('terms-agree').checked = true;
        document.getElementById('terms-agree').dispatchEvent(new Event('change'));
        modalOverlay.classList.remove('show');
    });

    // ⭐️ 4. 핵심 로직 (유효성 검사 + 이미지 프리뷰 + 헤더 닉네임/배지) ⭐️
    document.addEventListener('DOMContentLoaded', async () => {
        /* ===== 헤더 쪽: 사용자명/배지 처리 (공통) ===== */
        const headerNameSpan = document.getElementById('user-menu-username');
        const savedName = (localStorage.getItem('username') || '').trim();
        if (headerNameSpan) {
            // "사용자님" 같은 기본 문구 대신 저장된 닉네임 / 없으면 '게스트'
            headerNameSpan.textContent = savedName || '게스트';
        }

        // 빨간 알림 배지 (헤더에서 정의된 전역 함수가 있을 때만 안전하게 호출)
        if (typeof checkPendingReviews === 'function') {
            try { await checkPendingReviews(); } catch (e) { console.error(e); }
        }
        if (typeof checkUpcomingSchedules === 'function') {
            try { await checkUpcomingSchedules(); } catch (e) { console.error(e); }
        }
        if (typeof updateGlobalBadge === 'function') {
            try { updateGlobalBadge(); } catch (e) { console.error(e); }
        }
        /* ===== 여기까지가 헤더 관련, 아래는 기존 회원가입 로직 그대로 ===== */

        const registerForm = document.getElementById('register-form');
        const registerSubmitBtn = document.getElementById('register-submit-btn');

        // 필드
        const emailInput = document.getElementById('email');
        const usernameInput = document.getElementById('username');
        const nicknameInput = document.getElementById('nickname');
        const passwordInput = document.getElementById('password');
        const confirmPasswordInput = document.getElementById('confirm-password');
        const termsCheckbox = document.getElementById('terms-agree');
        const skillLevelSelect = document.getElementById('skill-level');
        const addressInput = document.getElementById('address');
        const genderInputs = document.querySelectorAll('input[name="gender"]');
        const dateElement = document.getElementById('terms-date');

        // 메시지창
        const emailMsg = document.getElementById('email-message');
        const usernameMsg = document.getElementById('username-message');
        const nicknameMsg = document.getElementById('nickname-message');
        const passwordMsg = document.getElementById('password-message');
        const profilePicMsg = document.getElementById('profile-pic-message');
        const errorMsg = document.getElementById('error-message');

        // 이미지 관련
        const profilePicInput = document.getElementById('profile-pic');
        const imagePreview = document.getElementById('image-preview');
        const resetImageBtn = document.getElementById('reset-image-btn');
        const socialProfileUrlInput = document.getElementById('socialProfileUrl');

        // 초기 유효성 상태
        let validationStatus = {
            email: emailInput.value.length > 0 && emailInput.readOnly, // 소셜이면 true
            username: false,
            nickname: nicknameInput.value.length > 0,
            password: false,
            terms: false,
            skill: false,
            address: false,
            gender: true
        };

        // 버튼 상태 업데이트
        function checkSubmitButtonState() {
            const allValid = Object.values(validationStatus).every(Boolean);
            registerSubmitBtn.disabled = !allValid;
            registerSubmitBtn.textContent = allValid ? 'Create Account' : '모든 항목을 확인해주세요';
        }

        // 메시지 표시/숨김
        function showFeedback(element, message, isError) {
            if (!element) return;
            element.textContent = message;
            element.className = isError ? 'info-message error' : 'info-message success';
        }
        function hideFeedback(element) {
            if (element) {
                element.textContent = '';
                element.className = 'info-message';
            }
        }

        // ⭐️ 유효성 검사 함수 (Debounce) ⭐️
        let debounceTimer;
        async function validateField(field, value, messageElement, apiUrl, regex, regexMsg) {
            clearTimeout(debounceTimer);

            // 1. 정규식 검사
            if (!regex.test(value)) {
                showFeedback(messageElement, regexMsg, true);
                validationStatus[field] = false;
                checkSubmitButtonState();
                return;
            }

            // 2. API 중복 검사 (0.5초 대기)
            debounceTimer = setTimeout(async () => {
                try {
                    const response = await fetch(`${apiUrl}?${field}=${encodeURIComponent(value)}`);
                    const isTaken = await response.json();

                    if (isTaken) {
                        showFeedback(messageElement, '이미 사용 중입니다.', true);
                        validationStatus[field] = false;
                    } else {
                        showFeedback(messageElement, '사용 가능합니다.', false);
                        validationStatus[field] = true;
                    }
                } catch (e) {
                    console.error(e);
                }
                checkSubmitButtonState();
            }, 500);
        }

        // --- 이벤트 리스너 (검사 로직) ---

        // 1. 이메일
        if (emailInput.readOnly) {
            showFeedback(emailMsg, '✅ 소셜 로그인 인증 완료', false);
        } else {
            emailInput.addEventListener('input', () => {
                const regex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
                validateField('email', emailInput.value, emailMsg, '/api/users/check-email', regex, '올바른 이메일 형식이 아닙니다.');
            });
        }

        // 2. 아이디
        usernameInput.addEventListener('input', () => {
            const regex = /^[a-z0-9_]{5,20}$/;
            validateField('username', usernameInput.value, usernameMsg, '/api/users/check-username', regex, '5~20자 영문 소문자, 숫자, (_)만 사용 가능');
        });

        // 3. 닉네임
        nicknameInput.addEventListener('input', () => {
            const regex = /^[가-힣a-zA-Z0-9]{2,16}$/;
            validateField('nickname', nicknameInput.value, nicknameMsg, '/api/users/check-nickname', regex, '2~16자 한글, 영문, 숫자만 사용 가능');
        });

        // 4. 비밀번호
        passwordInput.addEventListener('input', () => {
            const regex = /^(?=.*[A-Za-z])(?=.*\d)(?=.*[@$!%*#?&])[A-Za-z\d@$!%*#?&]{8,}$/;
            if (regex.test(passwordInput.value)) {
                showFeedback(passwordMsg, '사용 가능한 비밀번호입니다.', false);
                validationStatus.password = true;
            } else {
                showFeedback(passwordMsg, '8자 이상, 영문/숫자/특수문자를 모두 포함해야 합니다.', true);
                validationStatus.password = false;
            }
            if (confirmPasswordInput.value) confirmPasswordInput.dispatchEvent(new Event('input'));
            checkSubmitButtonState();
        });

        confirmPasswordInput.addEventListener('input', () => {
            if (passwordInput.value === confirmPasswordInput.value && validationStatus.password) {
                showFeedback(passwordMsg, '비밀번호가 일치합니다.', false);
            } else if (passwordInput.value !== confirmPasswordInput.value) {
                showFeedback(passwordMsg, '비밀번호가 일치하지 않습니다.', true);
            }
        });

        // 5. 기타 필수 항목
        termsCheckbox.addEventListener('change', () => { validationStatus.terms = termsCheckbox.checked; checkSubmitButtonState(); });
        skillLevelSelect.addEventListener('change', () => { validationStatus.skill = !!skillLevelSelect.value; checkSubmitButtonState(); });
        addressInput.addEventListener('change', () => { validationStatus.address = !!addressInput.value; checkSubmitButtonState(); });

        // ⭐️ 이미지 프리뷰 및 초기화 로직 ⭐️
        function updateImagePreview() {
            const file = profilePicInput.files[0];
            const socialUrl = socialProfileUrlInput.value;

            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    imagePreview.src = e.target.result;
                    imagePreview.classList.add('active');
                };
                reader.readAsDataURL(file);
            } else if (socialUrl) {
                imagePreview.src = socialUrl;
                imagePreview.classList.add('active');
            } else {
                imagePreview.src = '';
                imagePreview.classList.remove('active');
            }
        }

        profilePicInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file && file.size > 5 * 1024 * 1024) {
                showFeedback(profilePicMsg, '파일 크기는 5MB 이하여야 합니다.', true);
                profilePicInput.value = '';
            } else {
                hideFeedback(profilePicMsg);
                updateImagePreview();
            }
        });

        resetImageBtn.addEventListener('click', () => {
            profilePicInput.value = '';
            socialProfileUrlInput.value = '';
            updateImagePreview();
        });

        // 초기 실행
        updateImagePreview();
        if (nicknameInput.value) nicknameInput.dispatchEvent(new Event('input'));
        checkSubmitButtonState();

        // 약관 날짜
        if (dateElement) {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');

            dateElement.textContent = `${year}년 ${month}월 ${day}일`;
        }

        // ⭐️ 폼 제출 ⭐️
        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!Object.values(validationStatus).every(Boolean)) {
                alert("필수 항목을 모두 입력해주세요.");
                return;
            }
            if (passwordInput.value !== confirmPasswordInput.value) {
                alert("비밀번호가 일치하지 않습니다.");
                return;
            }

            const formData = new FormData();
            formData.append('email', emailInput.value);
            formData.append('username', usernameInput.value);
            formData.append('nickname', nicknameInput.value);
            formData.append('password', passwordInput.value);
            formData.append('gender', document.querySelector('input[name="gender"]:checked').value);
            formData.append('position', document.getElementById('position').value);
            formData.append('level', document.getElementById('skill-level').value);
            formData.append('address', (addressInput.value + ' ' + document.getElementById('address-detail').value).trim());

            if (profilePicInput.files[0]) {
                formData.append('profile_image_file', profilePicInput.files[0]);
            } else if (socialProfileUrlInput.value) {
                formData.append('profileImage', socialProfileUrlInput.value);
            }

            try {
                registerSubmitBtn.textContent = '처리 중...';
                registerSubmitBtn.disabled = true;

                const response = await fetch('/api/users/signup', { method: 'POST', body: formData });

                if (response.ok) {
                    alert("가입 완료! 로그인해주세요.");
                    window.location.href = '/login';
                } else {
                    throw new Error(await response.text());
                }
            } catch (error) {
                errorMsg.textContent = '❌ ' + error.message;
                errorMsg.style.display = 'block';
                registerSubmitBtn.textContent = 'Create Account';
                registerSubmitBtn.disabled = false;
            }
        });
    });
</script>
</body>
</html>
