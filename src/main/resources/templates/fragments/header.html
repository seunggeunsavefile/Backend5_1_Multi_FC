<!-- fragments/header.html -->
<div th:fragment="siteHeader">
    <header class="quick-menu">
        <div class="logo"><a href="/">Multi FC</a></div>
        <div class="header-icons">
            <button id="profile-menu-toggle" class="profile-icon" style="position: relative;">
                <i class="fas fa-user-circle"></i>
                <span id="notification-badge" class="notification-badge"></span>
            </button>
            <div id="profile-menu" class="user-menu">
                <div class="user-info">
                    <strong><span id="user-menu-username">ì‚¬ìš©ì</span>ë‹˜</strong>
                    <p>í™˜ì˜í•©ë‹ˆë‹¤!</p>
                </div>
                <ul>
                    <li><a href="/notifications" id="nav-notifications-link"><i class="fas fa-bell"></i> ì•Œë¦¼ ëª©ë¡</a></li>
                    <li><a href="/mypage"><i class="fas fa-user"></i> ë§ˆì´í˜ì´ì§€</a></li>
                    <li><a href="/profile/edit"><i class="fas fa-user-edit"></i> í”„ë¡œí•„ ìˆ˜ì •</a></li>
                    <li id="nav-logout-li" style="display:none;">
                        <a href="#" id="nav-logout-link"><i class="fas fa-sign-out-alt"></i> ë¡œê·¸ì•„ì›ƒ</a>
                    </li>
                </ul>
            </div>
            <button id="menu-toggle" class="menu-toggle-btn"><i class="fas fa-bars"></i></button>
        </div>

        <nav id="main-menu" class="main-nav">
            <ul>
                <li><a href="/" class="active"><i class="fas fa-home"></i> ë©”ì¸ (Home)</a></li>
                <li><a href="/fields"><i class="fas fa-search"></i> êµ¬ì¥ê²€ìƒ‰</a></li>
                <li><a href="/community"><i class="fas fa-users"></i> ì»¤ë®¤ë‹ˆí‹°</a></li>
                <li id="nav-chat-link-li"><a href="/chat" id="nav-chat-link"><i class="fas fa-comments"></i> ì‹¤ì‹œê°„ì±„íŒ…</a></li>
                <li><a href="/schedule?stadium"><i class="fas fa-calendar-check"></i> ê²½ê¸° ì¼ì •</a></li>
            </ul>
        </nav>
    </header>

    <!-- ğŸ”¥ ë¡œê·¸ì•„ì›ƒ ê¸€ì ë¹¨ê°„ìƒ‰ ì ìš© -->
    <style>
        #nav-logout-li a {
            color: #e74c3c !important;
            font-weight: 700;
        }
    </style>

    <!-- âœ… í—¤ë”ìš© JS (ì•Œë¦¼/ë°°ì§€ ê³µìš© í•¨ìˆ˜ + ë©”ë‰´ ì»¨íŠ¸ë¡¤) -->
    <script>
        // === ì „ì—­ ì•Œë¦¼ ìƒíƒœ (ì—¬ëŸ¬ í˜ì´ì§€ì—ì„œ ê³µìœ ) ===
        window.hasReviewNotif = window.hasReviewNotif || false;
        window.hasScheduleNotif = window.hasScheduleNotif || false;
        window.pendingReviewStadiumIds = window.pendingReviewStadiumIds || [];
        window.upcomingSchedules = window.upcomingSchedules || [];

        document.addEventListener('DOMContentLoaded', () => {
            const menuToggle = document.getElementById('menu-toggle');
            const mainMenu = document.getElementById('main-menu');
            const profileMenuToggle = document.getElementById('profile-menu-toggle');
            const profileMenu = document.getElementById('profile-menu');
            const logoutButton = document.getElementById('logout-button'); // ì—†ìœ¼ë©´ ë¬´ì‹œ
            const navNotificationsLink = document.getElementById('nav-notifications-link');
            const navLogoutLink = document.getElementById('nav-logout-link');
            const navLoginLink = document.getElementById('nav-login-link');
            const navChatLinkElement = document.getElementById('nav-chat-link');
            const badge = document.getElementById('notification-badge');

            // === 1) ì•Œë¦¼/ë°°ì§€ ì „ì—­ í•¨ìˆ˜ ì •ì˜ (ì—¬ê¸°ì„œ "ì •ì˜ë§Œ" í•˜ê³  í˜¸ì¶œì€ ê° í˜ì´ì§€ì—ì„œ) ===
            window.updateGlobalBadge = function () {
                if (!badge) return;

                if (pendingReviewStadiumIds.length > 0 || hasScheduleNotif) {
                    if (localStorage.getItem('hasReadReviews') !== 'true') {
                        badge.style.display = 'block';
                    } else {
                        badge.style.display = 'none';
                    }
                } else {
                    badge.style.display = 'none';
                }
            };

            window.checkPendingReviews = async function () {
                const currentUserId = localStorage.getItem('userId');
                if (!currentUserId) return;

                try {
                    const response = await fetch(`/api/reviews/pending-stadiums?userId=${currentUserId}`);
                    if (response.ok) {
                        const ids = await response.json();
                        pendingReviewStadiumIds = ids;
                        hasReviewNotif = ids && ids.length > 0;
                    }
                } catch (error) {
                    console.error("í›„ê¸° ì•Œë¦¼ ìš”ì²­ ì¤‘ ì˜¤ë¥˜:", error);
                }
            };

            window.checkUpcomingSchedules = async function () {
                if (localStorage.getItem('hasReadSchedules') === 'true') {
                    hasScheduleNotif = false;
                    return;
                }
                const accessToken = localStorage.getItem('accessToken');
                if (!accessToken) return;

                try {
                    const response = await fetch(`/api/schedule/upcoming`, {
                        headers: { 'Authorization': 'Bearer ' + accessToken }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        upcomingSchedules = data.map(item => ({
                            id: item.scheduleId,
                            matchId: item.matchId,
                            type: item.scheduleType,   // "ê²½ê¸°" / "ê°œì¸"
                            date: item.scheduleDate,
                            time: item.scheduleTime,
                            title: item.title
                        }));
                        hasScheduleNotif = upcomingSchedules.length > 0;
                    }
                } catch (error) {
                    console.error("ì¼ì • ìš”ì²­ ì¤‘ ì˜¤ë¥˜:", error);
                }
            };

            // === 2) í—¤ë” ë©”ë‰´ / í”„ë¡œí•„ ë“œë¡­ë‹¤ìš´ ===
            if (menuToggle) {
                menuToggle.addEventListener('click', () => {
                    mainMenu.classList.toggle('show');
                    profileMenu.classList.remove('show');
                });
            }
            if (profileMenuToggle) {
                profileMenuToggle.addEventListener('click', () => {
                    profileMenu.classList.toggle('show');
                    mainMenu.classList.remove('show');
                });
            }

            document.addEventListener('click', (event) => {
                if (
                    mainMenu &&
                    profileMenu &&
                    !mainMenu.contains(event.target) &&
                    !menuToggle.contains(event.target) &&
                    !profileMenu.contains(event.target) &&
                    !profileMenuToggle.contains(event.target)
                ) {
                    mainMenu.classList.remove('show');
                    profileMenu.classList.remove('show');
                }
            });

            // === 3) ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ UI ê¸°ë³¸ ì²˜ë¦¬ (ì˜µì…˜) ===
            const accessToken = localStorage.getItem('accessToken');
            const profileIcon = document.getElementById('profile-menu-toggle');
            const userMenuName = document.getElementById('user-menu-username');

            if (accessToken) {
                const nickname = localStorage.getItem('username') || 'ì‚¬ìš©ì';
                if (profileIcon) profileIcon.style.display = 'flex';
                if (userMenuName) userMenuName.textContent = nickname;

                if (navLoginLink && navLoginLink.parentElement) {
                    navLoginLink.parentElement.style.display = 'none';
                }
                if (navLogoutLink && navLogoutLink.parentElement) {
                    navLogoutLink.parentElement.style.display = 'list-item';
                }
            } else {
                if (profileIcon) profileIcon.style.display = 'none';
                if (userMenuName) userMenuName.textContent = 'ê²ŒìŠ¤íŠ¸';

                if (navLoginLink && navLoginLink.parentElement) {
                    navLoginLink.parentElement.style.display = 'list-item';
                }
                if (navLogoutLink && navLogoutLink.parentElement) {
                    navLogoutLink.parentElement.style.display = 'none';
                }
            }

            // ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬
            if (navLogoutLink) {
                navLogoutLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    localStorage.removeItem('accessToken');
                    localStorage.removeItem('username');
                    localStorage.removeItem('userId');
                    localStorage.removeItem('hasReadReviews');
                    localStorage.removeItem('hasReadSchedules');
                    window.location.href = '/login';
                });
            }

            // ì±„íŒ… ë©”ë‰´: ë¹„ë¡œê·¸ì¸ ì‹œ ë¡œê·¸ì¸ ìœ ë„
            if (navChatLinkElement) {
                navChatLinkElement.addEventListener('click', function (e) {
                    const accessToken = localStorage.getItem('accessToken');
                    if (!accessToken) {
                        e.preventDefault();
                        alert("ë¡œê·¸ì¸ì´ í•„ìš”í•œ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.");
                        window.location.href = '/login';
                    }
                });
            }

            // ì•Œë¦¼ ëª©ë¡ í´ë¦­ ì‹œ ì½ìŒ ì²˜ë¦¬
            if (navNotificationsLink) {
                navNotificationsLink.addEventListener('click', () => {
                    localStorage.setItem('hasReadReviews', 'true');
                    localStorage.setItem('hasReadSchedules', 'true');
                    // ì‹¤ì œ í˜ì´ì§€ ì´ë™ì€ a íƒœê·¸ hrefë¡œ ì§„í–‰
                });
            }
        });
    </script>
</div>
