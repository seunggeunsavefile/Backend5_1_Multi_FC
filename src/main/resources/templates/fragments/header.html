<div th:fragment="siteHeader">
    <header class="quick-menu">
        <div class="logo"><a href="/">Multi FC</a></div>
        <div class="header-icons">
            <button id="profile-menu-toggle" class="profile-icon" style="position: relative;">
                <i class="fas fa-user-circle"></i>
                <span id="notification-badge" class="notification-badge"></span>
            </button>
            <div id="profile-menu" class="user-menu">
                <div class="user-info">
                    <strong><span id="user-menu-username">사용자</span>님</strong>
                    <p>환영합니다!</p>
                </div>
                <ul>
                    <li><a href="/notifications" id="nav-notifications-link"><i class="fas fa-bell"></i> 알림 목록</a></li>
                    <li><a href="/mypage"><i class="fas fa-user"></i> 마이페이지</a></li>
                    <li><a href="/profile/edit"><i class="fas fa-user-edit"></i> 프로필 수정</a></li>
                    <li><a href="#" id="logout-button"><i class="fas fa-sign-out-alt"></i> 로그아웃</a></li>
                </ul>
            </div>
            <button id="menu-toggle" class="menu-toggle-btn"><i class="fas fa-bars"></i></button>
        </div>

        <nav id="main-menu" class="main-nav">
            <ul>
                <li><a href="/" class="active"><i class="fas fa-home"></i> 메인 (Home)</a></li>
                <li><a href="/fields"><i class="fas fa-search"></i> 구장검색</a></li>
                <li><a href="/community"><i class="fas fa-users"></i> 커뮤니티</a></li>
                <li id="nav-chat-link-li"><a href="/chat" id="nav-chat-link"><i class="fas fa-comments"></i> 실시간채팅</a></li>
                <li><a href="/schedule?stadium"><i class="fas fa-calendar-check"></i> 경기 일정</a></li>
            </ul>
        </nav>
    </header>

    <!-- ✅ 헤더용 JS를 fragment 안에서 로드 -->
    <script>
        // === 전역 알림 상태 ===
        window.hasReviewNotif = window.hasReviewNotif || false;
        window.hasScheduleNotif = window.hasScheduleNotif || false;
        window.pendingReviewStadiumIds = window.pendingReviewStadiumIds || [];
        window.upcomingSchedules = window.upcomingSchedules || [];

        document.addEventListener('DOMContentLoaded', () => {
            const menuToggle = document.getElementById('menu-toggle');
            const mainMenu = document.getElementById('main-menu');
            const profileMenuToggle = document.getElementById('profile-menu-toggle');
            const profileMenu = document.getElementById('profile-menu');
            const logoutButton = document.getElementById('logout-button');
            const navNotificationsLink = document.getElementById('nav-notifications-link');
            const navLogoutLink = document.getElementById('nav-logout-link');
            const navChatLinkElement = document.getElementById('nav-chat-link');
            const badge = document.getElementById('notification-badge');

            // --- 공용 함수 정의만! (여기서 호출 X) ---
            window.updateGlobalBadge = function () {
                if (!badge) return;

                if (pendingReviewStadiumIds.length > 0 || hasScheduleNotif) {
                    if (localStorage.getItem('hasReadReviews') !== 'true') {
                        badge.style.display = 'block';
                    } else {
                        badge.style.display = 'none';
                    }
                } else {
                    badge.style.display = 'none';
                }
            };

            window.checkPendingReviews = async function () {
                const currentUserId = localStorage.getItem('userId');
                if (!currentUserId) return;

                try {
                    const response = await fetch(`/api/reviews/pending-stadiums?userId=${currentUserId}`);
                    if (response.ok) {
                        const ids = await response.json();
                        pendingReviewStadiumIds = ids;
                        hasReviewNotif = ids && ids.length > 0;
                    }
                } catch (error) {
                    console.error("후기 알림 요청 중 오류:", error);
                }
            };

            window.checkUpcomingSchedules = async function () {
                if (localStorage.getItem('hasReadSchedules') === 'true') {
                    hasScheduleNotif = false;
                    return;
                }
                const accessToken = localStorage.getItem('accessToken');
                if (!accessToken) return;

                try {
                    const response = await fetch(`/api/schedule/upcoming`, {
                        headers: { 'Authorization': 'Bearer ' + accessToken }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        upcomingSchedules = data.map(item => ({
                            id: item.scheduleId,
                            matchId: item.matchId,
                            type: item.scheduleType,
                            date: item.scheduleDate,
                            time: item.scheduleTime,
                            title: item.title
                        }));
                        hasScheduleNotif = upcomingSchedules.length > 0;
                    }
                } catch (error) {
                    console.error("일정 요청 중 오류:", error);
                }
            };

            // --- 나머지: 메뉴 · 로그아웃 · 채팅 링크 · 알림 이동 ---

            if (menuToggle) {
                menuToggle.addEventListener('click', () => {
                    mainMenu.classList.toggle('show');
                    profileMenu.classList.remove('show');
                });
            }

            if (profileMenuToggle) {
                profileMenuToggle.addEventListener('click', () => {
                    profileMenu.classList.toggle('show');
                    mainMenu.classList.remove('show');
                });
            }

            document.addEventListener('click', (event) => {
                if (
                    mainMenu &&
                    profileMenu &&
                    !mainMenu.contains(event.target) &&
                    !menuToggle.contains(event.target) &&
                    !profileMenu.contains(event.target) &&
                    !profileMenuToggle.contains(event.target)
                ) {
                    mainMenu.classList.remove('show');
                    profileMenu.classList.remove('show');
                }
            });

            if (logoutButton) {
                logoutButton.addEventListener('click', (e) => {
                    e.preventDefault();
                    localStorage.removeItem('accessToken');
                    localStorage.removeItem('username');
                    localStorage.removeItem('hasReadReviews');
                    localStorage.removeItem('hasReadSchedules');
                    window.location.href = '/login';
                });
            }

            if (navLogoutLink) {
                navLogoutLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    localStorage.removeItem('accessToken');
                    localStorage.removeItem('hasReadReviews');
                    localStorage.removeItem('hasReadSchedules');
                    window.location.href = '/login';
                });
            }

            if (navChatLinkElement) {
                navChatLinkElement.addEventListener('click', function (e) {
                    const accessToken = localStorage.getItem('accessToken');
                    if (!accessToken) {
                        e.preventDefault();
                        alert("로그인이 필요한 서비스입니다.");
                        window.location.href = '/login';
                    }
                });
            }

            if (navNotificationsLink) {
                navNotificationsLink.addEventListener('click', () => {
                    localStorage.setItem('hasReadReviews', 'true');
                    localStorage.setItem('hasReadSchedules', 'true');
                    // href 로 이동
                });
            }
        });
    </script>


</div>
