<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FUTSAL MATCH - 게시글 작성/수정</title>

    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">

</head>
<body>

<header class="quick-menu">
    <div class="logo"><a href="/">Multi FC</a></div>
    <div class="header-icons">
        <button id="profile-menu-toggle" class="profile-icon" style="position: relative; display: none;">
            <i class="fas fa-user-circle"></i>
            <span id="notification-badge" class="notification-badge"></span>
        </button>
        <div id="profile-menu" class="user-menu">
            <div class="user-info">
                <strong><span id="user-menu-username">사용자</span>님</strong>
                <p>환영합니다!</p>
            </div>
            <ul>
                <li><a href="/notifications" id="nav-notifications-link"><i class="fas fa-bell"></i> 알림 목록</a></li>
                <li><a href="/mypage"><i class="fas fa-user"></i> 마이페이지</a></li>
                <li><a href="/profile/edit"><i class="fas fa-user-edit"></i> 프로필 수정</a></li>
                <li><a href="#" id="logout-button"><i class="fas fa-sign-out-alt"></i> 로그아웃</a></li>
            </ul>
        </div>
        <button id="menu-toggle" class="menu-toggle-btn"><i class="fas fa-bars"></i></button>
    </div>
    <nav id="main-menu" class="main-nav">
        <ul>
            <li><a href="/"><i class="fas fa-home"></i> 메인 (Home)</a></li>
            <li><a href="/fields"><i class="fas fa-search"></i> 구장검색</a></li>
            <li><a href="/community" class="active"><i class="fas fa-users"></i> 커뮤니티</a></li>
            <li><a href="/chat"><i class="fas fa-comments"></i> 실시간채팅</a></li>
            <li><a href="/schedule"><i class="fas fa-calendar-alt"></i> 일정</a></li>
            <li><a href="/login" id="nav-login-link"><i class="fas fa-sign-in-alt"></i> 로그인</a></li>
            <li><a href="#" id="nav-logout-link"><i class="fas fa-sign-out-alt"></i> 로그아웃</a></li>
        </ul>
    </nav>
</header>

<main class="community-main">
    <div class="board-container">

        <!-- ✅ 작성/수정 폼 -->
        <p id="post-success-message" class="info-message" style="display:none;"></p>
        <p id="post-error-message" class="error-message" style="display:none;"></p>

        <form id="write-form">
            <div class="write-header">
                <h1>새 게시글 작성</h1>
                <div class="write-controls">
                    <button type="button" class="write-btn-cancel" onclick="history.back()">취소</button>
                    <button type="submit" class="write-btn-save">등록</button>
                </div>
            </div>

            <div class="write-form">
                <div class="input-group">
                    <label for="category">카테고리 선택</label>
                    <!-- [수정] DB ENUM(공지 / 자유게시판)에 맞추기 위해 value를 한글로 변경 -->
                    <select id="category" name="category" required>
                        <option value="공지">공지사항</option>
                        <option value="자유게시판">자유게시판</option>
                    </select>
                </div>

                <div class="input-group">
                    <label for="title">제목</label>
                    <input type="text" id="title" name="title" placeholder="제목을 입력하세요" required>
                </div>

                <!-- [수정] 이미지 업로드 기능 추가: 첨부 이미지가 있을 경우 백엔드에 함께 전송 -->
                <div class="input-group">
                    <label for="image">이미지(선택)</label>
                    <input type="file" id="image" name="image" accept="image/*">
                </div>

                <div id="editor-container"></div>
            </div>

            <input type="hidden" id="post-content-html" name="contentHtml">
        </form>
    </div>
</main>
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

<script>
    // --- (★공통★) 메뉴 토글 및 로그아웃 로직 (유지) ---
    const menuToggle = document.getElementById('menu-toggle');
    const mainMenu = document.getElementById('main-menu');
    const profileMenuToggle = document.getElementById('profile-menu-toggle');
    const profileMenu = document.getElementById('profile-menu');
    const logoutButton = document.getElementById('logout-button');
    const navNotificationsLink = document.getElementById('nav-notifications-link');
    const navLoginLink = document.getElementById('nav-login-link');
    const navLogoutLink = document.getElementById('nav-logout-link');

    if (menuToggle) {
        menuToggle.addEventListener('click', () => {
            mainMenu.classList.toggle('show');
            if (profileMenu) profileMenu.classList.remove('show');
        });
    }

    if (profileMenuToggle) {
        profileMenuToggle.addEventListener('click', () => {
            profileMenu.classList.toggle('show');
            if (mainMenu) mainMenu.classList.remove('show');
        });
    }

    document.addEventListener('click', (event) => {
        const isClickInsideHeader = document.querySelector('header').contains(event.target);
        if (!isClickInsideHeader) {
            mainMenu.classList.remove('show');
            if (profileMenu) profileMenu.classList.remove('show');
        }
    });

    if (logoutButton) {
        logoutButton.addEventListener('click', (e) => {
            e.preventDefault();
            localStorage.removeItem('accessToken');
            localStorage.removeItem('hasReadReviews');
            localStorage.removeItem('hasReadSchedules');
            window.location.href = '/login';
        });
    }

    if (navLogoutLink) {
        navLogoutLink.addEventListener('click', (e) => {
            e.preventDefault();
            localStorage.removeItem('accessToken');
            localStorage.removeItem('hasReadReviews');
            localStorage.removeItem('hasReadSchedules');
            window.location.href = '/login';
        });
    }

    if (navNotificationsLink) {
        navNotificationsLink.addEventListener('click', (e) => {
            e.preventDefault();
            localStorage.setItem('hasReadReviews', 'true');
            localStorage.setItem('hasReadSchedules', 'true');
            window.location.href = '/notifications';
        });
    }

    // --- (★공통★) URL 기반 메뉴 활성화 함수 (유지) ---
    function setActiveMenuItem() {
        const path = window.location.pathname;
        const navLinks = document.querySelectorAll('#main-menu a');

        navLinks.forEach(link => {
            link.classList.remove('active');
        });

        navLinks.forEach(link => {
            const href = link.getAttribute('href');

            if (path === '/' && href === '/') {
                link.classList.add('active');
            } else if (path.startsWith('/community') && href === '/community') {
                link.classList.add('active');
            } else if (href !== '/' && path.startsWith(href)) {
                link.classList.add('active');
            }
        });
    }

    // [수정] 기존: 로컬스토리지에서 게시글을 찾아 채웠음 → 변경: 백엔드 API 호출로 실제 DB 게시글을 조회
    async function loadPostForEdit(postId) {
        try {
            const res = await fetch(`/api/community/posts/${postId}`);  // [수정] 서버에서 단일 게시글 상세 조회
            if (!res.ok) {
                throw new Error('게시글 정보를 불러오지 못했습니다.');
            }
            const post = await res.json();

            const headerTitle = document.querySelector('.write-header h1');
            const submitBtn = document.querySelector('.write-btn-save');// [수정] 버튼 클래스 이름을 실제 DOM(.write-btn-save)과 일치시키기

            // [수정] 수정 모드일 때 UI 텍스트를 수정용으로 변경
            if (headerTitle) headerTitle.textContent = '게시글 수정';
            if (submitBtn)   submitBtn.textContent   = '수정';

            // [수정] 백엔드에서 내려온 category를 그대로 사용, 없을 때는 기본값 '자유게시판'
            document.getElementById('category').value = post.category || '자유게시판';
            document.getElementById('title').value    = post.title    || '';

            // Quill 에디터 내용 채우기
            const quillEditor = Quill.find(document.querySelector('#editor-container'));
            if (quillEditor) {
                quillEditor.setText(post.content || '');
            }

            // [수정] 어떤 게시글을 수정 중인지 서버에 보낼 수 있도록 form dataset에 postId 저장
            writeForm.dataset.postId = postId;
        } catch (e) {
            console.error(e);
            alert('❌ 수정할 게시글 정보를 불러오지 못했습니다.');
            window.location.href = '/community';
        }
    }

    let quill;

    document.addEventListener('DOMContentLoaded', async () => {
        const accessToken = localStorage.getItem('accessToken');
        const currentPath = window.location.pathname;

        if (!accessToken) {
            alert("로그인이 필요한 페이지입니다.");
            localStorage.setItem('redirectAfterLogin', currentPath);
            window.location.href = '/login';
            return;
        }

        // 1. Quill 초기화
        const toolbarOptions = [
            [{'header': [1, 2, false]}],
            ['bold', 'italic', 'underline', 'strike'],
            [{'list': 'ordered'}, {'list': 'bullet'}],
            ['link', 'image'],
            ['clean']
        ];

        quill = new Quill('#editor-container', {
            theme: 'snow',
            placeholder: '내용을 입력하세요.',
            modules: {
                toolbar: { container: toolbarOptions },
                history: { delay: 100, maxStack: 50, userOnly: true }
            }
        });

        setActiveMenuItem();

        // 2. 수정 모드인지 체크
        // [수정] URL 쿼리파라미터 id 또는 edit가 있을 경우 수정 모드로 판단
        const urlParams   = new URLSearchParams(window.location.search);
        const editPostId  = urlParams.get('id') || urlParams.get('edit');

        if (editPostId) {
            // 수정 모드
            // [수정] 수정 모드일 때 서버에서 해당 게시글을 불러오도록 변경
            await loadPostForEdit(editPostId);
        } else {
            // 작성 모드
            const headerTitle = document.querySelector('.write-header h1');
            const submitBtn   = document.querySelector('.write-btn-save');  // [수정] 버튼 선택자 수정 (.btn-save → .write-btn-save)

            if (headerTitle) headerTitle.textContent = '새 게시글 작성';
            if (submitBtn)   submitBtn.textContent   = '등록';
        }
    });



    // --- (★페이지별★) 게시글 작성/수정 로직 ---
    const writeForm = document.getElementById('write-form');
    const postContentHtmlInput = document.getElementById('post-content-html'); // 숨겨진 필드
    const successMsg = document.getElementById('post-success-message');
    const errorMsg = document.getElementById('post-error-message');

    // ⭐⭐⭐ [최종 수정] 폼 제출 시 로컬 스토리지에 저장하고 이동하도록 로직 변경 ⭐⭐⭐
    // [수정] 로컬스토리지에 저장하지 않고, 백엔드 API(POST/PUT)로 전송하도록 변경
    writeForm.addEventListener('submit', async function (e) {
        e.preventDefault();
        successMsg.style.display = 'none';
        errorMsg.style.display = 'none';

        const accessToken = localStorage.getItem('accessToken');
        // [수정] 서버 요청 전에도 토큰이 있는지 한 번 더 검증 (보안/안정성 위해 추가 체크)
        if (!accessToken) {
            alert('로그인 후 글을 작성할 수 있습니다.');
            localStorage.setItem('redirectAfterLogin', window.location.pathname);
            window.location.href = '/login';
            return;
        }

        const category = document.getElementById('category').value;
        const title = document.getElementById('title').value.trim();
        const quillEditor = Quill.find(document.querySelector('#editor-container'));
        const contentText = quillEditor.getText().trim();
        const imageInput = document.getElementById('image'); // [수정] 이미지 파일 전송을 위해 input 참조

        if (!title || contentText.length === 0) {
            errorMsg.textContent = '❌ 제목과 내용을 모두 입력해주세요.';
            errorMsg.style.display = 'block';
            return;
        }

        const isEdit = !!writeForm.dataset.postId;   // 수정 모드인지 체크
        const postId = writeForm.dataset.postId;

        try {
            let res;

            if (isEdit) {
                // ✅ 수정: PUT /api/community/posts/{postId}
                // [수정] 수정 모드에서는 JSON DTO만 보내는 PUT 요청 사용
                const updateDto = {
                    title: title,
                    content: contentText
                };

                res = await fetch(`/api/community/posts/${postId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}`  // [수정] JWT 인증 헤더 추가
                    },
                    body: JSON.stringify(updateDto)
                });
            } else {
                // ✅ 등록: POST /api/community/posts (multipart/form-data)
                // [수정] 새 글 작성 시에는 게시글 정보 + 이미지 파일을 multipart/form-data로 전송
                const postDto = {
                    category: category,   // 'notice' 또는 'free'
                    title: title,
                    content: contentText
                };

                const formData = new FormData();
                formData.append(
                    'post',
                    new Blob([JSON.stringify(postDto)], { type: 'application/json' })
                );
                // [수정] 이미지가 선택된 경우에만 formData에 추가
                if (imageInput && imageInput.files[0]) {
                    formData.append('image', imageInput.files[0]);
                }

                res = await fetch('/api/community/posts', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    },
                    body: formData
                });
            }

            if (res.ok) {
                // [수정] 성공 시에는 알림 후 커뮤니티 목록으로 이동
                alert(isEdit ? '게시글이 수정되었습니다.' : '게시글이 등록되었습니다.');
                window.location.href = '/community';
            } else {
                const msg = await res.text();
                // [수정] 실패 시 서버 응답 메시지를 함께 보여주도록 변경
                errorMsg.textContent = (isEdit ? '수정 실패: ' : '등록 실패: ') + msg;
                errorMsg.style.display = 'block';
            }
        } catch (err) {
            console.error(err);
            // [수정] 네트워크/서버 오류 대응 메시지 변경 (등록/수정 모드 구분)
            errorMsg.textContent = isEdit
                ? '수정 중 오류가 발생했습니다.'
                : '등록 중 오류가 발생했습니다.';
            errorMsg.style.display = 'block';
        }
    });


</script>
</body>
</html>