<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FUTSAL MATCH - ê²Œì‹œê¸€ ì‘ì„±/ìˆ˜ì •</title>

    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
</head>
<body>

<div th:replace="~{fragments/header :: siteHeader}"></div>

<main class="community-main">
    <div class="board-container">

        <!-- âœ… ì‘ì„±/ìˆ˜ì • í¼ -->
        <p id="post-success-message" class="info-message" style="display:none;"></p>
        <p id="post-error-message" class="error-message" style="display:none;"></p>

        <form id="write-form">
            <div class="write-header">
                <h1>ìƒˆ ê²Œì‹œê¸€ ì‘ì„±</h1>
                <div class="write-controls">
                    <button type="button" class="write-btn-cancel" onclick="history.back()">ì·¨ì†Œ</button>
                    <button type="submit" class="write-btn-save">ë“±ë¡</button>
                </div>
            </div>

            <div class="write-form">
                <div class="input-group">
                    <label for="category">ì¹´í…Œê³ ë¦¬ ì„ íƒ</label>
                    <!-- DB ENUM(ê³µì§€ / ììœ ê²Œì‹œíŒ)ì— ë§ì¶¤ -->
                    <select id="category" name="category" required>
                        <option value="ê³µì§€">ê³µì§€ì‚¬í•­</option>
                        <option value="ììœ ê²Œì‹œíŒ">ììœ ê²Œì‹œíŒ</option>
                    </select>
                </div>

                <div class="input-group">
                    <label for="title">ì œëª©</label>
                    <input type="text" id="title" name="title" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" required>
                </div>

                <!-- ì´ë¯¸ì§€ ì—…ë¡œë“œ -->
                <div class="input-group">
                    <label for="image">ì´ë¯¸ì§€(ì„ íƒ)</label>
                    <input type="file" id="image" name="image" accept="image/*">
                </div>

                <div id="editor-container"></div>
            </div>

            <input type="hidden" id="post-content-html" name="contentHtml">
        </form>
    </div>
</main>

<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

<script>
    let quill;

    // ğŸ”¥ í˜ì´ì§€ ì´ˆê¸°í™”: ë¡œê·¸ì¸ ì²´í¬ + í—¤ë” ë‹‰ë„¤ì„ ì„¸íŒ… + Quill + ìˆ˜ì •ëª¨ë“œ ì²˜ë¦¬
    document.addEventListener('DOMContentLoaded', async () => {
        const accessToken = localStorage.getItem('accessToken');
        const currentPath = window.location.pathname;

        // ë¡œê·¸ì¸ ì•ˆ ë˜ì–´ ìˆìœ¼ë©´ ë¡œê·¸ì¸ìœ¼ë¡œ
        if (!accessToken) {
            alert("ë¡œê·¸ì¸ì´ í•„ìš”í•œ í˜ì´ì§€ì…ë‹ˆë‹¤.");
            localStorage.setItem('redirectAfterLogin', currentPath);
            window.location.href = '/login';
            return;
        }

        // âœ… í—¤ë”ì— ë‹‰ë„¤ì„ë§Œ ì„¸íŒ… (ê¸°ë³¸ 'ì‚¬ìš©ìë‹˜' ê°™ì€ ê±° ì•ˆ ì”€)
        const storedName   = (localStorage.getItem('username') || '').trim();
        const userMenuName = document.getElementById('user-menu-username');
        if (storedName && userMenuName) {
            userMenuName.textContent = storedName;
        }

        // 1. Quill ì—ë””í„° ì´ˆê¸°í™”
        const toolbarOptions = [
            [{'header': [1, 2, false]}],
            ['bold', 'italic', 'underline', 'strike'],
            [{'list': 'ordered'}, {'list': 'bullet'}],
            ['link', 'image'],
            ['clean']
        ];

        quill = new Quill('#editor-container', {
            theme: 'snow',
            placeholder: 'ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.',
            modules: {
                toolbar: { container: toolbarOptions },
                history: { delay: 100, maxStack: 50, userOnly: true }
            }
        });

        // 2. ìˆ˜ì • ëª¨ë“œ ì—¬ë¶€ ì²´í¬ (?edit= or ?id=)
        const urlParams  = new URLSearchParams(window.location.search);
        const editPostId = urlParams.get('id') || urlParams.get('edit');

        if (editPostId) {
            await loadPostForEdit(editPostId);
        } else {
            const headerTitle = document.querySelector('.write-header h1');
            const submitBtn   = document.querySelector('.write-btn-save');

            if (headerTitle) headerTitle.textContent = 'ìƒˆ ê²Œì‹œê¸€ ì‘ì„±';
            if (submitBtn)   submitBtn.textContent   = 'ë“±ë¡';
        }
    });

    // --- ìˆ˜ì • ëª¨ë“œì¼ ë•Œ ê¸°ì¡´ ê²Œì‹œê¸€ ë¶ˆëŸ¬ì˜¤ê¸° ---
    async function loadPostForEdit(postId) {
        try {
            const res = await fetch(`/api/community/posts/${postId}`);
            if (!res.ok) {
                throw new Error('ê²Œì‹œê¸€ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
            }
            const post = await res.json();

            const headerTitle = document.querySelector('.write-header h1');
            const submitBtn   = document.querySelector('.write-btn-save');

            if (headerTitle) headerTitle.textContent = 'ê²Œì‹œê¸€ ìˆ˜ì •';
            if (submitBtn)   submitBtn.textContent   = 'ìˆ˜ì •';

            document.getElementById('category').value = post.category || 'ììœ ê²Œì‹œíŒ';
            document.getElementById('title').value    = post.title    || '';

            const quillEditor = Quill.find(document.querySelector('#editor-container'));
            if (quillEditor) {
                quillEditor.setText(post.content || '');
            }

            writeForm.dataset.postId = postId;
        } catch (e) {
            console.error(e);
            alert('âŒ ìˆ˜ì •í•  ê²Œì‹œê¸€ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
            window.location.href = '/community';
        }
    }

    // --- ì‘ì„±/ìˆ˜ì • ì œì¶œ ë¡œì§ ---
    const writeForm            = document.getElementById('write-form');
    const postContentHtmlInput = document.getElementById('post-content-html');
    const successMsg           = document.getElementById('post-success-message');
    const errorMsg             = document.getElementById('post-error-message');

    writeForm.addEventListener('submit', async function (e) {
        e.preventDefault();
        successMsg.style.display = 'none';
        errorMsg.style.display   = 'none';

        const accessToken = localStorage.getItem('accessToken');
        if (!accessToken) {
            alert('ë¡œê·¸ì¸ í›„ ê¸€ì„ ì‘ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
            localStorage.setItem('redirectAfterLogin', window.location.pathname);
            window.location.href = '/login';
            return;
        }

        const category    = document.getElementById('category').value;
        const title       = document.getElementById('title').value.trim();
        const quillEditor = Quill.find(document.querySelector('#editor-container'));
        const contentText = quillEditor.getText().trim();
        const imageInput  = document.getElementById('image');

        if (!title || contentText.length === 0) {
            errorMsg.textContent = 'âŒ ì œëª©ê³¼ ë‚´ìš©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.';
            errorMsg.style.display = 'block';
            return;
        }

        const isEdit = !!writeForm.dataset.postId;
        const postId = writeForm.dataset.postId;

        try {
            let res;

            if (isEdit) {
                // ìˆ˜ì •
                const updateDto = {
                    title:   title,
                    content: contentText
                };

                res = await fetch(`/api/community/posts/${postId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}`
                    },
                    body: JSON.stringify(updateDto)
                });
            } else {
                // ë“±ë¡
                const postDto = {
                    category: category,
                    title:    title,
                    content:  contentText
                };

                const formData = new FormData();
                formData.append(
                    'post',
                    new Blob([JSON.stringify(postDto)], { type: 'application/json' })
                );
                if (imageInput && imageInput.files[0]) {
                    formData.append('image', imageInput.files[0]);
                }

                res = await fetch('/api/community/posts', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    },
                    body: formData
                });
            }

            if (res.ok) {
                alert(isEdit ? 'ê²Œì‹œê¸€ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.' : 'ê²Œì‹œê¸€ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
                window.location.href = '/community';
            } else {
                const msg = await res.text();
                errorMsg.textContent = (isEdit ? 'ìˆ˜ì • ì‹¤íŒ¨: ' : 'ë“±ë¡ ì‹¤íŒ¨: ') + msg;
                errorMsg.style.display = 'block';
            }
        } catch (err) {
            console.error(err);
            errorMsg.textContent = isEdit
                ? 'ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'
                : 'ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
            errorMsg.style.display = 'block';
        }
    });
</script>
</body>
</html>
