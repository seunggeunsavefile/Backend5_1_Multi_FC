<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MULTI FC - ê²½ê¸° í›„ê¸° ì‘ì„±</title>

    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>

<div th:replace="~{fragments/header :: siteHeader}"></div>

<main class="login-page-main">
    <div class="main-wrapper">
        <div class="login-section">
            <div class="login-container">

                <h1 class="title-login">ê²½ê¸° í›„ê¸° ì‘ì„±</h1>
                <p style="margin-bottom: 25px; font-size: 15px; color: #555; line-height: 1.5;">
                    ê²½ê¸°ëŠ” ì–´ë– ì…¨ë‚˜ìš”? âš½ ê²½ê¸° ì†Œê°ê³¼ êµ¬ì¥ í”¼ë“œë°±ì„ ììœ ë¡­ê²Œ ë‚¨ê²¨ì£¼ì„¸ìš”.
                </p>

                <p id="review-success-message" class="info-message" style="display:none;"></p>
                <p id="review-error-message" class="error-message" style="display:none;"></p>

                <form id="review-form" style="display: none;">
                    <div class="input-group">
                        <label>í›„ê¸° ì‘ì„± ëŒ€ìƒ êµ¬ì¥</label>

                        <!-- âœ… ê¸°ì¡´ input â†’ select ë¡œ êµì²´ -->
                        <select id="pending-stadium-select"
                                style="background: #fff; width: 100%; padding: 12px; border: 1px solid #ddd;
                                       border-radius: 10px; font-size: 15px;">
                            <option value="">êµ¬ì¥ ì •ë³´ ë¡œë”© ì¤‘...</option>
                        </select>

                        <!-- âœ… ì„ íƒëœ stadiumId ì €ì¥ìš© hidden -->
                        <input type="hidden" id="stadium-id" name="stadiumId" th:value="${stadiumId}" value="">
                        <p id="selected-stadium-hint"
                           style="font-size:12px; color:#777; margin-top:6px;"></p>
                    </div>

                    <div class="input-group" style="margin-top: 20px;">
                        <label for="review-rating">í‰ì  (1~5)</label>
                        <input type="number" id="review-rating" name="rating" min="1" max="5" required
                               placeholder="êµ¬ì¥ í‰ì ì„ 1ì ì—ì„œ 5ì ê¹Œì§€ ì…ë ¥í•´ì£¼ì„¸ìš”."
                               style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; font-size: 15px; background: #f7f7f7;">
                    </div>

                    <div class="input-group" style="margin-top: 30px;">
                        <label for="review-content">ê²½ê¸° í•œì¤„í‰ì„ ì‘ì„±í•´ ì£¼ì„¸ìš”.</label>
                        <textarea id="review-content" name="content" rows="5"
                                  placeholder="ê²½ê¸° ì†Œê°ì´ë‚˜ êµ¬ì¥ í”¼ë“œë°± ë“±ì„ ë‚¨ê²¨ì£¼ì„¸ìš”."
                                  required
                                  style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; font-size: 15px; background: #f7f7f7; font-family: inherit; resize: vertical;"></textarea>
                    </div>

                    <button type="submit" class="login-button" style="margin-top: 25px;">í›„ê¸° ë“±ë¡</button>
                </form>

                <div id="access-denied-container"></div>
            </div>
        </div>
        <div class="background-image-section">
        </div>
    </div>
</main>

<script>
    document.addEventListener('DOMContentLoaded', async () => {
        const accessToken = localStorage.getItem('accessToken');
        const currentUserId = localStorage.getItem('userId');

        const urlParams = new URLSearchParams(window.location.search);
        const preferredStadiumId = urlParams.get('stadiumId')
            || document.getElementById('stadium-id').value;

        const reviewForm = document.getElementById('review-form');
        const selectEl = document.getElementById('pending-stadium-select');
        const hintEl = document.getElementById('selected-stadium-hint');
        const deniedContainer = document.getElementById('access-denied-container');

        const successMsg = document.getElementById('review-success-message');
        const errorMsg = document.getElementById('review-error-message');

        // =========================
        // 1. í—¤ë” ë‹‰ë„¤ì„ / ë¹¨ê°„ ë°°ì§€
        // =========================
        const userMenuName = document.getElementById('user-menu-username');
        if (userMenuName) {
            const nickname =
                localStorage.getItem('userNickname') ||
                localStorage.getItem('username') ||
                'íšŒì›';
            userMenuName.textContent = nickname;
        }

        if (accessToken) {
            if (typeof checkPendingReviews === 'function') {
                try { await checkPendingReviews(); } catch (e) { console.error(e); }
            }
            if (typeof checkUpcomingSchedules === 'function') {
                try { await checkUpcomingSchedules(); } catch (e) { console.error(e); }
            }
            if (typeof updateGlobalBadge === 'function') {
                try { updateGlobalBadge(); } catch (e) { console.error(e); }
            }
        }

        // =========================
        // 2. ë¡œê·¸ì¸ ì²´í¬
        // =========================
        if (!accessToken) {
            alert("ë¡œê·¸ì¸ì´ í•„ìš”í•œ í˜ì´ì§€ì…ë‹ˆë‹¤. ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.");
            window.location.href = '/login';
            return;
        }

        // =========================
        // 3. pending êµ¬ì¥ ëª©ë¡ ë¡œë”©
        // =========================
        reviewForm.style.display = 'block';

        try {
            // (1) pending stadiumId ëª©ë¡
            const pendingRes = await fetch(`/api/reviews/pending-stadiums?userId=${currentUserId}`);
            if (!pendingRes.ok) throw new Error("pending êµ¬ì¥ ì¡°íšŒ ì‹¤íŒ¨");
            const pendingIds = await pendingRes.json(); // [id, id, id...]

            if (!pendingIds || pendingIds.length === 0) {
                reviewForm.style.display = 'none';
                deniedContainer.innerHTML = `
                    <div class="access-denied-message">
                        <i class="fas fa-check-circle"></i>
                        ì‘ì„±í•´ì•¼ í•  í›„ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤! ğŸ‰
                        <p style="margin-top: 10px;"><a href="/">ë©”ì¸ í˜ì´ì§€ë¡œ ëŒì•„ê°€ê¸°</a></p>
                    </div>
                `;
                return;
            }

            // (2) êµ¬ì¥ ì „ì²´ ëª©ë¡
            const stadiumRes = await fetch('/api/stadiums');
            if (!stadiumRes.ok) throw new Error('êµ¬ì¥ ëª©ë¡ API í˜¸ì¶œ ì‹¤íŒ¨');
            const stadiums = await stadiumRes.json();

            // (3) select ì˜µì…˜ ì±„ìš°ê¸°
            selectEl.innerHTML = '';
            pendingIds.forEach(id => {
                const stadium = stadiums.find(s => String(s.stadiumId) === String(id));
                const opt = document.createElement('option');
                opt.value = id;

                if (stadium) {
                    const shortAddr = stadium.address && stadium.address.length > 15
                        ? stadium.address.substring(0, 15) + '...'
                        : (stadium.address || 'ì£¼ì†Œ ì—†ìŒ');
                    opt.textContent = `${stadium.name} êµ¬ì¥ (${shortAddr})`;
                } else {
                    opt.textContent = `êµ¬ì¥ ID: ${id}`;
                }

                selectEl.appendChild(opt);
            });

            // (4) ì•Œë¦¼/URLë¡œ ë„˜ì–´ì˜¨ stadiumIdê°€ pending ì•ˆì— ìˆìœ¼ë©´ ê¸°ë³¸ ì„ íƒ
            if (preferredStadiumId && pendingIds.map(String).includes(String(preferredStadiumId))) {
                selectEl.value = preferredStadiumId;
            }

            // (5) hidden stadium-id ë™ê¸°í™”
            document.getElementById('stadium-id').value = selectEl.value;
            hintEl.textContent = `ì„ íƒëœ êµ¬ì¥ ID: ${selectEl.value}`;

        } catch (e) {
            console.error("pending/êµ¬ì¥ ì •ë³´ ë¡œë“œ ì˜¤ë¥˜:", e);
            selectEl.innerHTML = `<option value="">âŒ êµ¬ì¥ ëª©ë¡ ë¡œë”© ì‹¤íŒ¨</option>`;
        }

        // âœ… ì„ íƒ ë³€ê²½ ì‹œ hidden ê°’ë„ ë³€ê²½
        selectEl.addEventListener('change', () => {
            document.getElementById('stadium-id').value = selectEl.value;
            hintEl.textContent = `ì„ íƒëœ êµ¬ì¥ ID: ${selectEl.value}`;
        });

        // =========================
        // 4. í›„ê¸° ë“±ë¡ ì²˜ë¦¬
        // =========================
        reviewForm.addEventListener('submit', async function (e) {
            e.preventDefault();
            successMsg.style.display = 'none';
            errorMsg.style.display = 'none';

            const content = document.getElementById('review-content').value.trim();
            const rating = document.getElementById('review-rating').value;
            const currentStadiumId = document.getElementById('stadium-id').value;

            if (!currentUserId || !currentStadiumId) {
                errorMsg.textContent = 'âŒ ì‚¬ìš©ì/êµ¬ì¥ ì •ë³´ê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
                errorMsg.style.display = 'block';
                return;
            }
            if (content === '' || !rating) {
                errorMsg.textContent = 'âŒ í‰ì ê³¼ ë‚´ìš©ì„ ëª¨ë‘ ì‘ì„±í•´ì£¼ì„¸ìš”.';
                errorMsg.style.display = 'block';
                return;
            }

            const reviewData = {
                stadiumId: Number(currentStadiumId),
                userId: Number(currentUserId),
                rating: Number(rating),
                content: content
            };

            try {
                const response = await fetch('/api/reviews', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(reviewData)
                });

                if (response.ok) {
                    successMsg.textContent =
                        'âœ… í›„ê¸°ê°€ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤. êµ¬ì¥ ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.';
                    successMsg.style.display = 'block';

                    // âœ… ì½ìŒ ì²˜ë¦¬
                    localStorage.setItem('hasReadReviews', 'true');

                    // âœ… pending ëª©ë¡ ì¬ë¡œë”© â†’ ë‹¤ìŒ êµ¬ì¥ ì„ íƒ ê°€ëŠ¥í•˜ê²Œ
                    setTimeout(async () => {
                        await location.reload();
                    }, 1200);

                } else {
                    const errorBody = await response.text();
                    console.error('ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜:', errorBody);

                    alert(`í›„ê¸° ë“±ë¡ ì‹¤íŒ¨: ${response.status} - ${errorBody.substring(0, 100)}...`);
                    errorMsg.textContent =
                        `âŒ í›„ê¸° ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. (${response.status}) ${errorBody}`;
                    errorMsg.style.display = 'block';
                }
            } catch (error) {
                console.error('API í†µì‹  ì‹¤íŒ¨', error);
                errorMsg.textContent = 'âŒ ì„œë²„ í†µì‹  ì¤‘ ì˜ˆìƒì¹˜ ëª»í•œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                errorMsg.style.display = 'block';
            }
        });
    });
</script>

</body>
</html>