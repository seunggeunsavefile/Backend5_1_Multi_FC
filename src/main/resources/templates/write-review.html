<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MULTI FC - 경기 후기 작성</title>

    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        /* 스타일 유지 */
        .login-page-main { min-height: 100vh; display: flex; align-items: center; justify-content: center; background-color: #f4f4f4; padding: 40px 20px; }
        .main-wrapper { max-width: 1000px; width: 100%; display: flex; background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .login-section { flex: 1; padding: 40px; }
        .background-image-section { flex: 1; background: url('https://placehold.co/500x700/6c5ce7/ffffff?text=Review') no-repeat center center/cover; }
        .login-container { max-width: 400px; margin: 0 auto; }
        .title-login { font-size: 30px; font-weight: 800; color: #333; margin-bottom: 20px; }
        .input-group label { display: block; font-weight: 700; color: #555; margin-bottom: 8px; font-size: 14px; }
        .input-group input, .input-group textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; font-size: 15px; box-sizing: border-box; background: #f7f7f7; }
        .login-button { width: 100%; padding: 15px; background-color: #6c5ce7; color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: 700; cursor: pointer; transition: background-color 0.3s; }
        .login-button:hover { background-color: #5d4bc5; }
        .error-message { color: #e74c3c; margin-top: 15px; font-weight: 700; font-size: 14px; padding: 10px; background: #fceae9; border-left: 5px solid #e74c3c; border-radius: 5px; display: none; }
        .info-message { color: #27ae60; margin-top: 15px; font-weight: 700; font-size: 14px; padding: 10px; background: #e9fcee; border-left: 5px solid #27ae60; border-radius: 5px; display: none; }
        /* ⭐⭐ 추가: 비활성화 메시지 스타일 ⭐⭐ */
        .access-denied-message {
            margin-top: 40px;
            padding: 20px;
            text-align: center;
            border: 2px dashed #e74c3c;
            color: #c0392b;
            font-weight: bold;
            border-radius: 10px;
        }
    </style>
</head>
<body>

<header class="quick-menu">
    <div class="logo"><a href="/">MULTI FC</a></div>
    <div class="header-icons">
        <button id="profile-menu-toggle" class="profile-icon" style="position: relative; display: none;"> <i class="fas fa-user-circle"></i>
            <span id="notification-badge" class="notification-badge"></span>
        </button>
        <button id="menu-toggle" class="menu-toggle-btn"><i class="fas fa-bars"></i></button>
    </div>
</header>
<main class="login-page-main">
    <div class="main-wrapper">
        <div class="login-section">
            <div class="login-container">

                <h1 class="title-login">경기 후기 작성</h1>
                <p style="margin-bottom: 25px; font-size: 15px; color: #555; line-height: 1.5;">
                    경기는 어떠셨나요? ⚽ 경기 소감과 구장 피드백을 자유롭게 남겨주세요.
                </p>

                <p id="review-success-message" class="info-message" style="display:none;"></p>
                <p id="review-error-message" class="error-message" style="display:none;"></p>

                <form id="review-form" style="display: none;">
                    <div class="input-group">
                        <label>후기 작성 대상 구장</label>
                        <input type="text" id="match-info" value="구장 정보 로딩 중..." disabled
                               style="background: #eee; cursor: not-allowed; width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; font-size: 15px; ">

                        <input type="hidden" id="stadium-id" name="stadiumId" th:value="${stadiumId}" value="">
                    </div>

                    <div class="input-group" style="margin-top: 20px;">
                        <label for="review-rating">평점 (1~5)</label>
                        <input type="number" id="review-rating" name="rating" min="1" max="5" required
                               placeholder="구장 평점을 1점에서 5점까지 입력해주세요."
                               style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; font-size: 15px; background: #f7f7f7;">
                    </div>

                    <div class="input-group" style="margin-top: 30px;">
                        <label for="review-content">경기 한줄평을 작성해 주세요.</label>
                        <textarea id="review-content" name="content" rows="5"
                                  placeholder="경기 소감이나 구장 피드백 등을 남겨주세요."
                                  required
                                  style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; font-size: 15px; background: #f7f7f7; font-family: inherit; resize: vertical;"></textarea>
                    </div>

                    <button type="submit" class="login-button" style="margin-top: 25px;">후기 등록</button>
                </form>

                <div id="access-denied-container"></div>
            </div>
        </div>
        <div class="background-image-section">
        </div>
    </div>
</main>

<script>
    // --- (★공통★) 메뉴 토글 및 로그아웃 로직 (유지) ---
    const menuToggle = document.getElementById('menu-toggle');
    const mainMenu = document.getElementById('main-menu');
    const profileMenuToggle = document.getElementById('profile-menu-toggle');
    const profileMenu = document.getElementById('profile-menu');
    const logoutButton = document.getElementById('logout-button');

    if (menuToggle) {
        menuToggle.addEventListener('click', () => {
            mainMenu.classList.toggle('show');
            profileMenu?.classList.remove('show');
        });
    }
    if (profileMenuToggle) {
        profileMenuToggle.addEventListener('click', () => {
            profileMenu.classList.toggle('show');
            mainMenu?.classList.remove('show');
        });
    }
    if (logoutButton) {
        logoutButton.addEventListener('click', (e) => {
            e.preventDefault();
            localStorage.clear();
            window.location.href = '/login';
        });
    }

    // --- (★페이지별★) 후기 등록 및 구장 정보 로딩 로직 ---
    document.addEventListener('DOMContentLoaded', async () => {
        const accessToken = localStorage.getItem('accessToken');
        const profileIcon = document.getElementById('profile-menu-toggle');
        const urlParams = new URLSearchParams(window.location.search);

        let stadiumId = urlParams.get('stadiumId') || document.getElementById('stadium-id').value;

        const currentUserId = localStorage.getItem('userId');
        const reviewForm = document.getElementById('review-form');
        const matchInfoInput = document.getElementById('match-info');
        const deniedContainer = document.getElementById('access-denied-container');

        if (!accessToken) {
            alert("로그인이 필요한 페이지입니다. 로그인 페이지로 이동합니다.");
            window.location.href = '/login';
            return;
        } else {
            if (profileIcon) profileIcon.style.display = 'block';
        }

        // ⭐⭐ [핵심 수정] URL 파라미터 검증 로직 추가 ⭐⭐
        if (!stadiumId) {
            deniedContainer.innerHTML = `
                <div class="access-denied-message">
                    <i class="fas fa-exclamation-triangle"></i>
                    후기 작성은 **경기를 완료한 후** 메인 페이지의 알림을 통해서만 가능합니다.<br>
                    직접 접근할 수 없습니다.
                    <p style="margin-top: 10px;"><a href="/">메인 페이지로 돌아가기</a></p>
                </div>
            `;
            reviewForm.style.display = 'none';
            return;
        }


        // 2. 구장 ID 처리 및 정보 로드 (stadiumId가 있을 때만 실행)
        if (stadiumId) {
            reviewForm.style.display = 'block'; // 폼 표시
            document.getElementById('stadium-id').value = stadiumId;

            try {
                const stadiumRes = await fetch('/api/stadiums');

                if (!stadiumRes.ok) throw new Error('구장 목록 API 호출 실패');

                const stadiums = await stadiumRes.json();
                const stadium = stadiums.find(s => s.stadiumId == stadiumId);

                if (stadium) {
                    matchInfoInput.value = `${stadium.name} 구장 (${stadium.address.substring(0, 15)}...)`;
                } else {
                    matchInfoInput.value = `❌ 오류: 구장 ID ${stadiumId}의 정보를 찾을 수 없습니다.`;
                }
            } catch (e) {
                console.error("구장 정보 로드 오류:", e);
                matchInfoInput.value = `❌ 구장 정보 로드 중 오류 발생. (서버 API 점검 필요)`;
            }

        } else {
            // (위에서 이미 처리되었지만 안전을 위해)
            matchInfoInput.value = '❌ 오류: 구장 ID 파라미터를 찾을 수 없습니다.';
        }


        // ⭐ 폼 제출 이벤트 리스너 (실제 API 호출)
        const successMsg = document.getElementById('review-success-message');
        const errorMsg = document.getElementById('review-error-message');

        reviewForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            successMsg.style.display = 'none';
            errorMsg.style.display = 'none';

            const content = document.getElementById('review-content').value.trim();
            const rating = document.getElementById('review-rating').value;
            const currentStadiumId = document.getElementById('stadium-id').value;

            if (!currentUserId || !currentStadiumId) {
                errorMsg.textContent = '❌ 사용자/구장 정보가 유효하지 않습니다.';
                errorMsg.style.display = 'block';
                return;
            }
            if (content === '' || !rating) {
                errorMsg.textContent = '❌ 평점과 내용을 모두 작성해주세요.';
                errorMsg.style.display = 'block';
                return;
            }

            const reviewData = {
                stadiumId: Number(currentStadiumId),
                userId: Number(currentUserId),
                rating: Number(rating),
                content: content
            };

            try {
                const response = await fetch('/api/reviews', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(reviewData)
                });

                if (response.ok) {
                    successMsg.textContent = '✅ 후기가 성공적으로 등록되었습니다. 구장 상세 페이지로 이동합니다.';
                    successMsg.style.display = 'block';

                    localStorage.setItem('hasReadReviews', 'true');

                    setTimeout(() => {
                        window.location.href = `/stadium/detail?id=${currentStadiumId}`;
                    }, 2000);
                } else {
                    const errorBody = await response.text();
                    console.error('서버 응답 오류:', errorBody);
                    // 서버에서 발생한 SecurityException 메시지를 사용자에게 보여줍니다.
                    alert(`후기 등록 실패: ${response.status} - ${errorBody.substring(0, 100)}...`);
                    errorMsg.textContent = `❌ 후기 등록 중 오류가 발생했습니다. (${response.status}) ${errorBody}`;
                    errorMsg.style.display = 'block';
                }

            } catch (error) {
                console.error('API 통신 실패', error);
                errorMsg.textContent = '❌ 서버 통신 중 예상치 못한 오류가 발생했습니다.';
                errorMsg.style.display = 'block';
            }
        });
    });
</script>
</body>
</html>