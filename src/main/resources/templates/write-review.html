<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MULTI FC - 경기 후기 작성</title>

    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>

<div th:replace="~{fragments/header :: siteHeader}"></div>

<main class="login-page-main">
    <div class="main-wrapper">
        <div class="login-section">
            <div class="login-container">

                <h1 class="title-login">경기 후기 작성</h1>
                <p style="margin-bottom: 25px; font-size: 15px; color: #555; line-height: 1.5;">
                    경기는 어떠셨나요? ⚽ 경기 소감과 구장 피드백을 자유롭게 남겨주세요.
                </p>

                <p id="review-success-message" class="info-message" style="display:none;"></p>
                <p id="review-error-message" class="error-message" style="display:none;"></p>

                <form id="review-form" style="display: none;">
                    <div class="input-group">
                        <label>후기 작성 대상 구장</label>
                        <input type="text" id="match-info" value="구장 정보 로딩 중..." disabled
                               style="background: #eee; cursor: not-allowed; width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; font-size: 15px; ">

                        <input type="hidden" id="stadium-id" name="stadiumId" th:value="${stadiumId}" value="">
                    </div>

                    <div class="input-group" style="margin-top: 20px;">
                        <label for="review-rating">평점 (1~5)</label>
                        <input type="number" id="review-rating" name="rating" min="1" max="5" required
                               placeholder="구장 평점을 1점에서 5점까지 입력해주세요."
                               style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; font-size: 15px; background: #f7f7f7;">
                    </div>

                    <div class="input-group" style="margin-top: 30px;">
                        <label for="review-content">경기 한줄평을 작성해 주세요.</label>
                        <textarea id="review-content" name="content" rows="5"
                                  placeholder="경기 소감이나 구장 피드백 등을 남겨주세요."
                                  required
                                  style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; font-size: 15px; background: #f7f7f7; font-family: inherit; resize: vertical;"></textarea>
                    </div>

                    <button type="submit" class="login-button" style="margin-top: 25px;">후기 등록</button>
                </form>

                <div id="access-denied-container"></div>
            </div>
        </div>
        <div class="background-image-section">
        </div>
    </div>
</main>

<script>
    document.addEventListener('DOMContentLoaded', async () => {
        const accessToken = localStorage.getItem('accessToken');
        const currentUserId = localStorage.getItem('userId');

        const urlParams = new URLSearchParams(window.location.search);
        let stadiumId = urlParams.get('stadiumId') || document.getElementById('stadium-id').value;

        const reviewForm = document.getElementById('review-form');
        const matchInfoInput = document.getElementById('match-info');
        const deniedContainer = document.getElementById('access-denied-container');

        const successMsg = document.getElementById('review-success-message');
        const errorMsg = document.getElementById('review-error-message');

        // =========================
        // 1. 헤더 닉네임 / 빨간 배지
        // =========================
        const userMenuName = document.getElementById('user-menu-username');
        if (userMenuName) {
            const nickname =
                localStorage.getItem('userNickname') ||
                localStorage.getItem('username') ||
                '회원';
            userMenuName.textContent = nickname;
        }

        // 공통 알림 함수가 있는 경우만 호출 → 빨간 배지 갱신
        if (accessToken) {
            if (typeof checkPendingReviews === 'function') {
                try { await checkPendingReviews(); } catch (e) { console.error(e); }
            }
            if (typeof checkUpcomingSchedules === 'function') {
                try { await checkUpcomingSchedules(); } catch (e) { console.error(e); }
            }
            if (typeof updateGlobalBadge === 'function') {
                try { updateGlobalBadge(); } catch (e) { console.error(e); }
            }
        }

        // =========================
        // 2. 로그인 체크
        // =========================
        if (!accessToken) {
            alert("로그인이 필요한 페이지입니다. 로그인 페이지로 이동합니다.");
            window.location.href = '/login';
            return;
        }

        // =========================
        // 3. stadiumId 검증
        // =========================
        if (!stadiumId) {
            reviewForm.style.display = 'none';
            deniedContainer.innerHTML = `
                <div class="access-denied-message">
                    <i class="fas fa-exclamation-triangle"></i>
                    후기 작성은 <strong>경기를 완료한 후</strong> 메인 페이지의 알림을 통해서만 가능합니다.<br>
                    직접 URL로 접근할 수 없습니다.
                    <p style="margin-top: 10px;"><a href="/">메인 페이지로 돌아가기</a></p>
                </div>
            `;
            return;
        }

        // =========================
        // 4. 구장 정보 로딩
        // =========================
        reviewForm.style.display = 'block';
        document.getElementById('stadium-id').value = stadiumId;

        try {
            const stadiumRes = await fetch('/api/stadiums');
            if (!stadiumRes.ok) throw new Error('구장 목록 API 호출 실패');

            const stadiums = await stadiumRes.json();
            const stadium = stadiums.find(s => s.stadiumId == stadiumId);

            if (stadium) {
                const shortAddr = stadium.address && stadium.address.length > 15
                    ? stadium.address.substring(0, 15) + '...'
                    : stadium.address;
                matchInfoInput.value = `${stadium.name} 구장 (${shortAddr})`;
            } else {
                matchInfoInput.value = `❌ 오류: 구장 ID ${stadiumId}의 정보를 찾을 수 없습니다.`;
            }
        } catch (e) {
            console.error("구장 정보 로드 오류:", e);
            matchInfoInput.value = `❌ 구장 정보 로드 중 오류 발생. (서버 API 점검 필요)`;
        }

        // =========================
        // 5. 후기 등록 처리
        // =========================
        reviewForm.addEventListener('submit', async function (e) {
            e.preventDefault();
            successMsg.style.display = 'none';
            errorMsg.style.display = 'none';

            const content = document.getElementById('review-content').value.trim();
            const rating = document.getElementById('review-rating').value;
            const currentStadiumId = document.getElementById('stadium-id').value;

            if (!currentUserId || !currentStadiumId) {
                errorMsg.textContent = '❌ 사용자/구장 정보가 유효하지 않습니다.';
                errorMsg.style.display = 'block';
                return;
            }
            if (content === '' || !rating) {
                errorMsg.textContent = '❌ 평점과 내용을 모두 작성해주세요.';
                errorMsg.style.display = 'block';
                return;
            }

            const reviewData = {
                stadiumId: Number(currentStadiumId),
                userId: Number(currentUserId),
                rating: Number(rating),
                content: content
            };

            try {
                const response = await fetch('/api/reviews', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(reviewData)
                });

                if (response.ok) {
                    successMsg.textContent =
                        '✅ 후기가 성공적으로 등록되었습니다. 구장 상세 페이지로 이동합니다.';
                    successMsg.style.display = 'block';

                    localStorage.setItem('hasReadReviews', 'true');

                    setTimeout(() => {
                        window.location.href = `/stadium/detail?id=${currentStadiumId}`;
                    }, 2000);
                } else {
                    const errorBody = await response.text();
                    console.error('서버 응답 오류:', errorBody);

                    alert(`후기 등록 실패: ${response.status} - ${errorBody.substring(0, 100)}...`);
                    errorMsg.textContent =
                        `❌ 후기 등록 중 오류가 발생했습니다. (${response.status}) ${errorBody}`;
                    errorMsg.style.display = 'block';
                }
            } catch (error) {
                console.error('API 통신 실패', error);
                errorMsg.textContent = '❌ 서버 통신 중 예상치 못한 오류가 발생했습니다.';
                errorMsg.style.display = 'block';
            }
        });
    });
</script>

</body>
</html>