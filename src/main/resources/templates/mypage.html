<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi FC - ë§ˆì´í˜ì´ì§€</title>

    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&family=Noto+Sans+KR:wght[400;700]&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

</head>
<body class="mypage-page">

<header class="quick-menu">
    <div class="logo"><a href="/">Multi FC</a></div>
    <div class="header-icons">
        <button id="profile-menu-toggle" class="profile-icon" style="position: relative; display: none;">
            <i class="fas fa-user-circle"></i>
            <span id="notification-badge" class="notification-badge" style="display: none;"></span>
        </button>
        <button id="menu-toggle" class="menu-toggle-btn"><i class="fas fa-bars"></i></button>
    </div>

    <div id="profile-menu" class="mypage-user-menu">
        <div class="user-info">
            <strong><span id="user-menu-username">ì‚¬ìš©ì</span>ë‹˜</strong>
            <p>í™˜ì˜í•©ë‹ˆë‹¤!</p>
        </div>
        <ul>
            <li><a href="/notifications" id="nav-notifications-link"><i class="fas fa-bell"></i> ì•Œë¦¼ ëª©ë¡</a></li>
            <li><a href="/mypage"><i class="fas fa-user"></i> ë§ˆì´í˜ì´ì§€</a></li>
            <li><a href="/profile/edit"><i class="fas fa-user-edit"></i> í”„ë¡œí•„ ìˆ˜ì •</a></li>
            <li><a href="#" id="logout-button"><i class="fas fa-sign-out-alt"></i> ë¡œê·¸ì•„ì›ƒ</a></li>
        </ul>
    </div>

    <nav id="main-menu" class="main-menu">
        <ul>
            <li><a href="/"><i class="fas fa-home"></i> ë©”ì¸ (Home)</a></li>
            <li><a href="/fields"><i class="fas fa-search"></i> êµ¬ì¥ê²€ìƒ‰</a></li>
            <li><a href="/community"><i class="fas fa-users"></i> ì»¤ë®¤ë‹ˆí‹°</a></li>
            <li><a href="/chat"><i class="fas fa-comments"></i> ì‹¤ì‹œê°„ì±„íŒ…</a></li>
        </ul>
    </nav>
</header>

<main class="login-page-main">
    <div class="main-wrapper">
        <div class="main-section" id="full-width-section">
            <div class="login-container">
                <h1 class="title-login">ë§ˆì´í˜ì´ì§€</h1>

                <div class="tab-buttons">
                    <button class="tab-btn active" data-tab="tab-info">íšŒì›ì •ë³´</button>
                    <button class="tab-btn" data-tab="tab-calendar">ìº˜ë¦°ë”</button>
                    <button class="tab-btn" data-tab="tab-friends">ì¹œêµ¬ ê´€ë¦¬</button>
                </div>

                <div id="day-schedule-popup" style="display: none;"></div>

                <div id="tab-info" class="tab-content active">
                    <h3 style="font-size: 24px; color: #2c3e50; margin-top: 20px; margin-bottom: 25px;">íšŒì›ì •ë³´ í™•ì¸</h3>

                    <div style="text-align: center; margin-bottom: 15px;">
                        <img id="profile-preview-view" th:src="@{/images/default-profile.png}" alt="í”„ë¡œí•„ ì‚¬ì§„" class="info-view-profile-pic">
                    </div>

                    <div class="score-display">
                        <div class="score-item">
                            <span class="icon-box"><i class="fas fa-running"></i></span>
                            ì‹¤ë ¥ ë ˆë²¨
                            <strong id="view-skill-level">ì¤‘ê¸‰</strong>
                        </div>
                        <div class="score-item">
                            <span class="icon-box"><i class="fas fa-crosshairs"></i></span>
                            í¬ì§€ì…˜
                            <strong id="view-position-score">í”½ì†Œ (FIXO)</strong>
                        </div>
                    </div>

                    <div class="info-view-group">
                        <label>ì´ë©”ì¼</label>
                        <div id="view-email" class="info-view-text">...</div>
                    </div>

                    <div class="info-view-group">
                        <label>ì•„ì´ë””</label>
                        <div id="view-username" class="info-view-text">...</div>
                    </div>

                    <div class="info-view-group">
                        <label>ë‹‰ë„¤ì„</label>
                        <div id="view-nickname" class="info-view-text">...</div>
                    </div>

                    <div class="info-view-group">
                        <label>ì£¼ì†Œ</label>
                        <div id="view-address" class="info-view-text">...</div>
                    </div>

                    <div style="text-align: center; margin-top: 30px;">
                        <a href="/profile/edit" id="edit-profile-button" class="login-button" style="text-decoration: none; padding: 12px 30px; font-size: 16px; width: auto; background: #6c5ce7; border-radius: 8px; box-shadow: 0 4px 10px rgba(108, 92, 231, 0.3);">
                            <i class="fas fa-edit" style="margin-right: 5px;"></i> íšŒì›ì •ë³´ ìˆ˜ì •í•˜ê¸°
                        </a>
                    </div>
                </div>

                <div id="tab-calendar" class="tab-content">
                    <h3 style="font-size: 24px; color: #2c3e50; margin-top: 20px; margin-bottom: 20px;">ë‚´ ì¼ì •</h3>

                    <div class="calendar-layout-wrapper">
                        <div class="calendar-container">
                            <div class="calendar-header">
                                <nav class="calendar-nav">
                                    <button id="prev-month">&lt;</button>
                                </nav>
                                <h2 id="current-month-year">2025ë…„ 10ì›”</h2>
                                <nav class="calendar-nav">
                                    <button id="next-month">&gt;</button>
                                </nav>
                            </div>
                            <div class="calendar-grid" id="calendar-days-header">
                                <div class="calendar-header-cell">ì¼</div>
                                <div class="calendar-header-cell">ì›”</div>
                                <div class="calendar-header-cell">í™”</div>
                                <div class="calendar-header-cell">ìˆ˜</div>
                                <div class="calendar-header-cell">ëª©</div>
                                <div class="calendar-header-cell">ê¸ˆ</div>
                                <div class="calendar-header-cell">í† </div>
                            </div>
                            <div class="calendar-grid" id="calendar-days-grid"></div>
                        </div>

                        <div id="fixed-schedule-detail">
                            <button id="close-detail-btn">&times;</button>
                            <h3 id="detail-current-date" style="font-size: 16px; border-bottom: 1px solid #f0f0f0; padding-bottom: 8px; margin-bottom: 10px;">11ì›” 05ì¼ ì¼ì •</h3>

                            <ul class="fixed-schedule-list" id="fixed-schedule-list" style="list-style: none; padding: 0; margin-bottom: 15px; max-height: 200px; overflow-y: auto;"></ul>

                            <h3 id="new-schedule-title" style="font-size: 16px; margin-top: 15px; font-weight: 700; display: none;">ìƒˆ ê°œì¸ ì¼ì • ë“±ë¡</h3>
                            <h3 id="personal-schedule-title" style="font-size: 16px; margin-top: 15px; font-weight: 700;">ê°œì¸ ì¼ì • ìƒì„¸ ì •ë³´</h3>

                            <div id="fixed-detail-edit-area">
                                <input type="hidden" id="selected-schedule-id">
                                <input type="time" id="selected-schedule-time" style="width: 100%; padding: 8px; margin-bottom: 8px; border: 1px solid #ddd; display: none;">
                                <input type="text" id="selected-schedule-name" placeholder="ì¼ì •ëª…" disabled style="width: 100%; padding: 8px; margin-bottom: 8px; border: 1px solid #ddd;">
                                <textarea id="selected-schedule-content" rows="4" placeholder="ì„¸ë¶€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”." disabled style="width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ddd;"></textarea>

                                <div style="text-align: right;">
                                    <button id="save-schedule-btn" disabled style="padding: 8px 15px; margin-left: 10px; background-color: #ccc; color: white; border: none; border-radius: 5px;">ì €ì¥</button>
                                    <button id="delete-schedule-btn" disabled style="padding: 8px 15px; background-color: #ccc; color: white; border: none; border-radius: 5px;">ì‚­ì œ</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="tab-friends" class="tab-content">
                    <div class="friends-management-title-wrapper">
                        <h3>ì¹œêµ¬ ê´€ë¦¬</h3>
                        <!-- ğŸ”„ ë§í¬ ëŒ€ì‹  ëª¨ë‹¬ ì—´ê¸° ë²„íŠ¼ìœ¼ë¡œ ë³€ê²½ -->
                        <button class="friends-add-icon-btn" id="open-friend-add-modal" type="button">
                            <i class="fas fa-user-plus"></i>
                        </button>
                    </div>

                    <div class="tab-buttons sub-tabs">
                        <button class="sub-tab-btn active" data-sub-tab="sub-tab-friend-list">ì¹œêµ¬ ëª©ë¡</button>
                        <button class="sub-tab-btn" data-sub-tab="sub-tab-friend-add">ì¹œêµ¬ ìš”ì²­</button>
                    </div>

                    <div id="sub-tab-friend-list" class="sub-tab-content active">
                        <p style="font-size: 14px; color: #6c5ce7; font-weight: 600; text-align: right; margin-bottom: 15px;">
                            ì´ <span id="friend-count-display">0</span>ëª…
                        </p>

                        <div class="friend-list-search-group">
                            <input type="text" id="friend-list-search-input" placeholder="ì¹œêµ¬ ë‹‰ë„¤ì„ ê²€ìƒ‰">
                            <button onclick="searchFriendList()">ê²€ìƒ‰</button>
                        </div>

                        <ul id="friend-list" class="friend-item-list"></ul>
                        <p id="no-friends-message" style="color: #777; text-align: center; padding: 20px; display: none;">
                            ë“±ë¡ëœ ì¹œêµ¬ê°€ ì—†ìŠµë‹ˆë‹¤. 'ì¹œêµ¬ ìš”ì²­' íƒ­ì—ì„œ ìš”ì²­ì„ í™•ì¸í•˜ì„¸ìš”.
                        </p>
                    </div>

                    <div id="sub-tab-friend-add" class="sub-tab-content">
                        <ul id="friend-add-search-results" class="friend-item-list"></ul>

                        <div id="friend-request-message" style="border: 1px dashed #ddd; border-radius: 8px; padding: 15px; min-height: 100px; text-align: center; display: none; margin-top: 20px;">
                            <p style="color: #999;">ìƒˆë¡œìš´ ì¹œêµ¬ ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<!-- âœ… ì¹œêµ¬ ì¶”ê°€ ëª¨ë‹¬ -->
<div id="friend-add-modal-overlay" class="friend-add-modal-overlay">
    <div class="friend-add-modal" id="friend-add-modal">
        <div class="friend-add-modal-header">
            <h2>ì¹œêµ¬ ì¶”ê°€</h2>
            <button type="button" class="friend-add-modal-close" id="friend-add-modal-close">&times;</button>
        </div>

        <div class="friend-add-search-group">
            <div class="search-input-wrapper">
                <i class="fas fa-search search-icon"></i>
                <input type="text" id="friend-modal-search-input" placeholder="ì¹œêµ¬ ì•„ì´ë”” ë˜ëŠ” ë‹‰ë„¤ì„ ê²€ìƒ‰">
            </div>
            <button type="button" id="friend-modal-search-btn">ê²€ìƒ‰</button>
        </div>

        <div class="friend-add-search-results" id="friend-modal-search-results">
            <!-- JSë¡œ ì±„ì›€ -->
        </div>

        <p style="margin-top: 10px; font-size: 13px; color: #888;">
            * ì´ë¯¸ ì¹œêµ¬ì¸ ì‚¬ìš©ìëŠ” 'ì¹œêµ¬' ìƒíƒœë¡œ í‘œì‹œë©ë‹ˆë‹¤.
        </p>
    </div>
</div>

<script>
    // ë©”ë‰´ í† ê¸€ & ë¡œê·¸ì•„ì›ƒ
    const menuToggle = document.getElementById('menu-toggle');
    const mainMenu = document.getElementById('main-menu');
    const profileMenuToggle = document.getElementById('profile-menu-toggle');
    const profileMenu = document.getElementById('profile-menu');
    const logoutButton = document.getElementById('logout-button');

    if (menuToggle) {
        menuToggle.addEventListener('click', (e) => {
            e.stopPropagation();
            mainMenu.classList.toggle('show');
            if (profileMenu) profileMenu.classList.remove('show');
        });
    }
    if (profileMenuToggle) {
        profileMenuToggle.addEventListener('click', (e) => {
            e.stopPropagation();
            if (profileMenu) profileMenu.classList.toggle('show');
            if (mainMenu) mainMenu.classList.remove('show');
        });
    }
    document.addEventListener('click', (e) => {
        if (!mainMenu.contains(e.target) && !menuToggle.contains(e.target)) mainMenu.classList.remove('show');
        if (!profileMenu.contains(e.target) && !profileMenuToggle.contains(e.target)) profileMenu.classList.remove('show');
    });
    if (logoutButton) {
        logoutButton.addEventListener('click', (e) => {
            e.preventDefault();
            localStorage.removeItem('accessToken');
            localStorage.removeItem('username');
            window.location.href = '/login';
        });
    }

    // 25-11-18 ì¶”ê°€
    function formatToHHMM(timeStr) {
        if (!timeStr) return '';
        const parts = timeStr.split(':'); // ["HH","mm","ss"]
        if (parts.length >= 2) {
            return parts[0].padStart(2, '0') + ':' + parts[1].padStart(2, '0');
        }
        return timeStr; // ì´ë¯¸ HH:mm ì´ê±°ë‚˜ ë‹¤ë¥¸ í˜•ì‹ì´ë©´ ê·¸ëŒ€ë¡œ
    }


    // ì•Œë¦¼ ë°°ì§€
    const badge = document.getElementById('notification-badge');
    let hasReviewNotif = false;
    let hasScheduleNotif = false;
    function updateGlobalBadge() {
        if (badge) {
            badge.style.display = (hasReviewNotif || hasScheduleNotif) ? 'block' : 'none';
        }
    }
    async function checkPendingReviews() {
        await new Promise(r => setTimeout(r, 200));
        hasReviewNotif = localStorage.getItem('hasReadReviews') !== 'true';
    }
    async function checkUpcomingSchedules() {
        await new Promise(r => setTimeout(r, 500));
        hasScheduleNotif = true;
    }


    // ========== ë¡œê·¸ì¸í•œ ì‚¬ìš©ì ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸° ==========
    async function loadUserInfo() {
        const token = localStorage.getItem('accessToken');

        if (!token) {
            alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
            window.location.href = '/login';
            return;
        }

        try {
            const response = await fetch('/api/mypage/me', {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (response.ok) {
                const user = await response.json();
                console.log('ì‚¬ìš©ì ì •ë³´:', user);

                // íšŒì›ì •ë³´ íƒ­ì— ë°ì´í„° í‘œì‹œ
                document.getElementById('view-email').textContent = user.email || 'ì •ë³´ ì—†ìŒ';
                document.getElementById('view-username').textContent = user.username || 'ì •ë³´ ì—†ìŒ';
                document.getElementById('view-nickname').textContent = user.nickname || 'ì •ë³´ ì—†ìŒ';
                document.getElementById('view-address').textContent = user.address || 'ì •ë³´ ì—†ìŒ';
                document.getElementById('view-skill-level').textContent = user.level || 'ì •ë³´ ì—†ìŒ';
                document.getElementById('view-position-score').textContent = user.position || 'ì •ë³´ ì—†ìŒ';
                localStorage.setItem('username', user.nickname || user.username);

                // í”„ë¡œí•„ ì´ë¯¸ì§€ í‘œì‹œ
                if (user.profileImage) {
                    document.getElementById('profile-preview-view').src = user.profileImage;
                }

                // ìƒë‹¨ ë©”ë‰´ì˜ ì‚¬ìš©ì ì´ë¦„ í‘œì‹œ
                document.getElementById('user-menu-username').textContent = user.nickname || user.username;

            } else if (response.status === 401 || response.status === 404) {
                alert('ë¡œê·¸ì¸ ì •ë³´ê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
                localStorage.removeItem('accessToken');
                localStorage.removeItem('username');
                window.location.href = '/login';
            } else {
                console.error('ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨:', response.status);
                alert('ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        } catch (error) {
            console.error('ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜:', error);
            alert('ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    }

    // ìº˜ë¦°ë”
    const monthYearElement = document.getElementById('current-month-year');
    const daysGrid = document.getElementById('calendar-days-grid');
    const prevMonthBtn = document.getElementById('prev-month');
    const nextMonthBtn = document.getElementById('next-month');

    const fixedDetailWindow = document.getElementById('fixed-schedule-detail');
    const detailList = document.getElementById('fixed-schedule-list');
    const detailDateTitle = document.getElementById('detail-current-date');
    const saveBtn = document.getElementById('save-schedule-btn');
    const deleteBtn = document.getElementById('delete-schedule-btn');
    const scheduleNameInput = document.getElementById('selected-schedule-name');
    const scheduleContentInput = document.getElementById('selected-schedule-content');
    const selectedScheduleIdInput = document.getElementById('selected-schedule-id');
    const closeDetailBtn = document.getElementById('close-detail-btn');
    const scheduleTimeInput = document.getElementById('selected-schedule-time');
    const newScheduleTitle = document.getElementById('new-schedule-title');
    const personalScheduleTitle = document.getElementById('personal-schedule-title');

    let currentDate = new Date();
    currentDate.setDate(1);


    // âœ… ìˆ˜ì •ëœ ë²„ì „: ì´ì œ personalSchedulesë§Œ ì‚¬ìš©
    function loadSchedulesFromStorage() {
        const personalData = JSON.parse(localStorage.getItem("personalSchedules")) || [];

        const schedules = personalData.map(p => {
            const dateObj = new Date(p.date || "2025-11-01T00:00:00");

            return {
                id: p.id,
                year: dateObj.getFullYear(),
                month: dateObj.getMonth(), // 0ë¶€í„° ì‹œì‘
                day: dateObj.getDate(),
                time: (p.time || "").split("~")[0].trim(),
                type: p.type || 'personal', // match / personal ë‘˜ ë‹¤ ì²˜ë¦¬
                title: p.title || (p.type === 'match' ? "ê²½ê¸° ì¼ì •" : "ê°œì¸ ì¼ì •"),
                detail: p.detail || "",
                matchId: p.matchId ?? null
            };
        });

        MOCK_SCHEDULES = schedules;
    }

    async function openDaySchedule(day, event) {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth(); // 0-based
        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;

        await reloadDaySchedulesFromServer(dateStr);

        const schedulesToday = MOCK_SCHEDULES
            .filter(s => s.year === year && s.month === month && s.day === day)
            .sort((a, b) => a.time.localeCompare(b.time));

        detailDateTitle.textContent = `${month + 1}ì›” ${day}ì¼ ì¼ì •`;
        detailList.innerHTML = '';
        fixedDetailWindow.dataset.selectedDate = `${year}-${month + 1}-${day}`;

        if (schedulesToday.length > 0) {
            personalScheduleTitle.style.display = 'block';
            newScheduleTitle.style.display = 'none';
            scheduleTimeInput.style.display = 'none';

            // 25-11-18 ìˆ˜ì •
            schedulesToday.forEach(schedule => {
                const li = document.createElement('li');
                const eventClass = schedule.type === 'match' ? 'match-schedule' : 'personal-schedule';
                li.className = eventClass;
                li.dataset.scheduleId = schedule.id;
                const displayTime = formatToHHMM(schedule.time);
                li.innerHTML = `<span style="font-weight: 700;">${displayTime}</span> ${schedule.title}`;
                li.onclick = (e) => bindScheduleToDetail(e, schedule);
                detailList.appendChild(li);
            });

            const addNewBtn = document.createElement('button');
            addNewBtn.textContent = '+ ìƒˆ ê°œì¸ ì¼ì • ë“±ë¡';
            addNewBtn.style.marginTop = '10px';
            addNewBtn.style.padding = '8px 12px';
            addNewBtn.style.backgroundColor = '#2ecc71';
            addNewBtn.style.color = 'white';
            addNewBtn.style.border = 'none';
            addNewBtn.style.borderRadius = '6px';
            addNewBtn.style.cursor = 'pointer';
            addNewBtn.style.width = '100%';
            addNewBtn.onclick = (e) => {
                e.stopPropagation();
                setNewScheduleMode();
            };
            detailList.appendChild(addNewBtn);

            clearDetailEditArea();
        } else {
            personalScheduleTitle.style.display = 'none';
            newScheduleTitle.style.display = 'block';
            setNewScheduleMode();
        }

        fixedDetailWindow.style.display = 'block';

        if (event && event.stopPropagation) {
            event.stopPropagation();
        }
    }

    function setNewScheduleMode() {
        detailList.innerHTML = '<li style="color: #6c5ce7; text-align: center; padding: 10px;">ìƒˆ ì¼ì •ì„ ë“±ë¡í•˜ì„¸ìš”.</li>';
        scheduleNameInput.value = '';
        scheduleContentInput.value = '';
        selectedScheduleIdInput.value = '';
        scheduleTimeInput.value = '';
        scheduleTimeInput.style.display = 'block';

        saveBtn.disabled = false;
        saveBtn.textContent = "ë“±ë¡";
        saveBtn.style.backgroundColor = 'rgba(46, 204, 113, 0.85)';
        saveBtn.setAttribute('data-mode', 'add');
        deleteBtn.style.display = 'none';

        scheduleNameInput.disabled = false;
        scheduleContentInput.disabled = false;
        scheduleTimeInput.disabled = false;
        scheduleNameInput.placeholder = "ì¼ì •ëª… (í•„ìˆ˜)";
        scheduleContentInput.placeholder = "ì„¸ë¶€ ë‚´ìš© (ì„ íƒ)";

        const existingSummary = document.getElementById('match-summary');
        if (existingSummary) existingSummary.remove();
    }

    function clearDetailEditArea() {
        scheduleNameInput.value = '';
        scheduleContentInput.value = '';
        selectedScheduleIdInput.value = '';

        personalScheduleTitle.style.display = 'block';
        newScheduleTitle.style.display = 'none';
        scheduleTimeInput.style.display = 'none';

        saveBtn.disabled = true;
        saveBtn.textContent = "ì €ì¥";
        saveBtn.style.backgroundColor = 'rgba(204, 204, 204, 0.7)';
        saveBtn.setAttribute('data-mode', 'edit');
        deleteBtn.style.display = 'inline-block';
        deleteBtn.disabled = true;
        deleteBtn.style.backgroundColor = 'rgba(204, 204, 204, 0.7)';

        scheduleNameInput.disabled = true;
        scheduleContentInput.disabled = true;
        scheduleTimeInput.disabled = true;
        scheduleNameInput.placeholder = "ì¼ì •ì„ ì„ íƒí•˜ê±°ë‚˜, ê²½ê¸°ëŠ” ìƒì„¸ë³´ê¸°ë¥¼ ì´ìš©í•˜ì„¸ìš”.";
        scheduleContentInput.placeholder = "ì¼ì •ì„ ì„ íƒí•˜ê±°ë‚˜, ê²½ê¸°ëŠ” ìƒì„¸ë³´ê¸°ë¥¼ ì´ìš©í•˜ì„¸ìš”.";

        detailList.querySelectorAll('li').forEach(li => li.classList.remove('active'));

        const existingSummary = document.getElementById('match-summary');
        if (existingSummary) existingSummary.remove();
    }

    function bindScheduleToDetail(event, schedule) {
        clearDetailEditArea();
        event.currentTarget.classList.add('active');

        personalScheduleTitle.style.display = 'block';
        newScheduleTitle.style.display = 'none';
        scheduleTimeInput.style.display = 'block';

        scheduleNameInput.value = schedule.title;
        scheduleContentInput.value = schedule.detail;
        selectedScheduleIdInput.value = schedule.id;
        scheduleTimeInput.value = schedule.time;

        if (schedule.type === 'match') {
            scheduleNameInput.disabled = true;
            scheduleContentInput.disabled = true;
            scheduleTimeInput.disabled = true;
            saveBtn.disabled = true;
            deleteBtn.disabled = true;
            saveBtn.style.backgroundColor = 'rgba(204, 204, 204, 0.7)';
            deleteBtn.style.backgroundColor = 'rgba(204, 204, 204, 0.7)';

            scheduleNameInput.placeholder = "ê²½ê¸° ì¼ì •ì€ ìˆ˜ì •ì´ ë¶ˆê°€í•©ë‹ˆë‹¤.";
            scheduleContentInput.placeholder = "ê²½ê¸° ì¼ì •ì€ ìˆ˜ì •ì´ ë¶ˆê°€í•©ë‹ˆë‹¤.";

            const summaryDiv = document.createElement('div');
            summaryDiv.id = 'match-summary';
            summaryDiv.style.marginTop = '10px';
            summaryDiv.style.padding = '10px';
            summaryDiv.style.border = '1px solid #ddd';
            summaryDiv.style.borderRadius = '8px';
            summaryDiv.style.background = 'rgba(255,255,255,0.8)';
            summaryDiv.innerHTML = `
                <strong>âš½ ê²½ê¸° ìš”ì•½ ì •ë³´</strong><br>
                ì¥ì†Œ: ${schedule.detail.includes('ì¥ì†Œ') ? schedule.detail.split(',')[0].replace('ì¥ì†Œ:', '').trim() : schedule.title}<br>
                ì‹œê°„: ${schedule.time}<br><br>
                <div style="text-align:center;">
                    <button id="go-to-match-btn"
                        style="background:#6c5ce7;
                               color:white;
                               border:none;
                               padding:8px 15px;
                               border-radius:6px;
                               cursor:pointer;
                               font-weight:600;
                               transition:0.2s;">
                        ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™
                    </button>
                </div>
            `;
            document.getElementById('fixed-detail-edit-area').appendChild(summaryDiv);

            document.getElementById('go-to-match-btn').addEventListener('click', () => {
                window.location.href = `/schedule/detail/${schedule.matchId}`;
            });
            return;
        }

        if (schedule.type === 'personal') {
            scheduleNameInput.disabled = false;
            scheduleContentInput.disabled = false;
            scheduleTimeInput.disabled = false;
            saveBtn.disabled = false;
            saveBtn.textContent = "ì €ì¥";
            saveBtn.style.backgroundColor = 'rgba(74, 144, 226, 0.85)';
            saveBtn.setAttribute('data-mode', 'edit');
            deleteBtn.disabled = false;
            deleteBtn.style.backgroundColor = 'rgba(231, 76, 60, 0.85)';
            scheduleNameInput.placeholder = "ì¼ì •ëª… (ìˆ˜ì • ê°€ëŠ¥)";
            scheduleContentInput.placeholder = "ì„¸ë¶€ ë‚´ìš© (ìˆ˜ì • ê°€ëŠ¥)";
        }
    }
    //ì¼ì • ì¶”ê°€
    saveBtn.addEventListener('click', async function() {
        if (saveBtn.disabled) return;

        const id = selectedScheduleIdInput.value;
        const newTitle = scheduleNameInput.value.trim();
        const newDetail = scheduleContentInput.value.trim();
        const newTime = scheduleTimeInput.value; // "HH:mm"

        if (!newTitle || !newTime) {
            alert("ì¼ì •ëª…ê³¼ ì‹œê°„ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return;
        }

        // ì„ íƒëœ ë‚ ì§œ
        const selectedDateParts = fixedDetailWindow.dataset.selectedDate.split('-');
        const selectedYear = parseInt(selectedDateParts[0]);
        const selectedMonth = parseInt(selectedDateParts[1]) - 1;
        const selectedDay = parseInt(selectedDateParts[2]);
        const dateStr = `${selectedYear}-${String(selectedMonth + 1).padStart(2, '0')}-${String(selectedDay).padStart(2, '0')}`;

        const accessToken = localStorage.getItem('accessToken');
        if (!accessToken) {
            alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
            window.location.href = '/login';
            return;
        }

        const body = {
            scheduleDate: dateStr,      // LocalDate
            scheduleTime: newTime,      // LocalTime (e.g. "18:00")
            title: newTitle,
            content: newDetail
        };

        try {
            if (!id || saveBtn.getAttribute('data-mode') === 'add') {
                // â˜… ì‹ ê·œ ë“±ë¡ (POST)
                const res = await fetch('/api/schedule/personal', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}`,
                    },
                    body: JSON.stringify(body)
                });

                if (!res.ok) {
                    throw new Error('ê°œì¸ ì¼ì • ë“±ë¡ ì‹¤íŒ¨');
                }
                alert("âœ… ìƒˆ ê°œì¸ ì¼ì •ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!");
            } else {
                // â˜… ìˆ˜ì • (PUT)
                const res = await fetch(`/api/schedule/personal/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}`,
                    },
                    body: JSON.stringify(body)
                });

                if (!res.ok) {
                    throw new Error('ê°œì¸ ì¼ì • ìˆ˜ì • ì‹¤íŒ¨');
                }
                alert(`âœ… ê°œì¸ ì¼ì •ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤! ID: ${id}`);
            }

            // ì„œë²„ ë°˜ì˜ í›„ â†’ ê·¸ ë‚ ì§œ ì¼ì • ë‹¤ì‹œ ì¡°íšŒ
            await reloadDaySchedulesFromServer(dateStr);

            fixedDetailWindow.style.display = 'none';
        } catch (err) {
            console.error(err);
            alert("ì¼ì • ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
    });
    //ì¼ì • ì‚­ì œ
    deleteBtn.addEventListener('click', async function() {
        if (deleteBtn.disabled) return;
        if (!confirm("ì •ë§ë¡œ ì´ ì¼ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

        const id = selectedScheduleIdInput.value;
        const accessToken = localStorage.getItem('accessToken');
        if (!accessToken) {
            alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
            window.location.href = '/login';
            return;
        }

        try {
            const res = await fetch(`/api/schedule/personal/${id}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${accessToken}`,
                }
            });

            if (!res.ok) {
                throw new Error('ê°œì¸ ì¼ì • ì‚­ì œ ì‹¤íŒ¨');
            }

            alert(`âœ… ê°œì¸ ì¼ì •ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤! ID: ${id}`);

            const dateStr = fixedDetailWindow.dataset.selectedDate;
            await reloadDaySchedulesFromServer(dateStr);

            fixedDetailWindow.style.display = 'none';
        } catch (err) {
            console.error(err);
            alert("ì¼ì • ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
    });
    //í•´ë‹¹ ë‚ ì ì¼ì • ê°€ì ¸ì˜¤ê¸° (ì„œë²„ì—ì„œ)
    async function reloadDaySchedulesFromServer(dateStr) {
        const accessToken = localStorage.getItem('accessToken');
        if (!accessToken) {
            alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
            window.location.href = '/login';
            return;
        }

        const res = await fetch(`/api/schedule/day?date=${dateStr}`, {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${accessToken}`,
            }
        });

        if (!res.ok) {
            console.error('ì¼ì • ì¡°íšŒ ì‹¤íŒ¨', res.status);
            return;
        }

        const dayItems = await res.json(); // List<ScheduleDto.DayItem>

        const [year, month, day] = dateStr.split('-').map(v => parseInt(v));
        // MOCK_SCHEDULESë¥¼ ì•„ì˜ˆ â€œì„œë²„ ê¸°ë°˜â€ìœ¼ë¡œ ë‹¤ì‹œ ì±„ìš°ê¸°
        MOCK_SCHEDULES = MOCK_SCHEDULES.filter(s => !(s.year === year && s.month === (month - 1) && s.day === day));

        dayItems.forEach(item => {
            MOCK_SCHEDULES.push({
                id: item.scheduleId,
                year: year,
                month: (month - 1),
                day: day,
                time: item.scheduleTime,
                type: item.scheduleType === 'ê²½ê¸°' ? 'match' : 'personal',
                title: item.title,
                detail: item.content || '',
                matchId: item.matchId ?? null
            });
        });

        renderCalendar();
    }

    // ì´ë²ˆ ë‹¬ ì „ì²´ ì¼ì • ì„œë²„ì—ì„œ ë¶ˆëŸ¬ì™€ì„œ ì±„ìš°ê¸°
    async function loadThisMonthSchedules() {
        const accessToken = localStorage.getItem('accessToken');
        if (!accessToken) return;

        const year = currentDate.getFullYear();
        const month = currentDate.getMonth() + 1; // JSëŠ” 0ë¶€í„°, ì„œë²„ëŠ” 1ë¶€í„°

        try {
            const res = await fetch(`/api/schedule/month?year=${year}&month=${month}`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${accessToken}`,
                }
            });

            if (!res.ok) {
                console.error('ì´ë²ˆ ë‹¬ ì¼ì • ì¡°íšŒ ì‹¤íŒ¨:', res.status);
                return;
            }

            const monthItems = await res.json(); // List<ScheduleDto.DayItem>

            // ê¸°ì¡´ ë°ì´í„° ì´ˆê¸°í™” í›„ ì„œë²„ ë°ì´í„°ë¡œ ì±„ìš°ê¸°
            MOCK_SCHEDULES = [];

            monthItems.forEach(item => {
                const [y, m, d] = item.scheduleDate.split('-').map(v => parseInt(v));
                MOCK_SCHEDULES.push({
                    id: item.scheduleId,
                    year: y,
                    month: m - 1,             // 0-based
                    day: d,
                    time: item.scheduleTime,  // "HH:mm" ë˜ëŠ” "HH:mm:ss"
                    type: item.scheduleType === 'ê²½ê¸°' ? 'match' : 'personal',
                    title: item.title,
                    detail: item.content || '',
                    matchId: item.matchId ?? null
                });
            });

            // ìƒˆ ë°ì´í„° ê¸°ì¤€ìœ¼ë¡œ ìº˜ë¦°ë” ë‹¤ì‹œ ê·¸ë¦¼
            renderCalendar();
        } catch (e) {
            console.error('ì´ë²ˆ ë‹¬ ì¼ì • ì¡°íšŒ ì¤‘ ì˜¤ë¥˜:', e);
        }
    }

    function renderCalendar() {
        const daysGrid = document.getElementById("calendar-days-grid");
        if (!daysGrid) return;
        daysGrid.innerHTML = "";

        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();

        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const daysInPrevMonth = new Date(year, month, 0).getDate();

        if (monthYearElement) monthYearElement.textContent = `${year}ë…„ ${month + 1}ì›”`;

        for (let i = firstDay - 1; i >= 0; i--) {
            const cell = document.createElement("div");
            cell.classList.add("calendar-day-cell");
            cell.style.backgroundColor = "rgba(245,245,245,0.8)";
            cell.style.color = "#bbb";
            cell.textContent = daysInPrevMonth - i;
            cell.style.cursor = "default";
            daysGrid.appendChild(cell);
        }

        for (let day = 1; day <= daysInMonth; day++) {
            const cell = document.createElement("div");
            cell.classList.add("calendar-day-cell");
            cell.textContent = day;

            const today = new Date();
            if (year === today.getFullYear() && month === today.getMonth() && day === today.getDate()) {
                cell.classList.add("today");
            }

            const schedulesToday = MOCK_SCHEDULES
                .filter(s => s.year === year && s.month === month && s.day === day)
                .sort((a, b) => a.time.localeCompare(b.time));

            //25-11-18 ìˆ˜ì •
            if (schedulesToday.length > 0) {
                const visible = schedulesToday.slice(0, 2);
                visible.forEach(s => {
                    const eventDiv = document.createElement("div");
                    eventDiv.className = "calendar-event " + (s.type === "match" ? "match-schedule" : "personal-schedule");

                    const timeTextRaw = s.time?.split("~")[0]?.trim() || "";
                    const timeText = formatToHHMM(timeTextRaw);   //ì´ˆ ì œê±°

                    eventDiv.textContent = `${timeText} ${s.title.split(' ')[0]}`;
                    eventDiv.onclick = (e) => {
                        e.stopPropagation();
                        openDaySchedule(day, e);
                    };
                    cell.appendChild(eventDiv);
                });

                if (schedulesToday.length > 2) {
                    const moreDiv = document.createElement("div");
                    moreDiv.className = "calendar-event more-events";
                    moreDiv.textContent = `+${schedulesToday.length - 2}ê°œ ë”ë³´ê¸°`;
                    moreDiv.onclick = (e) => {
                        e.stopPropagation();
                        openDaySchedule(day, e);
                    };
                    cell.appendChild(moreDiv);
                }
            }

            cell.onclick = (e) => openDaySchedule(day, e);
            daysGrid.appendChild(cell);
        }

        const totalCells = firstDay + daysInMonth;
        const nextMonthPlaceholders = (7 - (totalCells % 7)) % 7;
        for (let i = 1; i <= nextMonthPlaceholders; i++) {
            const cell = document.createElement("div");
            cell.classList.add("calendar-day-cell");
            cell.style.backgroundColor = "rgba(245,245,245,0.8)";
            cell.style.color = "#bbb";
            cell.textContent = i;
            cell.style.cursor = "default";
            daysGrid.appendChild(cell);
        }
    }

    if (prevMonthBtn) prevMonthBtn.addEventListener('click', async () => {
        currentDate.setMonth(currentDate.getMonth() - 1);
        await loadThisMonthSchedules(); // âœ… ì¶”ê°€
        fixedDetailWindow.style.display = 'none';
    });

    if (nextMonthBtn) nextMonthBtn.addEventListener('click', async () => {
        currentDate.setMonth(currentDate.getMonth() + 1);
        await loadThisMonthSchedules(); // âœ… ì¶”ê°€
        fixedDetailWindow.style.display = 'none';
    });
    if (closeDetailBtn) {
        closeDetailBtn.addEventListener('click', () => {
            fixedDetailWindow.style.display = 'none';
        });
    }

    //[ì¶”ê°€] ì¹œêµ¬ ëª©ë¡/ì‚­ì œ/ê²€ìƒ‰
    async function renderFriendList() {
        const listContainer = document.getElementById('friend-list');
        const countDisplay = document.getElementById('friend-count-display');
        const messageContainer = document.getElementById('no-friends-message');
        const keyword = (document.getElementById('friend-list-search-input')?.value || '').trim();

        listContainer.innerHTML = '';
        try {
            const friends = await apiGetFriends(keyword); // [{friendId,userId,username,nickname}]
            if (countDisplay) countDisplay.textContent = friends.length;

            if (!friends.length) {
                if (messageContainer) messageContainer.style.display = 'block';
                return;
            }
            if (messageContainer) messageContainer.style.display = 'none';

            friends.forEach(f => {
                const li = document.createElement('li');
                li.dataset.friendId = f.friendId;
                li.innerHTML = `
          <strong>${f.nickname}</strong> (${f.username})
          <div class="action-buttons">
            <button class="btn-chat" onclick="event.stopPropagation(); alert('${f.nickname}ë‹˜ê³¼ ì±„íŒ…(ì¶”í›„ì—°ë™)');">ì±„íŒ…</button>
            <button class="btn-delete" onclick="event.stopPropagation(); deleteFriend(${f.userId}, '${f.nickname}');">ì‚­ì œ</button>
          </div>
        `;
                li.onclick = () => {
                    listContainer.querySelectorAll('li').forEach(item => item.classList.remove('active'));
                    li.classList.add('active');
                };
                listContainer.appendChild(li);
            });
        } catch (e) {
            console.error(e);
            alert('ì¹œêµ¬ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
        }
    }

    function searchFriendList() {
        renderFriendList();
    }

    async function deleteFriend(targetUserId, nickname) {
        if (!confirm(`${nickname}ë‹˜ì„ ì¹œêµ¬ ëª©ë¡ì—ì„œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
        try {
            await apiDeleteFriend(targetUserId);
            await renderFriendList();
            alert(`${nickname}ë‹˜ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);
        } catch (e) {
            console.error(e);
            alert('ì¹œêµ¬ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    }

    const subTabButtons = document.querySelectorAll('.sub-tabs .sub-tab-btn');
    const subTabContents = document.querySelectorAll('.sub-tab-content');
    subTabButtons.forEach(button => {
        button.addEventListener('click', () => {
            const targetTab = button.getAttribute('data-sub-tab');
            subTabButtons.forEach(btn => btn.classList.remove('active'));
            subTabContents.forEach(content => content.classList.remove('active'));
            button.classList.add('active');
            document.getElementById(targetTab).classList.add('active');

            if (targetTab === 'sub-tab-friend-add') {
                renderFriendRequests();
            } else if (targetTab === 'sub-tab-friend-list') {
                renderFriendList();
            }
        });
    });

    const tabButtons = document.querySelectorAll('.tab-btn');
    const tabContents = document.querySelectorAll('.tab-content');
    tabButtons.forEach(button => {
        button.addEventListener('click', () => {
            const targetTab = button.getAttribute('data-tab');
            tabButtons.forEach(btn => btn.classList.remove('active'));
            tabContents.forEach(content => content.classList.remove('active'));
            button.classList.add('active');
            document.getElementById(targetTab).classList.add('active');
            fixedDetailWindow.style.display = 'none';
        });
    });

    if (localStorage.getItem("calendarUpdated") === "true") {
        localStorage.removeItem("calendarUpdated");
        window.location.reload();
    }

    // [ì¶”ê°€] ì¹œêµ¬ ê³µí†µ í—¬í¼
    function requireLoginOrRedirect() {
        const token = localStorage.getItem('accessToken');
        if (!token) {
            alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
            window.location.href = '/login';
            throw new Error('No token');
        }
    }
    function authHeaders() {
        const token = localStorage.getItem('accessToken');
        return {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json',
        };
    }

    /* ===== Friends API ===== */
    async function apiGetFriends(keyword = '') {
        requireLoginOrRedirect();
        const q = keyword ? `?keyword=${encodeURIComponent(keyword)}` : '';
        const res = await fetch(`/api/friends${q}`, { headers: authHeaders() });
        if (!res.ok) throw new Error('ì¹œêµ¬ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨');
        return res.json(); // [{friendId,userId,username,nickname}]
    }

    async function apiDeleteFriend(targetUserId) {
        requireLoginOrRedirect();
        const res = await fetch(`/api/friends/${targetUserId}`, {
            method: 'DELETE', headers: authHeaders()
        });
        if (!res.ok) throw new Error('ì¹œêµ¬ ì‚­ì œ ì‹¤íŒ¨');
    }

    async function apiGetIncomingRequests() {
        requireLoginOrRedirect();
        const res = await fetch(`/api/friends/requests`, { headers: authHeaders() });
        if (!res.ok) throw new Error('ë°›ì€ ìš”ì²­ ì¡°íšŒ ì‹¤íŒ¨');
        return res.json(); // [{friendId,userId,username,nickname}]
    }

    async function apiAcceptRequest(requesterUserId) {
        requireLoginOrRedirect();
        const res = await fetch(`/api/friends/requests/${requesterUserId}/accept`, {
            method: 'POST', headers: authHeaders()
        });
        if (!res.ok) throw new Error('ìš”ì²­ ìˆ˜ë½ ì‹¤íŒ¨');
    }

    async function apiRejectRequest(requesterUserId) {
        requireLoginOrRedirect();
        const res = await fetch(`/api/friends/requests/${requesterUserId}/reject`, {
            method: 'POST', headers: authHeaders()
        });
        if (!res.ok) throw new Error('ìš”ì²­ ê±°ì ˆ ì‹¤íŒ¨');
    }

    async function apiSearchUsersForFriend(keyword) {
        requireLoginOrRedirect();
        const res = await fetch(`/api/friends/search?keyword=${encodeURIComponent(keyword)}`, {
            headers: authHeaders()
        });
        if (!res.ok) throw new Error('ì¹œêµ¬ ì¶”ê°€ ê²€ìƒ‰ ì‹¤íŒ¨');
        return res.json(); // [{userId,username,nickname,isFriend?:boolean}]
    }

    async function apiSendFriendRequestById(targetUserId) {
        requireLoginOrRedirect();
        const res = await fetch(`/api/friends/requests`, {
            method: 'POST', headers: authHeaders(),
            body: JSON.stringify({ targetUserId })
        });
        if (!res.ok) throw new Error('ì¹œêµ¬ ìš”ì²­ ì‹¤íŒ¨');
    }

    function _toggleActiveItem(event) {
        const clickedItem = event.currentTarget;
        if (event.target.closest('.request-actions')) return;
        const container = clickedItem.parentElement;
        container.querySelectorAll('.friend-request-item.active').forEach(item => {
            if (item !== clickedItem) item.classList.remove('active');
        });
        clickedItem.classList.toggle('active');
    }

    // [ì¶”ê°€] ë°›ì€ ì¹œêµ¬ ìš”ì²­ ëª©ë¡/ìˆ˜ë½/ê±°ì ˆ
    async function renderFriendRequests() {
        const listContainer = document.getElementById('friend-add-search-results');
        const messageContainer = document.getElementById('friend-request-message');
        listContainer.innerHTML = '';

        try {
            const requests = await apiGetIncomingRequests(); // [{friendId,userId,username,nickname}]
            if (!requests.length) {
                if (messageContainer) messageContainer.style.display = 'block';
                return;
            }
            if (messageContainer) messageContainer.style.display = 'none';

            requests.forEach(req => {
                const li = document.createElement('li');
                li.className = 'friend-request-item';
                li.dataset.requesterId = req.userId;
                li.onclick = _toggleActiveItem;
                li.innerHTML = `
          <span>${req.nickname} (${req.username})</span>
          <div class="request-actions">
            <button class="btn-accept" onclick="event.stopPropagation(); acceptFriendRequest(${req.userId}, '${req.nickname}');"><i class="fas fa-check"></i> ìˆ˜ë½</button>
            <button class="btn-reject" onclick="event.stopPropagation(); rejectFriendRequest(${req.userId}, '${req.nickname}');"><i class="fas fa-times"></i> ê±°ì ˆ</button>
          </div>
        `;
                listContainer.appendChild(li);
            });
        } catch (e) {
            console.error(e);
            alert('ì¹œêµ¬ ìš”ì²­ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
        }
    }

    async function acceptFriendRequest(requesterId, nickname) {
        try {
            await apiAcceptRequest(requesterId);
            await renderFriendRequests();
            await renderFriendList();
            alert(`${nickname}ë‹˜ì˜ ì¹œêµ¬ ìš”ì²­ì„ ìˆ˜ë½í–ˆìŠµë‹ˆë‹¤.`);
        } catch (e) {
            console.error(e);
            alert('ìš”ì²­ ìˆ˜ë½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    }

    async function rejectFriendRequest(requesterId, nickname) {
        try {
            await apiRejectRequest(requesterId);
            await renderFriendRequests();
            alert(`${nickname}ë‹˜ì˜ ì¹œêµ¬ ìš”ì²­ì„ ê±°ì ˆí–ˆìŠµë‹ˆë‹¤.`);
        } catch (e) {
            console.error(e);
            alert('ìš”ì²­ ê±°ì ˆ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    }

    // [ì¶”ê°€] ì¹œêµ¬ ì¶”ê°€ ëª¨ë‹¬ (ê²€ì„¹/ìš”ì²­)
    function renderModalSearchResults(users) {
        const container = document.getElementById('friend-modal-search-results');
        container.innerHTML = '';
        if (!users || !users.length) {
            container.innerHTML = '<div class="friend-add-no-results">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
            return;
        }

        users.forEach(user => {
            const item = document.createElement('div');
            item.className = 'friend-add-result-item';
            item.dataset.userId = user.userId;
            item.innerHTML = `
        <div class="friend-add-result-user">
          <i class="fas fa-user-circle"></i>
          <span>${user.nickname} (${user.username})</span>
        </div>
        <div class="friend-add-result-actions">
          ${user.isFriend ? '<button type="button" disabled>ì¹œêµ¬</button>' : '<button type="button" class="friend-add-request-btn">ì¹œêµ¬ ìš”ì²­</button>'}
        </div>
      `;
            item.addEventListener('click', (e) => {
                if (e.target.closest('.friend-add-result-actions')) return;
                const siblings = container.querySelectorAll('.friend-add-result-item');
                siblings.forEach(el => el.classList.remove('active'));
                item.classList.toggle('active');
            });

            const btn = item.querySelector('.friend-add-request-btn');
            if (btn) {
                btn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    try {
                        await apiSendFriendRequestById(user.userId);
                        btn.disabled = true;
                        btn.textContent = 'ìš”ì²­ ë³´ëƒ„';
                        btn.style.backgroundColor = '#ccc';
                        btn.style.cursor = 'default';
                        alert(`${user.nickname}ë‹˜ì—ê²Œ ì¹œêµ¬ ìš”ì²­ì„ ë³´ëƒˆìŠµë‹ˆë‹¤.`);
                    } catch (err) {
                        console.error(err);
                        alert('ì¹œêµ¬ ìš”ì²­ ì „ì†¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                    }
                });
            }

            container.appendChild(item);
        });
    }

    async function searchFriendsInModal() {
        const input = document.getElementById('friend-modal-search-input');
        const term = input.value.trim();
        try {
            const results = term ? await apiSearchUsersForFriend(term) : [];
            renderModalSearchResults(results);
        } catch (e) {
            console.error(e);
            alert('ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    }

    document.addEventListener('DOMContentLoaded', async () => {
        const accessToken = localStorage.getItem('accessToken');
        if (!accessToken) {
            alert("ë¡œê·¸ì¸ì´ í•„ìš”í•œ í˜ì´ì§€ì…ë‹ˆë‹¤.");
            window.location.href = '/login';
            return;
        }

        const profileMenuToggle = document.getElementById('profile-menu-toggle');
        if (profileMenuToggle) profileMenuToggle.style.display = 'block';

        await checkPendingReviews();
        await checkUpcomingSchedules();
        updateGlobalBadge();

        await loadUserInfo();

        renderFriendList();

        await loadThisMonthSchedules();

        const urlParams = new URLSearchParams(window.location.search);
        const mainTab = urlParams.get('tab');
        const subTab = urlParams.get('subtab');

        // ìº˜ë¦°ë” ë”¥ë§í¬ ì²˜ë¦¬
        const dateParam = urlParams.get('date');        // ex) "2025-11-20"
        const scheduleIdParam = urlParams.get('scheduleId'); // ex) "123"

        if (mainTab === 'calendar' && dateParam) {
            const calendarTabBtn = document.querySelector('.tab-btn[data-tab="tab-calendar"]');
            if (calendarTabBtn) calendarTabBtn.click();
            const [dy, dm, dd] = dateParam.split('-').map(Number);

            // ìº˜ë¦°ë” ê¸°ì¤€ ì›”ì„ í•´ë‹¹ ë‚ ì§œì˜ ì›”ë¡œ ë§ì¶”ê¸°
            if (dy && dm) {
                currentDate = new Date(dy, dm - 1, 1);
                await loadThisMonthSchedules();   // ê·¸ ë‹¬ ì¼ì • ë‹¤ì‹œ ë¡œë”© + ë Œë”
                monthYearElement.textContent = `${dy}ë…„ ${dm}ì›”`;
            }

            // í•´ë‹¹ ë‚ ì§œ ìƒì„¸ íŒ¨ë„ ì—´ê¸°
            await openDaySchedule(dd, { stopPropagation: () => {} });

            // íŠ¹ì • scheduleIdê¹Œì§€ ë„˜ì–´ì™”ìœ¼ë©´ ê·¸ ì¼ì • ìë™ ì„ íƒ
            if (scheduleIdParam) {
                setTimeout(() => {
                    const targetLi = document.querySelector(
                        `#fixed-schedule-list li[data-schedule-id="${scheduleIdParam}"]`
                    );
                    if (!targetLi) return;

                    const schedule = (window.MOCK_SCHEDULES || []).find(
                        s => String(s.id) === String(scheduleIdParam)
                    );
                    if (schedule) {
                        bindScheduleToDetail({ currentTarget: targetLi }, schedule);
                    } else {
                        targetLi.click();
                    }
                }, 200);
            }
        }


        if (!(mainTab === 'calendar' && dateParam)) {
            if (mainTab === 'calendar' && !dateParam) {
                document.querySelector('.tab-btn[data-tab="tab-calendar"]').click();
            } else if (mainTab === 'friends') {
                document.querySelector('.tab-btn[data-tab="tab-friends"]').click();
                if (subTab === 'add') {
                    document.querySelector('.sub-tab-btn[data-sub-tab="sub-tab-friend-add"]').click();
                }
            } else {
                document.querySelector('.tab-btn[data-tab="tab-info"]').click();
            }
        }

        // ğŸ”— ëª¨ë‹¬ ì´ë²¤íŠ¸ ë°”ì¸ë”©
        const openFriendModalBtn = document.getElementById('open-friend-add-modal');
        const friendModalOverlay = document.getElementById('friend-add-modal-overlay');
        const friendModalClose = document.getElementById('friend-add-modal-close');
        const friendModalSearchBtn = document.getElementById('friend-modal-search-btn');
        const friendModalSearchInput = document.getElementById('friend-modal-search-input');

        if (openFriendModalBtn && friendModalOverlay) {
            openFriendModalBtn.addEventListener('click', () => {
                friendModalOverlay.classList.add('show');
                renderModalSearchResults([]); // ì²˜ìŒì—” ë¹ˆ ìƒíƒœ
                setTimeout(() => friendModalSearchInput && friendModalSearchInput.focus(), 50);
            });
        }

        if (friendModalClose && friendModalOverlay) {
            friendModalClose.addEventListener('click', () => {
                friendModalOverlay.classList.remove('show');
            });
        }

        if (friendModalOverlay) {
            friendModalOverlay.addEventListener('click', (e) => {
                if (e.target === friendModalOverlay) {
                    friendModalOverlay.classList.remove('show');
                }
            });
        }

        if (friendModalSearchBtn) {
            friendModalSearchBtn.addEventListener('click', searchFriendsInModal);
        }
        if (friendModalSearchInput) {
            friendModalSearchInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') searchFriendsInModal();
            });
        }
    });


</script>
</body>
</html>