<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="'êµ¬ì¥ ìƒì„¸ (' + ${stadiumId} + ') - MULTI FC'">MULTI FC - êµ¬ì¥ ìƒì„¸</title>
    <link rel="stylesheet" th:href="@{/css/style.css?v=219}">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="//dapi.kakao.com/v2/maps/sdk.js?appkey=4caaf2cb0e09303d4dd13d3fb5ff15e9&libraries=services"></script>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
</head>
<body>

<div th:replace="~{fragments/header :: siteHeader}"></div>

<main class="stadium-main">
    <div class="search-container">
        <h1 class="stadium-title" id="stadium-name">êµ¬ì¥ ì •ë³´ ë¡œë”©ì¤‘... (ID: <span th:text="${stadiumId}"></span>)</h1>

        <div class="detail-left-column">
            <div class="map-area" id="map"></div>
            <div class="info-card">
                <h2>êµ¬ì¥ ê¸°ë³¸ ì •ë³´</h2>
                <div class="info-item"><i class="fas fa-map-marker-alt"></i> <span id="stadium-address">ì£¼ì†Œ</span></div>
                <div class="info-item"><i class="fas fa-users"></i> <span id="stadium-size">-</span></div>
            </div>
        </div>

        <div class="review-right-column">
            <div class="tab-header">
                <button id="tab-btn-match" class="tab-button active">ê²½ê¸°</button>
                <button id="tab-btn-review" class="tab-button">í›„ê¸°</button>
            </div>
            <div id="tab-match" class="tab-content active">
                <h2 style="font-size: 24px; color: #333; margin-bottom: 15px;">âš½ ê²½ê¸° ì •ë³´</h2>
                <div class="match-filter">
                    <label for="match-date-filter">ë‚ ì§œ ì„ íƒ</label>
                    <input type="date" id="match-date-filter">
                </div>
                <div id="match-list" class="match-list">
                    <p style="color:#777; font-size:13px; padding:10px 0;">ë‚ ì§œë¥¼ ì„ íƒí•˜ë©´ ê²½ê¸°ê°€ í‘œì‹œë©ë‹ˆë‹¤.</p>
                </div>
            </div>
            <div id="tab-review" class="tab-content">
                <h2 style="font-size: 24px; color: #333; margin-bottom: 15px;">â­ êµ¬ì¥ ë¦¬ë·°</h2>
                <div id="review-list"></div>
                <div style="text-align: center; margin-top: 20px; font-size: 14px; color: #777;">
                    í›„ê¸° ì‘ì„±ì€ ë§¤ì¹­ ì™„ë£Œ í›„ ë©”ì¸ í˜ì´ì§€ ì•Œë¦¼ì„ í†µí•´ ê°€ëŠ¥í•©ë‹ˆë‹¤.
                </div>
            </div>
        </div>

        <div class="action-button-group">
            <a href="/schedule?stadiumId=1" class="btn-schedule" id="btn-schedule"><i class="fas fa-calendar-alt"></i> ë§¤ì¹˜/ì¼ì • í™•ì¸</a>
            <button class="btn-create-match" id="btn-create-match"><i class="fas fa-plus-circle"></i> ê²½ê¸° ìƒì„±</button>
        </div>
    </div>
</main>

<div id="match-create-modal" class="modal-overlay">
    <div class="modal-content">
        <h2>ê²½ê¸° ê°œì„¤</h2>
        <label>ì£¼ìµœì</label>
        <input type="text" id="hostName" readonly>
        <label>ì¥ì†Œ</label>
        <input type="text" id="stadiumName" readonly>
        <input type="hidden" id="stadiumId">
        <label>ë ˆë²¨</label>
        <select id="matchLevel">
            <option value="ì´ˆê¸‰">ì´ˆê¸‰</option>
            <option value="ì¤‘ê¸‰">ì¤‘ê¸‰</option>
            <option value="ê³ ê¸‰">ê³ ê¸‰</option>
        </select>
        <label>ë‚ ì§œ</label>
        <input type="date" id="matchDate">
        <label>ì‹œê°„</label>
        <div class="time-select-group">
            <select id="startTime"></select> <span>~</span> <select id="endTime"></select>
        </div>
        <div class="modal-actions">
            <button class="btn-create" onclick="submitMatchForm()">ìƒì„±</button>
            <button class="btn-cancel" onclick="openMatchModal(false)">ì·¨ì†Œ</button>
        </div>
    </div>
</div>

<div id="edit-review-modal" class="modal-overlay">
    <div class="modal-content">
        <h2>í›„ê¸° ìˆ˜ì •</h2>
        <form id="edit-review-form">
            <input type="hidden" id="edit-review-id">
            <label>í‰ì </label>
            <input type="number" id="edit-rating" name="rating" min="1" max="5" required>
            <label>ë‚´ìš©</label>
            <textarea id="edit-content" name="content" rows="5" required></textarea>
            <div class="modal-actions">
                <button class="btn-cancel" type="button" onclick="document.getElementById('edit-review-modal').style.display='none'">ì·¨ì†Œ</button>
                <button class="btn-create" type="submit">ìˆ˜ì • ì™„ë£Œ</button>
            </div>
        </form>
    </div>
</div>

<script>
    // ===========================
    // 1. ì´ˆê¸°í™” (í—¤ë” ìŠ¤í¬ë¦½íŠ¸ ì œê±° ë²„ì „)
    // ===========================
    document.addEventListener('DOMContentLoaded', async () => {
        const token = localStorage.getItem('accessToken');

        // âœ… í—¤ë” ë‹‰ë„¤ì„: "ì‚¬ìš©ìë‹˜" ëŒ€ì‹  localStorage ê°’ ì‚¬ìš©
        const userMenuName = document.getElementById('user-menu-username');
        if (userMenuName) {
            const nickname =
                localStorage.getItem('userNickname') ||
                localStorage.getItem('username') ||
                'íšŒì›';
            userMenuName.textContent = nickname;
        }

        // ğŸ”´ ê³µí†µ ì•Œë¦¼ ë°°ì§€ í•¨ìˆ˜ê°€ ìˆìœ¼ë©´ í˜¸ì¶œ â†’ ë¹¨ê°„ ë°°ì§€ ê°±ì‹ 
        if (token) {
            if (typeof checkPendingReviews === 'function') {
                try { await checkPendingReviews(); } catch (e) { console.error(e); }
            }
            if (typeof checkUpcomingSchedules === 'function') {
                try { await checkUpcomingSchedules(); } catch (e) { console.error(e); }
            }
            if (typeof updateGlobalBadge === 'function') {
                try { updateGlobalBadge(); } catch (e) { console.error(e); }
            }
        }

        // ===========================
        // 2. êµ¬ì¥ ì •ë³´ ë° ê²½ê¸° ë¡œë“œ
        // ===========================
        const stadiumId = new URLSearchParams(window.location.search).get('id');
        const currentUserId = localStorage.getItem('userId');

        if (stadiumId) {
            // êµ¬ì¥ ì •ë³´
            const stadiumListRes = await fetch('/api/stadiums');
            const stadiumList = await stadiumListRes.json();
            const stadium = stadiumList.find(s => s.stadiumId == stadiumId);

            if (stadium) {
                document.getElementById('stadium-name').textContent =
                    `${stadium.name} (ID: ${stadiumId})`;
                document.getElementById('stadium-address').textContent = stadium.address;
                document.getElementById('stadiumName').value = stadium.name;
                document.getElementById('stadiumId').value = stadiumId;

                // Kakao Map ì´ˆê¸°í™” ë° ë§ˆì»¤ í‘œì‹œ
                if (window.kakao && kakao.maps) {
                    const map = new kakao.maps.Map(
                        document.getElementById('map'),
                        {
                            center: new kakao.maps.LatLng(stadium.latitude, stadium.longitude),
                            level: 3
                        }
                    );
                    new kakao.maps.Marker({ position: map.getCenter(), map: map });
                }
            }

            // ê²½ê¸° ëª©ë¡
            let allMatchesRes = await fetch(`/api/matchrooms/stadium/${stadiumId}`);
            let allMatches = await allMatchesRes.json();

            const today = new Date().toISOString().split("T")[0];
            document.getElementById('match-date-filter').value = today;
            renderMatches(allMatches, today);

            document
                .getElementById('match-date-filter')
                .addEventListener('change', (e) =>
                    renderMatches(allMatches, e.target.value)
                );

            // WebSocket (ì‹¤ì‹œê°„ ëª©ë¡ ê°±ì‹ )
            const socket = new SockJS('/ws');
            const stompClient = Stomp.over(socket);
            stompClient.connect({}, () => {
                stompClient.subscribe(`/topic/matches/${stadiumId}`, (msg) => {
                    const newMatch = JSON.parse(msg.body);
                    if (!allMatches.some(m => m.roomId === newMatch.roomId)) {
                        allMatches.push(newMatch);
                    } else {
                        allMatches = allMatches.map(m =>
                            m.roomId === newMatch.roomId ? newMatch : m
                        );
                    }
                    renderMatches(
                        allMatches,
                        document.getElementById('match-date-filter').value
                    );
                });
            });
        }

        // ===========================
        // 3. ê²½ê¸° ìƒì„± ë²„íŠ¼
        // ===========================
        document.getElementById('btn-create-match').addEventListener('click', (e) => {
            e.preventDefault();
            if (!localStorage.getItem('accessToken')) {
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                return location.href = '/login';
            }
            document.getElementById('hostName').value =
                localStorage.getItem('userNickname') || 'íšŒì›';
            setupTime(); // ì‹œê°„/ë ˆë²¨ ì´ˆê¸°í™”
            openMatchModal(true);
        });

        // ===========================
        // 4. íƒ­ ì´ë²¤íŠ¸
        // ===========================
        document
            .getElementById('tab-btn-match')
            .addEventListener('click', () => changeTab('match'));
        document
            .getElementById('tab-btn-review')
            .addEventListener('click', () => changeTab('review'));

        changeTab('match');
    });

    // ===========================
    // 5. íƒ­ ë³€ê²½ ë° í›„ê¸° ë¡œì§
    // ===========================
    function changeTab(activeTab) {
        document.querySelectorAll('.tab-button')
            .forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('.tab-content')
            .forEach(content => content.classList.remove('active'));

        document.getElementById(`tab-btn-${activeTab}`).classList.add('active');
        document.getElementById(`tab-${activeTab}`).classList.add('active');

        if (activeTab === 'review') {
            const stadiumId = new URLSearchParams(window.location.search).get('id');
            const currentUserId = localStorage.getItem('userId');
            if (stadiumId) {
                fetchReviews(stadiumId, currentUserId);
            }
        }
    }

    async function fetchReviews(stadiumId, currentUserId) {
        const reviewListEl = document.getElementById('review-list');
        reviewListEl.innerHTML = '<p style="color:#777; padding:10px 0;">í›„ê¸° ë¡œë”©ì¤‘...</p>';

        try {
            const res = await fetch(`/api/reviews/stadium/${stadiumId}`);
            if (!res.ok) throw new Error('í›„ê¸° ë¡œë“œ ì‹¤íŒ¨');

            const reviews = await res.json();
            renderReviews(reviews, currentUserId);
        } catch (e) {
            console.error("Failed to fetch reviews:", e);
            reviewListEl.innerHTML =
                '<p style="color:#e74c3c; padding:10px 0;">í›„ê¸° ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ</p>';
        }
    }

    function renderReviews(reviews, currentUserId) {
        const reviewListEl = document.getElementById('review-list');
        reviewListEl.innerHTML = '';

        if (!reviews || reviews.length === 0) {
            reviewListEl.innerHTML =
                '<p style="color:#777; padding:10px 0;">ì•„ì§ ì‘ì„±ëœ í›„ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
            return;
        }

        reviews.forEach(review => {
            const isMyReview =
                currentUserId && Number(currentUserId) === review.userId;
            const stars = 'â­'.repeat(review.rating);

            const reviewDiv = document.createElement('div');
            reviewDiv.className = 'review-item';

            reviewDiv.innerHTML = `
                <div class="review-header">
                    <span class="review-author">
                        ${review.nickname || 'ìµëª…'} ${isMyReview ? '(ë‚˜)' : ''}
                    </span>
                    <span class="review-rating">${stars} (${review.rating}/5)</span>
                </div>
                <p class="review-content">${review.content}</p>
                <div class="review-actions">
                    ${
                isMyReview
                    ? `<button class="action-btn edit-review-btn"
                                       data-id="${review.reviewId}"
                                       data-rating="${review.rating}"
                                       data-content="${review.content}">ìˆ˜ì •</button>
                               <button class="action-btn delete-review-btn"
                                       data-id="${review.reviewId}">ì‚­ì œ</button>`
                    : ''
            }
                    <small style="color: #aaa; margin-left: 10px;">
                        ì‘ì„±ì¼: ${review.createdAt || 'ë°©ê¸ˆ'}
                    </small>
                </div>
            `;
            reviewListEl.appendChild(reviewDiv);
        });

        registerReviewActionListeners(currentUserId);
    }

    function registerReviewActionListeners(currentUserId) {
        const stadiumId = new URLSearchParams(window.location.search).get('id');

        // ì‚­ì œ
        document.querySelectorAll('.delete-review-btn').forEach(button => {
            button.addEventListener('click', async (e) => {
                const reviewId = e.target.dataset.id;
                if (!confirm("ì •ë§ë¡œ ì´ í›„ê¸°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

                try {
                    const response = await fetch(
                        `/api/reviews/${reviewId}?userId=${Number(currentUserId)}`,
                        { method: 'DELETE' }
                    );

                    if (response.ok) {
                        alert('í›„ê¸°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                        fetchReviews(stadiumId, currentUserId);
                    } else {
                        const errorText = await response.text();
                        alert(`ì‚­ì œ ì‹¤íŒ¨: ${errorText}`);
                    }
                } catch (error) {
                    console.error('Delete error:', error);
                    alert('ì„œë²„ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            });
        });

        // ìˆ˜ì • ëª¨ë‹¬ ì˜¤í”ˆ
        document.querySelectorAll('.edit-review-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                document.getElementById('edit-review-id').value = e.target.dataset.id;
                document.getElementById('edit-rating').value = e.target.dataset.rating;
                document.getElementById('edit-content').value = e.target.dataset.content;

                document.getElementById('edit-review-modal').style.display = 'flex';
            });
        });

        // ìˆ˜ì • í¼ ì œì¶œ
        document.getElementById('edit-review-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const reviewId = document.getElementById('edit-review-id').value;
            const newRating = document.getElementById('edit-rating').value;
            const newContent = document.getElementById('edit-content').value;

            const updatedReviewData = {
                userId: Number(currentUserId),
                rating: Number(newRating),
                content: newContent
            };

            try {
                const response = await fetch(`/api/reviews/${reviewId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updatedReviewData)
                });

                if (response.ok) {
                    alert('í›„ê¸°ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    document.getElementById('edit-review-modal').style.display = 'none';
                    fetchReviews(stadiumId, currentUserId);
                } else {
                    const errorText = await response.text();
                    alert(`ìˆ˜ì • ì‹¤íŒ¨: ${errorText}`);
                }
            } catch (error) {
                console.error('Update error:', error);
                alert('ì„œë²„ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        });
    }

    // ===========================
    // 6. ê²½ê¸° ìƒì„± ê´€ë ¨
    // ===========================
    function setupTime() {
        const start = document.getElementById("startTime");
        const end = document.getElementById("endTime");
        const levelSelect = document.getElementById("matchLevel");

        start.innerHTML = "";
        end.innerHTML = "";

        for (let i = 0; i < 24; i++) {
            const t = `${i < 10 ? '0' + i : i}:00`;
            start.innerHTML += `<option>${t}</option>`;
            end.innerHTML += `<option>${t}</option>`;
        }
        start.value = "19:00";
        end.value = "20:00";

        if (levelSelect) {
            levelSelect.value = "ì´ˆê¸‰";
        }
    }

    async function submitMatchForm() {
        const hostId = localStorage.getItem('userId');
        const level = document.getElementById('matchLevel').value;

        if (!hostId) {
            alert("ë¡œê·¸ì¸ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.");
            location.href = '/login';
            return;
        }

        const req = {
            stadiumId: Number(document.getElementById('stadiumId').value),
            hostId: Number(hostId),
            matchDate: document.getElementById('matchDate').value,
            matchTime: document.getElementById('startTime').value,
            maxPlayers: 10,
            level: level
        };

        const res = await fetch('/api/matchrooms', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(req)
        });

        if (res.ok) {
            alert("ê²½ê¸° ìƒì„± ì™„ë£Œ!");
            openMatchModal(false);
        } else {
            alert("ìƒì„± ì‹¤íŒ¨");
        }
    }

    // ===========================
    // 7. ê²½ê¸° ë¦¬ìŠ¤íŠ¸ ë Œë”ë§ & ëª¨ë‹¬
    // ===========================
    function renderMatches(matches, date) {
        const list = document.getElementById('match-list');
        const filtered = matches.filter(m => m.matchDate === date);

        if (filtered.length === 0) {
            list.innerHTML = '<p style="color:#777; padding:10px 0;">ë“±ë¡ëœ ê²½ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
            return;
        }

        filtered.sort((a, b) => a.matchTime.localeCompare(b.matchTime));

        list.innerHTML = filtered.map(m => {
            const isClosed = (m.status === 'CLOSED' || m.status === 'closed');
            const statusText = isClosed ? 'ëª¨ì§‘ ë§ˆê°' : 'ëª¨ì§‘ì¤‘';
            const statusClass = isClosed ? 'closed' : 'open';

            return `
                <div class="match-item" onclick="location.href='/schedule/detail/${m.roomId}'">
                    <div class="match-item-time">${m.matchTime}</div>
                    <div class="match-item-meta">
                        ìµœëŒ€ì¸ì›: ${m.maxPlayers}ëª… Â·
                        <span class="match-status ${statusClass}">${statusText}</span>
                    </div>
                </div>`;
        }).join('');
    }

    function openMatchModal(show) {
        document.getElementById('match-create-modal').style.display =
            show ? 'flex' : 'none';
    }
</script>
</body>
</html>
