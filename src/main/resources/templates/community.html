<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FUTSAL MATCH - ì»¤ë®¤ë‹ˆí‹°</title>

    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

</head>
<body>

<header class="quick-menu">
    <div class="logo"><a href="/">Multi FC</a></div>
    <div class="header-icons">
        <button id="profile-menu-toggle" class="profile-icon" style="position: relative;">
            <i class="fas fa-user-circle"></i>
            <span id="notification-badge" class="notification-badge"></span>
        </button>
        <div id="profile-menu" class="user-menu">
            <div class="user-info">
                <strong><span id="user-menu-username">ì‚¬ìš©ì</span>ë‹˜</strong>
                <p>í™˜ì˜í•©ë‹ˆë‹¤!</p>
            </div>
            <ul>
                <li><a href="/notifications" id="nav-notifications-link"><i class="fas fa-bell"></i> ì•Œë¦¼ ëª©ë¡</a></li>
                <li><a href="/mypage"><i class="fas fa-user"></i> ë§ˆì´í˜ì´ì§€</a></li>
                <li><a href="/profile/edit"><i class="fas fa-user-edit"></i> í”„ë¡œí•„ ìˆ˜ì •</a></li>
                <li><a href="#" id="logout-button"><i class="fas fa-sign-out-alt"></i> ë¡œê·¸ì•„ì›ƒ</a></li>
            </ul>
        </div>
        <button id="menu-toggle" class="menu-toggle-btn"><i class="fas fa-bars"></i></button>
    </div>

    <nav id="main-menu" class="main-nav">
        <ul>
            <li><a href="/"><i class="fas fa-home"></i> ë©”ì¸ (Home)</a></li>
            <li><a href="/fields"><i class="fas fa-search"></i> êµ¬ì¥ê²€ìƒ‰</a></li>
            <li><a href="/community" class="active"><i class="fas fa-users"></i> ì»¤ë®¤ë‹ˆí‹°</a></li>
            <li id="nav-chat-link-li"><a href="/chat" id="nav-chat-link"><i class="fas fa-comments"></i> ì‹¤ì‹œê°„ì±„íŒ…</a></li>
            <li><a href="/schedule?stadium"><i class="fas fa-calendar-check"></i> ê²½ê¸° ì¼ì •</a></li>
            <li><a href="/login" id="nav-login-link"><i class="fas fa-sign-in-alt"></i> ë¡œê·¸ì¸</a></li>
        </ul>
    </nav>
</header>

<main class="community-main">
    <div class="community-board-container">
        <div class="board-controls">
            <div class="board-tabs" id="community-tabs">
                <button data-category="ì „ì²´" class="active">ì „ì²´ëª©ë¡</button>
                <button data-category="ê³µì§€">ê³µì§€ì‚¬í•­</button>
                <button data-category="ììœ ê²Œì‹œíŒ">ììœ ê²Œì‹œíŒ</button>
            </div>
            <a href="/community/write" class="write-button" id="write-post-btn">
                <i class="fas fa-pencil-alt"></i> ê¸€ì“°ê¸°
            </a>
        </div>

        <div class="search-area">
            <select id="search-type">
                <option value="title">ì œëª©</option>
                <option value="content">ë‚´ìš©</option>
                <option value="writer">ì‘ì„±ì</option>
            </select>
            <input type="text" id="search-keyword" placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
            <button id="search-exec-btn"><i class="fas fa-search"></i> ê²€ìƒ‰</button>
        </div>
        <table class="post-table">
            <thead>
            <tr>
                <th style="width: 8%;">ë²ˆí˜¸</th>
                <th style="width: 10%;">ì¹´í…Œê³ ë¦¬</th>
                <th style="width: 45%;">ì œëª©</th> <th style="width: 10%;"><i class="fas fa-comment-dots" title="ëŒ“ê¸€ ìˆ˜"></i></th>
                <th style="width: 12%;">ì‘ì„±ì</th>
                <th style="width: 15%;">ë‚ ì§œ</th>
                <th style="width: 7%;"><i class="fas fa-eye"></i></th>
            </tr>
            </thead>
            <tbody id="post-list-body">
            </tbody>
        </table>

        <div class="pagination" id="community-pagination">
        </div>
    </div>
</main>

<script>
    // --- (â˜…ê³µí†µâ˜…) ë©”ë‰´ í† ê¸€ ë° ë¡œê·¸ì•„ì›ƒ ë¡œì§ (ìœ ì§€) ---
    const menuToggle = document.getElementById('menu-toggle');
    const mainMenu = document.getElementById('main-menu');
    const profileMenuToggle = document.getElementById('profile-menu-toggle');
    const profileMenu = document.getElementById('profile-menu');
    const logoutButton = document.getElementById('logout-button');
    const navNotificationsLink = document.getElementById('nav-notifications-link');

    const navLoginLink = document.getElementById('nav-login-link');
    const navLogoutLink = document.getElementById('nav-logout-link');

    if (menuToggle) {
        menuToggle.addEventListener('click', () => {
            mainMenu.classList.toggle('show');
            if (profileMenu) profileMenu.classList.remove('show');
        });
    }
    if (profileMenuToggle) {
        profileMenuToggle.addEventListener('click', () => {
            profileMenu.classList.toggle('show');
            if (mainMenu) mainMenu.classList.remove('show');
        });
    }
    document.addEventListener('click', (event) => {
        const isClickInsideHeader = document.querySelector('header').contains(event.target);
        if (!isClickInsideHeader) {
            mainMenu.classList.remove('show');
            if (profileMenu) profileMenu.classList.remove('show');
        }
    });

    if (logoutButton) {
        logoutButton.addEventListener('click', (e) => {
            e.preventDefault();
            localStorage.removeItem('accessToken');
            localStorage.removeItem('hasReadReviews');
            localStorage.removeItem('hasReadSchedules');
            window.location.href = '/login';
        });
    }
    if (navLogoutLink) {
        navLogoutLink.addEventListener('click', (e) => {
            e.preventDefault();
            localStorage.removeItem('accessToken');
            localStorage.removeItem('hasReadReviews');
            localStorage.removeItem('hasReadSchedules');
            window.location.href = '/login';
        });
    }

    if (navNotificationsLink) {
        navNotificationsLink.addEventListener('click', (e) => {
            localStorage.setItem('hasReadReviews', 'true');
            window.location.href = '/notifications';
        });
    }

    // --- (â˜…ê³µí†µâ˜…) ì•Œë¦¼ ë°°ì§€ ë¡œë“œ í•¨ìˆ˜ (ìƒëµ) ---
    const badge = document.getElementById('notification-badge');
    let hasReviewNotif = false;
    let hasScheduleNotif = false;
    function updateGlobalBadge() {
        const hasNew = localStorage.getItem('hasNewNotification') === 'true';
        const badge = document.getElementById('notification-badge');
        if (badge) badge.style.display = hasNew ? 'block' : 'none';
    }
    updateGlobalBadge();

    // [ìˆ˜ì •] ë”ë¯¸ë°ì´í„°ë¥¼ ì œê±°í•˜ê³  ë°±ì—”ë“œ APIì™€ ì—°ë™í•˜ê¸° ìœ„í•œ ì¤€ë¹„
    const postListBody = document.getElementById('post-list-body');
    const tabsContainer = document.getElementById('community-tabs');
    const writeButton = document.getElementById('write-post-btn');
    const searchExecBtn = document.getElementById('search-exec-btn');
    const paginationContainer = document.getElementById('community-pagination');

    const POSTS_PER_PAGE = 10;
    const CATEGORY_ALL = 'ì „ì²´'; // [ìˆ˜ì •] 'ì „ì²´' íƒ­ì—ì„œ ì‚¬ìš©í•  ì¹´í…Œê³ ë¦¬ ìƒìˆ˜ ì¶”ê°€
    let currentPage = 1;
    let allFilteredPosts = [];

    // â­ ë°±ì—”ë“œì—ì„œ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
    async function fetchPosts(category) {
        let url = '/api/community/posts';

        // backendê°€ í˜„ì¬ category í•„ìˆ˜ë©´:
        // all â†’ free/notice ë‘ ë²ˆ í˜¸ì¶œí•´ì„œ í•©ì¹˜ê¸°
        // [ìˆ˜ì •] ì „ì²´ê°€ ì•„ë‹Œ ê²½ìš°ì—ë§Œ category íŒŒë¼ë¯¸í„°ë¥¼ ë¶™ì—¬ì„œ ë‹¨ì¼ ì¹´í…Œê³ ë¦¬ ëª©ë¡ì„ ì¡°íšŒ
        if (category && category !== CATEGORY_ALL) {
            url += `?category=${encodeURIComponent(category)}`;
            const res = await fetch(url);
            if (!res.ok) throw new Error('ê²Œì‹œê¸€ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
            return res.json(); // PostListResponse[]
        } else {
            // all: notice + free ë‘ ë²ˆ ë¶ˆëŸ¬ì™€ì„œ í•©ì¹˜ê¸°
            // [ìˆ˜ì •] 'ì „ì²´' íƒ­ì¼ ë•ŒëŠ” ê³µì§€ + ììœ ê²Œì‹œíŒ ë‘ ì¹´í…Œê³ ë¦¬ë¥¼ ê°ê° í˜¸ì¶œí•´ì„œ í•©ì¹œë‹¤
            const [noticeRes, freeRes] = await Promise.all([
                fetch('/api/community/posts?category=ê³µì§€'),
                fetch('/api/community/posts?category=ììœ ê²Œì‹œíŒ')
            ]);
            if (!noticeRes.ok || !freeRes.ok) {
                throw new Error('ê²Œì‹œê¸€ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
            }
            const notice = await noticeRes.json();
            const free = await freeRes.json();
            return [...notice, ...free];
        }
    }



    /**
     * í˜ì´ì§€ë„¤ì´ì…˜ ì»¨íŠ¸ë¡¤ ë Œë”ë§
     */
    function renderPagination(totalPosts, currentPage) {
        const totalPages = Math.ceil(totalPosts / POSTS_PER_PAGE);
        paginationContainer.innerHTML = '';

        if (totalPages <= 1) return;

        // â­â­ [í•µì‹¬ ìˆ˜ì •] í˜ì´ì§€ë„¤ì´ì…˜ ë²„íŠ¼ ìˆ˜ ì¡°ì • (ìš”ì²­: 10ê°œê¹Œì§€ í‘œì‹œ) â­â­
        const pagesPerGroup = 10;
        const currentGroup = Math.ceil(currentPage / pagesPerGroup);
        const startPage = (currentGroup - 1) * pagesPerGroup + 1;
        const endPage = Math.min(startPage + pagesPerGroup - 1, totalPages);

        // --- ë²„íŠ¼ ë Œë”ë§ ---

        // ì´ì „ ê·¸ë£¹/í˜ì´ì§€ ë§í¬ (ë‹¨ìˆœ ì´ì „ í˜ì´ì§€ë¡œ ì´ë™)
        const prevGroupPage = currentPage > 1 ? currentPage - 1 : 1;
        const prevDisabled = currentPage === 1;
        paginationContainer.innerHTML += `<a href="#" data-page="${prevGroupPage}" class="${prevDisabled ? 'disabled' : ''}">&lt;</a>`;

        // í˜ì´ì§€ ë²ˆí˜¸
        for (let i = startPage; i <= endPage; i++) {
            paginationContainer.innerHTML += `<a href="#" data-page="${i}" class="${i === currentPage ? 'active' : ''}">${i}</a>`;
        }

        // ë‹¤ìŒ ê·¸ë£¹/í˜ì´ì§€ ë§í¬ (ë‹¨ìˆœ ë‹¤ìŒ í˜ì´ì§€ë¡œ ì´ë™)
        const nextGroupPage = currentPage < totalPages ? currentPage + 1 : totalPages;
        const nextDisabled = currentPage === totalPages;
        paginationContainer.innerHTML += `<a href="#" data-page="${nextGroupPage}" class="${nextDisabled ? 'disabled' : ''}">&gt;</a>`;

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¬í• ë‹¹
        // [ìˆ˜ì •] í˜ì´ì§€ ë²„íŠ¼ í´ë¦­ ì‹œ, í˜„ì¬ ì„ íƒëœ íƒ­/ê²€ìƒ‰ ì¡°ê±´ì„ ìœ ì§€í•œ ì±„ë¡œ í•´ë‹¹ í˜ì´ì§€ë¥¼ ë‹¤ì‹œ ë Œë”ë§
        paginationContainer.querySelectorAll('a').forEach(link => {
            if (!link.classList.contains('disabled')) {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const newPage = parseInt(e.target.dataset.page);
                    if (newPage > 0 && newPage <= totalPages) {
                        // í˜„ì¬ íƒ­ê³¼ ê²€ìƒ‰ ì¡°ê±´ì„ ìœ ì§€í•˜ë©´ì„œ í˜ì´ì§€ ë³€ê²½
                        renderPostList(
                            document.querySelector('.board-tabs button.active').dataset.category,
                            document.getElementById('search-keyword').value,
                            document.getElementById('search-type').value,
                            newPage
                        );
                    }
                });
            }
        });
    }

    // [ìˆ˜ì •] ê²Œì‹œê¸€ ëª©ë¡ì„ ë°±ì—”ë“œ ë°ì´í„°ë¡œ ë Œë”ë§í•˜ëŠ” í•¨ìˆ˜ë¡œ ë³€ê²½
    async function renderPostList(category, searchKeyword = '', searchType = 'title', page = 1) {
        try {
            let posts = await fetchPosts(category); // [ìˆ˜ì •] í•­ìƒ ë°±ì—”ë“œì—ì„œ ìµœì‹  ëª©ë¡ì„ ë°›ì•„ì˜´

            // ê²€ìƒ‰
            if (searchKeyword) {
                const keyword = searchKeyword.toLowerCase();
                posts = posts.filter(post => {
                    if (searchType === 'title') {
                        return post.title.toLowerCase().includes(keyword);
                    }
                    if (searchType === 'writer') {
                        return (post.writerNickname || '').toLowerCase().includes(keyword);
                    }
                    // ë‚´ìš© ê²€ìƒ‰ì€ ì„œë²„ì— ë”°ë¡œ ê²€ìƒ‰
                    return false;
                });
            }

            allFilteredPosts = posts;
            const totalPosts = allFilteredPosts.length;
            const startIndex = (page - 1) * POSTS_PER_PAGE;
            const postsToDisplay = allFilteredPosts.slice(startIndex, startIndex + POSTS_PER_PAGE);

            postListBody.innerHTML = '';

            if (totalPosts === 0) {
                postListBody.innerHTML = `
                <tr>
                    <td colspan="7" style="text-align: center; color: #999; padding: 50px;">
                        ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤.
                    </td>
                </tr>
            `;
                renderPagination(0, 1);
                return;
            }

            postsToDisplay.forEach((post, index) => {
                const row = document.createElement('tr');
                row.dataset.postId = post.postId;

                const sequentialId = startIndex + index + 1;
                // [ìˆ˜ì •] DB ENUM ê°’(ê³µì§€ / ììœ ê²Œì‹œíŒ)ì— ë§ì¶° ì¹´í…Œê³ ë¦¬ í‘œì‹œ
                const categoryDisplay = post.category === 'ì „ì²´' ? 'ê³µì§€' : 'ììœ ';

                row.innerHTML = `
                <td>${sequentialId}</td>
                <td class="col-category">${categoryDisplay}</td>
                <td class="col-title" onclick="location.href='/community/detail/${post.postId}'">
                    ${post.title}
                </td>
                <td>${post.commentCount ?? 0}</td>
                <td>${post.writerNickname}</td>
                <td>${post.createdAt ?? ''}</td>
                <td>${post.viewCount ?? 0}</td>
            `;
                postListBody.appendChild(row);
            });

            renderPagination(totalPosts, page);
        } catch (err) {
            console.error(err);
            postListBody.innerHTML = `
            <tr>
                <td colspan="7" style="text-align: center; color: #e74c3c; padding: 50px;">
                    ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.
                </td>
            </tr>
        `;
        }
    }


    // [ìˆ˜ì •] ê²€ìƒ‰ ì‹¤í–‰ í•¨ìˆ˜ì—ì„œ 'ì „ì²´' íƒ­ì¼ ë•Œ CATEGORY_ALL ìƒìˆ˜ë¥¼ ì‚¬ìš©í•˜ë„ë¡ ë³€ê²½
    if (searchExecBtn) {
        searchExecBtn.addEventListener('click', () => {
            const activeTab = document.querySelector('.board-tabs button.active');
            const category = activeTab ? activeTab.dataset.category : CATEGORY_ALL; // [ìˆ˜ì •] ê¸°ë³¸ê°’ì„ 'ì „ì²´' ìƒìˆ˜ë¡œ
            const keyword = document.getElementById('search-keyword').value;
            const type = document.getElementById('search-type').value;

            renderPostList(category, keyword, type, 1);
        });
    }


    // --- ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ ---
    document.addEventListener('DOMContentLoaded', () => {
        const accessToken = localStorage.getItem('accessToken');
        const profileIcon = document.getElementById('profile-menu-toggle');
        const userMenuName = document.getElementById('user-menu-username');
        const navLoginLink = document.getElementById('nav-login-link'); // ğŸ”¥ ì—¬ê¸°ì„œ ë‹¤ì‹œ ê°€ì ¸ì™€ë„ ë¨

        if (accessToken) {
            // ë¡œê·¸ì¸ ìƒíƒœ
            if (profileIcon) profileIcon.style.display = 'flex';
            if (userMenuName) {
                const nickname = localStorage.getItem('username') || 'ì‚¬ìš©ì';
                userMenuName.textContent = nickname;
            }

            // ğŸ”¥ ë¡œê·¸ì¸ ë©”ë‰´ ìˆ¨ê¸°ê¸°
            if (navLoginLink && navLoginLink.parentElement) {
                navLoginLink.parentElement.style.display = 'none';
            }

            updateGlobalBadge();
            window.addEventListener('storage', (e) => {
                if (e.key === 'hasNewNotification') updateGlobalBadge();
            });
        } else {
            // ë¹„ë¡œê·¸ì¸ ìƒíƒœ
            if (profileIcon) profileIcon.style.display = 'none';

            // ğŸ”¥ ë¡œê·¸ì¸ ë©”ë‰´ ë³´ì´ê²Œ
            if (navLoginLink && navLoginLink.parentElement) {
                navLoginLink.parentElement.style.display = 'list-item';
            }
        }

        // [ê¸°ì¡´ ì½”ë“œë“¤ ê·¸ëŒ€ë¡œ ìœ ì§€]
        const tabs = tabsContainer.querySelectorAll('button');
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById('search-keyword').value = '';
                renderPostList(tab.dataset.category, '', 'title', 1);
            });
        });

        renderPostList(CATEGORY_ALL);

        document.querySelectorAll('.post-table').forEach(table => {
            table.addEventListener('click', function(e) {
                const titleCell = e.target.closest('.col-title');
                if (titleCell) {
                    const postId = String(titleCell.closest('tr').dataset.postId);
                    location.href = `/community/detail/${postId}`;
                }
            });
        });
    });
</script>


</body>
</html>