<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi FC - ë©”ì¸ í˜ì´ì§€</title> <link rel="stylesheet" th:href="@{/css/style.css?v=219}">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        /* ê¸°ì¡´ main.html ë‚´ì˜ ìŠ¤íƒ€ì¼ì„ IAMGROUND ìŠ¤íƒ€ì¼ì— ë§ê²Œ ì •ë¦¬ */

        .main-content {
            /* ì´ í´ë˜ìŠ¤ëŠ” ì „ì²´ í˜ì´ì§€ ë ˆì´ì•„ì›ƒì„ ìœ„í•´ ê·¸ëŒ€ë¡œ ì‚¬ìš© */
            min-height: 100vh;
            /* Hero ì„¹ì…˜ ì•„ë˜ ì½˜í…ì¸ ë“¤ì´ body ë°°ê²½ ìœ„ë¡œ ì˜¬ë¼ì˜¤ë„ë¡ íˆ¬ëª…í•˜ê²Œ ì„¤ì • */
            background: transparent;
            padding: 0;
        }

        /* Hero ì„¹ì…˜ ì•„ë˜ ì½˜í…ì¸ ë“¤ì´ body ë°°ê²½ ìœ„ë¡œ ì˜¬ë¼ì˜¤ë„ë¡ íˆ¬ëª…í•˜ê²Œ ì„¤ì • */
        #upcoming-schedule-section, #review-notification-section {
            position: relative;
            z-index: 10; /* ë¹„ë””ì˜¤ ë°°ê²½ ìœ„ì— ì˜¤ë„ë¡ */
        }

        /* â­â­â­ [ì¶”ê°€] ì•Œë¦¼ ë°°ë„ˆ ë‹«ê¸° ë²„íŠ¼ ìŠ¤íƒ€ì¼ â­â­â­ */
        #review-notification-section {
            /* ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€: flexë¥¼ ì‚¬ìš©í–ˆë‹¤ëŠ” ê°€ì • í•˜ì— paddingì„ ì¡°ì • */
            position: relative;
            padding-right: 40px; /* ë‹«ê¸° ë²„íŠ¼ ê³µê°„ í™•ë³´ */
        }
        .close-review-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: none;
            border: none;
            color: white;
            font-size: 16px;
            cursor: pointer;
            padding: 5px;
            opacity: 0.6;
            transition: opacity 0.2s;
            line-height: 1;
            z-index: 20;
        }
        .close-review-btn:hover {
            opacity: 1;
        }
        /* â­â­â­ [ì¶”ê°€ ë] â­â­â­ */

        /* ë¹„íšŒì› ë¡œê·¸ì¸ ìœ ë„ ë²„íŠ¼ì€ hero ì„¹ì…˜ ì•„ë˜ì— ë°°ì¹˜ë˜ë„ë¡ ì¡°ì • */
        .login-prompt-button {
            z-index: 50;
            display: inline-block;
            margin: 10px 5px 0 5px;
            padding: 10px 20px;
            font-size: 16px;
            font-weight: 600;
            color: white;
            background: #6c5ce7;
            border-radius: 25px;
            text-decoration: none;
            transition: background 0.3s;
        }

        /* â­â­â­ ìŠ¬ë¼ì´ë” ì•„ì´í…œ ìŠ¤íƒ€ì¼ (ì´ì „ ìš”ì²­ì˜ ìµœì¢… ìˆ˜ì • ë‚´ìš© ìœ ì§€) â­â­â­ */
        .schedule-item {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(240, 240, 240, 0.95)) !important;
            color: #2c3e50 !important;
            border: 1px solid rgba(0,0,0,0.1);
            text-align: left;
        }
        .schedule-item strong {
            font-size: 17px;
            color: #2c3e50;
            display: block;
            margin-bottom: 5px;
        }
        .schedule-item .item-location {
            font-size: 14px;
            color: #555;
            display: flex;
            align-items: center;
        }
        .schedule-item .item-location i {
            margin-right: 5px;
            color: #8e44ad;
        }
        .schedule-item .item-type {
            font-size: 13px;
            font-weight: 700;
            color: #e74c3c;
            margin-bottom: 5px;
        }
        /* â­â­â­ ìŠ¬ë¼ì´ë” ì•„ì´í…œ ìŠ¤íƒ€ì¼ ë â­â­â­ */

    </style>
</head>
<body>

<header class="quick-menu">
    <div class="logo"><a href="/">Multi FC</a></div>
    <div class="header-icons">
        <button id="profile-menu-toggle" class="profile-icon" style="position: relative;">
            <i class="fas fa-user-circle"></i>
            <span id="notification-badge" class="notification-badge"></span>
        </button>
        <div id="profile-menu" class="user-menu">
            <div class="user-info">
                <strong><span id="user-menu-username">ì‚¬ìš©ì</span>ë‹˜</strong>
                <p>í™˜ì˜í•©ë‹ˆë‹¤!</p>
            </div>
            <ul>
                <li><a href="/notifications" id="nav-notifications-link"><i class="fas fa-bell"></i> ì•Œë¦¼ ëª©ë¡</a></li>
                <li><a href="/mypage"><i class="fas fa-user"></i> ë§ˆì´í˜ì´ì§€</a></li>
                <li><a href="/profile/edit"><i class="fas fa-user-edit"></i> í”„ë¡œí•„ ìˆ˜ì •</a></li>
                <li><a href="#" id="logout-button"><i class="fas fa-sign-out-alt"></i> ë¡œê·¸ì•„ì›ƒ</a></li>
            </ul>
        </div>
        <button id="menu-toggle" class="menu-toggle-btn"><i class="fas fa-bars"></i></button>
    </div>

    <nav id="main-menu" class="main-nav">
        <ul>
            <li><a href="/" class="active"><i class="fas fa-home"></i> ë©”ì¸ (Home)</a></li>
            <li><a href="/fields"><i class="fas fa-search"></i> êµ¬ì¥ê²€ìƒ‰</a></li>
            <li><a href="/community"><i class="fas fa-users"></i> ì»¤ë®¤ë‹ˆí‹°</a></li>
            <li id="nav-chat-link-li"><a href="/chat" id="nav-chat-link"><i class="fas fa-comments"></i> ì‹¤ì‹œê°„ì±„íŒ…</a></li>
            <li><a href="/login" id="nav-login-link"><i class="fas fa-sign-in-alt"></i> ë¡œê·¸ì¸</a></li>
            <li><a href="#" id="nav-logout-link"><i class="fas fa-sign-out-alt"></i> ë¡œê·¸ì•„ì›ƒ</a></li>
        </ul>
    </nav>
</header>

<div class="video-background">
    <video poster="" autoplay muted loop>
    </video>
</div>
<div class="video-overlay"></div>

<main class="main-content">

    <section class="hero-section">

        <div id="no-schedule-view-hero" style="display:none; position:relative; z-index:50;">
            <p class="no-schedule-message" style="color:white; font-size:1.5rem; text-shadow: 0 0 5px black;">
                ë¡œê·¸ì¸í•˜ê³  7ì¼ ì´ë‚´ì˜<br>ë‚˜ì˜ ì¼ì •ì„ í™•ì¸í•˜ì„¸ìš”! âš½
            </p>
            <div style="text-align: center; margin-top: 20px;">
                <a href="/login" class="login-prompt-button" style="background: #e74c3c;">ë¡œê·¸ì¸</a>
                <a href="/register" class="login-prompt-button" style="background: #2c3e50;">íšŒì›ê°€ì…</a>
            </div>
        </div>

        <div id="member-content-area" style="position:relative; z-index:50;">
            <div id="review-notification-section">
            </div>
            <div id="upcoming-schedule-section">
                <h2 class="schedule-title">ğŸ“… 7ì¼ ì´ë‚´ì˜ ì¼ì •</h2>
                <div class="schedule-slider-container" style="display:none;">
                    <div class="slider-controls-wrapper">
                        <button id="schedule-prev" class="slider-arrow prev" style="display: none;">&lt;</button>
                        <div class="schedule-slider-viewport">
                            <div id="schedule-list-items">
                            </div>
                        </div>
                        <button id="schedule-next" class="slider-arrow next" style="display: none;">&gt;</button>
                    </div>
                    <div class="slider-pagination" id="schedule-pagination">
                    </div>
                </div>
                <div id="no-schedule-view" style="display:none;">
                </div>
            </div>
        </div>

        <h1 class="hero-message">Multi FC</h1> <h2 class="hero-sub-message">ì‹¤ì‹œê°„ í’‹ì‚´ ë§¤ì¹­, ì§€ê¸ˆ ì‹œì‘í•˜ì„¸ìš”!</h2>

        <a href="/fields" class="cta-button" style="z-index:50; position:relative;">ë§¤ì¹˜ ì°¾ì•„ë³´ê¸°</a>

    </section>

    <section class="value-section">
        <h2 style="font-size: 30px; font-weight: 800; margin-bottom: 50px;">ì„œë¹„ìŠ¤ í•µì‹¬ ê°€ì¹˜</h2>
        <div class="value-grid">

            <div class="value-card">
                <i class="fas fa-bolt"></i>
                <h3>ì´ˆê³ ì† ë§¤ì¹­</h3>
                <p>ìµœì í™”ëœ ì•Œê³ ë¦¬ì¦˜ìœ¼ë¡œ ëŒ€ê¸° ì‹œê°„ ì—†ì´ ì¦‰ì‹œ íŒ€ì›ì„ ì°¾ê³  ê²½ê¸°ë¥¼ í™•ì •í•©ë‹ˆë‹¤.</p>
            </div>

            <div class="value-card">
                <i class="fas fa-shield-alt"></i>
                <h3>ë§¤ë„ˆ ì‹œìŠ¤í…œ</h3>
                <p>í‰ì  ê¸°ë°˜ì˜ ì—„ê²©í•œ ë§¤ë„ˆ ê´€ë¦¬ë¡œ ë¶ˆì¾Œí•œ ê²½í—˜ ì—†ëŠ” ê¹¨ë—í•œ í’‹ì‚´ í™˜ê²½ì„ ì œê³µí•©ë‹ˆë‹¤.</p>
            </div>

            <div class="value-card">
                <i class="fas fa-sync-alt"></i>
                <h3>ì‹¤ì‹œê°„ ë™ê¸°í™”</h3>
                <p>ì¼ì • ë³€ê²½, ì±„íŒ…, ì°¸ì—¬ í˜„í™© ë“± ëª¨ë“  ì •ë³´ê°€ ì‹¤ì‹œê°„ìœ¼ë¡œ ë™ê¸°í™”ë˜ì–´ ì¦‰ê°ì ì¸ ëŒ€ì‘ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
            </div>

            <div class="value-card">
                <i class="fas fa-map-marker-alt"></i>
                <h3>ì§€ë„ ê¸°ë°˜ ê²€ìƒ‰</h3>
                <p>í˜„ì¬ ìœ„ì¹˜ì™€ í™œë™ ë°˜ê²½ì— ë§ì¶˜ ì •êµí•œ êµ¬ì¥ ê²€ìƒ‰ìœ¼ë¡œ ì´ë™ ì‹œê°„ì„ ìµœì†Œí™”í•©ë‹ˆë‹¤.</p>
            </div>
        </div>
    </section>

    <section class="chat-promo-section">
        <h2><i class="fas fa-comments" style="color:#2ecc71; margin-right: 10px;"></i> ì‹¤ì‹œê°„ ì†Œí†µ ì±„ë„</h2>
        <div class="chat-promo-box">
            <p>
                í˜„ì¬ ì§„í–‰ ì¤‘ì¸ ë§¤ì¹­ë°©, íŒ€ì› ëª¨ì§‘ë°©, ììœ  ìˆ˜ë‹¤ë°©ì—ì„œ<br>
                ë‹¤ë¥¸ ìœ ì €ë“¤ê³¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ì†Œí†µí•˜ê³  ì •ë³´ë¥¼ êµí™˜í•˜ì„¸ìš”.
            </p>
            <a id="chat-promo-link" href="/chat" class="chat-action-link">
                ì±„íŒ… ì°¸ì—¬í•˜ê¸°
            </a>
        </div>
    </section>

    <section id="features-section">
        <h2 style="font-size: 36px; color: #2c3e50; margin-bottom: 60px; font-weight:900;">Multi FC, ì£¼ìš” ì„œë¹„ìŠ¤</h2> <div class="features-grid">

        <div class="feature-card">
            <div class="icon-wrapper">
                <i class="fas fa-map-marked-alt"></i>
            </div>
            <h3>ìµœì ì˜ êµ¬ì¥ ê²€ìƒ‰</h3>
            <p>ìœ„ì¹˜, ì¸ì›, ì‹œê°„ëŒ€ë³„ ë§ì¶¤í˜• í•„í„°ë¡œ ì£¼ë³€ í’‹ì‚´ì¥ì„ ë¹ ë¥´ê²Œ ì°¾ì•„ë³´ì„¸ìš”. ì§€ë„ ì—°ë™ìœ¼ë¡œ ì ‘ê·¼ì„±ì„ ë†’ì…ë‹ˆë‹¤.</p>
            <a href="/fields" class="card-link">êµ¬ì¥ ì°¾ê¸°</a>
        </div>

        <div class="feature-card">
            <div class="icon-wrapper">
                <i class="fas fa-calendar-alt"></i>
            </div>
            <h3>ì‹¤ì‹œê°„ ë§¤ì¹˜ ìŠ¤ì¼€ì¤„</h3>
            <p>íŒ€ ë˜ëŠ” ê°œì¸ ë§¤ì¹˜ ì¼ì •ì„ ë“±ë¡í•˜ê³ , ë‚¨ì€ ì¸ì›ì„ í™•ì¸í•˜ì„¸ìš”. ëª¨ë“  ì°¸ì—¬ìëŠ” ì•Œë¦¼ì„ í†µí•´ ì¼ì •ì„ ê´€ë¦¬í•©ë‹ˆë‹¤.</p>
            <a href="/schedule" class="card-link">ì¼ì • í™•ì¸</a>
        </div>

        <div class="feature-card">
            <div class="icon-wrapper">
                <i class="fas fa-users"></i>
            </div>
            <h3>ë§¤ë„ˆ ê¸°ë°˜ ì»¤ë®¤ë‹ˆí‹°</h3>
            <p>ë§¤ì¹˜ í›„ íŒ€ì›ì„ í‰ê°€í•˜ì—¬ ì‹ ë¢°ë„ë¥¼ ìŒ“ìœ¼ì„¸ìš”. ì‹¤ì‹œê°„ ì±„íŒ…ê³¼ ììœ ê²Œì‹œíŒì„ í†µí•´ í™œë°œí•˜ê²Œ ì†Œí†µí•©ë‹ˆë‹¤.</p>
            <a href="/community" class="card-link">ì»¤ë®¤ë‹ˆí‹° ë°”ë¡œê°€ê¸°</a>
        </div>
    </div>
    </section>

    <section class="global-cta-section" id="global-cta-register">
        <h2>ì§€ê¸ˆ ë°”ë¡œ ë‹¹ì‹ ì˜ í’‹ì‚´ íŒ€ì„ ì°¾ìœ¼ì„¸ìš”!</h2>
        <a href="/register" class="login-button" style="width: 300px; margin: 0 auto; text-decoration: none;">ê³„ì • ìƒì„±í•˜ê³  ì‹œì‘í•˜ê¸°</a>
    </section>

</main>

<footer class="project-footer">
    <div class="footer-content">
        <p>
            í”„ë¡œì íŠ¸ ì¡°ëª… : Multi FC <br>
            í”„ë¡œì íŠ¸ íŒ€ì› : íŒ€ì¥ - ë°•íƒœë€ / íŒ€ì› - ê¶Œì„±ë¯¼, ë¬¸ì§„ìš°, ìœ¤ìŠ¹ê·¼, ìµœì¤€í˜¸, í™ì˜ˆë¦° <br>
            ë‹´ë‹¹ ì—…ë¬´ : í”„ë¡ íŠ¸- ìœ¤ìŠ¹ê·¼(ì¡°ì¥), ê¶Œì„±ë¯¼ / ë°±ì—”ë“œ - ë°•íƒœë€(ì¡°ì¥), ë¬¸ì§„ìš°, ìµœì¤€í˜¸, í™ì˜ˆë¦° <br>
            í”„ë¡œì íŠ¸ ì£¼ì œ : WebSocket ê¸°ë°˜ ì‹¤ì‹œê°„ ìŠ¤í¬ì¸  ë§¤ì¹­ í”Œë«í¼
        </p>
    </div>
</footer>
<script>
    // --- (â˜…ê³µí†µâ˜…) ë©”ë‰´ í† ê¸€ ë° ë¡œê·¸ì•„ì›ƒ ë¡œì§ ---
    const menuToggle = document.getElementById('menu-toggle');
    const mainMenu = document.getElementById('main-menu');
    const profileMenuToggle = document.getElementById('profile-menu-toggle');
    const profileMenu = document.getElementById('profile-menu');
    const logoutButton = document.getElementById('logout-button');
    const navNotificationsLink = document.getElementById('nav-notifications-link');
    const navLoginLink = document.getElementById('nav-login-link');
    const navLogoutLink = document.getElementById('nav-logout-link');

    // â­â­ ì¶”ê°€ëœ ì„ íƒì: ë©”ë‰´ë°”ì˜ ì±„íŒ… ë§í¬ â­â­
    const navChatLinkElement = document.getElementById('nav-chat-link');

    if (menuToggle) {
        menuToggle.addEventListener('click', () => {
            mainMenu.classList.toggle('show');
            profileMenu.classList.remove('show');
        });
    }
    if (profileMenuToggle) {
        profileMenuToggle.addEventListener('click', () => {
            profileMenu.classList.toggle('show');
            mainMenu.classList.remove('show');
        });
    }
    document.addEventListener('click', (event) => {
        if (!mainMenu.contains(event.target) && !menuToggle.contains(event.target) &&
            !profileMenu.contains(event.target) && !profileMenuToggle.contains(event.target)) {
            mainMenu.classList.remove('show');
            profileMenu.classList.remove('show');
        }
    });

    if (logoutButton) {
        logoutButton.addEventListener('click', (e) => {
            e.preventDefault();
            localStorage.removeItem('accessToken');
            localStorage.removeItem('username'); //
            localStorage.removeItem('hasReadReviews');
            localStorage.removeItem('hasReadSchedules');
            window.location.href = '/login';
        });
    }
    if (navLogoutLink) {
        navLogoutLink.addEventListener('click', (e) => {
            e.preventDefault();
            localStorage.removeItem('accessToken');
            localStorage.removeItem('hasReadReviews');
            localStorage.removeItem('hasReadSchedules');
            window.location.href = '/login';
        });
    }

    if (navNotificationsLink) {
        navNotificationsLink.addEventListener('click', (e) => {
            e.preventDefault();
            localStorage.setItem('hasReadReviews', 'true');
            localStorage.setItem('hasReadSchedules', 'true');
            window.location.href = '/notifications';
        });
    }

    // --- (â˜…ê³µí†µâ˜…) ì•Œë¦¼ ë°°ì§€ ë¡œë“œ í•¨ìˆ˜ ---
    const badge = document.getElementById('notification-badge');
    let hasReviewNotif = false;
    let hasScheduleNotif = false;

    // â­ [ìˆ˜ì •] í›„ê¸° ì‘ì„±ì´ í•„ìš”í•œ êµ¬ì¥ ID ëª©ë¡ (ë™ì ìœ¼ë¡œ ê°€ì ¸ì˜´)
    let pendingReviewStadiumIds = [];

    // â­ [ì¶”ê°€] ë‹¤ê°€ì˜¤ëŠ” ì¼ì • ë°ì´í„° (ì‹¤ì œ API ì‘ë‹µ ì €ì¥ìš©)
    let upcomingSchedules = [];

    function updateGlobalBadge() {
        if (pendingReviewStadiumIds.length > 0 || hasScheduleNotif) {
            if (badge) badge.style.display = 'block';
        } else {
            if (badge) badge.style.display = 'none';
        }
    }

    async function checkPendingReviews() {
        if (localStorage.getItem('hasReadReviews') === 'true') {
            hasReviewNotif = false;
            return;
        }

        const currentUserId = localStorage.getItem('userId');
        if (!currentUserId) return; // ë¡œê·¸ì¸ ì•ˆ í–ˆìœ¼ë©´ í†µê³¼

        try {
            // â­ [ìˆ˜ì •] ìƒˆë¡œìš´ API í˜¸ì¶œ: ë¡œê·¸ì¸ëœ ì‚¬ìš©ìê°€ í›„ê¸° ì‘ì„±ì´ í•„ìš”í•œ êµ¬ì¥ ID ëª©ë¡ì„ ê°€ì ¸ì˜´
            const response = await fetch(`/api/reviews/pending-stadiums?userId=${currentUserId}`);

            if (response.ok) {
                const ids = await response.json();
                pendingReviewStadiumIds = ids;

                if (ids && ids.length > 0) {
                    hasReviewNotif = true;
                } else {
                    hasReviewNotif = false;
                }
            }
        } catch (error) {
            console.error("í›„ê¸° ì•Œë¦¼ ìš”ì²­ ì¤‘ ì˜¤ë¥˜:", error);
            hasReviewNotif = false;
        }
    }

    async function checkUpcomingSchedules() {
        if (localStorage.getItem('hasReadSchedules') === 'true') {
            hasScheduleNotif = false;
            return;
        }

        const accessToken = localStorage.getItem('accessToken');
        if (!accessToken) {
            hasScheduleNotif = false;
            return;
        }

        try {
            const response = await fetch(`/api/schedule/upcoming`, {
                headers: {
                    'Authorization': 'Bearer ' + accessToken,
                    'Content-Type': 'application/json'
                }
            });

            if (response.ok) {
                const data = await response.json();

                upcomingSchedules = data.map(item => ({
                    id: item.scheduleId,
                    matchId: item.matchId,
                    type: item.scheduleType,    // "ê²½ê¸°" / "ê°œì¸"
                    date: item.scheduleDate,
                    time: item.scheduleTime,
                    title: item.title
                }));

                hasScheduleNotif = upcomingSchedules.length > 0;
            } else {
                console.error("ë‹¤ê°€ì˜¤ëŠ” ì¼ì • ì¡°íšŒ ì‹¤íŒ¨:", response.status);
                hasScheduleNotif = false;
                upcomingSchedules = [];
            }
        } catch (error) {
            console.error("ì¼ì • ìš”ì²­ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
            hasScheduleNotif = false;
            upcomingSchedules = [];
        }
    }


    // â­â­ [ì¶”ê°€] ì•Œë¦¼ ë‹«ê¸° ë¡œì§: ë¦¬ë·° ì•Œë¦¼ ë°°ë„ˆ ìˆ¨ê¸°ê¸° â­â­
    function closeReviewNotification() {
        const reviewSection = document.getElementById('review-notification-section');
        if (reviewSection) {
            reviewSection.style.display = 'none';
        }
    }
    // â­â­ [ì¶”ê°€ ë] â­â­


    // --- (â˜…í˜ì´ì§€ë³„â˜…) ë¡œì§ ì‹¤í–‰ ---
    document.addEventListener('DOMContentLoaded', async () => {

        // â­ï¸ 1. SSO ë¡œê·¸ì¸ í›„ ì²˜ë¦¬ (í† í° ì €ì¥ + ë‚´ ì •ë³´ ê°€ì ¸ì˜¤ê¸°) â­ï¸
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');

        if (token) {
            // (1) í† í° ì €ì¥
            localStorage.setItem('accessToken', token);

            // (2) URL ì •ë¦¬
            window.history.replaceState({}, document.title, "/");

            // (3) ë‚´ ì •ë³´(ë‹‰ë„¤ì„) ê°€ì ¸ì˜¤ê¸° API í˜¸ì¶œ
            try {
                const response = await fetch('/api/users/me', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });

                if (response.ok) {
                    const userData = await response.json();
                    // ë‹‰ë„¤ì„ê³¼ ì•„ì´ë””ë¥¼ ì €ì¥ (í™”ë©´ í‘œì‹œì— ì‚¬ìš©ë¨)
                    localStorage.setItem('username', userData.nickname);
                    localStorage.setItem('userId', userData.username);
                }
            } catch (e) {
                console.error("ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨", e);
            }

        }

        const accessToken = localStorage.getItem('accessToken');
        const loggedInUsername = localStorage.getItem('username'); //
        const mainLoginLink = document.getElementById('main-login-link');
        const heroSection = document.querySelector('.hero-section');
        const memberContentArea = document.getElementById('member-content-area');
        const noScheduleViewHero = document.getElementById('no-schedule-view-hero');
        const chatPromoLink = document.getElementById('chat-promo-link');
        const globalCtaRegister = document.getElementById('global-cta-register'); // â­ ì¶”ê°€ëœ CTA ì„¹ì…˜ ID â­


        const scheduleSection = document.getElementById('upcoming-schedule-section');
        const reviewSection = document.getElementById('review-notification-section');

        // ìŠ¬ë¼ì´ë” ë¡œì§ ë³€ìˆ˜
        let currentIndex = 0;
        let totalSlides = 0;
        const sliderTrack = document.getElementById('schedule-list-items');
        const prevBtn = document.getElementById('schedule-prev');
        const nextBtn = document.getElementById('schedule-next');
        const noScheduleView = document.getElementById('no-schedule-view');
        const sliderContainer = document.querySelector('.schedule-slider-container');
        const paginationContainer = document.getElementById('schedule-pagination');

        function moveSlider() {
            if (sliderTrack && sliderTrack.querySelector('.schedule-item')) {
                // ì•„ì´í…œ í•˜ë‚˜ ë„ˆë¹„(500px + ì¢Œìš° ë§ˆì§„ 20px)ë¥¼ ê³„ì‚°í•˜ì—¬ ì´ë™
                const itemWidth = sliderTrack.querySelector('.schedule-item').offsetWidth + 20;
                sliderTrack.style.transform = `translateX(-${currentIndex * itemWidth}px)`;
            }
        }
        function updatePaginationDots() {
            if (paginationContainer) {
                const dots = paginationContainer.querySelectorAll('.dot');
                dots.forEach((dot, index) => {
                    if (index === currentIndex) {
                        dot.classList.add('active');
                    } else {
                        dot.classList.remove('active');
                    }
                });
            }
        }
        function updateSliderControls() {
            if (prevBtn && nextBtn && sliderContainer) {
                // ì•„ì´í…œì´ 1ê°œ ì´ˆê³¼ì¼ ë•Œë§Œ ì»¨íŠ¸ë¡¤ í‘œì‹œ
                if (totalSlides > 1) {
                    prevBtn.style.display = (currentIndex === 0) ? 'none' : 'block';
                    nextBtn.style.display = (currentIndex === totalSlides - 1) ? 'none' : 'block';
                } else {
                    prevBtn.style.display = 'none';
                    nextBtn.style.display = 'none';
                }
            }
        }
        if(nextBtn) nextBtn.addEventListener('click', () => {
            if (currentIndex < totalSlides - 1) {
                currentIndex++;
                moveSlider();
                updateSliderControls();
                updatePaginationDots();
            }
        });
        if(prevBtn) prevBtn.addEventListener('click', () => {
            if (currentIndex > 0) {
                currentIndex--;
                moveSlider();
                updateSliderControls();
                updatePaginationDots();
            }
        });

        // í˜ì´ì§€ë„¤ì´ì…˜ ì  í´ë¦­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        if(paginationContainer) {
            paginationContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('dot')) {
                    currentIndex = parseInt(e.target.dataset.index);
                    moveSlider();
                    updateSliderControls();
                    updatePaginationDots();
                }
            });
        }


        // (â˜…ìˆ˜ì •â˜…) ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
        if (accessToken) {
            // [íšŒì›ì¼ ë•Œ] - Hero ì„¹ì…˜ì— ì¼ì •/ì•Œë¦¼ í‘œì‹œ
            if (profileMenuToggle) profileMenuToggle.style.display = 'block';
            if (navLoginLink) navLoginLink.parentElement.style.display = 'none';
            if (navLogoutLink) navLogoutLink.parentElement.style.display = 'list-item';

            const userMenuUsername = document.getElementById('user-menu-username');
            if (userMenuUsername) {
                console.log("âœ… [main.html] í˜„ì¬ localStorage ë‹‰ë„¤ì„ ê°’:", loggedInUsername);
                userMenuUsername.textContent = loggedInUsername; // í—¤ë” ë‹‰ë„¤ì„ ë³€ê²½
            }

            // Hero ì„¹ì…˜ í•˜ë‹¨ì˜ ë¡œê·¸ì¸ ìœ ë„ í…ìŠ¤íŠ¸ ìˆ¨ê¹€
            if (mainLoginLink) mainLoginLink.style.display = 'none';
            if (noScheduleViewHero) noScheduleViewHero.style.display = 'none';

            // ì¼ì •/ì•Œë¦¼ ì˜ì—­ë§Œ í‘œì‹œ ì¤€ë¹„
            if (memberContentArea) memberContentArea.style.display = 'block';

            // â­â­â­ ìˆ˜ì •: íšŒì›ì¼ ë•Œ í•˜ë‹¨ CTA ìˆ¨ê¹€ â­â­â­
            if (globalCtaRegister) {
                globalCtaRegister.style.display = 'none';
            }
            // â­â­â­

            await checkPendingReviews();
            await checkUpcomingSchedules();
            updateGlobalBadge();

            // (â˜…) ì‹¤ì‹œê°„ ì±„íŒ… ë§í¬ ì„¤ì • (íšŒì›: ë°”ë¡œ í˜ì´ì§€ ì´ë™)
            if (chatPromoLink) {
                chatPromoLink.href = "/chat";
                chatPromoLink.textContent = "ì‹¤ì‹œê°„ ì±„íŒ… ë°”ë¡œê°€ê¸°";
            }

            // (â˜…) í›„ê¸° ì•Œë¦¼ ë°°ë„ˆ í‘œì‹œ ë¡œì§ (ë§í¬ì— stadiumId ì¶”ê°€)
            if (reviewSection && pendingReviewStadiumIds.length > 0) {
                // â­â­ [ìˆ˜ì •ë¨] í›„ê¸° ì‘ì„± ë§í¬ì— ì²« ë²ˆì§¸ stadiumId íŒŒë¼ë¯¸í„° ì¶”ê°€ â­â­
                const targetStadiumId = pendingReviewStadiumIds[0];
                const reviewLinkUrl = `/reviews/write?stadiumId=${targetStadiumId}`;
                const count = pendingReviewStadiumIds.length;

                reviewSection.innerHTML = `
                    <div class="review-notification-text">
                        <i class="fas fa-bell"></i> ì‘ì„±í•˜ì§€ ì•Šì€ ê²½ê¸° í›„ê¸°ê°€ <strong>${count}ê±´</strong> ìˆìŠµë‹ˆë‹¤.
                    </div>
                    <a href="${reviewLinkUrl}" id="main-review-link" class="review-notification-link">í›„ê¸° ì‘ì„±í•˜ê¸°</a>
                    <button class="close-review-btn" onclick="closeReviewNotification()">&times;</button>
                `;
                reviewSection.style.display = 'flex';

                const mainReviewLink = document.getElementById('main-review-link');
                mainReviewLink.addEventListener('click', (e) => {
                    localStorage.setItem('hasReadReviews', 'true');
                    reviewSection.style.display = 'none';
                    // ì•Œë¦¼ì„ ì½ì—ˆìœ¼ë¯€ë¡œ ë°°ì—´ ì´ˆê¸°í™”
                    pendingReviewStadiumIds = [];
                    updateGlobalBadge();
                });

            } else if (reviewSection) {
                reviewSection.style.display = 'none';
            }

            // (â˜…) ë‹¤ê°€ì˜¤ëŠ” ì¼ì • ìŠ¬ë¼ì´ë” ë¡œì§
            if (scheduleSection) {
                scheduleSection.style.display = 'block';
                const noScheduleView = document.getElementById('no-schedule-view');

                // âœ” checkUpcomingSchedules()ì—ì„œ ì±„ì›Œì¤€ ê°’ ì‚¬ìš©
                const list = upcomingSchedules;

                if (list && list.length > 0) {
                    sliderTrack.innerHTML = '';
                    paginationContainer.innerHTML = '';

                    list.forEach((schedule, index) => {
                        const item = document.createElement('div');
                        item.className = 'schedule-item';

                        const isMatch = schedule.type === 'ê²½ê¸°';   // ê²½ê¸° ì¼ì •ì¸ì§€ ì—¬ë¶€

                        if (isMatch) {
                            const targetMatchId = schedule.matchId;
                            // â­ ê²½ê¸° ì¼ì • ì¹´ë“œ
                            item.innerHTML = `
                                <div class="item-info-wrapper">
                                    <div class="item-type type-match">ê²½ê¸° ì¼ì •</div>
                                    <strong>${schedule.title || ''}</strong>
                                    <div class="item-location">
                                        <i class="fas fa-clock"></i>
                                        ${schedule.date || ''} ${schedule.time ? `(${schedule.time})` : ''}
                                    </div>
                                </div>
                                 <a href="/schedule/detail/${targetMatchId}" class="schedule-item-link">ìƒì„¸ë³´ê¸°</a>
                            `;
                        } else {
                            // â­ ê°œì¸ ì¼ì • ì¹´ë“œ
                            item.innerHTML = `
                                <div class="item-info-wrapper">
                                    <div class="item-type type-personal">ê°œì¸ ì¼ì •</div>
                                    <strong>${schedule.title || '(ì œëª© ì—†ëŠ” ì¼ì •)'}</strong>
                                    <div class="item-location">
                                        <i class="fas fa-calendar-alt"></i>
                                        ${schedule.date || ''} ${schedule.time ? `(${schedule.time})` : ''}
                                    </div>
                                </div>
                                <a href="/mypage?tab=calendar&date=${schedule.date}&scheduleId=${schedule.id}" class="schedule-item-link">
                                ë‹¬ë ¥ì—ì„œ ë³´ê¸°</a>
                            `;
                        }

                        sliderTrack.appendChild(item);

                        const dot = document.createElement('span');
                        dot.className = 'dot';
                        dot.dataset.index = index;
                        paginationContainer.appendChild(dot);
                    });

                    totalSlides = list.length;
                    currentIndex = 0;

                    updateSliderControls();
                    updatePaginationDots();

                    if (document.querySelector('.schedule-slider-container')) {
                        document.querySelector('.schedule-slider-container').style.display = 'block';
                    }
                    if (noScheduleView) noScheduleView.style.display = 'none';

                } else if (noScheduleView) {
                    noScheduleView.innerHTML =
                        '<p class="no-schedule-message" style="color:white; text-shadow: 0 0 3px black;">ì•„ì§ 7ì¼ ì´ë‚´ì˜ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤. ğŸ˜¥</p>';
                    noScheduleView.style.display = 'block';
                    if (document.querySelector('.schedule-slider-container')) {
                        document.querySelector('.schedule-slider-container').style.display = 'none';
                    }
                }
            }
        } else {
            // [ë¹„íšŒì›ì¼ ë•Œ] - Hero ì„¹ì…˜ì— ë¡œê·¸ì¸ ìœ ë„ ë©”ì‹œì§€ í‘œì‹œ
            if (profileMenuToggle) profileMenuToggle.style.display = 'none';
            if (navLoginLink) navLoginLink.parentElement.style.display = 'list-item';
            if (navLogoutLink) navLogoutLink.parentElement.style.display = 'none';

            // Hero ì„¹ì…˜ í•˜ë‹¨ì˜ ë¡œê·¸ì¸ ìœ ë„ í…ìŠ¤íŠ¸ í‘œì‹œ
            if (mainLoginLink) mainLoginLink.style.display = 'none';
            if (noScheduleViewHero) noScheduleViewHero.style.display = 'block';
            if (memberContentArea) memberContentArea.style.display = 'none';

            // ê¸°ì¡´ ì¼ì •/ì•Œë¦¼ ì˜ì—­ ìˆ¨ê¹€
            if (scheduleSection) scheduleSection.style.display = 'none';
            if (reviewSection) reviewSection.style.display = 'none';

            // â­â­â­ ìˆ˜ì •: ë¹„íšŒì›ì¼ ë•Œ í•˜ë‹¨ CTA í‘œì‹œ â­â­â­
            if (globalCtaRegister) {
                globalCtaRegister.style.display = 'block';
            }
            // â­â­â­

            // (â˜…) ì‹¤ì‹œê°„ ì±„íŒ… ë§í¬ ì„¤ì • (ë¹„íšŒì›: ë¡œê·¸ì¸ ìœ ë„)
            if (chatPromoLink) {
                chatPromoLink.href = "/login";
                chatPromoLink.textContent = "ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥";
                // ë©”ì¸ í˜ì´ì§€ì˜ CTA ë§í¬ëŠ” ìì²´ì ìœ¼ë¡œ ê²½ê³ ë¥¼ ë„ì›ë‹ˆë‹¤.
                chatPromoLink.onclick = function(e) {
                    e.preventDefault();
                    alert("ì‹¤ì‹œê°„ ì±„íŒ…ì€ ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.");
                    window.location.href = "/login";
                };
            }

            if (navChatLinkElement) {
                // âœ… ìˆ˜ì •ë¨: ìš”ì†Œë¥¼ ë°”ë¡œ ì‚¬ìš©
                navChatLinkElement.addEventListener('click', function(e) {
                    e.preventDefault();
                    // alert("âŒ ì‹¤ì‹œê°„ ì±„íŒ…ì€ íšŒì›ë§Œ ì´ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); // (ë©”ì‹œì§€ê°€ ì¢€ ì–´ìƒ‰í•´ì„œ ìˆ˜ì • ì œì•ˆ)
                    alert("ë¡œê·¸ì¸ì´ í•„ìš”í•œ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.");
                    window.location.href = '/login';
                });
            }
        }
    });
</script>