<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MULTI FC - 아이디/비밀번호 찾기</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>

<div th:replace="~{fragments/header :: siteHeader}"></div>

<main class="login-page-main">
    <div class="main-wrapper">
        <div class="main-section">
            <div class="login-container">
                <h1 class="title-login">Find Account</h1>

                <p id="feedback-message" class="info-message" style="display:none; color: green; margin-bottom: 15px;">Message here.</p>
                <p id="error-message" class="error-message" style="display:none; margin-bottom: 15px;">Error message here.</p>

                <div class="tab-buttons">
                    <button class="tab-btn active" data-tab="find-id">아이디 찾기</button>
                    <button class="tab-btn" data-tab="find-pw">비밀번호 찾기</button>
                </div>

                <!-- 아이디 찾기 : 이메일만 -->
                <div id="find-id" class="tab-content active">
                    <form id="find-id-form">
                        <p style="font-size: 15px; color: #555; margin-bottom: 15px;">
                            가입 시 사용한 이메일을 입력하세요.
                        </p>
                        <div class="input-group">
                            <label for="find-id-email">이메일</label>
                            <input type="email" id="find-id-email" name="email" placeholder="가입 시 등록한 이메일" required>
                        </div>
                        <button type="submit" class="login-button" style="margin-top: 20px;">아이디 찾기</button>
                    </form>

                    <div id="find-id-result" style="display: none; text-align: center; margin-top: 30px;">
                        <p style="font-size: 16px; color: #555;">회원님의 아이디입니다.</p>
                        <h3 id="found-id-text" style="font-size: 22px; color: #6c5ce7; margin: 10px 0 25px 0; font-weight: 700;"></h3>
                        <a href="/login" class="login-button" style="text-decoration: none; padding: 14px;">로그인하기</a>
                    </div>
                </div>

                <!-- 비밀번호 찾기 : 인증번호 방식 -->
                <div id="find-pw" class="tab-content">
                    <form id="request-reset-form">
                        <p style="font-size: 15px; color: #555; margin-bottom: 15px;">아이디와 이메일을 입력하세요.</p>
                        <div class="input-group">
                            <label for="reset-pw-username">아이디 (User name)</label>
                            <input type="text" id="reset-pw-username" name="username" placeholder="아이디" required>
                        </div>
                        <div class="input-group">
                            <label for="reset-pw-email">이메일</label>
                            <input type="email" id="reset-pw-email" name="email" placeholder="가입 시 등록한 이메일" required>
                        </div>
                        <button type="submit" class="login-button" style="margin-top: 20px;">인증번호 받기</button>
                    </form>

                    <form id="verify-pw-form" style="display: none;">
                        <p style="font-size: 15px; color: #555; margin-bottom: 15px;">이메일로 발송된 6자리 인증번호를 입력하세요.</p>
                        <div class="input-group">
                            <label for="reset-pw-code">인증번호</label>
                            <input type="text" id="reset-pw-code" name="code" placeholder="인증번호 6자리" required maxlength="6">
                        </div>
                        <button type="submit" class="login-button" style="margin-top: 20px;">인증 확인</button>
                    </form>

                    <form id="reset-password-form" style="display: none;">
                        <p style="font-size: 15px; color: #555; margin-bottom: 15px;">인증이 완료되었습니다. 새 비밀번호를 설정하세요.</p>
                        <div class="input-group">
                            <label for="new-password">새 비밀번호</label>
                            <div class="password-wrapper">
                                <input type="password" id="new-password" name="newPassword" placeholder="8자 이상, 영문/숫자/특수문자 조합" required pattern="^(?=.*[A-Za-z])(?=.*\d)(?=.*[@$!%*#?&])[A-Za-z\d@$!%*#?&]{8,}$">
                                <i class="fas fa-eye-slash toggle-password"></i>
                            </div>
                        </div>
                        <div class="input-group">
                            <label for="confirm-new-password">새 비밀번호 확인</label>
                            <div class="password-wrapper">
                                <input type="password" id="confirm-new-password" name="confirmNewPassword" placeholder="********" required>
                                <i class="fas fa-eye-slash toggle-password"></i>
                            </div>
                        </div>
                        <button type="submit" class="login-button" style="margin-top: 20px;">비밀번호 변경</button>
                    </form>
                </div>

                <div class="back-to-login">
                    <a href="/login">&larr; 로그인 페이지로 돌아가기</a>
                </div>
            </div>
        </div>
        <div class="background-image-section" id="forgot-pw-background"></div>
    </div>
</main>

<script>
    // ✅ 이미 로그인된 사용자는 메인으로 보내기 (헤더와 무관)
    document.addEventListener('DOMContentLoaded', () => {
        const accessToken = localStorage.getItem('accessToken');
        if (accessToken) {
            window.location.href = '/';
        }
    });

    // --- 아이디/비번 찾기 공통 메시지 처리 ---
    const feedbackMsg = document.getElementById('feedback-message');
    const errorMsg = document.getElementById('error-message');

    function clearMessages() {
        feedbackMsg.style.display = 'none';
        errorMsg.style.display = 'none';
    }

    // --- 탭 전환 로직 ---
    const tabButtons = document.querySelectorAll('.tab-btn');
    const tabContents = document.querySelectorAll('.tab-content');

    let resetEmail = '';
    let verifiedCode = '';

    tabButtons.forEach(button => {
        button.addEventListener('click', () => {
            const targetTab = button.getAttribute('data-tab');
            clearMessages();

            // 비밀번호 찾기 상태 초기화
            resetEmail = '';
            verifiedCode = '';

            document.getElementById('find-id-form').style.display = 'block';
            document.getElementById('find-id-result').style.display = 'none';
            document.getElementById('request-reset-form').style.display = 'block';
            document.getElementById('verify-pw-form').style.display = 'none';
            document.getElementById('reset-password-form').style.display = 'none';

            document.getElementById('find-id-email').value = '';
            document.getElementById('reset-pw-username').value = '';
            document.getElementById('reset-pw-email').value = '';
            document.getElementById('reset-pw-code').value = '';
            document.getElementById('new-password').value = '';
            document.getElementById('confirm-new-password').value = '';

            tabButtons.forEach(btn => btn.classList.remove('active'));
            tabContents.forEach(content => content.classList.remove('active'));
            button.classList.add('active');
            document.getElementById(targetTab).classList.add('active');
        });
    });

    // === 아이디 찾기 ===
    const findIdForm = document.getElementById('find-id-form');
    const findIdResult = document.getElementById('find-id-result');

    findIdForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        clearMessages();
        const email = document.getElementById('find-id-email').value.trim();

        if (!email) {
            errorMsg.textContent = '❌ 이메일을 입력해주세요.';
            errorMsg.style.display = 'block';
            return;
        }

        try {
            const response = await fetch('/api/users/find-id', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email: email })
            });

            if (response.ok) {
                const data = await response.json();
                document.getElementById('found-id-text').textContent = data.username;
                findIdForm.style.display = 'none';
                findIdResult.style.display = 'block';
            } else {
                errorMsg.textContent = '❌ ' + await response.text();
                errorMsg.style.display = 'block';
            }
        } catch (error) {
            errorMsg.textContent = '❌ 아이디 조회 중 오류가 발생했습니다.';
            errorMsg.style.display = 'block';
        }
    });

    // === 비밀번호 찾기 ===
    const requestResetForm = document.getElementById('request-reset-form');
    const verifyPwForm = document.getElementById('verify-pw-form');
    const resetPasswordForm = document.getElementById('reset-password-form');

    // 1) 인증번호 요청
    requestResetForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        clearMessages();

        const username = document.getElementById('reset-pw-username').value.trim();
        resetEmail = document.getElementById('reset-pw-email').value.trim();

        if (!username || !resetEmail) {
            errorMsg.textContent = '❌ 아이디와 이메일을 모두 입력해주세요.';
            errorMsg.style.display = 'block';
            return;
        }

        try {
            const response = await fetch('/api/users/reset-password/request', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: username, email: resetEmail })
            });

            if (response.ok) {
                feedbackMsg.textContent = '✅ ' + await response.text();
                feedbackMsg.style.display = 'block';
                requestResetForm.style.display = 'none';
                verifyPwForm.style.display = 'block';
            } else {
                errorMsg.textContent = '❌ ' + await response.text();
                errorMsg.style.display = 'block';
            }
        } catch (error) {
            errorMsg.textContent = '❌ 요청 중 오류가 발생했습니다.';
            errorMsg.style.display = 'block';
        }
    });

    // 2) 인증번호 검증
    verifyPwForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        clearMessages();

        const code = document.getElementById('reset-pw-code').value.trim();
        if (code.length !== 6) {
            errorMsg.textContent = '❌ 인증번호 6자리를 정확히 입력하세요.';
            errorMsg.style.display = 'block';
            return;
        }

        try {
            const response = await fetch('/api/users/reset-password/verify', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email: resetEmail, code: code })
            });

            if (response.ok) {
                verifiedCode = code;
                feedbackMsg.textContent = '✅ ' + await response.text();
                feedbackMsg.style.display = 'block';
                verifyPwForm.style.display = 'none';
                resetPasswordForm.style.display = 'block';
            } else {
                errorMsg.textContent = '❌ ' + await response.text();
                errorMsg.style.display = 'block';
            }
        } catch (error) {
            errorMsg.textContent = '❌ 인증 처리 중 오류가 발생했습니다.';
            errorMsg.style.display = 'block';
        }
    });

    // 3) 새 비밀번호 변경
    resetPasswordForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        clearMessages();

        const newPassword = document.getElementById('new-password').value;
        const confirmPassword = document.getElementById('confirm-new-password').value;
        const passwordPattern = /^(?=.*[A-Za-z])(?=.*\d)(?=.*[@$!%*#?&])[A-Za-z\d@$!%*#?&]{8,}$/;

        if (newPassword !== confirmPassword) {
            errorMsg.textContent = '❌ 새 비밀번호가 일치하지 않습니다.';
            errorMsg.style.display = 'block';
            return;
        }
        if (!passwordPattern.test(newPassword)) {
            errorMsg.textContent = '❌ 비밀번호는 8자 이상이며, 영문, 숫자, 특수문자를 포함해야 합니다.';
            errorMsg.style.display = 'block';
            return;
        }

        try {
            const response = await fetch('/api/users/reset-password/confirm', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    email: resetEmail,
                    code: verifiedCode,
                    newPassword: newPassword
                })
            });

            if (response.ok) {
                alert("비밀번호가 성공적으로 변경되었습니다. 로그인 페이지로 이동합니다.");
                window.location.href = '/login';
            } else {
                errorMsg.textContent = '❌ ' + await response.text();
                errorMsg.style.display = 'block';
            }
        } catch (error) {
            errorMsg.textContent = '❌ 비밀번호 변경 중 오류가 발생했습니다.';
            errorMsg.style.display = 'block';
        }
    });

    // 비밀번호 보이기/가리기
    document.querySelectorAll('.toggle-password').forEach(icon => {
        icon.addEventListener('click', function() {
            const passwordInput = this.parentElement.querySelector('input');
            const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
            passwordInput.setAttribute('type', type);
            this.classList.toggle('fa-eye');
            this.classList.toggle('fa-eye-slash');
        });
    });
</script>

</body>
</html>