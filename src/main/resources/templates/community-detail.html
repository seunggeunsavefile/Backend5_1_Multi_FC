<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="'ê²Œì‹œê¸€ ìƒì„¸ (' + ${postId} + ') - FUTSAL MATCH'">FUTSAL MATCH - ê²Œì‹œê¸€ ìƒì„¸</title>

    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

</head>
<body class="community-page">

<div th:replace="~{fragments/header :: siteHeader}"></div>

<main class="community-main">
    <div class="board-container">

        <div class="detail-header">
            <h1 id="post-title"></h1>
            <div class="detail-meta">
                <span id="detail-writer"></span>
                <span id="detail-date"></span>
                <span id="detail-views"></span>
                <span id="detail-comments"></span>
            </div>
        </div>

        <div class="detail-content" id="post-content">
        </div>

        <div class="post-actions">
            <div class="detail-controls">
                <a href="/community" class="btn-list" style="background-color: #f0f0f0; color: #555;">ëª©ë¡ìœ¼ë¡œ</a>
            </div>

            <div class="detail-controls" id="author-controls">
                <button class="btn-edit" id="btn-edit-post" style="display: none; background-color: #4a90e2; color: white;">ìˆ˜ì •</button>
                <button class="btn-delete" id="btn-delete-post" style="display: none; background-color: #e74c3c; color: white;">ì‚­ì œ</button>
            </div>
        </div>

        <div class="comments-section">
            <h3 style="font-size: 20px; color: #2c3e50; margin-bottom: 15px;">
                ëŒ“ê¸€ (<span id="comment-count">0</span>)
            </h3>

            <div class="comment-form">
                <textarea id="comment-input" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”..." required></textarea>
                <button onclick="submitComment()">ë“±ë¡</button>
                <div style="clear: both;"></div>
            </div>

            <div id="comments-list"></div>
        </div>
    </div>
</main>

<script>
    // í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ì ë‹‰ë„¤ì„ (ëŒ“ê¸€ "(ë‚˜)" í‘œì‹œ, ìˆ˜ì •/ì‚­ì œ ê¶Œí•œ ì²´í¬ìš©)
    let CURRENT_USER_NICKNAME = '';
    let POST_DATA = null;

    // ëŒ€ëŒ“ê¸€ìš©: ì–´ë–¤ ëŒ“ê¸€ì— ë‹µê¸€ ì¤‘ì¸ì§€
    let CURRENT_PARENT_COMMENT_ID = null;

    // ===== ì´ˆê¸°í™” (í—¤ë” ë‹‰ë„¤ì„ + ê²Œì‹œê¸€ ìƒì„¸ + ì•Œë¦¼ ë°°ì§€) =====
    document.addEventListener('DOMContentLoaded', () => {
        const storedName = (localStorage.getItem('username') || '').trim();
        const accessToken = localStorage.getItem('accessToken');

        const userMenuName      = document.getElementById('user-menu-username');
        const profileMenuToggle = document.getElementById('profile-menu-toggle');
        const navLoginLink      = document.getElementById('nav-login-link');
        const navLogoutLink     = document.getElementById('nav-logout-link');

        // âœ… ë¡œê·¸ì¸ ìƒíƒœì¼ ë•Œ í—¤ë”ì— ë‹‰ë„¤ì„ / ë©”ë‰´ í‘œì‹œ
        if (accessToken) {
            if (storedName) {
                CURRENT_USER_NICKNAME = storedName;
                if (userMenuName) {
                    userMenuName.textContent = storedName;   // "ì‚¬ìš©ìë‹˜" ëŒ€ì‹  ì‹¤ì œ ë‹‰ë„¤ì„
                }
            }

            if (profileMenuToggle) {
                profileMenuToggle.style.display = 'flex';
            }
            if (navLoginLink && navLoginLink.parentElement) {
                navLoginLink.parentElement.style.display = 'none';
            }
            if (navLogoutLink && navLogoutLink.parentElement) {
                navLogoutLink.parentElement.style.display = 'list-item';
            }
        } else {
            // ë¹„ë¡œê·¸ì¸
            if (profileMenuToggle) {
                profileMenuToggle.style.display = 'none';
            }
            if (navLoginLink && navLoginLink.parentElement) {
                navLoginLink.parentElement.style.display = 'list-item';
            }
            if (navLogoutLink && navLogoutLink.parentElement) {
                navLogoutLink.parentElement.style.display = 'none';
            }
        }

        // ğŸ”¹ ë¡œê·¸ì¸ ìƒíƒœë¼ë©´ ì•Œë¦¼/ì¼ì • ì •ë³´ ë¶ˆëŸ¬ì™€ì„œ í—¤ë” ë°°ì§€ ê°±ì‹ 
        if (accessToken) {
            (async () => {
                // userIdê°€ ì—†ìœ¼ë©´ ë³´ê°•ìš©ìœ¼ë¡œ í•œ ë²ˆ ë” ê°€ì ¸ì˜¤ê¸°
                if (!localStorage.getItem('userId')) {
                    try {
                        const res = await fetch('/api/users/me', {
                            headers: { 'Authorization': 'Bearer ' + accessToken }
                        });
                        if (res.ok) {
                            const user = await res.json();
                            localStorage.setItem('userId', user.userId);
                            localStorage.setItem('username', user.nickname);
                            CURRENT_USER_NICKNAME = user.nickname;
                            if (userMenuName) userMenuName.textContent = user.nickname;
                        }
                    } catch (e) {
                        console.error('ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨:', e);
                    }
                }

                if (window.checkPendingReviews) await window.checkPendingReviews();
                if (window.checkUpcomingSchedules) await window.checkUpcomingSchedules();
                if (window.updateGlobalBadge) window.updateGlobalBadge();
            })();
        }

        // URL ì—ì„œ postId ì¶”ì¶œ í›„ ìƒì„¸ ì¡°íšŒ
        const pathSegments = window.location.pathname.split('/');
        const postId = pathSegments.pop() || pathSegments.pop();
        loadPostDetail(postId);
    });

    // ===== ê²Œì‹œê¸€ ìƒì„¸ ì¡°íšŒ =====
    async function loadPostDetail(postId) {
        try {
            const res = await fetch(`/api/community/posts/${postId}`);
            if (!res.ok) {
                throw new Error('ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
            }
            const post = await res.json();
            POST_DATA = post;

            document.getElementById('post-title').textContent = post.title;
            document.getElementById('detail-writer').textContent = `ì‘ì„±ì: ${post.writerNickname}`;
            document.getElementById('detail-date').textContent = post.createdAt ?? '';
            document.getElementById('detail-views').textContent = `ì¡°íšŒ: ${post.viewCount ?? 0}`;
            document.getElementById('detail-comments').textContent = `ëŒ“ê¸€: ${post.commentCount ?? 0}`;

            const contentDiv = document.getElementById('post-content');

            let html = '';

            if (post.imageUrl) {
                html += `
                    <div class="post-image-wrapper">
                        <img src="${post.imageUrl}"
                             alt="ê²Œì‹œê¸€ ì´ë¯¸ì§€"
                             style="max-width:100%; height:auto; display:block; margin-bottom:16px; border-radius:8px;">
                    </div>
                `;
            }

            let safeContent = post.content || '';
            safeContent = safeContent.replace(/\n/g, '<br>');
            html += safeContent;

            contentDiv.innerHTML = html;

            document.getElementById('comment-count').textContent = post.commentCount ?? 0;

            setupAuthorButtons(post);
            renderComments(post.comments || []);
        } catch (err) {
            console.error(err);
            document.getElementById('post-title').textContent = 'ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
            document.getElementById('post-content').textContent = 'ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
        }
    }

    // ì‘ì„±ìë§Œ ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ ë³´ì´ê²Œ
    function setupAuthorButtons(post) {
        const editBtn = document.getElementById('btn-edit-post');
        const deleteBtn = document.getElementById('btn-delete-post');

        if (CURRENT_USER_NICKNAME && CURRENT_USER_NICKNAME === post.writerNickname) {
            if (editBtn) {
                editBtn.style.display = 'inline-block';
                editBtn.onclick = () => {
                    window.location.href = `/community/write?edit=${post.postId}`;
                };
            }
            if (deleteBtn) {
                deleteBtn.style.display = 'inline-block';
                deleteBtn.onclick = handleDeletePost;
            }
        }
    }

    async function handleDeletePost() {
        if (!confirm('ì •ë§ ì´ ê²Œì‹œê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

        const token = localStorage.getItem('accessToken');
        if (!token) {
            alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
            window.location.href = '/login';
            return;
        }

        const res = await fetch(`/api/community/posts/${POST_DATA.postId}`, {
            method: 'DELETE',
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });

        if (res.ok) {
            alert('ê²Œì‹œê¸€ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            window.location.href = '/community';
        } else {
            const msg = await res.text();
            alert('ì‚­ì œ ì‹¤íŒ¨: ' + msg);
        }
    }

    function renderComments(comments) {
        const commentsList = document.getElementById('comments-list');
        commentsList.innerHTML = '';

        if (!comments || comments.length === 0) {
            commentsList.innerHTML =
                '<p style="color:#999; text-align:center; padding:10px 0;">ì•„ì§ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
            return;
        }

        const childrenMap = {};
        comments.forEach(c => {
            const parentKey = (c.parentCommentId === null || c.parentCommentId === undefined)
                ? 0
                : c.parentCommentId;

            if (!childrenMap[parentKey]) {
                childrenMap[parentKey] = [];
            }
            childrenMap[parentKey].push(c);
        });

        Object.values(childrenMap).forEach(list => {
            list.sort((a, b) => a.commentId - b.commentId);
        });

        function renderTree(parentId, depth) {
            const list = childrenMap[parentId] || [];
            list.forEach(c => {
                const item = document.createElement('div');
                item.className = depth > 0 ? 'comment-item reply' : 'comment-item';
                item.dataset.commentId = c.commentId;

                if (depth > 0) {
                    item.style.marginLeft = (depth * 20) + 'px';
                }

                const writerNick = (c.commentWriterNickname || '').trim();
                const isMine = CURRENT_USER_NICKNAME !== '' && writerNick === CURRENT_USER_NICKNAME;

                let safeContent = c.content || '';
                safeContent = safeContent.replace(/\n/g, '<br>');

                let actionsHtml = '';

                if (localStorage.getItem('accessToken')) {
                    const safeWriterNickname = (c.commentWriterNickname || '').replace(/'/g, "\\'");
                    actionsHtml += `
                        <button type="button"
                                class="reply"
                                onclick="prepareReply(${c.commentId}, '${safeWriterNickname}')">
                            ë‹µê¸€
                        </button>
                    `;
                }

                if (isMine) {
                    const escapedContent = (c.content || '')
                        .replace(/'/g, "\\'")
                        .replace(/\n/g, '\\n');

                    actionsHtml += `
                        <button type="button"
                                onclick="editComment(${c.commentId}, '${escapedContent}')">
                            ìˆ˜ì •
                        </button>
                        <button type="button"
                                class="delete"
                                onclick="deleteComment(${c.commentId})">
                            ì‚­ì œ
                        </button>
                    `;
                }

                item.innerHTML = `
                    <div class="comment-header-row">
                        <div class="comment-meta">
                            <span class="comment-writer">
                                ${c.commentWriterNickname}${isMine ? ' (ë‚˜)' : ''}
                            </span>
                            <span class="comment-date">${c.createdAt ?? ''}</span>
                        </div>
                        <div class="comment-actions">
                            ${actionsHtml}
                        </div>
                    </div>
                    <div class="comment-content">${safeContent}</div>
                `;

                commentsList.appendChild(item);
                renderTree(c.commentId, depth + 1);
            });
        }

        renderTree(0, 0);
    }

    async function submitComment() {
        const content = document.getElementById('comment-input').value.trim();
        if (!content) {
            alert('ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }

        const token = localStorage.getItem('accessToken');
        if (!token) {
            alert('ë¡œê·¸ì¸ í›„ ëŒ“ê¸€ì„ ì‘ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
            window.location.href = '/login';
            return;
        }

        const res = await fetch(`/api/community/posts/${POST_DATA.postId}/comments`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({
                parentCommentId: CURRENT_PARENT_COMMENT_ID,
                content: content
            })
        });

        if (res.ok) {
            document.getElementById('comment-input').value = '';
            CURRENT_PARENT_COMMENT_ID = null;
            await loadPostDetail(POST_DATA.postId);
        } else {
            const msg = await res.text();
            alert('ëŒ“ê¸€ ë“±ë¡ ì‹¤íŒ¨: ' + msg);
        }
    }

    function prepareReply(parentCommentId, writerNickname) {
        CURRENT_PARENT_COMMENT_ID = parentCommentId;
        const input = document.getElementById('comment-input');
        input.value = `@${writerNickname} `;
        input.focus();
    }

    async function editComment(commentId, currentContent) {
        const newContent = prompt('ëŒ“ê¸€ ìˆ˜ì •', currentContent);
        if (!newContent || !newContent.trim()) return;

        const token = localStorage.getItem('accessToken');
        if (!token) {
            alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
            return;
        }

        const res = await fetch(`/api/community/comments/${commentId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({ content: newContent.trim() })
        });

        if (res.ok) {
            await loadPostDetail(POST_DATA.postId);
        } else {
            alert('ëŒ“ê¸€ ìˆ˜ì • ì‹¤íŒ¨');
        }
    }

    async function deleteComment(commentId) {
        if (!confirm('ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

        const token = localStorage.getItem('accessToken');
        if (!token) {
            alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
            return;
        }

        const res = await fetch(`/api/community/comments/${commentId}`, {
            method: 'DELETE',
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });

        if (res.ok) {
            await loadPostDetail(POST_DATA.postId);
        } else {
            alert('ëŒ“ê¸€ ì‚­ì œ ì‹¤íŒ¨');
        }
    }
</script>

</body>
</html>
