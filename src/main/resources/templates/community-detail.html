<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="'ê²Œì‹œê¸€ ìƒì„¸ (' + ${postId} + ') - FUTSAL MATCH'">FUTSAL MATCH - ê²Œì‹œê¸€ ìƒì„¸</title>

    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

</head>
<body class="community-page">

<header class="quick-menu">
    <div class="logo"><a href="/">Multi FC</a></div>
    <div class="header-icons">
        <button id="profile-menu-toggle" class="profile-icon" style="position: relative;">
            <i class="fas fa-user-circle"></i>
            <span id="notification-badge" class="notification-badge"></span>
        </button>
        <div id="profile-menu" class="user-menu">
            <div class="user-info"> <strong><span id="user-menu-username">ì‚¬ìš©ì</span>ë‹˜</strong> <p>í™˜ì˜í•©ë‹ˆë‹¤!</p> </div>
            <ul>
                <li><a href="/notifications" id="nav-notifications-link"><i class="fas fa-bell"></i> ì•Œë¦¼ ëª©ë¡</a></li>
                <li><a href="/mypage"><i class="fas fa-user"></i> ë§ˆì´í˜ì´ì§€</a></li>
                <li><a href="/profile/edit"><i class="fas fa-user-edit"></i> í”„ë¡œí•„ ìˆ˜ì •</a></li>
                <li><a href="#" id="logout-button"><i class="fas fa-sign-out-alt"></i> ë¡œê·¸ì•„ì›ƒ</a></li>
            </ul>
        </div>
        <button id="menu-toggle" class="menu-toggle-btn"><i class="fas fa-bars"></i></button>
    </div>

    <nav id="main-menu" class="main-nav">
        <ul>
            <li><a href="/"><i class="fas fa-home"></i> ë©”ì¸ (Home)</a></li>
            <li><a href="/fields"><i class="fas fa-search"></i> êµ¬ì¥ê²€ìƒ‰</a></li>
            <li><a href="/community" class="active"><i class="fas fa-users"></i> ì»¤ë®¤ë‹ˆí‹°</a></li>
            <li><a href="/chat"><i class="fas fa-comments"></i> ì‹¤ì‹œê°„ì±„íŒ…</a></li>
            <li><a href="/schedule"><i class="fas fa-calendar-alt"></i> ì¼ì •</a></li>
        </ul>
    </nav>
</header>

<main class="community-main">
    <div class="board-container">

        <div class="detail-header">
            <h1 id="post-title"></h1>
            <div class="detail-meta">
                <span id="detail-writer"></span>
                <span id="detail-date"></span>
                <span id="detail-views"></span>
                <span id="detail-comments"></span>
            </div>
        </div>

        <div class="detail-content" id="post-content">
        </div>

        <div class="post-actions">

            <div class="detail-controls">
                <a href="/community" class="btn-list" style="background-color: #f0f0f0; color: #555;">ëª©ë¡ìœ¼ë¡œ</a>
            </div>

            <div class="detail-controls" id="author-controls">
                <button class="btn-edit" id="btn-edit-post" style="display: none; background-color: #4a90e2; color: white;">ìˆ˜ì •</button>
                <button class="btn-delete" id="btn-delete-post" style="display: none; background-color: #e74c3c; color: white;">ì‚­ì œ</button>
            </div>
        </div>

        <div class="comments-section">
            <h3 style="font-size: 20px; color: #2c3e50; margin-bottom: 15px;">ëŒ“ê¸€ (<span id="comment-count">0</span>)</h3>

            <div class="comment-form">
                <textarea id="comment-input" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”..." required></textarea>
                <button onclick="submitComment()">ë“±ë¡</button>
                <div style="clear: both;"></div>
            </div>

            <div id="comments-list">
            </div>
        </div>
    </div>
</main>

<script>
    // [ìˆ˜ì •] ë” ì´ìƒ MOCK_POSTS / community_posts ë¥¼ ì“°ì§€ ì•Šê³ ,
    // ì„œë²„ì—ì„œ ë°›ì•„ì˜¨ ë‹‰ë„¤ì„ + ëŒ“ê¸€ ì •ë³´ë§Œ ì‚¬ìš©
    let CURRENT_USER_NICKNAME = '';
    let POST_DATA = null;

    // [ëŒ€ëŒ“ê¸€] í˜„ì¬ ì–´ë–¤ ëŒ“ê¸€ì— ë‹µê¸€ì„ ë‹¬ê³  ìˆëŠ”ì§€ (nullì´ë©´ ì¼ë°˜ ëŒ“ê¸€)
    let CURRENT_PARENT_COMMENT_ID = null;

    // ===== ê³µí†µ ë©”ë‰´/ë¡œê·¸ì•„ì›ƒ =====
    document.addEventListener('DOMContentLoaded', () => {
        const menuToggle = document.getElementById('menu-toggle');
        const mainMenu = document.getElementById('main-menu');
        const profileMenuToggle = document.getElementById('profile-menu-toggle');
        const profileMenu = document.getElementById('profile-menu');
        const logoutButton = document.getElementById('logout-button');
        const userMenuName = document.getElementById('user-menu-username');

        const accessToken = localStorage.getItem('accessToken');

        // âœ… ë¡œê·¸ì¸ ë•Œ ì €ì¥í•´ ë‘” ê°’ë§Œ ì‚¬ìš© (ë¡œê·¸ì¸ í˜ì´ì§€ì—ì„œ localStorage.setItem('username', data.user.nickname))
        const storedName = (localStorage.getItem('username') || '').trim();
        if (storedName) {
            CURRENT_USER_NICKNAME = storedName;
            if (userMenuName) {
                userMenuName.textContent = storedName;
            }
        } else {
            // ì €ì¥ëœ ê²Œ ì—†ìœ¼ë©´ ê¸°ë³¸ê°’
            if (userMenuName) {
                userMenuName.textContent = 'ì‚¬ìš©ì';
            }
        }

        // í”„ë¡œí•„ ì•„ì´ì½˜/ë©”ë‰´ í† ê¸€, ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬ ë“± ê¸°ì¡´ ì½”ë“œ ê·¸ëŒ€ë¡œ
        if (menuToggle) {
            menuToggle.addEventListener('click', (event) => {
                event.stopPropagation();
                if (mainMenu) mainMenu.classList.toggle('show');
                if (profileMenu) profileMenu.classList.remove('show');
            });
        }
        if (profileMenuToggle) {
            profileMenuToggle.addEventListener('click', (event) => {
                event.stopPropagation();
                if (profileMenu) profileMenu.classList.toggle('show');
                if (mainMenu) mainMenu.classList.remove('show');
            });
        }
        document.addEventListener('click', (event) => {
            const header = document.querySelector('header');
            if (header && !header.contains(event.target)) {
                if (mainMenu) mainMenu.classList.remove('show');
                if (profileMenu) profileMenu.classList.remove('show');
            }
        });
        if (logoutButton) {
            logoutButton.addEventListener('click', (e) => {
                e.preventDefault();
                localStorage.removeItem('accessToken');
                localStorage.removeItem('hasReadReviews');
                localStorage.removeItem('hasReadSchedules');
                localStorage.removeItem('username');
                window.location.href = '/login';
            });
        }

        if (accessToken && profileMenuToggle) {
            profileMenuToggle.style.display = 'flex';
        }

        // URL ì—ì„œ postId ì¶”ì¶œ í›„ ìƒì„¸ ì¡°íšŒ
        const pathSegments = window.location.pathname.split('/');
        const postId = pathSegments.pop() || pathSegments.pop();
        loadPostDetail(postId);
    });

    // ===== ìƒì„¸ ì¡°íšŒ =====
    async function loadPostDetail(postId) {
        try {
            const res = await fetch(`/api/community/posts/${postId}`);
            if (!res.ok) {
                throw new Error('ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
            }
            const post = await res.json();
            POST_DATA = post;

            document.getElementById('post-title').textContent = post.title;
            document.getElementById('detail-writer').textContent = `ì‘ì„±ì: ${post.writerNickname}`;
            document.getElementById('detail-date').textContent = post.createdAt ?? '';
            document.getElementById('detail-views').textContent = `ì¡°íšŒ: ${post.viewCount ?? 0}`;
            document.getElementById('detail-comments').textContent = `ëŒ“ê¸€: ${post.commentCount ?? 0}`;

            const contentDiv = document.getElementById('post-content');

            // [ìˆ˜ì •] ì´ë¯¸ì§€ê°€ ìˆìœ¼ë©´ ìƒë‹¨ì— ì´ë¯¸ì§€ íƒœê·¸ë¥¼ ë¨¼ì € ë¶™ì´ê³ , ê·¸ ì•„ë˜ì— ë³¸ë¬¸(content) ì¶œë ¥
            let html = '';

            if (post.imageUrl) {
                html += `
                <div class="post-image-wrapper">
                    <img src="${post.imageUrl}"
                         alt="ê²Œì‹œê¸€ ì´ë¯¸ì§€"
                         style="max-width:100%; height:auto; display:block; margin-bottom:16px; border-radius:8px;">
                </div>
            `;
            }
            // XSS ë°©ì–´
            let safeContent = post.content || '';
            safeContent = safeContent.replace(/\n/g, '<br>'); // ì¤„ë°”ê¿ˆë§Œ ì²˜ë¦¬

            html += safeContent;
            contentDiv.innerHTML = html;

            document.getElementById('comment-count').textContent = post.commentCount ?? 0;

            setupAuthorButtons(post);
            renderComments(post.comments || []);
        } catch (err) {
            console.error(err);
            document.getElementById('post-title').textContent = 'ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
            document.getElementById('post-content').textContent = 'ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
        }
    }

    // ì‘ì„±ìë§Œ ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ ë³´ì´ê²Œ
    function setupAuthorButtons(post) {
        const editBtn = document.getElementById('btn-edit-post');
        const deleteBtn = document.getElementById('btn-delete-post');

        if (CURRENT_USER_NICKNAME && CURRENT_USER_NICKNAME === post.writerNickname) {
            if (editBtn) {
                editBtn.style.display = 'inline-block';
                editBtn.onclick = () => {
                    window.location.href = `/community/write?edit=${post.postId}`;
                };
            }
            if (deleteBtn) {
                deleteBtn.style.display = 'inline-block';
                deleteBtn.onclick = handleDeletePost;
            }
        }
    }

    async function handleDeletePost() {
        if (!confirm('ì •ë§ ì´ ê²Œì‹œê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        const token = localStorage.getItem('accessToken');
        if (!token) {
            alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
            window.location.href = '/login';
            return;
        }
        const res = await fetch(`/api/community/posts/${POST_DATA.postId}`, {
            method: 'DELETE',
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        if (res.ok) {
            alert('ê²Œì‹œê¸€ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            window.location.href = '/community';
        } else {
            const msg = await res.text();
            alert('ì‚­ì œ ì‹¤íŒ¨: ' + msg);
        }
    }

    function renderComments(comments) {
        const commentsList = document.getElementById('comments-list');
        commentsList.innerHTML = '';

        if (!comments || comments.length === 0) {
            commentsList.innerHTML =
                '<p style="color:#999; text-align:center; padding:10px 0;">ì•„ì§ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
            return;
        }

        // 1) ë¶€ëª¨ë³„ë¡œ children ëª¨ìœ¼ê¸° (null/undefined ëŠ” 0ìœ¼ë¡œ í†µì¼í•´ì„œ ìµœìƒìœ„ë¡œ ì‚¬ìš©)
        const childrenMap = {};
        comments.forEach(c => {
            const parentKey = (c.parentCommentId === null || c.parentCommentId === undefined)
                ? 0
                : c.parentCommentId;

            if (!childrenMap[parentKey]) {
                childrenMap[parentKey] = [];
            }
            childrenMap[parentKey].push(c);
        });

        // (ì„ íƒ) ì •ë ¬: commentId ê¸°ì¤€ìœ¼ë¡œ ì˜¤ë˜ëœ ìˆœì„œëŒ€ë¡œ
        Object.values(childrenMap).forEach(list => {
            list.sort((a, b) => a.commentId - b.commentId);
        });

        // 2) ê³µí†µ ë Œë” í•¨ìˆ˜ (depth ë¡œ ë“¤ì—¬ì“°ê¸°)
        function renderTree(parentId, depth) {
            const list = childrenMap[parentId] || [];
            list.forEach(c => {
                const item = document.createElement('div');
                item.className = depth > 0 ? 'comment-item reply' : 'comment-item';
                item.dataset.commentId = c.commentId;

                // depth ì— ë”°ë¼ ë“¤ì—¬ì“°ê¸° ì¡°ê¸ˆì”© ì¦ê°€
                if (depth > 0) {
                    item.style.marginLeft = (depth * 20) + 'px';
                }

                const writerNick = (c.commentWriterNickname || '').trim();
                const isMine = CURRENT_USER_NICKNAME !== '' && writerNick === CURRENT_USER_NICKNAME;

                // ë””ë²„ê·¸: ì—¬ê¸° ì•ˆì—ì„œë§Œ ì‚¬ìš©í•´ì•¼ í•¨
                console.log(
                    'CURRENT_USER_NICKNAME=', CURRENT_USER_NICKNAME,
                    'writerNick=', writerNick,
                    'isMine=', isMine,
                    'commentId=', c.commentId
                );

                // XSS ë°©ì–´
                let safeContent = c.content || '';
                safeContent = safeContent.replace(/\n/g, '<br>');

                let actionsHtml = '';

                // ë¡œê·¸ì¸ ë˜ì–´ ìˆìœ¼ë©´ ëˆ„êµ¬ë‚˜ "ë‹µê¸€" ë²„íŠ¼
                if (localStorage.getItem('accessToken')) {
                    const safeWriterNickname = (c.commentWriterNickname || '').replace(/'/g, "\\'");
                    actionsHtml += `
                    <button type="button"
                            class="reply"
                            onclick="prepareReply(${c.commentId}, '${safeWriterNickname}')">
                        ë‹µê¸€
                    </button>
                `;
                }

                // ë‚´ ëŒ“ê¸€ì´ë©´ ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼
                if (isMine) {
                    const escapedContent = (c.content || '')
                        .replace(/'/g, "\\'")
                        .replace(/\n/g, '\\n');

                    actionsHtml += `
                    <button type="button"
                            onclick="editComment(${c.commentId}, '${escapedContent}')">
                        ìˆ˜ì •
                    </button>
                    <button type="button"
                            class="delete"
                            onclick="deleteComment(${c.commentId})">
                        ì‚­ì œ
                    </button>
                `;
                }

                item.innerHTML = `
                <div class="comment-header-row">
                    <div class="comment-meta">
                        <span class="comment-writer">
                            ${c.commentWriterNickname}${isMine ? ' (ë‚˜)' : ''}
                        </span>
                        <span class="comment-date">${c.createdAt ?? ''}</span>
                    </div>
                    <div class="comment-actions">
                        ${actionsHtml}
                    </div>
                </div>
                <div class="comment-content">${safeContent}</div>
            `;

                commentsList.appendChild(item);
                // ğŸ” ì´ ëŒ“ê¸€ì˜ ìì‹(ëŒ€ëŒ“ê¸€ë“¤) ì¬ê·€ ë Œë”ë§
                renderTree(c.commentId, depth + 1);
            });
        }

        // parentId = 0 ì¸ ìµœìƒìœ„ ëŒ“ê¸€ë¶€í„° ì‹œì‘
        renderTree(0, 0);
    }




    async function submitComment() {
        const content = document.getElementById('comment-input').value.trim();
        if (!content) {
            alert('ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }

        const token = localStorage.getItem('accessToken');
        if (!token) {
            alert('ë¡œê·¸ì¸ í›„ ëŒ“ê¸€ì„ ì‘ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
            window.location.href = '/login';
            return;
        }

        const res = await fetch(`/api/community/posts/${POST_DATA.postId}/comments`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({
                parentCommentId: CURRENT_PARENT_COMMENT_ID,
                content: content
            })
        });

        if (res.ok) {
            document.getElementById('comment-input').value = '';
            // [ëŒ€ëŒ“ê¸€] í•œ ë²ˆ ë³´ë‚´ê³  ë‚˜ë©´ ë‹¤ì‹œ ì¼ë°˜ ëŒ“ê¸€ ëª¨ë“œë¡œ ì´ˆê¸°í™”
            CURRENT_PARENT_COMMENT_ID = null;
            await loadPostDetail(POST_DATA.postId); // ìƒˆë¡œê³ ì¹¨ ëŒ€ì‹  ì¬ë¡œë”©
        } else {
            const msg = await res.text();
            alert('ëŒ“ê¸€ ë“±ë¡ ì‹¤íŒ¨: ' + msg);
        }
    }

    function prepareReply(parentCommentId, writerNickname) {
        CURRENT_PARENT_COMMENT_ID = parentCommentId;  // ì´ì œë¶€í„° ì´ ëŒ“ê¸€ì˜ ëŒ€ëŒ“ê¸€ë¡œ ì €ì¥
        const input = document.getElementById('comment-input');
        input.value = `@${writerNickname} `;         // ì„ íƒ: ë©˜ì…˜ ëŠë‚Œ
        input.focus();
    }

    async function editComment(commentId, currentContent) {
        const newContent = prompt('ëŒ“ê¸€ ìˆ˜ì •', currentContent);
        if (!newContent || !newContent.trim()) return;

        const token = localStorage.getItem('accessToken');
        if (!token) {
            alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
            return;
        }

        const res = await fetch(`/api/community/comments/${commentId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({ content: newContent.trim() })
        });

        if (res.ok) {
            await loadPostDetail(POST_DATA.postId);
        } else {
            alert('ëŒ“ê¸€ ìˆ˜ì • ì‹¤íŒ¨');
        }
    }

    async function deleteComment(commentId) {
        if (!confirm('ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

        const token = localStorage.getItem('accessToken');
        if (!token) {
            alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
            return;
        }

        const res = await fetch(`/api/community/comments/${commentId}`, {
            method: 'DELETE',
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });

        if (res.ok) {
            await loadPostDetail(POST_DATA.postId);
        } else {
            alert('ëŒ“ê¸€ ì‚­ì œ ì‹¤íŒ¨');
        }
    }
</script>
