<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MULTI FC - ì‹¤ì‹œê°„ ì±„íŒ…</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        /* [ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€] */
        .chat-main {
            padding-top: 70px;
            display: flex;
            min-height: 100vh;
            background-color: #f7f7f7;
            position: relative;
            overflow-x: hidden;
            transition: all 0.3s ease-in-out;
        }
        .chat-sidebar {
            width: 300px;
            background: white;
            border-right: 1px solid #ddd;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
        }
        .chat-content-area {
            flex-grow: 1;
            background: #fff;
            display: flex;
            flex-direction: column;
            position: relative;
            transition: all 0.3s ease-in-out;
            min-width: 0;
        }

        /* í•µì‹¬ CSS: ì‚¬ì´ë“œë°”ê°€ ì—´ë¦´ ë•Œ ë©”ì¸ ì½˜í…ì¸ ë¥¼ ë°€ì–´ëƒ…ë‹ˆë‹¤. */
        .chat-main.sidebar-open {
            margin-right: 280px;
        }

        .chat-header {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 18px;
            font-weight: 700;
            color: #2c3e50;
        }

        /* â˜…ì±„íŒ… ìœ í˜• íƒ­ ë²„íŠ¼ ìŠ¤íƒ€ì¼ (ê¹”ë”í•œ ê¸€ì”¨ ë°‘ì¤„ í˜•ì‹)â˜… */
        .chat-type-tabs {
            display: flex;
            justify-content: space-around;
            padding: 10px 0 0 0;
            margin-bottom: 0;
            border-bottom: 1px solid #eee;
        }
        .chat-type-tabs button {
            flex-grow: 1;
            padding: 10px 5px;
            margin: 0;
            background: none !important;
            border: none !important;
            border-radius: 0 !important;
            font-size: 14px;
            font-weight: 600;
            color: #999;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
            outline: none;
        }
        .chat-type-tabs button.active {
            color: #6c5ce7;
            border-bottom-color: #6c5ce7;
        }
        .chat-type-tabs button:hover:not(.active) {
            color: #2c3e50;
            background-color: transparent;
        }


        /* ì±„íŒ…ë°© ëª©ë¡ */
        .room-list-container {
            flex-grow: 1;
            overflow-y: auto;
        }
        .room-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 10px 15px 20px;
            border-bottom: 1px solid #f7f7f7;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .room-item:hover, .room-item.active {
            background-color: #f0f0f0;
        }
        .room-info {
            flex-grow: 1;
            min-width: 0;
            padding-right: 10px;
        }
        .room-name {
            font-weight: 600;
            color: #2c3e50;
        }
        .last-message {
            font-size: 13px;
            color: #888;
            margin-top: 4px;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }

        /* ì‚­ì œ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .delete-room-btn {
            background: none;
            border: none;
            color: #e74c3c;
            font-size: 15px;
            cursor: pointer;
            flex-shrink: 0;
            opacity: 0.7;
            padding: 5px;
        }
        .delete-room-btn:hover {
            opacity: 1;
        }

        /* ì±„íŒ…ë°© ìƒì„¸ */
        .chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 20px;
            background-color: #f7f7f7;
        }
        .chat-input-area {
            border-top: 1px solid #ddd;
            padding: 10px 20px;
            display: flex;
            align-items: center;
            background: white;
        }
        .chat-input-area input {
            flex-grow: 1;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 20px;
            margin-right: 10px;
            font-size: 15px;
        }
        .chat-input-area button {
            background-color: #6c5ce7;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 20px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .chat-input-area button:hover {
            background-color: #8e44ad;
        }
        /* ê° ë©”ì‹œì§€ ë¬¶ìŒ */
        .message-wrapper {
            margin: 12px 0;
            display: flex;
            flex-direction: column;
        }

        /* ì •ë ¬ */
        .message-wrapper.other {
            align-items: flex-start;
        }

        .message-wrapper.mine {
            align-items: flex-end;
        }

        /* ë‹‰ë„¤ì„ */
        .message-nickname {
            font-size: 13px;
            color: #444;
            margin-bottom: 3px;
            margin-left: 4px;
            font-weight: 600;
        }

        /* ë§í’ì„  + ì‹œê°„ í–‰ */
        .bubble-row {
            display: flex;
            align-items: flex-end;
            gap: 6px;
        }

        .bubble-row.other {
            justify-content: flex-start;
        }

        .bubble-row.mine {
            justify-content: flex-end;
        }

        /* ë§í’ì„  ìŠ¤íƒ€ì¼ */
        .message-bubble {
            max-width: 250px;
            padding: 9px 12px;
            border-radius: 18px;
            line-height: 1.4;
            font-size: 14px;
            word-break: break-word;
        }

        /* ìƒëŒ€ ë§í’ì„  */
        .message-bubble.other {
            background: #ffffff;
            border: 1px solid #ddd;
            color: #222;
        }

        /* ë‚´ ë§í’ì„  (ì¹´í†¡ ë¸”ë£¨ ê³„ì—´) */
        .message-bubble.mine {
            background: #d2e4fc;
            color: #111;
        }

        /* ì‹œê°„ */
        .message-time {
            font-size: 11px;
            color: #777;
            margin-bottom: 15px;
        }

        .message-text {
            padding: 10px 15px;
            max-width: 70%;
            word-wrap: break-word;
            font-size: 15px;
        }
        .message-meta {
            font-size: 11px;
            color: #888;
            align-self: flex-end;
            margin: 0 5px;
        }

        /* ë£¸ì´ ì„ íƒë˜ì§€ ì•Šì•˜ì„ ë•Œ */
        #chat-welcome-message {
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 20px;
            color: #999;
            height: 100%;
            text-align: center;
        }
        #current-chat-room {
            display: none;
            flex-direction: column;
            position: relative;
            height: 100%;
            overflow: hidden; /* ì¸ë¼ì¸ í”„ë¡œí•„ì´ ë²—ì–´ë‚˜ì§€ ì•Šë„ë¡ */
        }

        /* ìƒíƒœ ë©”ì‹œì§€ */
        #connection-status {
            position: absolute;
            top: 70px;
            left: 0;
            width: 100%;
            background-color: #f0f0f0;
            color: #e74c3c;
            padding: 8px;
            text-align: center;
            font-size: 14px;
            font-weight: 600;
            z-index: 990;
            display: none;
        }

        /* â˜…ì°¸ì—¬ì ëª©ë¡ ì‚¬ì´ë“œë°” ìŠ¤íƒ€ì¼â˜… */
        #participant-sidebar {
            position: fixed;
            top: 70px;
            right: 0;
            width: 280px;
            height: calc(100vh - 70px);
            background: white;
            box-shadow: -4px 0 10px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.3s ease-in-out;
            display: flex;
            flex-direction: column;
            border-left: 1px solid #ddd;
        }
        #participant-sidebar.open {
            transform: translateX(0);
        }
        .sidebar-header {
            padding: 15px 20px;
            font-size: 18px;
            font-weight: 700;
            color: #2c3e50;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .sidebar-close-btn {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #555;
        }
        .participant-list-container {
            flex-grow: 1;
            padding: 10px 0;
        }

        /* ì°¸ì—¬ì í•­ëª© ìŠ¤íƒ€ì¼ ê°œì„  */
        .participant-item {
            display: flex;
            align-items: center;
            padding: 10px 20px;
            border-bottom: 1px solid #f7f7f7;
            cursor: pointer;
        }
        .participant-item:hover {
            background-color: #fcfcfc;
        }
        .participant-icon-wrapper {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background-color: #f0f0f0;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-right: 10px;
            flex-shrink: 0;
        }
        .participant-icon-wrapper i {
            font-size: 16px;
            color: #6c5ce7;
            margin: 0;
        }
        .participant-details {
            display: flex;
            flex-direction: column;
            line-height: 1.3;
        }
        .participant-name {
            font-size: 15px;
            color: #333;
            font-weight: 500;
        }
        .participant-role-badge {
            font-size: 11px;
            font-weight: 700;
            padding: 2px 5px;
            border-radius: 5px;
            margin-left: 5px;
            color: white;
            white-space: nowrap;
        }
        .role-admin { background-color: #6c5ce7; }
        .role-host { background-color: #e74c3c; }
        .role-me { background-color: #3498db; }

        /* ëª¨ë°”ì¼ ëŒ€ì‘ */
        @media (max-width: 900px) {
            .chat-main.sidebar-open {
                width: 100%;
                margin-right: 0;
            }
            #participant-sidebar {
                width: 100%;
                height: calc(100vh - 70px);
            }
        }

        /* â˜…ëª¨ë‹¬ ìŠ¤íƒ€ì¼â˜… */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10001;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }
        .modal-overlay.open {
            opacity: 1;
            pointer-events: auto;
        }
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            max-width: 400px;
            width: 90%;
            transform: translateY(-20px);
            transition: transform 0.3s;
            position: relative;
        }
        .modal-overlay.open .modal-content {
            transform: translateY(0);
        }
        .modal-content h2 {
            font-size: 24px;
            color: #2c3e50;
            margin-bottom: 20px;
            border-bottom: 2px solid #6c5ce7;
            padding-bottom: 10px;
        }
        .modal-content p {
            font-size: 15px;
            color: #555;
            margin-bottom: 10px;
        }
        .modal-content strong {
            color: #6c5ce7;
            margin-left: 5px;
        }
        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        .modal-actions button {
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
        }
        .btn-cancel {
            background: #f0f0f0;
            color: #555;
            border: 1px solid #ddd;
        }
        .btn-create {
            background: #6c5ce7;
            color: white;
            border: none;
        }

        /* ìƒˆ ì±„íŒ… ëª¨ë‹¬ ì „ìš© ì…ë ¥ í•„ë“œ ìŠ¤íƒ€ì¼ */
        #new-chat-modal .modal-content input,
        #new-chat-modal .modal-content select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 15px;
            box-sizing: border-box;
            font-size: 15px;
        }

        /* â˜…ì¹œêµ¬ ì´ˆëŒ€ ëª¨ë‹¬ ëª©ë¡ ìŠ¤íƒ€ì¼ */
        .invite-friend-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f7f7f7;
            cursor: pointer;
        }
        .invite-friend-item:hover {
            background-color: #fafafa;
        }
        .invite-friend-item.selected {
            background-color: #e6e6ff; /* ì—°í•œ ë³´ë¼ìƒ‰ ë°°ê²½ */
        }
        .invite-friend-item span {
            font-size: 15px;
            color: #333;
        }
        .friend-status {
            font-size: 12px;
            color: #28a745; /* ì˜¨ë¼ì¸ ìƒ‰ìƒ */
            margin-left: 10px;
        }
        .friend-status.offline {
            color: #999;
        }
        .friend-checkbox {
            transform: scale(1.2);
            accent-color: #6c5ce7;
        }

        /* â˜…ì´ˆëŒ€ ëª¨ë‹¬ ë‚´ ë²„íŠ¼ */
        #invite-modal .modal-content button {
            padding: 5px 15px;
            border-radius: 5px;
            font-weight: 600;
        }
        #final-invite-btn:disabled {
            background-color: #aaa;
            cursor: not-allowed;
        }

        /* â˜…â˜…â˜… ìµœì¢… ìˆ˜ì •: ì¸ë¼ì¸ í”„ë¡œí•„ ìƒì„¸ ì •ë³´ ìŠ¤íƒ€ì¼ (ë²„ê·¸ í•´ê²° ë° UI í™•ì •) â˜…â˜…â˜… */
        .inline-profile-detail {
            /* â­â­â­ ìœ„ì¹˜ ì¡°ì •: FIXED + ìš°ì¸¡ ì°¸ì—¬ì ì‚¬ì´ë“œë°” ì˜†ì— ë‚˜ì˜¤ë„ë¡ â­â­â­ */
            position: fixed;
            top: 100px;
            right: 280px; /* ì°¸ì—¬ì ì‚¬ì´ë“œë°” ë„ˆë¹„ë§Œí¼ ì™¼ìª½ìœ¼ë¡œ ë„ìš°ê¸° (280px) */
            width: 200px; /* ì°½ í¬ê¸° ì¡°ì • */
            height: auto;
            background: white;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            padding: 15px;

            /* â­â­â­ ì´ˆê¸° ìˆ¨ê¹€ ìƒíƒœ (JSì—ì„œ display:none ì œì–´) â­â­â­ */
            transform: translateX(100%);
            transition: transform 0.3s ease-in-out;
            display: none; /* â­â­ ì´ˆê¸° ë Œë”ë§ ì‹œ ì•„ì˜ˆ ìˆ¨ê¹€ â­â­ */
            flex-direction: column;
            z-index: 9999;
            border: 1px solid #ddd;
        }

        /* ì°½ì´ ì—´ë ¸ì„ ë•Œ (í˜„ì¬ ìœ„ì¹˜(right: 280px)ë¡œ ì´ë™) */
        .inline-profile-detail.open {
            transform: translateX(0%); /* Xì¶• ì´ë™ 0% = right: 280px ìœ„ì¹˜ì— í‘œì‹œ */
            display: flex; /* â­â­ ì—´ë¦´ ë•Œë§Œ ë³´ì´ê²Œ ì„¤ì • â­â­ */
        }

        .inline-profile-detail .close-profile-btn {
            position: absolute;
            top: 5px;
            right: 10px;
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #555;
        }
        .profile-detail-img {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 8px;
            border: 2px solid #6c5ce7;
        }
        .profile-info-content h3 {
            font-size: 16px;
            color: #2c3e50;
            margin-bottom: 8px;
        }
        .profile-meta-info p {
            font-size: 12px;
            color: #555;
            margin-bottom: 4px;
        }
        .profile-meta-info strong {
            font-size: 13px;
        }
        .chat-one-on-one-btn, .send-friend-request-btn {
            padding: 8px 10px;
            margin-top: 8px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: background-color 0.2s;
            font-size: 13px;
        }
        /* í”„ë¡œí•„ ìƒì„¸ ì°½ì´ ì—´ë ¸ì„ ë•Œ ë©”ì‹œì§€ ì˜ì—­ì„ ë°€ì–´ëƒ…ë‹ˆë‹¤. (fixed positionì´ë¼ í•„ìš” ì—†ìŒ) */
        .chat-content-area.profile-open {
            padding-left: 0;
        }
        /* â­â­ ë³´ê°•: ì±„íŒ…ë°© ìƒì„¸ ì •ë³´ (ì¸ì›/ìœ í˜•) í—¤ë” ìŠ¤íƒ€ì¼ â­â­ */
        .room-title-wrapper {
            display: flex;
            align-items: center;
        }
        .room-status-info {
            font-size: 13px;
            font-weight: 500;
            color: #6c5ce7;
            margin-left: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .room-status-info .fa-lock { color: #e74c3c; } /* 1:1 ì±„íŒ… ì•„ì´ì½˜ ìƒ‰ìƒ */
        .room-status-info .fa-users { color: #6c5ce7; } /* ê·¸ë£¹ ì±„íŒ… ì•„ì´ì½˜ ìƒ‰ìƒ */
        /* â­â­ ë³´ê°• ë â­â­ */
        /* â­â­ ë³´ê°•: ì•ˆ ì½ì€ ë©”ì‹œì§€ ë±ƒì§€ ë° ì¸ì› ìˆ˜ í‘œì‹œë¥¼ ìœ„í•œ ì»¨í…Œì´ë„ˆ â­â­ */
        .room-item-actions {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-shrink: 0;
        }
        .unread-badge {
            background-color: #e74c3c;
            color: white;
            font-size: 11px;
            font-weight: 700;
            border-radius: 40px;
            padding: 3px 8px;
            flex-shrink: 0;
            display: inline-block;
            min-width: 24px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.07);
            text-align: center;
        }
        /* â­â­ ë³´ê°• ë â­â­ */

        /* â˜…ì¶”ê°€: ì¹œêµ¬ ì´ˆëŒ€ ë²„íŠ¼ ìŠ¤íƒ€ì¼ ê°œì„  */
        .invite-action-btn {
            padding: 15px 25px !important; /* ë‚´ë¶€ íŒ¨ë”© ì¦ê°€ë¡œ ë†’ì´/í¬ê¸° ì¦ê°€ */
            font-size: 16px !important; /* í°íŠ¸ í¬ê¸° ìœ ì§€ */
            font-weight: 700 !important;
            cursor: pointer !important; /* ë§ˆìš°ìŠ¤ í¬ì¸í„° ì¶”ê°€ */
            transition: background-color 0.3s, transform 0.2s;
        }
        .invite-action-btn:hover {
            transform: translateY(-1px);
            background-color: #27ae60 !important; /* hover ìƒ‰ìƒ ë³€ê²½ */
        }
    </style>
</head>
<body>

<header class="quick-menu">
    <div class="logo"><a href="/">Multi FC</a></div>
    <div class="header-icons">
        <button id="profile-menu-toggle" class="profile-icon" style="position: relative; display: none;">
            <i class="fas fa-user-circle"></i>
        </button>
        <div id="profile-menu" class="user-menu"></div>
        <button id="menu-toggle" class="menu-toggle-btn"><i class="fas fa-bars"></i></button>
    </div>
    <nav id="main-menu" class="main-nav">
        <ul>
            <li><a href="/"><i class="fas fa-home"></i> ë©”ì¸ (Home)</a></li>
            <li><a href="/fields"><i class="fas fa-search"></i> êµ¬ì¥ê²€ìƒ‰</a></li>
            <li><a href="/community"><i class="fas fa-users"></i> ì»¤ë®¤ë‹ˆí‹°</a></li>
            <li id="nav-chat-link-li"><a href="/chat" class="active"><i class="fas fa-comments"></i> ì‹¤ì‹œê°„ì±„íŒ…</a></li>
        </ul>
    </nav>
</header>

<div id="connection-status">
    WebSocket ì—°ê²° ì¤‘... ì„œë²„ê°€ ì¤€ë¹„ë˜ë©´ ìë™ìœ¼ë¡œ ì—°ê²°ë©ë‹ˆë‹¤.
</div>

<main id="chat-main-wrapper" class="chat-main">
    <!-- âœ… ì‚¬ì´ë“œë°”: ì±„íŒ… ëª©ë¡ -->
    <div class="chat-sidebar">
        <div class="chat-header">
            ì±„íŒ… ëª©ë¡
            <button id="new-chat-btn" onclick="openNewChatModal(true)" style="background:none; border:none; color:#6c5ce7; font-size:16px; cursor:pointer;" title="ìƒˆ ì±„íŒ… ì‹œì‘">
                <i class="fas fa-plus-circle"></i>
            </button>
        </div>

        <div id="chat-type-tabs" class="chat-type-tabs">
            <button data-type="public" class="active">ì „ì²´ ì±„íŒ…</button>
            <button data-type="group">ê·¸ë£¹ ì±„íŒ…</button>
            <button data-type="one-on-one">1:1 ì±„íŒ…</button>
        </div>

        <div id="room-list-container" class="room-list-container"></div>
    </div>

    <!-- âœ… ë©”ì¸ ì±„íŒ… ì˜ì—­ -->
    <div class="chat-content-area">
        <!-- ì´ˆê¸° ì•ˆë‚´ ë©”ì‹œì§€ -->
        <div id="chat-welcome-message">
            <p>ì±„íŒ… ëª©ë¡ì—ì„œ ë°©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</p>
        </div>

        <!-- ì±„íŒ…ë°© í™œì„±í™” ì‹œ í‘œì‹œ -->
        <div id="current-chat-room" style="display: none;">
            <!-- âœ… ì±„íŒ…ë°© í—¤ë” -->
            <div id="chat-room-header" class="chat-header">
                <div class="room-title-wrapper">
                    <span id="room-title">ì±„íŒ…ë°© ì œëª©</span>
                    <!-- âœ… ì°¸ì—¬ì ìˆ˜ ë° íƒ€ì… ì•„ì´ì½˜ -->
                    <div id="room-status-display" class="room-status-info" style="display: none;">
                        <span id="room-type-icon"></span>
                        <span id="room-participant-count">0</span>
                    </div>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button onclick="openParticipantList()" id="open-participant-btn" style="background:none; border:none; color:#6c5ce7; font-size:18px; cursor:pointer;" title="ì°¸ì—¬ì ëª©ë¡">
                        <i class="fas fa-users"></i>
                    </button>
                    <button id="leave-room-btn" style="background:none; border:none; color:#e74c3c; font-size:18px; cursor:pointer; display:none;" title="ì±„íŒ…ë°© ë‚˜ê°€ê¸°">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>

            <!-- âœ… ì¸ë¼ì¸ í”„ë¡œí•„ ìƒì„¸ (ìš°ì¸¡ ìŠ¬ë¼ì´ë“œ) -->
            <div id="inline-profile-detail" class="inline-profile-detail">
                <button class="close-profile-btn" onclick="openInlineProfileDetail(false)" id="close-inline-profile">&times;</button>
                <div class="profile-info-content" style="text-align: center;">
                    <div style="margin-bottom: 10px; padding-top: 5px;">
                        <img id="profile-img-detail" src="/images/default-profile.png" alt="í”„ë¡œí•„ ì´ë¯¸ì§€" class="profile-detail-img">
                        <h3 id="profile-nickname-detail">ë‹‰ë„¤ì„</h3>
                    </div>
                    <div class="profile-meta-info" style="border-top: 1px solid #eee; padding-top: 10px;">
                        <p style="font-weight: 500;">ì¥ì†Œ: <strong id="profile-location-detail">...</strong></p>
                        <p style="font-weight: 500;">í¬ì§€ì…˜: <strong id="profile-position-detail">...</strong></p>
                    </div>
                    <button class="chat-one-on-one-btn profile-action-button" id="profile-chat-btn">1:1 ì±„íŒ…í•˜ê¸°</button>
                    <button class="send-friend-request-btn profile-action-button" id="profile-friend-btn">ì¹œêµ¬ ìš”ì²­</button>
                </div>
            </div>

            <!-- âœ… ë©”ì‹œì§€ í‘œì‹œ ì˜ì—­ -->
            <div id="chat-messages-container" class="chat-messages"></div>

            <!-- âœ… ë©”ì‹œì§€ ì…ë ¥ ì˜ì—­ (ì¸ë¼ì¸ ì´ë²¤íŠ¸ ì œê±°) -->
            <div class="chat-input-area">
                <input type="text" id="message-input" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." maxlength="500">
                <button onclick="sendMessage()" id="send-message-btn">ì „ì†¡</button>
            </div>
        </div>
    </div>
</main>

<!-- âœ… ì°¸ì—¬ì ì‚¬ì´ë“œë°” (ìš°ì¸¡) -->
<div id="participant-sidebar" class="participant-sidebar">
    <div class="sidebar-header">
        <span id="sidebar-room-name">ì°¸ì—¬ì ëª©ë¡</span>
        <button class="sidebar-close-btn" onclick="openParticipantList(false)" id="close-participant-sidebar">
            <i class="fas fa-times"></i>
        </button>
    </div>
    <div id="participant-list-container" class="participant-list-container"></div>
    <div style="padding: 15px; border-top: 1px solid #eee;">
        <button class="btn-create invite-action-btn" style="width: 100%;" onclick="openInviteModal()" id="open-invite-modal-btn">
            <i class="fas fa-user-plus"></i> ì¹œêµ¬ ì´ˆëŒ€í•˜ê¸°
        </button>
    </div>
</div>

<!-- âœ… ëª¨ë‹¬: ìƒˆ ì±„íŒ…ë°© ìƒì„± -->
<div id="new-chat-modal" class="modal-overlay">
    <div class="modal-content">
        <h2>ìƒˆ ì±„íŒ…ë°© ì‹œì‘</h2>

        <label for="new-chat-type">ì±„íŒ…ë°© ìœ í˜• ì„ íƒ</label>
        <select id="new-chat-type" onchange="updateNewChatForm(this.value)">
            <option value="one-on-one" selected>1:1 ì±„íŒ…</option>
            <option value="group">ê·¸ë£¹ ì±„íŒ…</option>
            <option value="public">ì „ì²´ ì±„íŒ… (ì „ì²´ ê³µê°œ)</option>
        </select>

        <div id="max-participants-group" style="display: none; margin-top: 10px;">
            <label for="new-chat-max-participants">ìµœëŒ€ ì°¸ì—¬ ì¸ì› (ê·¸ë£¹ ì±„íŒ…)</label>
            <input type="number" id="new-chat-max-participants" min="3" max="50" value="10">
        </div>

        <label for="new-chat-title" style="margin-top: 10px;">ì±„íŒ…ë°© ì´ë¦„</label>
        <input type="text" id="new-chat-title" placeholder="ì±„íŒ…ë°© ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”">

        <div id="recipient-input-group">
            <label for="new-chat-recipient" style="margin-top: 10px;">ìƒëŒ€ë°© ë‹‰ë„¤ì„</label>
            <input type="text" id="new-chat-recipient" placeholder="ì±„íŒ…í•  ìƒëŒ€ë°©ì˜ ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”">
            <p id="chat-form-info" style="font-size: 13px; color: #777; margin-top: 5px;">
                1:1 ì±„íŒ…ì€ ìƒëŒ€ë°© ë‹‰ë„¤ì„ì´ í•„ìˆ˜ì…ë‹ˆë‹¤.
            </p>
        </div>

        <div class="modal-actions">
            <button class="btn-cancel" onclick="openNewChatModal(false)" id="cancel-new-chat-btn">ì·¨ì†Œ</button>
            <button class="btn-create" onclick="createNewChat()" id="create-new-chat-btn">ì±„íŒ… ì‹œì‘</button>
        </div>
    </div>
</div>

<!-- âœ… ëª¨ë‹¬: ì¹œêµ¬ ì´ˆëŒ€ -->
<div id="invite-modal" class="modal-overlay">
    <div class="modal-content">
        <h2>ì¹œêµ¬ ì´ˆëŒ€</h2>
        <p id="invite-room-info" style="font-size: 14px; color: #555; margin-bottom: 15px;">
            í˜„ì¬ ë°©: <strong id="invite-room-name">...</strong>
        </p>

        <div id="friend-list-to-invite" style="max-height: 300px; overflow-y: auto;"></div>

        <div class="modal-actions" style="justify-content: space-between; margin-top: 15px;">
            <p style="font-size: 14px; color: #555; margin: 0; align-self: center;">
                <span id="selected-invite-count">0</span>ëª… ì„ íƒë¨
            </p>
            <div>
                <button class="btn-cancel" onclick="openInviteModal(false)" id="cancel-invite-btn">ì·¨ì†Œ</button>
                <button class="btn-create" onclick="sendInvite()" id="send-invite-btn">ì´ˆëŒ€í•˜ê¸°</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>

<script>
    console.log('âœ… ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì‹œì‘');
    // --- (â˜…ê³µí†µâ˜…) ë©”ë‰´ í† ê¸€ ë° ì¸ì¦ ë¡œì§ ---
    const menuToggle = document.getElementById('menu-toggle');
    const mainMenu = document.getElementById('main-menu');
    const profileMenuToggle = document.getElementById('profile-menu-toggle');
    const profileMenu = document.getElementById('profile-menu');
    const logoutButton = document.getElementById('logout-button');
    const navLoginLink = document.querySelector('#main-menu a[href="/login"]');
    const navLogoutLink = document.querySelector('#main-menu ul li:last-child');
    // ... (ì´í•˜ ê³µí†µ ë¡œì§ ìœ ì§€) ...

    if (menuToggle) {
        menuToggle.addEventListener('click', () => {
            mainMenu.classList.toggle('show');
            if (profileMenu) profileMenu.classList.remove('show');
        });
    }

    if (profileMenuToggle) {
        profileMenuToggle.addEventListener('click', () => {
            profileMenu.classList.toggle('show');
            if (mainMenu) mainMenu.classList.remove('show');
        });
    }
    // ... (ì´í•˜ ê³µí†µ ë¡œì§ ìœ ì§€) ...


    // ===========================================
    // ì±— í´ë¼ì´ì–¸íŠ¸ ë¡œì§ (WebSocket/STOMP)
    // ===========================================

    //webSocket/Stomp
    let stompClient = null;
    let currentRoomId = null;

    //êµ¬ë… ê´€ë¦¬
    let roomSubscription = null;
    let userQueueSubscription = null;

    //ì‚¬ìš©ì ì •ë³´
    let myUserId = null;
    let myUsername = null;
    let currentUserId = null;
    let currentNickname = null;

    //DOM ìš”ì†Œ
    const chatContainer = document.getElementById('chat-messages-container');
    const inputArea = document.getElementById('message-input');
    const roomTitleElement = document.getElementById('room-title');
    const connectionStatus = document.getElementById('connection-status');
    const roomListContainer = document.getElementById('room-list-container');
    const chatTypeTabs = document.getElementById('chat-type-tabs');
    const participantSidebar = document.getElementById('participant-sidebar');
    const participantListContainer = document.getElementById('participant-list-container');
    const chatMainWrapper = document.getElementById('chat-main-wrapper'); // ë©”ì¸ wrapper

    //modal ìš”ì†Œ
    const newChatModal = document.getElementById('new-chat-modal'); // ìƒˆ ì±„íŒ… ëª¨ë‹¬
    const inviteModal = document.getElementById('invite-modal'); // â˜…ì´ˆëŒ€ ëª¨ë‹¬
    const friendListToInvite = document.getElementById('friend-list-to-invite'); // â˜…ì´ˆëŒ€ ëª©ë¡ ì»¨í…Œì´ë„ˆ
    const selectedInviteCountElement = document.getElementById('selected-invite-count'); // â˜…ì„ íƒ ì¸ì› ìˆ˜ í‘œì‹œ
    let selectedInvitees = new Set(); // â˜…ì„ íƒëœ ì¹œêµ¬ Set

    // inline í”„ë¡œí•„
    const inlineProfileDetail = document.getElementById('inline-profile-detail');
    const chatContentArea = document.getElementById('chat-content-area');
    const roomStatusDisplay = document.getElementById('room-status-display');
    const roomParticipantCount = document.getElementById('room-participant-count');
    const roomTypeIcon = document.getElementById('room-type-icon');

    // â˜…ëª¨ë‹¬ ë‚´ ì…ë ¥ ìš”ì†Œ
    const newChatTypeSelect = document.getElementById('new-chat-type');
    const newChatTitleInput = document.getElementById('new-chat-title');
    const newChatRecipientInput = document.getElementById('new-chat-recipient');
    const recipientInputGroup = document.getElementById('recipient-input-group');
    const chatFormInfo = document.getElementById('chat-form-info');

    const RECONNECT_INTERVAL = 5000;
    let currentChatType = 'public'; // â˜…ê¸°ë³¸ê°’ publicìœ¼ë¡œ ì„¤ì • (HTML íƒ­ê³¼ ì¼ì¹˜)

    let token = localStorage.getItem('accessToken');

    if(!token) {
        alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
        window.location.href = "/login";
    }

    //JWT í† í° ë””ì½”ë”© í•¨ìˆ˜
    function parseJwt(token) {
        try {
            const base64Url = token.split('.')[1];
            const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            const jsonPayload = decodeURIComponent(atob(base64).split('').map(function (c){
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
            return JSON.parse(jsonPayload);
        } catch (e){
            console.error('JWT íŒŒì‹± ì‹¤íŒ¨ :' , e);
            return null;
        }
    }

    //JWT ì‚¬ìš©ì ì •ë³´ ì¶”ì¶œ
    function initUserInfo() {
        token = localStorage.getItem('accessToken');
        const payload = parseJwt(token);
        if(!payload || !payload.sub) {
            alert('ìœ íš¨í•˜ì§€ ì•Šì€ í† í°ì…ë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸ í•´ì£¼ì„¸ìš”.');
            localStorage.removeItem('accessToken');
            window.location.href = "/login";
            return;
        }

        fetch('/api/users/me', {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        })
            .then(response => {
                if(!response.ok) throw new Error('ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨');
                return response.json();
            })
            .then(user => {
                currentUserId = user.userId;
                currentNickname = user.nickname;
                myUserId = user.userId;
                myUsername = user.nickname;
                console.log('í˜„ì¬ ì‚¬ìš©ì:', {userId: currentUserId,nickname:currentNickname});

                connect();

                const defaultType = 'public';
                const activeTab = document.querySelector(`[data-type="public"]`);
                if(activeTab) activeTab.classList.add('active');
                loadRoomList(defaultType);
            })
            .catch(error => {
                console.error('ì‚¬ìš©ì ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', error);
                alert('ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                window.location.href = "/login";
            });
    }

    //WebSocket ì—°ê²° ê´€ë¦¬
    function updateStatus(message, isError = true) {
        connectionStatus.textContent = message;
        connectionStatus.style.display = 'block';
        connectionStatus.style.backgroundColor = isError ? '#ffe3e3' : '#e6ffed';
        connectionStatus.style.color = isError ? '#c0392b' : '#28a745';

        if (!isError) {
            setTimeout(() => {
                connectionStatus.style.display = 'none';
            }, 3000);
        } else {
            connectionStatus.style.display = 'none';
            console.error("WebSocket ì—°ê²° ì‹¤íŒ¨. 5ì´ˆ í›„ ì¬ì‹œë„í•©ë‹ˆë‹¤.");
        }
    }

    function connect() {
        if (stompClient && stompClient.connected) {
            console.log('ì´ë¯¸ ì—°ê²° ë˜ì–´ìˆìŠµë‹ˆë‹¤');
            return;
        }

        updateStatus("WebSocket ì—°ê²° ì‹œë„ ì¤‘...", true);

        const socket = new SockJS('/chat');
        stompClient = Stomp.over(socket);
        stompClient.debug = null;

        const headers = token ? { 'Authorization': `Bearer ${token}`  } : {};

        stompClient.connect(headers, onConnected, onError);
    }
    function onConnected() {
        console.log('WebSocket ì—°ê²° ì„±ê³µ.');
        updateStatus("âœ… ì‹¤ì‹œê°„ ì±„íŒ… ì„œë²„ì— ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤.", false);

        if (currentRoomId && !userQueueSubscription) {
            try {
                userQueueSubscription = stompClient.subscribe(`/user/queue/messages`, function (message) {
                        const receivedMessage = JSON.parse(message.body);
                        console.log('ğŸ“¨ ê°œì¸ ë©”ì‹œì§€ ìˆ˜ì‹ :', receivedMessage);
                        handleReceivedMessage(receivedMessage);
                    },{
                        id : `user-queue-${currentRoomId}`}
                );
                console.log('ê°œì¸ ë©”ì„¸ì§€ í êµ¬ë… ì™„ë£Œ');
            } catch (e) {
                console.error('ê°œì¸ í êµ¬ë… ì‹¤íŒ¨ :' ,e);
            }
        }
        if (currentRoomId) {
            subscribeToRoom(currentRoomId);
        }
    }

    function disconnect(){
        console.log('ğŸ”Œ WebSocket ì—°ê²° ì¢…ë£Œ ì‹œì‘');

        if(userQueueSubscription) {
            try {
                userQueueSubscription.unsubscribe();
                console.log('âœ… ê°œì¸ í êµ¬ë… í•´ì œ ì™„ë£Œ');
            } catch (e) {
                console.warn('ê°œì¸ í êµ¬ë… í•´ì œ ì‹¤íŒ¨:', e);
            }
            userQueueSubscription = null;
        }

        if (roomSubscription) {
            try {
                roomSubscription.unsubscribe();
                console.log('âœ… ë°© êµ¬ë… í•´ì œ ì™„ë£Œ');
            } catch (e) {
                console.warn('ë°© êµ¬ë… í•´ì œ ì‹¤íŒ¨:', e);
            }
            roomSubscription = null;
        }

        if (stompClient && stompClient.connected) {
            stompClient.disconnect(() => {
                console.log('âœ… STOMP ì—°ê²° ì™„ì „ ì¢…ë£Œ');
                stompClient = null;
            });
        }
    }

    function onError(error) {
        console.error('WebSocket ì—°ê²° ì˜¤ë¥˜: ì¬ì—°ê²° ì‹œë„', error);
        connectionStatus.style.display = 'none';

        if(userQueueSubscription) {
            userQueueSubscription = null;
        }
        if(roomSubscription) {
            roomSubscription = null;
        }
        if(stompClient){
            try {
                if (stompClient.ws && stompClient.ws.readyState === WebSocket.OPEN) {
                    stompClient.disconnect(() => {
                        stompClient = null;
                        setTimeout(connect, RECONNECT_INTERVAL);
                    });
                } else {
                    stompClient = null;
                    setTimeout(connect, RECONNECT_INTERVAL);
                }
            } catch (e) {
                console.error('ì—°ê²° ì¢…ë£Œ ì¤‘ ì˜¤ë¥˜:', e);
                stompClient = null;
                setTimeout(connect, RECONNECT_INTERVAL);
            }
        } else {
            setTimeout(connect, RECONNECT_INTERVAL);
        }
    }

    function handleReceivedMessage(receivedMessage) {
        console.log('ğŸ“¨ ê°œì¸ ë©”ì‹œì§€ ìˆ˜ì‹ :', receivedMessage);

        if(receivedMessage.roomId === currentRoomId) {
            displayMessage({
                sender: receivedMessage.senderId,
                senderNickname: receivedMessage.senderNickname,
                content: receivedMessage.content,
                timestamp : formatTimestamp(receivedMessage.sentAt || new Date()),
            });
        } else {
            updateUnreadCount(receivedMessage.roomId);
        }

        updateLastMessageInList(receivedMessage.roomId, receivedMessage.content, receivedMessage.senderNickname);
    }

    function updateUnreadCount(roomId) {
        if(roomId !== currentRoomId) {
            const roomItem = document.querySelector(`.room-item-[data-room-id="${roomId}"]`);
            if(roomItem){
                let badge = roomItem.querySelector('.unread-badge');

                if(!badge) {
                    const actionContainer = roomItem.querySelector(('.room-item-actions'));
                    if(actionContainer) {
                        badge = document.createElement('span');
                        badge.classList.add('unread-badge');
                        badge.textContent = '1';
                        actionContainer.insertBefore(badge, actionContainer.firstChild);
                    }
                } else {
                    const currentCount = parseInt(badge.textContent) || 0;
                    badge.textContent = currentCount + 1;
                }
            }
        }
    }

    function updateLastMessageInList(roomId, content, senderNickname) {
        const roomItem = document.querySelector(`.room-item-[data-room-id="${roomId}"]`);
        if(roomItem) {
            const roomInfo = roomItem.querySelector('.room-info');
            if(roomInfo) {
                let lastMessageDiv = roomInfo.querySelector('.last-message');
                if(!lastMessageDiv) {
                    lastMessageDiv = document.createElement('div');
                    lastMessageDiv.className = 'last-message';
                    lastMessageDiv.style.fontSize = '12px';
                    lastMessageDiv.style.color = '#999';
                    lastMessageDiv.style.marginTop = '4px';
                    lastMessageDiv.style.overflow = 'hidden';
                    lastMessageDiv.style.textOverflow = 'ellipsis';
                    lastMessageDiv.style.whiteSpace = 'nowrap';
                    roomInfo.appendChild(lastMessageDiv);
                }
                const preview = content.length > 30 ? content.substring(0, 30) + '...' : content;
                lastMessageDiv.textContent = `${senderNickname}: ${preview}`;
            }
        }
    }



    //ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
    async function fetchUserIdByNickname(nickname) {
        const response = await fetch(`/api/users/search?nickname=${encodeURIComponent(nickname)}`, {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });

        if(!response.ok) throw new Error(`ì‚¬ìš©ì "${nickname}"ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);

        const users = await response.json();

        const user = users[0];
        console.log(user);
        return user.userId;
    }

    async function fetchUserIdsByNicknames(nicknames) {
        const userIds = [];
        for (const nickname of nicknames) {
            try{
                userIds.push(await fetchUserIdByNickname(nickname));
            } catch(e) {
                console.error(`${nickname} ì¡°íšŒ ì‹¤íŒ¨:`,e);
            }
        }
        return userIds;
    }

    function convertToBackendRoomType(frontendType){
        const typeMap = {
            'public': null,
            'group': 'ê·¸ë£¹',
            'one-on-one':'1ëŒ€1'
        };
        return typeMap[frontendType];
    }

    function convertToFrontendRoomType(backendType){
        const typeMap = {
            'ê·¸ë£¹': 'group',
            '1ëŒ€1': 'one-on-one'
        };
        return typeMap[backendType] || 'public';
    }

    //ë©”ì„¸ì§€ ê´€ë ¨
    function subscribeToRoom(roomId) {
        if(roomSubscription) {
            console.log('ğŸ”„ ì´ì „ ë°© êµ¬ë… í•´ì œ:', roomSubscription.id);
            try {
                roomSubscription.unsubscribe();
            } catch (e) {
                console.warn('êµ¬ë… í•´ì œ ì‹¤íŒ¨:', e);
            }
            roomSubscription = null;
        }

        if(stompClient && stompClient.connected) {
            try {
                roomSubscription = stompClient.subscribe(
                    `/topic/chatroom/${roomId}`,
                    onMessageReceived,
                    { id: `room-${roomId}` }
                );
                console.log(`âœ… Room ${roomId} êµ¬ë… ì‹œì‘.`)
            } catch (e){
                console.error('ë°© êµ¬ë… ì‹¤íŒ¨:', e);
            }
        } else{
            console.warn('âš ï¸ STOMP ì—°ê²°ì´ ì—†ì–´ ë°© êµ¬ë… ì‹¤íŒ¨');
        }
    }

    function onMessageReceived(payload) {
        try {
            const message = JSON.parse(payload.body);
            console.log("ìˆ˜ì‹ ëœ ë©”ì„¸ì§€:", message);


            displayMessage({
                sender : message.senderId,
                senderNickname : message.senderNickname,
                content : message.content,
                timestamp : formatTimestamp(message.sentAt || new Date())
            });
        } catch (e) {
            console.log('ë©”ì„¸ì§€ íŒŒì‹± ì˜¤ë¥˜:',e);
        }
    }
    function formatTimestamp(sentAt) {
        return new Date(sentAt).toLocaleTimeString('ko-KR', {
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    // ë©”ì‹œì§€ ì „ì†¡ ë¡œì§ (ì „ì†¡ í›„ í™”ë©´ í‘œì‹œ)
    function sendMessage() {
        const messageContent = inputArea.value.trim();

        if(!messageContent) return;

        if(!currentRoomId){
            alert("ì±„íŒ…ë°©ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.");
            return;
        }

        if(!stompClient || !stompClient.connected){
            alert("âŒ ì±„íŒ… ì„œë²„ì— ì—°ê²°ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤. ì ì‹œ í›„ ì¬ì‹œë„ í•´ì£¼ì„¸ìš”.");
            return;
        }

        const chatMessage = {
            roomId: currentRoomId,
            sender: currentUserId,
            senderNickname: currentNickname,
            content: messageContent,
        };

        console.log("chatMessage :", chatMessage);

        // 1. ì„œë²„ë¡œ ì „ì†¡ (ì‹¤ì‹œê°„ ì›¹ì†Œì¼“)
        stompClient.send(`/app/chatroom/${currentRoomId}/send`, {}, JSON.stringify(chatMessage));

        // 2. ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
        inputArea.value = '';

        // 4. ëª©ë¡ì˜ ë§ˆì§€ë§‰ ë©”ì‹œì§€ ì—…ë°ì´íŠ¸
        updateLastMessage(currentRoomId, messageContent);

    }


    // ìƒˆë¡œìš´ í•¨ìˆ˜: ì±„íŒ… ëª©ë¡ì˜ ë§ˆì§€ë§‰ ë©”ì‹œì§€ ì—…ë°ì´íŠ¸
    function updateLastMessage(roomId, content) {
        const roomItem = document.querySelector(`.room-item[data-room-id="${roomId}"]`);
        if (roomItem) {
            const lastMessageDiv = roomItem.querySelector('.last-message');
            if (lastMessageDiv) {
                const preview = (content.length > 30 ? content.substring(0, 30) + '...' : content);
                lastMessageDiv.textContent = `ë‚˜: ${preview}`;
            }
        }
    }

    function displayMessage(message) {
        const isMine = message.sender === myUserId;

        const wrapper = document.createElement('div');
        wrapper.className = 'message-wrapper ' + (isMine ? 'mine' : 'other');

        if (!isMine) {
            const nicknameDiv = document.createElement('div');
            nicknameDiv.className = 'message-nickname';
            nicknameDiv.textContent = message.senderNickname;
            wrapper.appendChild(nicknameDiv);
        }

        const bubbleRow = document.createElement('div');
        bubbleRow.className = 'bubble-row ' + (isMine ? 'mine' : 'other');

        const timeDiv = document.createElement('div');
        timeDiv.className = 'message-meta';
        timeDiv.textContent = message.timestamp;

        const bubble = document.createElement('div');
        bubble.className = 'message-bubble ' + (isMine ? 'mine' : 'other');
        bubble.innerHTML = message.content;

        // ì‹œê°„
        const time = document.createElement('div');
        time.className = 'message-time';
        time.textContent = message.timestamp;

        // ì¹´í†¡ì²˜ëŸ¼ ë§í’ì„  ì˜¤ë¥¸ìª½ì— ì‹œê°„ ë¶™ì´ê¸°
        if (isMine) {
            bubbleRow.appendChild(time);
            bubbleRow.appendChild(bubble);
        } else {
            bubbleRow.appendChild(bubble);
            bubbleRow.appendChild(time);
        }

        wrapper.appendChild(bubbleRow);

        chatContainer.appendChild(wrapper);
        chatContainer.scrollTop = chatContainer.scrollHeight;

        // const isMine = message.sender === myUserId;
        // const bubble = document.createElement('div');
        // bubble.className = 'message-bubble ' + (isMine ? 'mine' : 'other');
        //
        // if(!isMine) {
        //     const nicknameDiv = document.createElement('div');
        //     nicknameDiv.className = 'message-nickname';
        //     nicknameDiv.textContent = message.senderNickname;
        //     bubble.appendChild(nicknameDiv);
        // }
        //
        //
        //
        //
        // const meta = `<div class="message-meta">${message.timestamp}</div>`;
        // const content = `<div class="message-content message-text">${message.senderNickname}${!isMine && message.senderNickname ? ': ' : ''}${message.content}</div>`;
        //
        // if (isMine) {
        //     bubble.innerHTML = meta + content;
        // } else {
        //     bubble.innerHTML = content + meta;
        // }
        //
        // chatContainer.appendChild(bubble);
        // chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    // ì±„íŒ…ë°© ëª©ë¡ ê´€ë¦¬
    async function loadRoomList(type) {
        currentChatType = type;
        roomListContainer.innerHTML = '<div style="padding:20px; text-align:center; color:#999;">ë¡œë”© ì¤‘...</div>';

        try {
            let rooms = [];
            const token = localStorage.getItem('accessToken');

            if (type === 'public') {
                const [oneToOneResponse, groupResponse] = await Promise.all([
                    fetch('/chatroom?type=1ëŒ€1', {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    }),
                    fetch('/chatroom?type=ê·¸ë£¹',{
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    })
                ]);

                if(!oneToOneResponse.ok || !groupResponse.ok){
                    throw new Error('ì±„íŒ…ë°© ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨');
                }

                const oneToOneRooms = await oneToOneResponse.json();
                const groupRooms = await groupResponse.json();
                rooms = [...oneToOneRooms, ...groupRooms];
            } else {
                const backendType = convertToBackendRoomType(type);
                const response = await fetch(`/chatroom?type=${backendType}`,{
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if(!response.ok) throw new Error('ì±„íŒ…ë°© ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨');
                rooms = await response.json();
            }

            renderRoomList(rooms);
        } catch (error) {
            console.error('ì±„íŒ…ë°© ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
            roomListContainer.innerHTML = '<div style="padding:20px; text-align:center; color:#e74c3c;">ì±„íŒ…ë°©ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</div>';
        }
    }

    // ë Œë”ë§ ë¡œì§ ë¶„ë¦¬
    function renderRoomList(rooms) {
        roomListContainer.innerHTML = '';

        if (rooms.length === 0) {
            roomListContainer.innerHTML = `<div style="padding: 20px; text-align: center; color: #999;">í˜„ì¬ ${currentChatType} ìœ í˜•ì˜ ì±„íŒ…ë°©ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
            if (!currentRoomId || !rooms.find(room => room.roomId === currentRoomId)) {
                currentRoomId = null;
                document.getElementById('current-chat-room').style.display = 'none';
                document.getElementById('chat-welcome-message').style.display = 'flex';
                roomStatusDisplay.style.display = 'none';
            }
            return;
        }

        rooms.forEach(room => {
            const isActive = room.roomId === currentRoomId;
            const item = document.createElement('div');
            item.className = 'room-item' + (isActive ? ' active' : '');
            item.dataset.roomId = room.roomId;

            let typeIcon = '';
            if (room.roomType === '1ëŒ€1') {
                typeIcon = '<i class="fas fa-user" style="color:#6c5ce7; margin-right:5px;"></i>';
            } else if (room.roomType === 'ê·¸ë£¹') {
                typeIcon = '<i class="fas fa-users" style="color:#00b894; margin-right:5px;"></i>';
            }

            // ====== ë°© êµ¬ì¡° ì‹œì‘ ======
            const roomInfo = document.createElement('div');
            roomInfo.className = 'room-info';

            // ì œëª©ê³¼ ë±ƒì§€ í•œ ì¤„
            const titleRow = document.createElement('div');
            titleRow.style.display = 'flex';
            titleRow.style.justifyContent = 'space-between';
            titleRow.style.alignItems = 'center';

            const roomNameDiv = document.createElement('div');
            roomNameDiv.className = 'room-name';
            roomNameDiv.innerHTML = `${typeIcon}<span>${room.roomName}</span>`;

            // ë±ƒì§€(ì•ˆì½ì€ ë©”ì‹œì§€ ê°œìˆ˜)
            let badge = null;
            if (room.unreadCount && room.unreadCount > 0) {
                badge = document.createElement('span');
                badge.className = 'unread-badge';
                badge.textContent = room.unreadCount;
            }

            titleRow.appendChild(roomNameDiv);
            if (badge) titleRow.appendChild(badge);

            // ì°¸ì—¬ì ìˆ˜ (ì•„ë˜ ì¤„)
            const partDiv = document.createElement('div');
            partDiv.className = 'room-participants';
            partDiv.style.color = '#aaa';
            partDiv.style.fontSize = '11px';
            partDiv.style.marginTop = '2px';
            partDiv.textContent = `ì°¸ì—¬ì: ${room.memberCount}ëª…`;

            // ì¡°ë¦½
            roomInfo.appendChild(titleRow);
            roomInfo.appendChild(partDiv);

            roomInfo.addEventListener('click', () => selectRoom(room));

            item.appendChild(roomInfo);
            roomListContainer.appendChild(item);
        });

        if (!currentRoomId) {
            document.getElementById('current-chat-room').style.display = 'none';
            document.getElementById('chat-welcome-message').style.display = 'flex';
        }
    }


    // â˜…ìƒˆë¡œìš´ í•¨ìˆ˜: ì±„íŒ…ë°© ì‚­ì œ ë¡œì§
    async function leaveChatRoom(roomId) {
        if(!confirm('ì •ë§ë¡œ ì´ ì±„íŒ…ë°©ì„ ë‚˜ê°€ì‹œê² ìŠµë‹ˆê¹Œ?')){
            return;
        }

        try {
            const response = await fetch(`/chatroom/${roomId}/leave`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if(!response.ok) throw new Error('ì±„íŒ…ë°© ë‚˜ê°€ê¸° ì‹¤íŒ¨')

            alert('ì±„íŒ…ë°©ì„ ë‚˜ê°”ìŠµë‹ˆë‹¤.');

            if(currentRoomId === roomId){
                currentRoomId = null;
                document.getElementById('current-chat-room').style.display = 'none';
                document.getElementById('chat-welcome-message').style.display = 'flex';

                const leaveRoomBtn = document.getElementById('leave-room-btn');
                if(leaveRoomBtn){
                    leaveRoomBtn.style.display = 'none';
                }
            }
            loadRoomList(currentChatType);
        } catch (e){
            console.error('ì±„íŒ…ë°© ë‚˜ê°€ê¸° ì‹¤íŒ¨:', e);
            alert('ì±„íŒ…ë°©ì„ ë‚˜ê°€ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    }

    async function loadRoomHistory(roomId) {
        if(chatContainer.children.length > 0){
            chatContainer.innerHTML = '';
        } else {
            chatContainer.innerHTML = '<div style="text-align:center; padding:30px; color:#999;">ë©”ì‹œì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
        }

        try {
            const response = await fetch(`/chatroom/${roomId}/messages`,{
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            if(!response.ok) throw new Error('ë©”ì„¸ì§€ ì¡°íšŒ ì‹¤íŒ¨');

            const messages = await response.json();
            chatContainer.innerHTML = '';

            messages.forEach(msg => {
                displayMessage({
                    sender : msg.senderId,
                    senderNickname : msg.senderNickname,
                    content : msg.content,
                    timestamp: formatTimestamp(msg.sentAt)
                });
            });
            chatContainer.scrollTop = chatContainer.scrollHeight;
        } catch (e) {
            console.error('ë©”ì„¸ì§€ ë¡œë“œ ì‹¤íŒ¨:',e);
            chatContainer.innerHTML = '<div style="text-align:center; color:#e74c3c; padding:30px;">ë©”ì‹œì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</div>';
        }
    }

    // â­â­ ë³´ê°•: selectRoom í•¨ìˆ˜ (ì±„íŒ…ë°© ìƒíƒœ í‘œì‹œ ì—…ë°ì´íŠ¸) â­â­
    async function selectRoom(room) {
        const activeItem = document.querySelector('.room-item.active');
        if (activeItem) {
            activeItem.classList.remove('active');
            if(participantSidebar.classList.contains('open')) {
                openParticipantList(false);
            }
        }

        // â­â­â­ ë³´ê°•: ìƒˆë¡œìš´ ë°© ì„ íƒ ì‹œ ì¸ë¼ì¸ í”„ë¡œí•„ ì°½ ë‹«ê¸° â­â­â­
        openInlineProfileDetail(false);

        const newActiveItem = document.querySelector(`.room-item[data-room-id="${room.roomId}"]`);
        if (newActiveItem) {
            newActiveItem.classList.add('active');
            // ì„ íƒëœ ë°©ì˜ ë±ƒì§€ ì œê±° (ì½ìŒ ì²˜ë¦¬)
            const badge = newActiveItem.querySelector('.unread-badge');
            if(badge) badge.remove();
            room.unreadCount = 0;
        }

        try {
            await fetch(`/chatroom/${room.roomId}/mark-read`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                credentials: 'include'
            });
        } catch (e) {
            console.error('ì½ìŒ ìƒíƒœ ê°±ì‹  ì‹¤íŒ¨:', e);
        }

        currentRoomId = room.roomId;
        document.getElementById('sidebar-room-name').textContent = room.roomName;
        roomTitleElement.textContent = room.roomName;

        const leaveRoomBtn = document.getElementById('leave-room-btn');
        if(leaveRoomBtn){
            leaveRoomBtn.style.display = 'block';
            leaveRoomBtn.onclick = () => leaveChatRoom(room.roomId);
        }

        // ì±„íŒ…ë°© ìƒì„¸ ìƒíƒœ ì—…ë°ì´íŠ¸ (ERD: ChatRoom ë°˜ì˜)
        roomStatusDisplay.style.display = 'flex';
        roomParticipantCount.textContent = `${room.memberCount}ëª…`;

        let iconClass = room.roomType === '1ëŒ€1' ? 'fas fa-lock' : 'fas fa-users';
        roomTypeIcon.innerHTML = `<i class="${iconClass}"></i>`;

        document.getElementById('chat-welcome-message').style.display = 'none';
        document.getElementById('current-chat-room').style.display = 'flex';
        document.getElementById('current-chat-room').style.flexDirection = 'column';

        // â­â­ ë³´ê°•: ì±„íŒ… ë‚´ìš©ì„ ë¡œë“œ â­â­
        await loadRoomHistory(room.roomId);

        if (stompClient && stompClient.connected) {
            subscribeToRoom(room.roomId);
        } else {
            connect();
        }
    }

    function openParticipantList(shouldOpen) {
        const isOpen = typeof shouldOpen === 'boolean' ? shouldOpen : !participantSidebar.classList.contains('open');

        if (isOpen) {
            loadParticipantList(currentRoomId);
            participantSidebar.classList.add('open');
            chatMainWrapper.classList.add('sidebar-open');
            openInlineProfileDetail(false);
        } else {
            participantSidebar.classList.remove('open');
            chatMainWrapper.classList.remove('sidebar-open');
        }
    }

    // â˜…â˜…â˜… ìˆ˜ì •: ì°¸ì—¬ì ëª©ë¡ ë¡œë“œ ì‹œ ì¸ë¼ì¸ í”„ë¡œí•„ ìƒì„¸ ì°½ ì—°ê²° â˜…â˜…â˜…
    async function loadParticipantList(roomId) {
        participantListContainer.innerHTML = '<div style="padding:20px; text-align:center; color:#999;">ì°¸ì—¬ì ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
        try{
            const [roomResponse, participantsResponse] = await Promise.all([
                fetch(`/chatroom/${roomId}`,{
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                }),
                fetch(`/chatroom/${roomId}/participants`,{
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                })
            ]);

            if(!roomResponse.ok || !participantsResponse.ok) throw new Error('ì°¸ì—¬ì ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨');

            const room = await roomResponse.json();
            const participants = await participantsResponse.json();

            console.log(`ì°¸ê°€ì ëª©ë¡ ëª…ë‹¨ ${participants.map(p => p.nickname)}`);

            participantListContainer.innerHTML = '';

            if(!participants || participants.length === 0){
                participantListContainer.innerHTML = '<p style="color: #999; text-align: center; padding:20px;">ì°¸ì—¬ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            document.getElementById('sidebar-room-name').textContent = `${room.roomName} (${participants.length} ëª…)`;

            participants.forEach(participant => {
                const item = document.createElement('div');
                item.className = 'participant-item';

                let iconClass = 'fas fa-user-circle';
                let roleBadge = '';
                const nickname = participant.nickname;

                if(participant.role === 'creator'){
                    iconClass = 'fas fa-crown';
                    roleBadge = '<span class="participant-role-badge role-host">ë°©ì¥</span>';
                }

                if(participant.userId === myUserId){
                    roleBadge += '<span class="participant-role-badge role-me">ë‚˜</span>';
                    item.style.backgroundColor = '#f0f5ff';
                }

                if(participant.userId === myUserId){
                    item.style.cursor = 'pointer';
                    item.onclick = () => openInlineProfileDetail(participant.userId, participant.nickname);
                } else {
                    item.style.cursor = 'default';
                }

                item.innerHTML = `
                       <div class="participant-icon-wrapper">
                           <i class="${iconClass}"></i>
                       </div>
                       <div class="participant-details">
                           <span class="participant-name">${participant.nickname}${roleBadge}</span>
                       </div>
                   `;
                participantListContainer.appendChild(item);
            });
        } catch (e) {
            console.error('ì°¸ì—¬ì ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', e);
            participantListContainer.innerHTML = '<p style="color: #e74c3c; text-align: center; padding:20px;">ì°¸ì—¬ì ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>';
        }
    }

    // â˜…â˜…â˜… ìµœì¢… ìˆ˜ì •: ì¸ë¼ì¸ í”„ë¡œí•„ ìƒì„¸ ì •ë³´ í•¨ìˆ˜ (ë§¤ì¹­ë‚´ìš© ì œê±°) â˜…â˜…â˜…
    async function openInlineProfileDetail(userId, displayName) {
        console.log('=== openInlineProfileDetail í˜¸ì¶œ ===');
        console.log('userId:', userId, 'íƒ€ì…:', typeof userId);
        console.log('displayName:', displayName);

        const isCurrentlyOpen = inlineProfileDetail.classList.contains('open');

        // ë‹«ê¸° ìš”ì²­ì´ê±°ë‚˜, ì´ë¯¸ ì—´ë ¤ ìˆëŠ” ìƒíƒœì—ì„œ ê°™ì€ ìœ ì €ë¥¼ ë‹¤ì‹œ í´ë¦­í•˜ë©´ ë‹«ê¸°
        if (userId === false || (isCurrentlyOpen && inlineProfileDetail.dataset.username === userId)) {
            // â­â­ ë‹«ê¸° ì‹œ display: noneìœ¼ë¡œ ì™„ì „íˆ ìˆ¨ê¹€ â­â­
            inlineProfileDetail.classList.remove('open');
            inlineProfileDetail.style.display = 'none'; // ì¦‰ì‹œ ìˆ¨ê¹€
            delete inlineProfileDetail.dataset.userId;
            return;
        }

        try {
            const response = await fetch(`/api/user/${userId}`,{
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if(!response.ok) throw new Error('ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨')

            const profile = await response.json();

            inlineProfileDetail.dataset.userId = userId;

            document.getElementById('profile-img-detail').src = profile.profilePic || '/images/default-profile.png';
            document.getElementById('profile-nickname-detail').textContent = profile.nickname;
            document.getElementById('profile-location-detail').textContent = profile.address; // ì¥ì†Œ (ì§€ì—­)
            document.getElementById('profile-position-detail').textContent = profile.position;

            inlineProfileDetail.style.display = 'flex';
            inlineProfileDetail.classList.add('open');
        } catch (e) {
            console.error('í”„ë¡œí•„ ì¡°íšŒ ì‹¤íŒ¨:', e);
            alert('í”„ë¡œí•„ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        }
    }

    // ìƒˆ ì±„íŒ… ëª¨ë‹¬ ì—´ê¸°/ë‹«ê¸° (ìƒëŒ€ë°© ë‹‰ë„¤ì„ ì¸ì ì¶”ê°€)
    function openNewChatModal(open, recipientUsername = null) {
        console.log("new-modal click");
        if (open) {
            newChatModal.classList.add('open');
            newChatTitleInput.value = '';
            newChatTypeSelect.value = 'one-on-one';
            updateNewChatForm('one-on-one'); // 1:1 ì±„íŒ…ìœ¼ë¡œ ì„¤ì •

            // â­ ìƒëŒ€ë°© ë‹‰ë„¤ì„ì´ ì „ë‹¬ë˜ì—ˆë‹¤ë©´ input í•„ë“œì— ì±„ìš°ê¸° â­
            if (recipientUsername) {
                newChatRecipientInput.value = recipientUsername;
            } else {
                newChatRecipientInput.value = '';
            }

            newChatTitleInput.focus();
        } else {
            newChatModal.classList.remove('open');
        }
    }


    // â˜…ìƒˆë¡œìš´ í•¨ìˆ˜: ì±„íŒ…ë°© ìœ í˜•ì— ë”°ë¼ í¼ í•„ë“œë¥¼ ì—…ë°ì´íŠ¸
    function updateNewChatForm(type) {
        const maxParticipantsGroup = document.getElementById('max-participants-group'); // ì¶”ê°€ëœ ë³€ìˆ˜

        if (type === 'one-on-one') {
            recipientInputGroup.style.display = 'block';
            if (maxParticipantsGroup) maxParticipantsGroup.style.display = 'none'; // 1:1ì€ ì¸ì› ì„¤ì • ìˆ¨ê¹€
            chatFormInfo.textContent = 'ìƒëŒ€ë°© ë‹‰ë„¤ì„ì´ í•„ìˆ˜ì…ë‹ˆë‹¤.';
            newChatRecipientInput.placeholder = '1:1 ì±„íŒ…í•  ìƒëŒ€ë°©ì˜ ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”';

        } else if (type === 'group') {
            recipientInputGroup.style.display = 'block';
            if (maxParticipantsGroup) maxParticipantsGroup.style.display = 'block'; // ê·¸ë£¹ì€ ì¸ì› ì„¤ì • í‘œì‹œ
            chatFormInfo.textContent = 'ê·¸ë£¹ ì±„íŒ…ì— ì´ˆëŒ€í•  ì°¸ì—¬ì ë‹‰ë„¤ì„ì„ ì‰¼í‘œ(,)ë¡œ ì…ë ¥í•˜ì„¸ìš” (ì„ íƒ ì‚¬í•­).';
            newChatRecipientInput.placeholder = 'ì´ˆëŒ€í•  ë‹‰ë„¤ì„ ì…ë ¥ (ì„ íƒ ì‚¬í•­)';

        } else if (type === 'public') {
            recipientInputGroup.style.display = 'none';
            if (maxParticipantsGroup) maxParticipantsGroup.style.display = 'none'; // ì „ì²´ ì±„íŒ…ì€ ì¸ì› ì„¤ì • ìˆ¨ê¹€
            chatFormInfo.textContent = 'ì „ì²´ ì±„íŒ…ë°©ì€ ëˆ„êµ¬ë‚˜ ì°¸ì—¬ ê°€ëŠ¥í•©ë‹ˆë‹¤.';
        }

        // í¼ ì´ˆê¸°í™” (í—·ê°ˆë¦¬ì§€ ì•Šë„ë¡)
        newChatRecipientInput.value = '';
    }

    // â˜…ìˆ˜ì •ëœ í•¨ìˆ˜: ì±„íŒ…ë°© ìƒì„± (ì¹´í…Œê³ ë¦¬ë³„)
    async function createNewChat() {
        const type = newChatTypeSelect.value;
        const title = newChatTitleInput.value.trim();
        const recipientInput = newChatRecipientInput.value.trim();
        const maxParticipantsInput = document.getElementById('new-chat-max-participants'); // ì¶”ê°€ëœ ë³€ìˆ˜
        const maxParticipants = parseInt(maxParticipantsInput.value);
        const createBtn = document.querySelector('.btn-create');
        createBtn.disabled = true;

        if (!title) {
            alert("ì±„íŒ…ë°© ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return;
        }

        try {
            //const token = localStorage.getItem('accessToken');
            let apiUrl = '';
            let requestOptions = {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            };

            if (type === 'one-on-one') {
                if (!recipientInput) {
                    alert("1:1 ì±„íŒ…ì€ ìƒëŒ€ë°© ë‹‰ë„¤ì„ì´ í•„ìˆ˜ì…ë‹ˆë‹¤.");
                    createBtn.disabled = false;
                    return;
                }
                const targetUserId = await fetchUserIdByNickname(recipientInput);
                apiUrl = `/chatroom/onetoone?targetUserId=${targetUserId}`;
                console.log(apiUrl);
            } else {
                const invitedNicknames = recipientInput ? recipientInput.split(',').map(n => n.trim()) : [];
                let invitedUserIds = invitedNicknames.length > 0 ? await fetchUserIdsByNicknames(invitedNicknames) : [];

                invitedUserIds = invitedUserIds.filter(id => id !== myUserId);
                console.log('ì´ˆëŒ€í•  ì‚¬ìš©ì (ë³¸ì¸ ì œì™¸):', invitedUserIds);

                apiUrl = '/chatroom/group';

                requestOptions.headers['Content-Type'] = 'application/json';
                requestOptions.body = JSON.stringify({
                    roomType: 'ê·¸ë£¹',
                    roomName: title,
                    invitedUserIds: invitedUserIds,
                    maxParticipants: maxParticipants || 10
                });
            }
            const response = await fetch(apiUrl, requestOptions);

            if (!response.ok) {
                const errorText = await response.text();
                console.error('ì‘ë‹µ ì—ëŸ¬:', errorText);
                throw new Error('ì±„íŒ…ë°© ìƒì„± ì‹¤íŒ¨');
            }

            const newRoom = await response.json();

            openNewChatModal(false);

            // íƒ­ ì „í™˜
            chatTypeTabs.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
            const newTab = document.querySelector(`[data-type="${type}"]`);
            if (newTab) newTab.classList.add('active');

            loadRoomList(type); // ëª©ë¡ ê°±ì‹ 
            setTimeout(()=>selectRoom(newRoom),500); // ìƒˆ ë°©ìœ¼ë¡œ ì´ë™
        } catch (e) {
            console.error('ì±„íŒ…ë°© ìƒì„± ì‹¤íŒ¨'+e);
            alert('ì±„íŒ…ë°© ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤:' + e.message);
        } finally {
            createBtn.disabled = false;
        }
    }

    // ===========================================
    // â˜…ì¹œêµ¬ ì´ˆëŒ€ ê¸°ëŠ¥ ë¡œì§â˜… (ì´ì „ ì½”ë“œì—ì„œ ë³µêµ¬)
    // ===========================================

    /**
     * ì¹œêµ¬ ì´ˆëŒ€ ëª¨ë‹¬ ì—´ê¸°/ë‹«ê¸°
     */
    function openInviteModal(open = true) {
        if(!currentRoomId) {
            alert('ì±„íŒ…ë°©ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.');
            return;
        }

        if(open) {
            loadFriendListForInvite();
            inviteModal.classList.add('open');
        } else {
            inviteModal.classList.remove('open');
        }
    }

    /**
     * ì´ˆëŒ€ ê°€ëŠ¥í•œ ì¹œêµ¬ ëª©ë¡ì„ ë Œë”ë§
     */
    async function loadFriendListForInvite(currentRoom) {
        if(!currentRoomId){
            alert('ì±„íŒ…ë°©ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.');
            return;
        }
        friendListToInvite.innerHTML = '<div style="padding:20px; text-align:center; color:#999;">ë¡œë”© ì¤‘...</div>';
        try {
            const [ friendsResponse, participantsResponse] = await Promise.all([
                fetch(`/api/friends`,{
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                }),
                fetch(`/chatroom/${currentRoomId}/participants`,{
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                })
            ]);
            if(!friendsResponse.ok) throw new Error('ì¹œêµ¬ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨');
            if (!participantsResponse.ok) throw new Error('ì°¸ì—¬ì ì¡°íšŒ ì‹¤íŒ¨');

            const friends = await friendsResponse.json();
            const participants = await participantsResponse.json();
            const participantUserIds = new Set(participants.map(p => p.userId));

            const availableFriends = friends.filter(f => !participantUserIds.has(f.userId));
            friendListToInvite.innerHTML = '';

            if (availableFriends.length === 0) {
                friendListToInvite.innerHTML = '<p style="text-align:center; padding:20px; color:#999;">ì´ˆëŒ€ ê°€ëŠ¥í•œ ì¹œêµ¬ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            friends.forEach(friend => {
                const item = document.createElement('div');
                item.className = 'invite-friend-item';
                item.innerHTML = `
                <input type="checkbox" class="friend-checkbox" value="${friend.userId}">
                <span>${friend.nickname}</span>`;
                friendListToInvite.appendChild(item);
            })
        } catch (e) {
            console.error('ì¹œêµ¬ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', e);
            friendListToInvite.innerHTML = '<p style="text-align:center; padding:20px; color:#e74c3c;">ì¹œêµ¬ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
        }
    }

    /**
     * ìµœì¢… ì´ˆëŒ€ ì „ì†¡ (ë”ë¯¸ ë¡œì§)
     */
    async function sendInvite() {
        const checkboxes = document.querySelectorAll('.friend-checkbox:checked');
        const invitedUserIds = Array.from(checkboxes).map(c => parseInt(c.value));

        if(invitedUserIds.length === 0) {
            alert('ì´ˆëŒ€í•  ì¹œêµ¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
            return;
        }

        try {
            const response = await fetch(`/chatroom/${currentRoomId}/invite`,{
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`,
                },
                body: JSON.stringify({ invitedUserIds:invitedUserIds })
            });

            if(!response.ok) throw new Error('ì´ˆëŒ€ ì‹¤íŒ¨');

            alert('ì´ˆëŒ€ ë©”ì„¸ì§€ë¥¼ ì„±ê³µì ìœ¼ë¡œ ë³´ëƒˆìŠµë‹ˆë‹¤.');
            openInviteModal(false);
            loadParticipantList(currentRoomId);
        } catch (e) {
            console.error('ì´ˆëŒ€ ì‹¤íŒ¨:', e);
            alert('ì´ˆëŒ€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    }
    // ===========================================
    // â˜…ê¸°íƒ€ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
    // ===========================================

    document.getElementById('room-list-container').addEventListener('click', (e) => {
        // ì‚­ì œ ë²„íŠ¼ í´ë¦­ì€ ì—¬ê¸°ì„œ ì²˜ë¦¬í•˜ì§€ ì•Šê³ , deleteChatRoomì—ì„œ ì²˜ë¦¬ë¨
    });

    chatTypeTabs.addEventListener('click', (e) => {
        const button = e.target.closest('button');
        if (button) {
            chatTypeTabs.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');

            const newType = button.dataset.type;
            loadRoomList(newType);
        }
    });

    // â­â­ ì¸ë¼ì¸ í”„ë¡œí•„ ì•¡ì…˜ ë²„íŠ¼ í•¸ë“¤ëŸ¬ ì—°ê²° â­â­
    document.addEventListener('DOMContentLoaded', () => {
        console.log('âœ… DOMContentLoaded ì‹¤í–‰ë¨');
        // âœ… ì¸ë¼ì¸ í”„ë¡œí•„ ì´ˆê¸° ìˆ¨ê¹€
        if (inlineProfileDetail) {
            inlineProfileDetail.style.display = 'none';
        }

        // âœ… ë¹„íšŒì› ì ‘ê·¼ ì œì–´
        const accessToken = localStorage.getItem('accessToken');
        if (!accessToken) {
            alert("âŒ ì‹¤ì‹œê°„ ì±„íŒ…ì€ íšŒì›ë§Œ ì´ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
            window.location.href = '/login';
            return;
        }

        initUserInfo();

        if(chatTypeTabs){
            chatTypeTabs.addEventListener('click', (e) => {
                const button = e.target.closest('button');
                if(button){
                    chatTypeTabs.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                }
                const newType = button.dataset.type;
                loadRoomList(newType);
            });
        }

        const profileChatBtn = document.getElementById('profile-chat-btn');
        const profileFriendBtn = document.getElementById('profile-friend-btn');

        if(profileChatBtn){
            profileChatBtn.addEventListener('click', async function(){
                const targetUserId = inlineProfileDetail.dataset.userId;
                if(!targetUserId){
                    alert('ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }
                try {
                    const response = await fetch(`/chatroom/onetoone?targetUserId=${targetUserId}`,{
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    if(!response.ok) throw new Error('1:1 ì±„íŒ…ë°© ìƒì„± ì‹¤íŒ¨');

                    const chatRoom = await response.json();
                    openInlineProfileDetail(false);

                    chatTypeTabs.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                    const oneToOneTab = document.querySelector(`[data-type="one-on-one"]`);
                    if(oneToOneTab) oneToOneTab.classList.add('active');

                    await loadRoomList('one-on-one');
                    setTimeout(() => selectRoom(chatRoom), 300);
                } catch (e) {
                    console.error('1:1 ì±„íŒ… ì‹œì‘ ì‹¤íŒ¨:', e);
                    alert('1:1 ì±„íŒ…ì„ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
            });
        }
        if (profileFriendBtn) {
            profileFriendBtn.addEventListener('click', async function() {
                const targetUserId = inlineProfileDetail.dataset.userId;
                if (!targetUserId) {
                    alert('ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }

                try {
                    const response = await fetch(`/api/friends/request/${targetUserId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ targetUserId: targetUserId })
                    });

                    if (!response.ok) throw new Error('ì¹œêµ¬ìš”ì²­ ì‹¤íŒ¨');

                    alert('ì¹œêµ¬ ìš”ì²­ì„ ë³´ëƒˆìŠµë‹ˆë‹¤.');
                    openInlineProfileDetail(false);
                } catch (e) {
                    console.error('ì¹œêµ¬ ìš”ì²­ ì‹¤íŒ¨:', e);
                    alert('ì¹œêµ¬ ìš”ì²­ì„ ë³´ë‚¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
            });
        }
    });
    const messageInput = document.getElementById('message-input');
    if (messageInput) {
        messageInput.addEventListener('keydown', function(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        });
    }

    window.addEventListener('beforeunload', () => {
        console.log('ğŸ”„ í˜ì´ì§€ ì–¸ë¡œë“œ, WebSocket ì •ë¦¬');
        disconnect();
    })
</script>
</body>
</html>