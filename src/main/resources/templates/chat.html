<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MULTI FC - ì‹¤ì‹œê°„ ì±„íŒ…</title>

    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link rel="stylesheet" th:href="@{/css/chat.css}">

    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>

<div th:replace="~{fragments/header :: siteHeader}"></div>

<div id="connection-status">
    WebSocket ì—°ê²° ì¤‘... ì„œë²„ê°€ ì¤€ë¹„ë˜ë©´ ìë™ìœ¼ë¡œ ì—°ê²°ë©ë‹ˆë‹¤.
</div>

<main id="chat-main-wrapper" class="chat-main">
    <div class="chat-sidebar">
        <div class="chat-header">
            ì±„íŒ… ëª©ë¡
            <button id="new-chat-btn" onclick="openNewChatModal(true)"
                    style="background:none; border:none; color:#6c5ce7; font-size:16px; cursor:pointer;"
                    title="ìƒˆ ì±„íŒ… ì‹œì‘">
                <i class="fas fa-plus-circle"></i>
            </button>
        </div>

        <div id="chat-type-tabs" class="chat-type-tabs">
            <button data-type="public" class="active">ì „ì²´ ì±„íŒ…</button>
            <button data-type="group">ê·¸ë£¹ ì±„íŒ…</button>
            <button data-type="one-on-one">1:1 ì±„íŒ…</button>
        </div>

        <div id="room-list-container" class="room-list-container"></div>
    </div>

    <div class="chat-content-area">
        <div id="chat-welcome-message">
            <p>ì±„íŒ… ëª©ë¡ì—ì„œ ë°©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</p>
        </div>

        <div id="current-chat-room" style="display: none;">
            <div id="chat-room-header" class="chat-header">
                <div class="room-title-wrapper">
                    <span id="room-title">ì±„íŒ…ë°© ì œëª©</span>
                    <div id="room-status-display" class="room-status-info" style="display: none;">
                        <span id="room-type-icon"></span>
                        <span id="room-participant-count">0</span>
                    </div>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button onclick="openParticipantList()" id="open-participant-btn"
                            style="background:none; border:none; color:#6c5ce7; font-size:18px; cursor:pointer;"
                            title="ì°¸ì—¬ì ëª©ë¡">
                        <i class="fas fa-users"></i>
                    </button>
                    <button id="leave-room-btn"
                            style="background:none; border:none; color:#e74c3c; font-size:18px; cursor:pointer; display:none;"
                            title="ì±„íŒ…ë°© ë‚˜ê°€ê¸°">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>

            <div id="inline-profile-detail" class="inline-profile-detail">
                <button class="close-profile-btn" onclick="openInlineProfileDetail(false)"
                        id="close-inline-profile">&times;</button>
                <div class="profile-info-content" style="text-align: center;">
                    <div style="margin-bottom: 10px; padding-top: 5px;">
                        <img id="profile-img-detail" src="/images/default-profile.png" alt="í”„ë¡œí•„ ì´ë¯¸ì§€"
                             class="profile-detail-img">
                        <h3 id="profile-nickname-detail">ë‹‰ë„¤ì„</h3>
                    </div>
                    <div class="profile-meta-info" style="border-top: 1px solid #eee; padding-top: 10px;">
                        <p style="font-weight: 500;">ì¥ì†Œ: <strong id="profile-location-detail">...</strong></p>
                        <p style="font-weight: 500;">í¬ì§€ì…˜: <strong id="profile-position-detail">...</strong></p>
                    </div>
                    <button class="chat-one-on-one-btn profile-action-button" id="profile-chat-btn">1:1 ì±„íŒ…í•˜ê¸°</button>
                    <button class="send-friend-request-btn profile-action-button" id="profile-friend-btn">ì¹œêµ¬ ìš”ì²­</button>
                </div>
            </div>

            <div id="chat-messages-container" class="chat-messages"></div>

            <div class="chat-input-area">
                <input type="text" id="message-input" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." maxlength="500">
                <button onclick="sendMessage()" id="send-message-btn">ì „ì†¡</button>
            </div>
        </div>
    </div>
</main>

<div id="participant-sidebar" class="participant-sidebar">
    <div class="sidebar-header">
        <span id="sidebar-room-name">ì°¸ì—¬ì ëª©ë¡</span>
        <button class="sidebar-close-btn" onclick="openParticipantList(false)" id="close-participant-sidebar">
            <i class="fas fa-times"></i>
        </button>
    </div>
    <div id="participant-list-container" class="participant-list-container"></div>
    <div style="padding: 15px; border-top: 1px solid #eee;">
        <button class="btn-create invite-action-btn" style="width: 100%;" onclick="openInviteModal()"
                id="open-invite-modal-btn">
            <i class="fas fa-user-plus"></i> ì¹œêµ¬ ì´ˆëŒ€í•˜ê¸°
        </button>
    </div>
</div>

<div id="new-chat-modal" class="chat-modal-overlay">
    <div class="chat-modal-content" style="position: relative;">
        <button type="button" class="modal-close-x" onclick="openNewChatModal(false)">&times;</button>

        <h2>ìƒˆ ì±„íŒ…ë°© ì‹œì‘</h2>

        <label for="new-chat-type">ì±„íŒ…ë°© ìœ í˜• ì„ íƒ</label>
        <select id="new-chat-type" onchange="updateNewChatForm(this.value)">
            <option value="one-on-one" selected>1:1 ì±„íŒ…</option>
            <option value="group">ê·¸ë£¹ ì±„íŒ…</option>
        </select>

        <div id="max-participants-group" style="display: none; margin-top: 10px;">
            <label for="new-chat-max-participants">ìµœëŒ€ ì°¸ì—¬ ì¸ì› (ê·¸ë£¹ ì±„íŒ…)</label>
            <input type="number" id="new-chat-max-participants" min="3" max="50" value="10">
        </div>

        <label for="new-chat-title" style="margin-top: 10px;">ì±„íŒ…ë°© ì´ë¦„</label>
        <input type="text" id="new-chat-title" placeholder="ì±„íŒ…ë°© ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”">

        <div id="recipient-input-group">
            <label for="new-chat-recipient" style="margin-top: 10px;">ìƒëŒ€ë°© ë‹‰ë„¤ì„</label>
            <input type="text" id="new-chat-recipient" placeholder="ì±„íŒ…í•  ìƒëŒ€ë°©ì˜ ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”">
            <p id="chat-form-info" style="font-size: 13px; color: #777; margin-top: 5px;">
                1:1 ì±„íŒ…ì€ ìƒëŒ€ë°© ë‹‰ë„¤ì„ì´ í•„ìˆ˜ì…ë‹ˆë‹¤.
            </p>
        </div>

        <div class="modal-actions" style="justify-content: flex-end; margin-top: 20px;">
            <button class="btn-create" onclick="createNewChat()" id="create-new-chat-btn">ì±„íŒ… ì‹œì‘</button>
        </div>
    </div>
</div>

<div id="invite-modal" class="chat-modal-overlay">
    <div class="modal-content">
        <button type="button" class="modal-close-x" onclick="openInviteModal(false)">&times;</button>

        <h2>ì¹œêµ¬ ì´ˆëŒ€</h2>
        <p id="invite-room-info" style="font-size: 14px; color: #555; margin-bottom: 15px;">
            í˜„ì¬ ë°©: <strong id="invite-room-name">...</strong>
        </p>

        <div id="friend-list-to-invite" style="max-height: 300px;"></div>

        <div class="modal-actions" style="justify-content: space-between; margin-top: 15px;">
            <p style="font-size: 14px; color: #555; margin: 0; align-self: center;">
                <span id="selected-invite-count">0</span>ëª… ì„ íƒë¨
            </p>
            <div>
                <button class="btn-create" onclick="sendInvite()" id="send-invite-btn">ì´ˆëŒ€í•˜ê¸°</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>

<script>
    console.log('âœ… ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì‹œì‘');

    let stompClient = null;
    let currentRoomId = null;

    let roomSubscription = null;
    let userQueueSubscription = null;

    let myUserId = null;
    let myUsername = null;
    let currentUserId = null;
    let currentNickname = null;

    // â­â­â­ ì¶”ê°€: ì°¸ì—¬ì IDì™€ ë‹‰ë„¤ì„ì„ ë§¤í•‘í•˜ëŠ” ë§µ â­â­â­
    let currentRoomParticipantsMap = {}; // Key: userId, Value: nickname
    let nicknameCache = {}; // Key: userId, Value: nickname (ì˜¨ë””ë§¨ë“œ ìºì‹œ)

    const chatContainer = document.getElementById('chat-messages-container');
    const inputArea = document.getElementById('message-input');
    const roomTitleElement = document.getElementById('room-title');
    const connectionStatus = document.getElementById('connection-status');
    const roomListContainer = document.getElementById('room-list-container');
    const chatTypeTabs = document.getElementById('chat-type-tabs');
    const participantSidebar = document.getElementById('participant-sidebar');
    const participantListContainer = document.getElementById('participant-list-container');
    const chatMainWrapper = document.getElementById('chat-main-wrapper');

    const newChatModal = document.getElementById('new-chat-modal');
    const inviteModal = document.getElementById('invite-modal');
    const friendListToInvite = document.getElementById('friend-list-to-invite');
    const selectedInviteCountElement = document.getElementById('selected-invite-count');
    let selectedInvitees = new Set();

    const inlineProfileDetail = document.getElementById('inline-profile-detail');
    const roomStatusDisplay = document.getElementById('room-status-display');
    const roomParticipantCount = document.getElementById('room-participant-count');
    const roomTypeIcon = document.getElementById('room-type-icon');

    const newChatTypeSelect = document.getElementById('new-chat-type');
    const newChatTitleInput = document.getElementById('new-chat-title');
    const newChatRecipientInput = document.getElementById('new-chat-recipient');
    const recipientInputGroup = document.getElementById('recipient-input-group');
    const chatFormInfo = document.getElementById('chat-form-info');

    const RECONNECT_INTERVAL = 5000;
    let currentChatType = 'public';

    let token = localStorage.getItem('accessToken');

    if (!token) {
        alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
        window.location.href = "/login";
    }

    function parseJwt(token) {
        try {
            const base64Url = token.split('.')[1];
            const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            const jsonPayload = decodeURIComponent(atob(base64).split('').map(function (c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
            return JSON.parse(jsonPayload);
        } catch (e) {
            console.error('JWT íŒŒì‹± ì‹¤íŒ¨ :', e);
            return null;
        }
    }

    function initUserInfo() {
        token = localStorage.getItem('accessToken');
        const payload = parseJwt(token);
        if (!payload || !payload.sub) {
            alert('ìœ íš¨í•˜ì§€ ì•Šì€ í† í°ì…ë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸ í•´ì£¼ì„¸ìš”.');
            localStorage.removeItem('accessToken');
            window.location.href = "/login";
            return;
        }

        fetch('/api/users/me', {
            headers: { 'Authorization': `Bearer ${token}` }
        })
            .then(response => {
                if (!response.ok) throw new Error('ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨');
                return response.json();
            })
            .then(user => {
                currentUserId = user.userId;
                currentNickname = user.nickname;
                myUserId = user.userId;
                myUsername = user.nickname;

                localStorage.setItem('userId', user.userId);
                localStorage.setItem('username', user.nickname);

                console.log('í˜„ì¬ ì‚¬ìš©ì:', { userId: currentUserId, nickname: currentNickname });

                connect();

                const defaultType = 'public';
                const activeTab = document.querySelector(`[data-type="public"]`);
                if (activeTab) activeTab.classList.add('active');
                loadRoomList(defaultType);
            })
            .catch(error => {
                console.error('ì‚¬ìš©ì ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', error);
                alert('ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                window.location.href = "/login";
            });
    }

    // â­â­â­ ì¶”ê°€: ì±„íŒ…ë°© ì°¸ì—¬ì ID-ë‹‰ë„¤ì„ ë§µì„ ë¡œë“œí•˜ëŠ” í•¨ìˆ˜ â­â­â­
    async function loadParticipantMap(roomId) {
        currentRoomParticipantsMap = {}; // ë§µ ì´ˆê¸°í™”
        try {
            const response = await fetch(`/chatroom/${roomId}/participants`, { headers: { 'Authorization': `Bearer ${token}` } });
            if (!response.ok) throw new Error('ì°¸ì—¬ì ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨');
            const participants = await response.json();

            participants.forEach(p => {
                currentRoomParticipantsMap[p.userId] = p.nickname;
            });
            console.log('âœ… ì°¸ì—¬ì ë§µ ì—…ë°ì´íŠ¸ ì™„ë£Œ:', currentRoomParticipantsMap);
        } catch (e) {
            console.error('ì°¸ì—¬ì ë§µ ë¡œë“œ ì‹¤íŒ¨:', e);
        }
    }

    // â­â­â­ ì¶”ê°€: ì‹¤ì‹œê°„ìœ¼ë¡œ ë‹‰ë„¤ì„ì„ ë³´ì¥í•˜ëŠ” ì˜¨ë””ë§¨ë“œ í•¨ìˆ˜ â­â­â­
    async function getNicknameOnTheFly(userId, initialNickname) {
        // IDê°€ nullì´ê±°ë‚˜ undefined, 0ì¸ ê²½ìš° REST API í˜¸ì¶œ ì—†ì´ ë°”ë¡œ ì´ˆê¸° ë‹‰ë„¤ì„ì„ ë°˜í™˜í•©ë‹ˆë‹¤.
        if (!userId || userId === 0) {
            return initialNickname || 'ì•Œ ìˆ˜ ì—†ëŠ” ì‚¬ìš©ì';
        }

        // 1. ìºì‹œ í™•ì¸
        if (nicknameCache[userId]) {
            return nicknameCache[userId];
        }
        // 2. í˜„ì¬ ë§µ í™•ì¸
        if (currentRoomParticipantsMap[userId]) {
            return currentRoomParticipantsMap[userId];
        }

        // 3. initialNicknameì´ ë‹‰ë„¤ì„ì²˜ëŸ¼ ë³´ì´ë©´ (IDê°€ ì•„ë‹ˆë©´) ìºì‹œì— ì €ì¥ í›„ ë°˜í™˜
        if (initialNickname && /[ê°€-í£A-Z]/.test(initialNickname)) {
            nicknameCache[userId] = initialNickname;
            return initialNickname;
        }

        // 4. REST APIë¥¼ í†µí•´ í”„ë¡œí•„ì„ ì¡°íšŒ (ìµœí›„ì˜ ìˆ˜ë‹¨)
        try {
            const response = await fetch(`/api/users/${userId}`, { headers: { 'Authorization': `Bearer ${token}` } });
            if (response.ok) {
                const profile = await response.json();
                const guaranteedNickname = profile.nickname || `ì‚¬ìš©ì${userId}`;

                // ìºì‹œ ë° ë§µ ì—…ë°ì´íŠ¸
                nicknameCache[userId] = guaranteedNickname;
                currentRoomParticipantsMap[userId] = guaranteedNickname;

                return guaranteedNickname;
            }
        } catch (e) {
            console.warn(`âš ï¸ On-the-fly ë‹‰ë„¤ì„ ì¡°íšŒ ì‹¤íŒ¨ (ID: ${userId})`, e);
        }

        // 5. ì‹¤íŒ¨ ì‹œ ID ë°˜í™˜
        return initialNickname || `ID:${userId}`;
    }


    function updateStatus(message, isError = true) {
        connectionStatus.textContent = message;
        connectionStatus.style.display = 'block';
        connectionStatus.style.backgroundColor = isError ? '#ffe3e3' : '#e6ffed';
        connectionStatus.style.color = isError ? '#c0392b' : '#28a745';

        // â­â­â­ ìˆ˜ì •: ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ ì‹œê°„ì„ 1ì´ˆë¡œ ë‹¨ì¶• (1000ms) â­â­â­
        const delay = isError ? 5000 : 1000;

        setTimeout(() => {
            connectionStatus.style.display = 'none';
        }, delay);

        if (isError) {
            console.error("WebSocket ì—°ê²° ì‹¤íŒ¨. 5ì´ˆ í›„ ì¬ì‹œë„í•©ë‹ˆë‹¤.");
        }
    }

    function connect() {
        if (stompClient && stompClient.connected) return;

        updateStatus("WebSocket ì—°ê²° ì‹œë„ ì¤‘...", true);

        const socket = new SockJS('/chat');
        stompClient = Stomp.over(socket);
        stompClient.debug = null;

        const headers = token ? { 'Authorization': `Bearer ${token}` } : {};
        stompClient.connect(headers, onConnected, onError);
    }

    function onConnected() {
        console.log('WebSocket ì—°ê²° ì„±ê³µ.');
        updateStatus("âœ… ì‹¤ì‹œê°„ ì±„íŒ… ì„œë²„ì— ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤.", false);

        if (!userQueueSubscription) {
            userQueueSubscription = stompClient.subscribe(`/user/queue/messages`, function (message) {
                const receivedMessage = JSON.parse(message.body);
                handleReceivedMessage(receivedMessage);
            }, { id: `user-queue` });
        }

        if (currentRoomId) subscribeToRoom(currentRoomId);
    }

    function disconnect() {
        if (userQueueSubscription) {
            try { userQueueSubscription.unsubscribe(); } catch (e) {}
            userQueueSubscription = null;
        }
        if (roomSubscription) {
            try { roomSubscription.unsubscribe(); } catch (e) {}
            roomSubscription = null;
        }
        if (stompClient && stompClient.connected) {
            stompClient.disconnect(() => stompClient = null);
        }
    }

    function onError(error) {
        console.error('WebSocket ì—°ê²° ì˜¤ë¥˜: ì¬ì—°ê²° ì‹œë„', error);
        connectionStatus.style.display = 'none';

        userQueueSubscription = null;
        roomSubscription = null;

        if (stompClient) {
            try {
                stompClient.disconnect(() => {
                    stompClient = null;
                    setTimeout(connect, RECONNECT_INTERVAL);
                });
            } catch (e) {
                stompClient = null;
                setTimeout(connect, RECONNECT_INTERVAL);
            }
        } else {
            setTimeout(connect, RECONNECT_INTERVAL);
        }
    }

    async function handleReceivedMessage(receivedMessage) {

        // ğŸ’¡ ìˆ˜ì •: IDê°€ ìœ íš¨í•œì§€ í™•ì¸í•˜ê³ , ë‹‰ë„¤ì„ ë³´ì¥ í•¨ìˆ˜ í˜¸ì¶œ
        const senderId = receivedMessage.sender || receivedMessage.senderId;
        let senderNickname = await getNicknameOnTheFly(senderId, receivedMessage.senderNickname);

        if (receivedMessage.roomId === currentRoomId) {
            displayMessage({
                sender: senderId,
                senderNickname: senderNickname,
                content: receivedMessage.content,
                timestamp: formatTimestamp(receivedMessage.sentAt || new Date()),
            });
        } else {
            updateUnreadCount(receivedMessage.roomId);
        }

        updateLastMessageInList(receivedMessage.roomId, receivedMessage.content, senderNickname);
    }

    function updateUnreadCount(roomId) {
        if (roomId !== currentRoomId) {
            const roomItem = document.querySelector(`.room-item[data-room-id="${roomId}"]`);
            if (roomItem) {
                let badge = roomItem.querySelector('.unread-badge');
                if (!badge) {
                    badge = document.createElement('span');
                    badge.classList.add('unread-badge');
                    badge.textContent = '1';
                    roomItem.querySelector('.title-row')?.appendChild(badge);
                } else {
                    const currentCount = parseInt(badge.textContent) || 0;
                    badge.textContent = currentCount + 1;
                }
            }
        }
    }

    function updateLastMessageInList(roomId, content, senderNickname) {
        const roomItem = document.querySelector(`.room-item[data-room-id="${roomId}"]`);
        if (roomItem) {
            const roomInfo = roomItem.querySelector('.room-info');
            if (roomInfo) {
                let lastMessageDiv = roomInfo.querySelector('.last-message');
                if (!lastMessageDiv) {
                    lastMessageDiv = document.createElement('div');
                    lastMessageDiv.className = 'last-message';
                    lastMessageDiv.style.fontSize = '12px';
                    lastMessageDiv.style.color = '#999';
                    lastMessageDiv.style.marginTop = '4px';
                    lastMessageDiv.style.overflow = 'hidden';
                    lastMessageDiv.style.textOverflow = 'ellipsis';
                    lastMessageDiv.style.whiteSpace = 'nowrap';
                    roomInfo.appendChild(lastMessageDiv);
                }
                const preview = content.length > 30 ? content.substring(0, 30) + '...' : content;
                lastMessageDiv.textContent = `${senderNickname}: ${preview}`;
            }
        }
    }

    function convertToBackendRoomType(frontendType) {
        const typeMap = { 'public': null, 'group': 'ê·¸ë£¹', 'one-on-one': '1ëŒ€1' };
        return typeMap[frontendType];
    }

    function subscribeToRoom(roomId) {
        if (roomSubscription) {
            try { roomSubscription.unsubscribe(); } catch (e) {}
            roomSubscription = null;
        }

        if (stompClient && stompClient.connected) {
            roomSubscription = stompClient.subscribe(
                `/topic/chatroom/${roomId}`,
                onMessageReceived,
                { id: `room-${roomId}` }
            );
        }
    }

    async function onMessageReceived(payload) {
        try {
            const message = JSON.parse(payload.body);

            // ğŸ’¡ ìˆ˜ì •: IDê°€ ìœ íš¨í•œì§€ í™•ì¸í•˜ê³ , ë‹‰ë„¤ì„ ë³´ì¥ í•¨ìˆ˜ í˜¸ì¶œ
            const senderId = message.sender || message.senderId;
            let senderNickname = await getNicknameOnTheFly(senderId, message.senderNickname);

            displayMessage({
                sender: senderId,
                senderNickname: senderNickname,
                content: message.content,
                timestamp: formatTimestamp(message.sentAt || new Date())
            });
        } catch (e) {
            console.log('ë©”ì„¸ì§€ íŒŒì‹± ì˜¤ë¥˜:', e);
        }
    }

    function formatTimestamp(sentAt) {
        return new Date(sentAt).toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
    }

    function sendMessage() {
        const messageContent = inputArea.value.trim();
        if (!messageContent) return;
        if (!currentRoomId) return alert("ì±„íŒ…ë°©ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.");
        if (!stompClient || !stompClient.connected) return alert("âŒ ì±„íŒ… ì„œë²„ì— ì—°ê²°ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.");

        const chatMessage = {
            roomId: currentRoomId,
            sender: currentUserId,
            senderNickname: currentNickname,
            content: messageContent,
        };

        stompClient.send(`/app/chatroom/${currentRoomId}/send`, {}, JSON.stringify(chatMessage));
        inputArea.value = '';
        updateLastMessage(currentRoomId, messageContent);
    }

    function updateLastMessage(roomId, content) {
        const roomItem = document.querySelector(`.room-item[data-room-id="${roomId}"]`);
        if (roomItem) {
            const lastMessageDiv = roomItem.querySelector('.last-message');
            if (lastMessageDiv) {
                const preview = (content.length > 30 ? content.substring(0, 30) + '...' : content);
                lastMessageDiv.textContent = `ë‚˜: ${preview}`;
            }
        }
    }

    function displayMessage(message) {
        const isMine = message.sender === myUserId;
        const wrapper = document.createElement('div');
        wrapper.className = 'message-wrapper ' + (isMine ? 'mine' : 'other');

        if (!isMine) {
            const nicknameDiv = document.createElement('div');
            nicknameDiv.className = 'message-nickname';
            nicknameDiv.textContent = message.senderNickname;
            wrapper.appendChild(nicknameDiv);
        }

        const bubbleRow = document.createElement('div');
        bubbleRow.className = 'bubble-row ' + (isMine ? 'mine' : 'other');

        const bubble = document.createElement('div');
        bubble.className = 'message-bubble ' + (isMine ? 'mine' : 'other');
        bubble.textContent = message.content;

        const time = document.createElement('div');
        time.className = 'message-time';
        time.textContent = message.timestamp;

        if (isMine) {
            bubbleRow.appendChild(time);
            bubbleRow.appendChild(bubble);
        } else {
            bubbleRow.appendChild(bubble);
            bubbleRow.appendChild(time);
        }

        wrapper.appendChild(bubbleRow);
        chatContainer.appendChild(wrapper);
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    async function loadRoomList(type) {
        currentChatType = type;
        roomListContainer.innerHTML = '<div style="padding:20px; text-align:center; color:#999;">ë¡œë”© ì¤‘...</div>';

        try {
            let rooms = [];
            const token = localStorage.getItem('accessToken');

            if (type === 'public') {
                const [oneToOneResponse, groupResponse] = await Promise.all([
                    fetch('/chatroom?type=1ëŒ€1', { headers: { 'Authorization': `Bearer ${token}` } }),
                    fetch('/chatroom?type=ê·¸ë£¹', { headers: { 'Authorization': `Bearer ${token}` } })
                ]);

                if (!oneToOneResponse.ok || !groupResponse.ok) throw new Error('ì±„íŒ…ë°© ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨');
                const oneToOneRooms = await oneToOneResponse.json();
                const groupRooms = await groupResponse.json();
                rooms = [...oneToOneRooms, ...groupRooms];
            } else {
                const backendType = convertToBackendRoomType(type);
                const response = await fetch(`/chatroom?type=${backendType}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!response.ok) throw new Error('ì±„íŒ…ë°© ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨');
                rooms = await response.json();
            }

            renderRoomList(rooms);
        } catch (error) {
            console.error('ì±„íŒ…ë°© ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
            roomListContainer.innerHTML =
                '<div style="padding:20px; text-align:center; color:#e74c3c;">ì±„íŒ…ë°©ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</div>';
        }
    }

    function renderRoomList(rooms) {
        roomListContainer.innerHTML = '';

        if (rooms.length === 0) {
            roomListContainer.innerHTML =
                `<div style="padding: 20px; text-align: center; color: #999;">í˜„ì¬ ${currentChatType} ìœ í˜•ì˜ ì±„íŒ…ë°©ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
            if (!currentRoomId || !rooms.find(room => room.roomId === currentRoomId)) {
                currentRoomId = null;
                document.getElementById('current-chat-room').style.display = 'none';
                document.getElementById('chat-welcome-message').style.display = 'flex';
                roomStatusDisplay.style.display = 'none';
            }
            return;
        }

        rooms.forEach(room => {
            const isActive = room.roomId === currentRoomId;
            const item = document.createElement('div');
            item.className = 'room-item' + (isActive ? ' active' : '');
            item.dataset.roomId = room.roomId;

            let typeIcon = '';
            if (room.roomType === '1ëŒ€1') typeIcon = '<i class="fas fa-user" style="color:#6c5ce7; margin-right:5px;"></i>';
            else if (room.roomType === 'ê·¸ë£¹') typeIcon = '<i class="fas fa-users" style="color:#00b894; margin-right:5px;"></i>';

            const roomInfo = document.createElement('div');
            roomInfo.className = 'room-info';

            const titleRow = document.createElement('div');
            titleRow.className = 'title-row';
            titleRow.style.display = 'flex';
            titleRow.style.justifyContent = 'space-between';
            titleRow.style.alignItems = 'center';

            const roomNameDiv = document.createElement('div');
            roomNameDiv.className = 'room-name';
            roomNameDiv.innerHTML = `${typeIcon}<span>${room.roomName}</span>`;

            let badge = null;
            if (room.unreadCount && room.unreadCount > 0) {
                badge = document.createElement('span');
                badge.className = 'unread-badge';
                badge.textContent = room.unreadCount;
            }

            titleRow.appendChild(roomNameDiv);
            if (badge) titleRow.appendChild(badge);

            const partDiv = document.createElement('div');
            partDiv.className = 'room-participants';
            partDiv.style.color = '#aaa';
            partDiv.style.fontSize = '11px';
            partDiv.style.marginTop = '2px';
            partDiv.textContent = `ì°¸ì—¬ì: ${room.memberCount}ëª…`;

            roomInfo.appendChild(titleRow);
            roomInfo.appendChild(partDiv);

            roomInfo.addEventListener('click', () => selectRoom(room));

            item.appendChild(roomInfo);
            roomListContainer.appendChild(item);
        });

        if (!currentRoomId) {
            document.getElementById('current-chat-room').style.display = 'none';
            document.getElementById('chat-welcome-message').style.display = 'flex';
        }
    }

    async function loadRoomHistory(roomId) {
        chatContainer.innerHTML = '<div style="text-align:center; padding:30px; color:#999;">ë©”ì‹œì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';

        try {
            const response = await fetch(`/chatroom/${roomId}/messages`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (!response.ok) throw new Error('ë©”ì„¸ì§€ ì¡°íšŒ ì‹¤íŒ¨');

            const messages = await response.json();
            chatContainer.innerHTML = '';

            messages.forEach(msg => {
                displayMessage({
                    sender: msg.senderId,
                    senderNickname: msg.senderNickname,
                    content: msg.content,
                    timestamp: formatTimestamp(msg.sentAt)
                });
            });
            chatContainer.scrollTop = chatContainer.scrollHeight;
        } catch (e) {
            console.error('ë©”ì„¸ì§€ ë¡œë“œ ì‹¤íŒ¨:', e);
            chatContainer.innerHTML =
                '<div style="text-align:center; color:#e74c3c; padding:30px;">ë©”ì‹œì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</div>';
        }
    }

    // â­â­â­ ì±„íŒ…ë°© ë‚˜ê°€ê¸° ë¡œì§ ì¶”ê°€ â­â­â­
    async function leaveChatRoom(roomId) {
        if (!confirm('ì •ë§ë¡œ ì´ ì±„íŒ…ë°©ì„ ë‚˜ê°€ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ë°©ì˜ ë©”ì‹œì§€ëŠ” ë” ì´ìƒ ë³¼ ìˆ˜ ì—†ê²Œ ë©ë‹ˆë‹¤.')) {
            return;
        }

        try {
            const response = await fetch(`/chatroom/${roomId}/leave`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (!response.ok) {
                const data = await response.json().catch(() => ({}));
                throw new Error(data.message || 'ì±„íŒ…ë°© ë‚˜ê°€ê¸° ìš”ì²­ ì‹¤íŒ¨');
            }

            alert('âœ… ì±„íŒ…ë°©ì„ ë‚˜ê°”ìŠµë‹ˆë‹¤.');

            // 1. í˜„ì¬ í™”ë©´ ì •ë¦¬
            if (currentRoomId === roomId) {
                currentRoomId = null;
                document.getElementById('current-chat-room').style.display = 'none';
                document.getElementById('chat-welcome-message').style.display = 'flex';
                document.getElementById('leave-room-btn').style.display = 'none';
                openInlineProfileDetail(false); // í”„ë¡œí•„ ì°½ ë‹«ê¸°
            }

            // 2. ì±„íŒ…ë°© ëª©ë¡ ê°±ì‹ 
            loadRoomList(currentChatType);

        } catch (e) {
            console.error('ì±„íŒ…ë°© ë‚˜ê°€ê¸° ì˜¤ë¥˜:', e);
            alert('âŒ ì±„íŒ…ë°©ì„ ë‚˜ê°€ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + e.message);
        }
    }


    async function selectRoom(room) {
        document.querySelector('.room-item.active')?.classList.remove('active');
        openInlineProfileDetail(false);

        const newActiveItem = document.querySelector(`.room-item[data-room-id="${room.roomId}"]`);
        newActiveItem?.classList.add('active');
        newActiveItem?.querySelector('.unread-badge')?.remove();
        room.unreadCount = 0;

        try {
            await fetch(`/chatroom/${room.roomId}/mark-read`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }
            });
        } catch (e) {}

        currentRoomId = room.roomId;
        document.getElementById('sidebar-room-name').textContent = room.roomName;
        roomTitleElement.textContent = room.roomName;

        const leaveRoomBtn = document.getElementById('leave-room-btn');
        leaveRoomBtn.style.display = 'block';
        leaveRoomBtn.onclick = () => leaveChatRoom(room.roomId);

        roomStatusDisplay.style.display = 'flex';
        roomParticipantCount.textContent = `${room.memberCount}ëª…`;
        roomTypeIcon.innerHTML = `<i class="${room.roomType === '1ëŒ€1' ? 'fas fa-lock' : 'fas fa-users'}"></i>`;

        document.getElementById('chat-welcome-message').style.display = 'none';
        const currentChatRoomEl = document.getElementById('current-chat-room');
        currentChatRoomEl.style.display = 'flex';
        currentChatRoomEl.style.flexDirection = 'column';

        // â­â­â­ ìˆ˜ì •: ì°¸ì—¬ì ë§µì„ ë¨¼ì € ë¡œë“œí•˜ì—¬ ì‹¤ì‹œê°„ ë‹‰ë„¤ì„ í‘œì‹œ ë¬¸ì œë¥¼ í•´ê²° â­â­â­
        await loadParticipantMap(room.roomId);

        await loadRoomHistory(room.roomId);

        if (stompClient && stompClient.connected) subscribeToRoom(room.roomId);
        else connect();
    }

    function openParticipantList(shouldOpen) {
        const isOpen = typeof shouldOpen === 'boolean'
            ? shouldOpen
            : !participantSidebar.classList.contains('open');

        if (isOpen) {
            if (!currentRoomId) return alert('ì±„íŒ…ë°©ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.');
            loadParticipantList(currentRoomId);
            participantSidebar.classList.add('open');
            chatMainWrapper.classList.add('sidebar-open');
            openInlineProfileDetail(false);
        } else {
            participantSidebar.classList.remove('open');
            chatMainWrapper.classList.remove('sidebar-open');
        }
    }

    async function loadParticipantList(roomId) {
        participantListContainer.innerHTML =
            '<div style="padding:20px; text-align:center; color:#999;">ì°¸ì—¬ì ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
        try {
            const [roomResponse, participantsResponse] = await Promise.all([
                fetch(`/chatroom/${roomId}`, { headers: { 'Authorization': `Bearer ${token}` } }),
                fetch(`/chatroom/${roomId}/participants`, { headers: { 'Authorization': `Bearer ${token}` } })
            ]);

            if (!roomResponse.ok || !participantsResponse.ok) throw new Error('ì°¸ì—¬ì ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨');

            const room = await roomResponse.json();
            const participants = await participantsResponse.json();

            participantListContainer.innerHTML = '';

            // â­â­â­ ìˆ˜ì •: ì°¸ì—¬ì ë§µì„ ë‹¤ì‹œ ì—…ë°ì´íŠ¸í•˜ì—¬ ìµœì‹  ì •ë³´ë¥¼ ë°˜ì˜ â­â­â­
            currentRoomParticipantsMap = {};
            participants.forEach(p => {
                currentRoomParticipantsMap[p.userId] = p.nickname;
            });
            console.log('âœ… ì°¸ì—¬ì ë§µ ì—…ë°ì´íŠ¸ ì™„ë£Œ (Sidebar í˜¸ì¶œ):', currentRoomParticipantsMap);

            if (!participants || participants.length === 0) {
                participantListContainer.innerHTML =
                    '<p style="color: #999; text-align: center; padding:20px;">ì°¸ì—¬ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            document.getElementById('sidebar-room-name').textContent =
                `${room.roomName} (${participants.length} ëª…)`;

            participants.forEach(participant => {
                const item = document.createElement('div');
                item.className = 'participant-item';

                let iconClass = 'fas fa-user-circle';
                let roleBadge = '';

                if (participant.role === 'creator') {
                    iconClass = 'fas fa-crown';
                    roleBadge = '<span class="participant-role-badge role-host">ë°©ì¥</span>';
                }
                if (participant.userId === myUserId) {
                    roleBadge += '<span class="participant-role-badge role-me">ë‚˜</span>';
                    item.style.backgroundColor = '#f0f5ff';
                }

                item.style.cursor = 'pointer';
                item.onclick = () => openInlineProfileDetail(participant.userId, participant.nickname);

                item.innerHTML = `
                   <div class="participant-icon-wrapper">
                       <i class="${iconClass}"></i>
                   </div>
                   <div class="participant-details">
                       <span class="participant-name">${participant.nickname}${roleBadge}</span>
                   </div>
                `;
                participantListContainer.appendChild(item);
            });
        } catch (e) {
            console.error('ì°¸ì—¬ì ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', e);
            participantListContainer.innerHTML =
                '<p style="color: #e74c3c; text-align: center; padding:20px;">ì°¸ì—¬ì ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>';
        }
    }

    // âœ… í”„ë¡œí•„ ìƒì„¸ ì—´ê¸°/ë‹«ê¸° (ì´ë¯¸ì§€ ê²½ë¡œ ì²˜ë¦¬ ë¡œì§ ìœ ì§€)
    async function openInlineProfileDetail(userId, displayName) {
        const isOpen = inlineProfileDetail.classList.contains('open');
        const openedUserId = inlineProfileDetail.dataset.userId;

        if (userId === false || (isOpen && String(openedUserId) === String(userId))) {
            inlineProfileDetail.classList.remove('open');
            inlineProfileDetail.style.display = 'none';
            delete inlineProfileDetail.dataset.userId;
            return;
        }

        try {
            // 1. ê¸°ë³¸ ì´ë¯¸ì§€ë¡œ ë¨¼ì € ì´ˆê¸°í™”
            const defaultImg = '/images/default-profile.png';
            const imgEl = document.getElementById('profile-img-detail');
            imgEl.src = defaultImg;

            const response = await fetch(`/api/users/${userId}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (!response.ok) throw new Error('ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨');
            const profile = await response.json();

            inlineProfileDetail.dataset.userId = userId;

            // 2. í”„ë¡œí•„ ì´ë¯¸ì§€ ê²½ë¡œ ê²°ì • (profileImage í•„ë“œë¥¼ ìš°ì„  í™•ì¸)
            let pic = profile.profileImage || profile.profilePic; // profileImage í•„ë“œë¥¼ ìš°ì„  í™•ì¸ (profile-edit.html ì°¸ê³ )

            if (!pic || String(pic).trim() === '') {
                pic = defaultImg;
            } else {
                pic = String(pic).trim();

                // 3. ì„œë²„ê°€ '/uploads/íŒŒì¼ëª…'ì„ ì£¼ì§€ ì•Šê³  'íŒŒì¼ëª…'ë§Œ ì¤„ ê²½ìš°ë¥¼ ëŒ€ë¹„í•´ ê²½ë¡œë¥¼ ê°•ì œë¡œ ë¶™ì„
                if (!pic.startsWith('http') && !pic.startsWith('/') && !pic.startsWith('uploads/')) {
                    pic = '/uploads/' + pic;
                } else if (pic.startsWith('uploads/')) {
                    // 'uploads/íŒŒì¼ëª…' í˜•íƒœë¡œ ë‚´ë ¤ì˜¬ ê²½ìš°, ë§¨ ì•ì— '/'ë¥¼ ë¶™ì—¬ ì ˆëŒ€ ê²½ë¡œë¡œ ë§Œë“¬
                    pic = '/' + pic;
                }
            }

            // 5. ì´ë¯¸ì§€ src ì„¤ì •
            imgEl.src = pic;

            // 6. ë¡œë”© ì‹¤íŒ¨ í•¸ë“¤ëŸ¬
            imgEl.onerror = () => {
                imgEl.onerror = null;
                imgEl.src = defaultImg;
            };

            // 7. ë‚˜ë¨¸ì§€ í”„ë¡œí•„ ì •ë³´ ì—…ë°ì´íŠ¸
            document.getElementById('profile-nickname-detail').textContent = profile.nickname;
            document.getElementById('profile-location-detail').textContent = profile.address || 'ë¯¸ë“±ë¡';
            document.getElementById('profile-position-detail').textContent = profile.position || 'ë¯¸ë“±ë¡';

            inlineProfileDetail.style.display = 'flex';
            inlineProfileDetail.classList.add('open');
        } catch (e) {
            console.error('í”„ë¡œí•„ ì¡°íšŒ ì‹¤íŒ¨:', e);
            alert('í”„ë¡œí•„ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        }
    }


    async function fetchUserIdByNickname(nickname) {
        const response = await fetch(`/api/users/search?nickname=${encodeURIComponent(nickname)}`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        if (!response.ok) throw new Error(`ì‚¬ìš©ì "${nickname}"ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
        const users = await response.json();
        return users[0].userId;
    }

    async function fetchUserIdsByNicknames(nicknames) {
        const userIds = [];
        for (const nickname of nicknames) {
            try { userIds.push(await fetchUserIdByNickname(nickname)); }
            catch (e) { console.error(`${nickname} ì¡°íšŒ ì‹¤íŒ¨:`, e); }
        }
        return userIds;
    }

    function openNewChatModal(open, recipientUsername = null) {
        if (open) {
            newChatModal.classList.add('open');
            newChatTitleInput.value = '';
            newChatTypeSelect.value = 'one-on-one';
            updateNewChatForm('one-on-one');
            newChatRecipientInput.value = recipientUsername || '';
            newChatTitleInput.focus();
        } else {
            newChatModal.classList.remove('open');
        }
    }

    function updateNewChatForm(type) {
        const maxParticipantsGroup = document.getElementById('max-participants-group');

        if (type === 'one-on-one') {
            recipientInputGroup.style.display = 'block';
            maxParticipantsGroup.style.display = 'none';
            chatFormInfo.textContent = 'ìƒëŒ€ë°© ë‹‰ë„¤ì„ì´ í•„ìˆ˜ì…ë‹ˆë‹¤.';
            newChatRecipientInput.placeholder = '1:1 ì±„íŒ…í•  ìƒëŒ€ë°©ì˜ ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”';

        } else if (type === 'group') {
            recipientInputGroup.style.display = 'block';
            maxParticipantsGroup.style.display = 'block';
            chatFormInfo.textContent = 'ê·¸ë£¹ ì±„íŒ…ì— ì´ˆëŒ€í•  ì°¸ì—¬ì ë‹‰ë„¤ì„ì„ ì‰¼í‘œ(,)ë¡œ ì…ë ¥í•˜ì„¸ìš” (ì„ íƒ ì‚¬í•­).';
            newChatRecipientInput.placeholder = 'ì´ˆëŒ€í•  ë‹‰ë„¤ì„ ì…ë ¥ (ì„ íƒ ì‚¬í•­)';
        }
    }

    async function createNewChat() {
        const type = newChatTypeSelect.value;
        const title = newChatTitleInput.value.trim();
        const recipientInput = newChatRecipientInput.value.trim();
        const maxParticipantsInput = document.getElementById('new-chat-max-participants');
        const maxParticipants = parseInt(maxParticipantsInput.value);

        const createBtn = document.getElementById('create-new-chat-btn');
        createBtn.disabled = true;

        if (!title) {
            alert("ì±„íŒ…ë°© ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            createBtn.disabled = false;
            return;
        }

        try {
            let apiUrl = '';
            let requestOptions = {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}` }
            };

            if (type === 'one-on-one') {
                if (!recipientInput) {
                    alert("1:1 ì±„íŒ…ì€ ìƒëŒ€ë°© ë‹‰ë„¤ì„ì´ í•„ìˆ˜ì…ë‹ˆë‹¤.");
                    createBtn.disabled = false;
                    return;
                }
                const targetUserId = await fetchUserIdByNickname(recipientInput);
                apiUrl = `/chatroom/onetoone?targetUserId=${targetUserId}`;
            } else {
                const invitedNicknames = recipientInput
                    ? recipientInput.split(',').map(n => n.trim()).filter(Boolean)
                    : [];
                let invitedUserIds = invitedNicknames.length > 0
                    ? await fetchUserIdsByNicknames(invitedNicknames)
                    : [];
                invitedUserIds = invitedUserIds.filter(id => id !== myUserId);

                apiUrl = '/chatroom/group';
                requestOptions.headers['Content-Type'] = 'application/json';
                requestOptions.body = JSON.stringify({
                    roomType: 'ê·¸ë£¹',
                    roomName: title,
                    invitedUserIds: invitedUserIds,
                    maxParticipants: maxParticipants || 10
                });
            }

            const response = await fetch(apiUrl, requestOptions);
            if (!response.ok) throw new Error('ì±„íŒ…ë°© ìƒì„± ì‹¤íŒ¨');

            const newRoom = await response.json();
            openNewChatModal(false);

            chatTypeTabs.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[data-type="${type}"]`)?.classList.add('active');

            loadRoomList(type);
            setTimeout(() => selectRoom(newRoom), 500);

        } catch (e) {
            console.error('ì±„íŒ…ë°© ìƒì„± ì‹¤íŒ¨', e);
            alert('ì±„íŒ…ë°© ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + e.message);
        } finally {
            createBtn.disabled = false;
        }
    }

    function openInviteModal(open = true) {
        if (!currentRoomId) return alert('ì±„íŒ…ë°©ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.');

        if (open) {
            document.getElementById('invite-room-name').textContent =
                roomTitleElement.textContent || 'ì•Œ ìˆ˜ ì—†ìŒ';
            selectedInvitees = new Set();
            selectedInviteCountElement.textContent = '0';
            loadFriendListForInvite();
            inviteModal.classList.add('open');
        } else {
            inviteModal.classList.remove('open');
        }
    }

    async function loadFriendListForInvite() {
        if (!currentRoomId) return;
        friendListToInvite.innerHTML =
            '<div style="padding:20px; text-align:center; color:#999;">ë¡œë”© ì¤‘...</div>';

        try {
            const [friendsResponse, participantsResponse] = await Promise.all([
                fetch(`/api/friends`, { headers: { 'Authorization': `Bearer ${token}` } }),
                fetch(`/chatroom/${currentRoomId}/participants`, { headers: { 'Authorization': `Bearer ${token}` } })
            ]);

            if (!friendsResponse.ok || !participantsResponse.ok) throw new Error('ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨');

            const friends = await friendsResponse.json();
            const participants = await participantsResponse.json();
            const participantUserIds = new Set(participants.map(p => p.userId));

            const availableFriends = friends.filter(f => !participantUserIds.has(f.userId));
            friendListToInvite.innerHTML = '';

            if (availableFriends.length === 0) {
                friendListToInvite.innerHTML =
                    '<p style="text-align:center; padding:20px; color:#999;">ì´ˆëŒ€ ê°€ëŠ¥í•œ ì¹œêµ¬ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            availableFriends.forEach(friend => {
                const item = document.createElement('div');
                item.className = 'invite-friend-item';
                item.innerHTML = `
                    <input type="checkbox" class="friend-checkbox" value="${friend.userId}">
                    <span>${friend.nickname}</span>`;
                friendListToInvite.appendChild(item);
            });

        } catch (e) {
            console.error('ì¹œêµ¬ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', e);
            friendListToInvite.innerHTML =
                '<p style="text-align:center; padding:20px; color:#e74c3c;">ì¹œêµ¬ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
        }
    }

    friendListToInvite?.addEventListener('change', (e) => {
        const target = e.target;
        if (!target.classList.contains('friend-checkbox')) return;

        const item = target.closest('.invite-friend-item');

        if (target.checked) {
            item?.classList.add('selected');
            selectedInvitees.add(target.value);
        } else {
            item?.classList.remove('selected');
            selectedInvitees.delete(target.value);
        }

        const checkedCount = friendListToInvite.querySelectorAll('.friend-checkbox:checked').length;
        selectedInviteCountElement.textContent = checkedCount;
    });

    async function sendInvite() {
        const invitedUserIds = Array.from(document.querySelectorAll('.friend-checkbox:checked'))
            .map(c => parseInt(c.value));

        if (invitedUserIds.length === 0) return alert('ì´ˆëŒ€í•  ì¹œêµ¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');

        try {
            const response = await fetch(`/chatroom/${currentRoomId}/invite`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`,
                },
                body: JSON.stringify(invitedUserIds),
                credentials: 'include'
            });

            if (!response.ok) throw new Error('ì´ˆëŒ€ ì‹¤íŒ¨');

            alert('ì´ˆëŒ€ ë©”ì„¸ì§€ë¥¼ ì„±ê³µì ìœ¼ë¡œ ë³´ëƒˆìŠµë‹ˆë‹¤.');
            openInviteModal(false);
            loadParticipantList(currentRoomId);
            loadRoomList(currentChatType);
        } catch (e) {
            console.error('ì´ˆëŒ€ ì‹¤íŒ¨:', e);
            alert('ì´ˆëŒ€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    }

    chatTypeTabs.addEventListener('click', (e) => {
        const button = e.target.closest('button');
        if (!button) return;
        chatTypeTabs.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
        button.classList.add('active');
        loadRoomList(button.dataset.type);
    });

    document.addEventListener('DOMContentLoaded', () => {
        if (inlineProfileDetail) inlineProfileDetail.style.display = 'none';

        const accessToken = localStorage.getItem('accessToken');
        if (!accessToken) {
            alert("âŒ ì‹¤ì‹œê°„ ì±„íŒ…ì€ íšŒì›ë§Œ ì´ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
            window.location.href = '/login';
            return;
        }

        initUserInfo();

        const openParticipantBtn = document.getElementById('open-participant-btn');

        // âœ… ì°¸ê°€ì ì‚¬ì´ë“œë°” ë°”ê¹¥ í´ë¦­ ì‹œ ë‹«ê¸° (ê¸°ì¡´ ìœ ì§€)
        document.addEventListener('click', (e) => {
            if (!participantSidebar.classList.contains('open')) return;

            const clickInsideSidebar = participantSidebar.contains(e.target);
            const clickOnOpenButton = openParticipantBtn && openParticipantBtn.contains(e.target);
            const clickInsideProfile = inlineProfileDetail && inlineProfileDetail.contains(e.target);

            // âœ… í”„ë¡œí•„ì°½ ì•ˆì—ì„œ í´ë¦­í•œ ê±´ "ë°”ê¹¥ í´ë¦­"ìœ¼ë¡œ ì·¨ê¸‰í•˜ì§€ ì•ŠìŒ
            if (clickInsideSidebar || clickOnOpenButton || clickInsideProfile) return;

            openParticipantList(false);
        });

        // âœ… í”„ë¡œí•„ ì°½ í´ë¦­ ì‹œ ì•„ë˜ ì˜ì—­ìœ¼ë¡œ ì´ë²¤íŠ¸ ì „íŒŒ ë°©ì§€
        inlineProfileDetail?.addEventListener('click', (e) => {
            e.stopPropagation();
        });

// âœ… í”„ë¡œí•„ X ë²„íŠ¼ í´ë¦­ë„ ì „íŒŒ ë§‰ê¸°
        document.getElementById('close-inline-profile')?.addEventListener('click', (e) => {
            e.stopPropagation();
        });

        // âœ… (ì¶”ê°€) í”„ë¡œí•„ ì˜ì—­ ë‚´ë¶€ í´ë¦­ì€ ë°”ê¹¥í´ë¦­ìœ¼ë¡œ ì²˜ë¦¬ ì•ˆ ë˜ê²Œ ë§‰ê¸°
        inlineProfileDetail.addEventListener('mousedown', (e) => e.stopPropagation());
        document.getElementById('close-inline-profile')
            ?.addEventListener('mousedown', (e) => e.stopPropagation());

        // âœ… (ìˆ˜ì •) ì¸ë¼ì¸ í”„ë¡œí•„ ë°”ê¹¥ í´ë¦­ ì‹œ "í”„ë¡œí•„ë§Œ" ë‹«ê¸°
        document.addEventListener('mousedown', (e) => {
            if (!inlineProfileDetail.classList.contains('open')) return;

            const clickInsideProfile = inlineProfileDetail.contains(e.target);
            const clickOnParticipant = e.target.closest('.participant-item');

            if (!clickInsideProfile && !clickOnParticipant) {
                openInlineProfileDetail(false);
            }
        });

        // âœ… (ì¶”ê°€) ESCë¡œ í”„ë¡œí•„/ëª¨ë‹¬/ì‚¬ì´ë“œë°” ë‹«ê¸°
        document.addEventListener('keydown', (e) => {
            if (e.key !== 'Escape') return;

            if (inlineProfileDetail.classList.contains('open')) openInlineProfileDetail(false);
            if (participantSidebar.classList.contains('open')) openParticipantList(false);
            if (newChatModal.classList.contains('open')) openNewChatModal(false);
            if (inviteModal.classList.contains('open')) openInviteModal(false);
        });

        const profileChatBtn = document.getElementById('profile-chat-btn');
        const profileFriendBtn = document.getElementById('profile-friend-btn');

        profileChatBtn?.addEventListener('click', async function () {
            const targetUserId = inlineProfileDetail.dataset.userId;
            if (!targetUserId) return alert('ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');

            try {
                const response = await fetch(`/chatroom/onetoone?targetUserId=${targetUserId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }
                });
                if (!response.ok) throw new Error('1:1 ì±„íŒ…ë°© ìƒì„± ì‹¤íŒ¨');

                const chatRoom = await response.json();
                openInlineProfileDetail(false);

                chatTypeTabs.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                document.querySelector(`[data-type="one-on-one"]`)?.classList.add('active');

                await loadRoomList('one-on-one');
                setTimeout(() => selectRoom(chatRoom), 300);
            } catch (e) {
                console.error('1:1 ì±„íŒ… ì‹œì‘ ì‹¤íŒ¨:', e);
                alert('1:1 ì±„íŒ…ì„ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }
        });

        // â­â­â­ ì¹œêµ¬ ìš”ì²­ ë¡œì§ ìµœì¢… ìˆ˜ì •: ë§ˆì´í˜ì´ì§€ ë¡œì§ê³¼ ë™ì¼í•˜ê²Œ ë³€ê²½ â­â­â­
        profileFriendBtn?.addEventListener('click', async function () {
            const targetUserId = inlineProfileDetail.dataset.userId;
            if (!targetUserId) return alert('ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');

            try {
                // ğŸ’¡ ìˆ˜ì •: ì—”ë“œí¬ì¸íŠ¸ë¥¼ ë§ˆì´í˜ì´ì§€ì™€ ë™ì¼í•œ /api/friends/requestsë¡œ ë³€ê²½í•˜ê³ ,
                // Content-Type í—¤ë”ì™€ JSON Bodyë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤.
                const response = await fetch(`/api/friends/requests`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json', // JSON Bodyë¥¼ ë³´ë‚´ê¸° ìœ„í•´ Content-Type ëª…ì‹œ
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ targetUserId: targetUserId }) // ë§ˆì´í˜ì´ì§€ì²˜ëŸ¼ Bodyì— targetUserId í¬í•¨
                });

                let data = {};
                try {
                    data = await response.json();
                } catch (e) {
                }

                if (!response.ok) {
                    // ì„œë²„ì—ì„œ ë°›ì€ ë©”ì‹œì§€ê°€ ìˆìœ¼ë©´ ì¶œë ¥í•˜ê³ , ì—†ìœ¼ë©´ ê¸°ë³¸ ì—ëŸ¬ ë©”ì‹œì§€ ì¶œë ¥
                    throw new Error(data.message || 'ì¹œêµ¬ìš”ì²­ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }

                alert('ì¹œêµ¬ ìš”ì²­ì„ ë³´ëƒˆìŠµë‹ˆë‹¤.');
                openInlineProfileDetail(false);
            } catch (e) {
                console.error('ì¹œêµ¬ ìš”ì²­ ì‹¤íŒ¨:', e);
                alert('âŒ ì¹œêµ¬ ìš”ì²­ì„ ë³´ë‚¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì˜¤ë¥˜: ' + e.message);
            }
        });
    });

    document.getElementById('message-input')?.addEventListener('keydown', function (event) {
        if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault();
            sendMessage();
        }
    });

    window.addEventListener('beforeunload', () => disconnect());
</script>

</body>
</html>