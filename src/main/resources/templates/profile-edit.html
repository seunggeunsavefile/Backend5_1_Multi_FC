<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MULTI FC - í”„ë¡œí•„ ìˆ˜ì •</title>
    <link rel="stylesheet" th:href="@{/css/style.css?v=219}">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
</head>
<body>

<div th:replace="~{fragments/header :: siteHeader}"></div>

<main class="login-page-main">
    <div class="main-wrapper">
        <div class="main-section">
            <div class="login-container">

                <!-- ë¹„ë°€ë²ˆí˜¸ ì¬í™•ì¸ ì˜ì—­ -->
                <div id="password-confirmation-wrapper">
                    <h1 class="title-login">ë³´ì•ˆ í™•ì¸</h1>
                    <p style="margin-bottom: 20px; font-size: 15px; color: #555;">íšŒì› ì •ë³´ë¥¼ ì•ˆì „í•˜ê²Œ ë³´í˜¸í•˜ê¸° ìœ„í•´<br>ë¹„ë°€ë²ˆí˜¸ë¥¼ ë‹¤ì‹œ í•œ ë²ˆ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>
                    <p id="confirm-error-message" class="error-message" style="display:none;"></p>
                    <form id="password-confirm-form">
                        <div class="input-group">
                            <label for="current-password-confirm">ë¹„ë°€ë²ˆí˜¸</label>
                            <div class="password-wrapper input-with-icon">
                                <i class="fas fa-lock input-icon"></i>
                                <input type="password" id="current-password-confirm" required>
                                <i class="fas fa-eye-slash toggle-password" style="right: 15px; left: auto;"></i>
                            </div>
                        </div>
                        <button type="submit" class="login-button" style="margin-top: 20px;">í™•ì¸</button>
                    </form>
                </div>

                <!-- ì‹¤ì œ ë‚´ ì •ë³´ ìˆ˜ì • ì˜ì—­ -->
                <div id="profile-edit-wrapper" style="display:none;">
                    <h1 class="title-login">ë‚´ ì •ë³´ ìˆ˜ì •</h1>

                    <p id="profile-success-message" class="info-message" style="display:none;"></p>
                    <p id="profile-error-message" class="error-message" style="display:none;"></p>
                    <p id="nickname-message" class="info-message" style="display:none;"></p>

                    <form id="profile-update-form" enctype="multipart/form-data">

                        <!-- ì´ë©”ì¼ -->
                        <div class="input-group">
                            <label for="email">ì´ë©”ì¼</label>
                            <input type="email"
                                   id="email"
                                   name="email"
                                   placeholder="example@multi.com"
                                   required>
                        </div>

                        <!-- ë‹‰ë„¤ì„ + ì¤‘ë³µ í™•ì¸ ë²„íŠ¼ -->
                        <div class="input-group with-button">
                            <div class="input-wrapper">
                                <label for="nickname">ë‹‰ë„¤ì„</label>
                                <input type="text" id="nickname" name="nickname" placeholder="ìƒˆ ë‹‰ë„¤ì„" required>
                            </div>
                            <button type="button" id="check-nickname-btn" class="check-duplicate-btn">ì¤‘ë³µ í™•ì¸</button>
                        </div>

                        <!-- í¬ì§€ì…˜ ì„¤ì • -->
                        <div class="input-group">
                            <label for="position">í¬ì§€ì…˜ ì„¤ì •</label>
                            <select id="position" name="position" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; font-size: 15px; background: #f7f7f7;">
                                <option value="ì „ì²´ (ALL)">ì „ì²´ (ALL)</option>
                                <option value="í”½ì„œ (FIXO)">í”½ì†Œ (FIXO)</option>
                                <option value="ë¹„ë³´ (PIVO)">ë¹„ë³´ (PIVO)</option>
                                <option value="ì½œë ˆì´ë¡œ (GOLEIRO)">ê³¨ë ˆì´ë¡œ (GOLEIRO)</option>
                            </select>
                        </div>

                        <!-- ì‹¤ë ¥ ë ˆë²¨ -->
                        <div class="input-group">
                            <label for="skill-level">ë‚˜ì˜ ì‹¤ë ¥ ë ˆë²¨</label>
                            <select id="skill-level" name="skillLevel" required
                                    style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; font-size: 15px; background: #f7f7f7;">
                                <option value="">ì‹¤ë ¥ì„ ì„ íƒí•˜ì„¸ìš”</option>
                                <option value="ì´ˆê¸‰">ì´ˆê¸‰</option>
                                <option value="ì¤‘ê¸‰">ì¤‘ê¸‰</option>
                                <option value="ê³ ê¸‰">ê³ ê¸‰</option>
                                <option value="ë¯¸ê¸°ì…">ë¯¸ê¸°ì…</option>
                            </select>
                        </div>

                        <!-- í™œë™ ì¥ì†Œ (ì£¼ì†Œ + ìƒì„¸ì£¼ì†Œ) -->
                        <div class="input-group address-group">
                            <div class="input-wrapper">
                                <label for="address">í™œë™ ì¥ì†Œ ì„¤ì •</label>
                                <input type="text"
                                       id="address"
                                       name="address"
                                       placeholder="ì£¼ì†Œ ê²€ìƒ‰ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”"
                                       required
                                       readonly>
                            </div>
                            <button type="button" onclick="searchAddress()">ì£¼ì†Œ ì°¾ê¸°</button>
                        </div>

                        <div class="input-group">
                            <input type="text"
                                   id="address-detail"
                                   placeholder="ìƒì„¸ ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: 101ë™ 1004í˜¸)">
                        </div>

                        <!-- í”„ë¡œí•„ ì‚¬ì§„ -->
                        <div class="input-group">
                            <label>í”„ë¡œí•„ ì‚¬ì§„ ìˆ˜ì •</label>
                            <img id="profile-preview" th:src="@{/images/default-profile.png}" alt="í”„ë¡œí•„ ë¯¸ë¦¬ë³´ê¸°" style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover; margin-bottom: 10px; border: 1px solid #ddd;">
                            <input type="file" id="profile-pic" name="profilePic" accept="image/*">
                        </div>

                        <button type="submit" id="profile-submit-btn" class="login-button" style="margin-top: 15px;" disabled>
                            ì •ë³´ ì €ì¥
                        </button>
                    </form>

                    <h3 style="font-size: 24px; color: #2c3e50; margin-top: 40px; border-top: 1px solid #ddd; padding-top: 30px;">ë¹„ë°€ë²ˆí˜¸ ìˆ˜ì •</h3>
                    <p id="password-success-message" class="info-message" style="display:none;"></p>
                    <p id="password-error-message" class="error-message" style="display:none;"></p>

                    <form id="password-change-form">
                        <div class="input-group">
                            <label for="current-password">í˜„ì¬ ë¹„ë°€ë²ˆí˜¸</label>
                            <div class="password-wrapper input-with-icon">
                                <i class="fas fa-lock input-icon"></i>
                                <input type="password" id="current-password" name="currentPassword" required>
                                <i class="fas fa-eye-slash toggle-password" style="right: 15px; left: auto;"></i>
                            </div>
                        </div>
                        <div class="input-group">
                            <label for="new-password">ìƒˆ ë¹„ë°€ë²ˆí˜¸</label>
                            <div class="password-wrapper input-with-icon">
                                <i class="fas fa-lock input-icon"></i>
                                <input type="password" id="new-password" name="newPassword" placeholder="8ì ì´ìƒ, ì˜ë¬¸/ìˆ«ì/íŠ¹ìˆ˜ë¬¸ì ì¡°í•©" required pattern="^(?=.*[A-Za-z])(?=.*\d)(?=.*[@$!%*#?&])[A-Za-z\d@$!%*#?&]{8,}$">
                                <i class="fas fa-eye-slash toggle-password" style="right: 15px; left: auto;"></i>
                            </div>
                        </div>
                        <div class="input-group">
                            <label for="confirm-password">ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
                            <div class="password-wrapper input-with-icon">
                                <i class="fas fa-lock input-icon"></i>
                                <input type="password" id="confirm-password" name="confirmPassword" required>
                                <i class="fas fa-eye-slash toggle-password" style="right: 15px; left: auto;"></i>
                            </div>
                        </div>
                        <button type="submit" class="login-button" style="margin-top: 15px;">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</button>

                        <button id="delete-account-btn"
                                style="margin-top: 40px; background:#ff4b4b; color:#fff; padding:12px; border:none; border-radius:8px; cursor:pointer;">
                            íšŒì›íƒˆí‡´
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</main>

<script>
    // --- ì£¼ì†Œ ê²€ìƒ‰ í•¨ìˆ˜ (ë‹¤ìŒ ìš°í¸ë²ˆí˜¸ API) ---
    function searchAddress() {
        new daum.Postcode({
            oncomplete: function(data) {
                const addressInput = document.getElementById("address");
                const detailInput = document.getElementById("address-detail");

                addressInput.value = data.roadAddress || data.jibunAddress;
                detailInput.focus();
                addressInput.dispatchEvent(new Event('change'));
            }
        }).open();
    }

    // âœ… í—¤ë” ë©”ë‰´ì— ì‹¤ì œ ë‹‰ë„¤ì„ ì„¸íŒ… (ì‚¬ìš©ìë‹˜ ë°©ì§€)
    async function fetchAndSetUserMenuNickname() {
        const token = localStorage.getItem('accessToken');
        if (!token) return;

        try {
            const res = await fetch('/api/mypage/me', {
                method: 'GET',
                headers: { 'Authorization': 'Bearer ' + token }
            });
            if (!res.ok) return;

            const myInfo = await res.json();
            const usernameSpan = document.getElementById('user-menu-username');
            if (usernameSpan) {
                usernameSpan.textContent = myInfo.nickname || myInfo.username || 'ì‚¬ìš©ì';
            }

            // ë‹¤ë¥¸ í˜ì´ì§€ì—ì„œë„ ì“°ë„ë¡ ì €ì¥
            localStorage.setItem('username', myInfo.nickname || myInfo.username || '');
        } catch (e) {
            console.error("ë©”ë‰´ ë‹‰ë„¤ì„ ë¡œë“œ ì‹¤íŒ¨:", e);
        }
    }

    // --- (í˜ì´ì§€ ê³µí†µ ì§„ì…) ---
    document.addEventListener('DOMContentLoaded', async () => {
        const accessToken = localStorage.getItem('accessToken');

        if (!accessToken) {
            alert("ë¡œê·¸ì¸ì´ í•„ìš”í•œ í˜ì´ì§€ì…ë‹ˆë‹¤. ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.");
            window.location.href = '/login';
            return;
        }

        // í—¤ë”ì— ë‹‰ë„¤ì„ ë°˜ì˜
        await fetchAndSetUserMenuNickname();

        // ğŸ”´ ë¹¨ê°„ ë°°ì§€ ê°±ì‹  (ë©”ì¸/í—¤ë” ìª½ì— ì •ì˜ë˜ì–´ ìˆì„ ë•Œë§Œ ì‹¤í–‰)
        try {
            if (typeof window.checkPendingReviews === 'function') {
                await window.checkPendingReviews();
            }
            if (typeof window.checkUpcomingSchedules === 'function') {
                await window.checkUpcomingSchedules();
            }
            if (typeof window.updateGlobalBadge === 'function') {
                window.updateGlobalBadge();
            }
        } catch (e) {
            console.error('ë°°ì§€ ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜:', e);
        }
    });

    // --- ë¹„ë°€ë²ˆí˜¸ í† ê¸€ ---
    document.querySelectorAll('.toggle-password').forEach(icon => {
        icon.addEventListener('click', function() {
            const passwordInput = this.parentElement.querySelector('input[type="password"], input[type="text"]');
            const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
            passwordInput.setAttribute('type', type);
            this.classList.toggle('fa-eye');
            this.classList.toggle('fa-eye-slash');
        });
    });

    // --- í”„ë¡œí•„ ì‚¬ì§„ ë¯¸ë¦¬ë³´ê¸° ---
    const profilePicInput = document.getElementById('profile-pic');
    const profilePreview = document.getElementById('profile-preview');
    if(profilePicInput) {
        profilePicInput.addEventListener('change', function() {
            if (this.files && this.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    profilePreview.src = e.target.result;
                }
                reader.readAsDataURL(this.files[0]);
            }
        });
    }

    // --- ë¹„ë°€ë²ˆí˜¸ ì¬í™•ì¸ ë¡œì§ ---
    const confirmForm = document.getElementById('password-confirm-form');
    const confirmButton = confirmForm.querySelector('button[type="submit"]');
    const confirmPasswordInput = document.getElementById('current-password-confirm');
    const confirmErrorMsg = document.getElementById('confirm-error-message');
    const confirmWrapper = document.getElementById('password-confirmation-wrapper');
    const editWrapper = document.getElementById('profile-edit-wrapper');
    let attemptCount = 0;
    const MAX_ATTEMPTS = 5;

    confirmForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        confirmErrorMsg.style.display = 'none';
        if (attemptCount >= MAX_ATTEMPTS) {
            confirmErrorMsg.textContent = 'âŒ 5íšŒ ì´ìƒ ì‹¤íŒ¨í•˜ì—¬ í™•ì¸ì´ ì ê²¼ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
            confirmErrorMsg.style.display = 'block';
            return;
        }
        const password = confirmPasswordInput.value;
        if (!password) {
            confirmErrorMsg.textContent = 'âŒ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.';
            confirmErrorMsg.style.display = 'block';
            return;
        }
        confirmButton.disabled = true;
        confirmButton.textContent = 'í™•ì¸ ì¤‘...';

        try {
            const response = await fetch('/api/mypage/confirm-password', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + localStorage.getItem('accessToken')
                },
                body: JSON.stringify({ currentPassword: password })
            });

            if (response.ok) {
                confirmWrapper.style.display = 'none';
                editWrapper.style.display = 'block';
                fetchMyEditInfo(); // ì‹¤ì œ ë‚´ ì •ë³´ ë¡œë”©
            } else {
                attemptCount++;
                const data = await response.json();
                if (attemptCount >= MAX_ATTEMPTS) {
                    confirmErrorMsg.textContent = 'âŒ 5íšŒ ì‹¤íŒ¨í•˜ì—¬ í™•ì¸ì´ ì ê²¼ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
                    confirmButton.disabled = true;
                    confirmPasswordInput.disabled = true;
                } else {
                    confirmErrorMsg.textContent = `âŒ ${data.message || 'ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.'} (${MAX_ATTEMPTS - attemptCount}íšŒ ë‚¨ìŒ)`;
                    confirmPasswordInput.value = '';
                    confirmPasswordInput.focus();
                }
                confirmErrorMsg.style.display = 'block';
            }
        } catch (error) {
            attemptCount++;
            confirmErrorMsg.textContent = `âŒ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. (${MAX_ATTEMPTS - attemptCount}íšŒ ë‚¨ìŒ)`;
            confirmErrorMsg.style.display = 'block';
        } finally {
            if (attemptCount < MAX_ATTEMPTS) {
                confirmButton.disabled = false;
                confirmButton.textContent = 'í™•ì¸';
            }
        }
    });

    // --- ë‹‰ë„¤ì„ / í”„ë¡œí•„ ìˆ˜ì • ë¡œì§ ---
    const nicknameInput = document.getElementById('nickname');
    const checkNicknameBtn = document.getElementById('check-nickname-btn');
    const nicknameMsg = document.getElementById('nickname-message');
    const profileSubmitBtn = document.getElementById('profile-submit-btn');
    const profileErrorMsg = document.getElementById('profile-error-message');
    const profileForm = document.getElementById('profile-update-form');
    const profileSuccessMsg = document.getElementById('profile-success-message');

    const emailInput = document.getElementById('email');
    const skillLevelSelect = document.getElementById('skill-level');

    let isNicknameChecked = true;
    let originalNickname = "";

    async function fetchMyEditInfo() {
        const token = localStorage.getItem('accessToken');
        if (!token) {
            alert('ë¡œê·¸ì¸ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸ í•´ì£¼ì„¸ìš”.');
            window.location.href = '/login';
            return;
        }

        try {
            const response = await fetch('/api/mypage/me', {
                method: 'GET',
                headers: { 'Authorization': 'Bearer ' + token }
            });

            if (!response.ok) throw new Error('ë‚´ ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨');

            const myInfo = await response.json();

            emailInput.value = myInfo.email || '';
            nicknameInput.value = myInfo.nickname || '';
            document.getElementById('position').value = myInfo.position || 'ì „ì²´ (ALL)';

            const addressInput = document.getElementById('address');
            const addressDetailInput = document.getElementById('address-detail');
            const fullAddress = myInfo.address || myInfo.location || '';
            addressInput.value = fullAddress;
            addressDetailInput.value = '';

            if (myInfo.level === 'ì´ˆê¸‰')           skillLevelSelect.value = 'ì´ˆê¸‰';
            else if (myInfo.level === 'ì¤‘ê¸‰')      skillLevelSelect.value = 'ì¤‘ê¸‰';
            else if (myInfo.level === 'ê³ ê¸‰')      skillLevelSelect.value = 'ê³ ê¸‰';
            else if (myInfo.level === 'ë¯¸ê¸°ì…')    skillLevelSelect.value = 'ë¯¸ê¸°ì…';
            else                                   skillLevelSelect.value = '';

            if (myInfo.profileImage) {
                profilePreview.src = myInfo.profileImage;
            }

            originalNickname = myInfo.nickname || '';

            // í—¤ë” í…ìŠ¤íŠ¸/ë¡œì»¬ìŠ¤í† ë¦¬ì§€ ë™ê¸°í™”
            const usernameSpan = document.getElementById('user-menu-username');
            if (usernameSpan) usernameSpan.textContent = originalNickname || 'ì‚¬ìš©ì';
            localStorage.setItem('username', originalNickname || myInfo.username || '');

            isNicknameChecked = true;
            profileSubmitBtn.disabled = false;
            profileSubmitBtn.textContent = 'ì •ë³´ ì €ì¥';
        } catch (err) {
            console.error(err);
            alert('ë‚´ ì •ë³´ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    }

    nicknameInput.addEventListener('input', () => {
        nicknameMsg.style.display = 'none';
        if (nicknameInput.value === originalNickname) {
            isNicknameChecked = true;
            checkNicknameBtn.disabled = true;
            checkNicknameBtn.classList.remove('success');
            profileSubmitBtn.disabled = false;
            profileSubmitBtn.textContent = 'ì •ë³´ ì €ì¥';
        } else {
            isNicknameChecked = false;
            checkNicknameBtn.disabled = false;
            checkNicknameBtn.classList.remove('success');
            profileSubmitBtn.disabled = true;
            profileSubmitBtn.textContent = 'ë‹‰ë„¤ì„ ì¤‘ë³µ í™•ì¸ í•„ìš”';
        }
    });

    checkNicknameBtn.addEventListener('click', async () => {
        profileErrorMsg.style.display = 'none';
        const nickname = nicknameInput.value.trim();
        if (!nickname) {
            nicknameMsg.textContent = 'âŒ ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.';
            nicknameMsg.className = 'error-message';
            nicknameMsg.style.display = 'block';
            return;
        }
        try {
            await new Promise(resolve => setTimeout(resolve, 500));
            const isDuplicate = (nickname === 'futsal'); // TODO: ì‹¤ì œ APIë¡œ êµì²´
            if (isDuplicate) {
                nicknameMsg.textContent = 'âŒ ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ë‹‰ë„¤ì„ì…ë‹ˆë‹¤.';
                nicknameMsg.className = 'error-message';
                isNicknameChecked = false;
            } else {
                nicknameMsg.textContent = 'âœ… ì‚¬ìš© ê°€ëŠ¥í•œ ë‹‰ë„¤ì„ì…ë‹ˆë‹¤.';
                nicknameMsg.className = 'info-message';
                isNicknameChecked = true;
                checkNicknameBtn.disabled = true;
                checkNicknameBtn.classList.add('success');
                profileSubmitBtn.disabled = false;
                profileSubmitBtn.textContent = 'ì •ë³´ ì €ì¥';
            }
            nicknameMsg.style.display = 'block';
        } catch (error) {
            profileErrorMsg.textContent = 'âŒ ì¤‘ë³µ í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
            profileErrorMsg.style.display = 'block';
            isNicknameChecked = false;
        }
    });

    profileForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        profileSuccessMsg.style.display = 'none';
        profileErrorMsg.style.display = 'none';

        if (!isNicknameChecked) {
            profileErrorMsg.textContent = 'âŒ ë‹‰ë„¤ì„ ì¤‘ë³µ í™•ì¸ì„ ì™„ë£Œí•´ì£¼ì„¸ìš”.';
            profileErrorMsg.style.display = 'block';
            return;
        }

        const token = localStorage.getItem('accessToken');
        if (!token) {
            alert('ë¡œê·¸ì¸ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸ í•´ì£¼ì„¸ìš”.');
            window.location.href = '/login';
            return;
        }

        const formData = new FormData();
        const addressInput = document.getElementById('address');
        const addressDetailInput = document.getElementById('address-detail');
        const fullLocation = `${addressInput.value} ${addressDetailInput.value}`.trim();

        formData.append('email', emailInput.value);
        formData.append('nickname', nicknameInput.value);
        formData.append('position', document.getElementById('position').value);
        formData.append('skillLevel', skillLevelSelect.value);
        formData.append('location', fullLocation);

        if (profilePicInput.files && profilePicInput.files[0]) {
            formData.append('profilePic', profilePicInput.files[0]);
        }

        try {
            const response = await fetch('/api/mypage/update', {
                method: 'PUT',
                headers: { 'Authorization': 'Bearer ' + token },
                body: formData
            });

            const data = await response.json().catch(() => ({}));

            if (response.ok) {
                profileSuccessMsg.textContent = 'âœ… ' + (data.message || 'í”„ë¡œí•„ì´ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
                profileSuccessMsg.style.display = 'block';

                // ë‹‰ë„¤ì„/ë¡œì»¬ìŠ¤í† ë¦¬ì§€/í—¤ë” ê°±ì‹ 
                originalNickname = nicknameInput.value;
                localStorage.setItem('username', originalNickname);
                const usernameSpan = document.getElementById('user-menu-username');
                if (usernameSpan) usernameSpan.textContent = originalNickname;

                checkNicknameBtn.disabled = true;

                setTimeout(() => {
                    window.location.href = "/mypage";
                }, 100);
            } else {
                profileErrorMsg.textContent = 'âŒ ' + (data.message || 'í”„ë¡œí•„ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                profileErrorMsg.style.display = 'block';
            }
        } catch (error) {
            console.error(error);
            profileErrorMsg.textContent = 'âŒ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
            profileErrorMsg.style.display = 'block';
        }
    });

    // --- ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ë¡œì§ ---
    const passwordForm = document.getElementById('password-change-form');
    const passwordSuccessMsg = document.getElementById('password-success-message');
    const passwordErrorMsg = document.getElementById('password-error-message');

    passwordForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        passwordSuccessMsg.style.display = 'none';
        passwordErrorMsg.style.display = 'none';

        const newPassword = document.getElementById('new-password').value;
        const confirmPassword = document.getElementById('confirm-password').value;
        const currentPassword = document.getElementById('current-password').value;

        if (newPassword !== confirmPassword) {
            passwordErrorMsg.textContent = 'âŒ ìƒˆ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
            passwordErrorMsg.style.display = 'block';
            return;
        }
        try {
            const response = await fetch('/api/mypage/password', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + localStorage.getItem('accessToken')
                },
                body: JSON.stringify({
                    currentPassword: currentPassword,
                    newPassword: newPassword
                }),
            });
            const data = await response.json();
            if (response.ok) {
                passwordSuccessMsg.textContent = 'âœ… ' + data.message;
                passwordSuccessMsg.style.display = 'block';
                passwordForm.reset();

                setTimeout(() => {
                    window.location.href = "/mypage";
                }, 100);
            } else {
                passwordErrorMsg.textContent = 'âŒ ' + data.message;
                passwordErrorMsg.style.display = 'block';
            }
        } catch (error) {
            passwordErrorMsg.textContent = 'âŒ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
            passwordErrorMsg.style.display = 'block';
        }
    });

    // --- íšŒì› íƒˆí‡´ ---
    const deleteBtn = document.getElementById('delete-account-btn');
    if (deleteBtn) {
        deleteBtn.addEventListener('click', async () => {
            if (!confirm("ì •ë§ íƒˆí‡´í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ëª¨ë“  ì •ë³´ê°€ ì‚­ì œë©ë‹ˆë‹¤.")) return;

            const token = localStorage.getItem('accessToken');
            try {
                const response = await fetch('/api/mypage/delete', {
                    method: 'DELETE',
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                const data = await response.json();
                if (response.ok) {
                    alert("íšŒì›íƒˆí‡´ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
                    localStorage.clear();
                    window.location.href = "/";
                } else {
                    alert("âŒ " + data.message);
                }
            } catch (error) {
                alert("âŒ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
        });
    }
</script>
</body>
</html>
