<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="'ê²½ê¸° ìƒì„¸ (ID: ' + ${matchId} + ') - MULTI FC'">MULTI FC - ì¼ì • ìƒì„¸</title>
    <link rel="stylesheet" th:href="@{/css/style.css?v=219}">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <script src="//dapi.kakao.com/v2/maps/sdk.js?appkey=4caaf2cb0e09303d4dd13d3fb5ff15e9&libraries=services"></script>
</head>
<body>
<div th:replace="~{fragments/header :: siteHeader}"></div>

<main class="search-main">
    <div class="search-container">
        <h1 class="search-title" th:text="'ê²½ê¸° ìƒì„¸ ì •ë³´ (ID: ' + ${matchId} + ')'">ğŸ“… ì¼ì • ìƒì„¸</h1>
        <input type="hidden" id="match-id-hidden" th:value="${matchId}">
        <div class="detail-grid">
            <div class="detail-left-column">
                <div class="map-area" id="map">ì§€ë„ë¥¼ ë¡œë“œí•˜ëŠ” ì¤‘...</div>

                <h3>
                    ê²½ê¸° ì •ë³´
                    <span id="match-status-display" class="match-status-label"></span>
                </h3>

                <div class="detail-info-item">
                    <i class="fas fa-calendar-alt"></i>
                    <span id="detail-datetime">ë¡œë”©ì¤‘...</span>
                </div>
                <div class="detail-info-item">
                    <i class="fas fa-map-marker-alt"></i>
                    <span id="detail-location">ë¡œë”©ì¤‘...</span>
                </div>
                <div class="detail-info-item">
                    <i class="fas fa-users"></i>
                    <span id="detail-match-type">ë¡œë”©ì¤‘...</span>
                </div>
                <div class="detail-info-item">
                    <i class="fas fa-medal"></i>
                    <span id="detail-skill-level">ë¡œë”©ì¤‘...</span>
                </div>
            </div>

            <div class="detail-right-column">
                <div class="status-card">
                    <h3>ì°¸ì—¬ í˜„í™©</h3>
                    <strong><span id="current-players">0</span> / <span id="max-players">0</span> ëª…</strong>
                    <ul class="participant-list" id="participant-list"></ul>

                    <div id="button-container"></div>

                    <p id="login-prompt-msg" style="display:none; text-align: center; margin-top: 15px; font-size: 14px;">
                        ì°¸ì—¬í•˜ë ¤ë©´ <a href="/login" style="color: #6c5ce7; font-weight: 600;">ë¡œê·¸ì¸</a>ì´ í•„ìš”í•©ë‹ˆë‹¤.
                    </p>
                </div>
            </div>
        </div>
    </div>
</main>

<script>
    /* =========================================================
       1. ì´ˆê¸°í™” (í—¤ë” ìŠ¤í¬ë¦½íŠ¸ ì œê±° ë²„ì „)
    ========================================================= */
    let stompClient = null;
    let currentMatchData = null;
    let currentUserId = null;
    const matchId = document.getElementById('match-id-hidden').value;

    document.addEventListener('DOMContentLoaded', async () => {
        const token = localStorage.getItem('accessToken');
        const currentPath = window.location.pathname;

        // ğŸ” ë¹„ë¡œê·¸ì¸ ì ‘ê·¼ ì°¨ë‹¨
        if (!token) {
            alert("âŒ íšŒì› ì „ìš© í˜ì´ì§€ì…ë‹ˆë‹¤.\në¡œê·¸ì¸ í›„ì— ì´ìš©í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
            localStorage.setItem('redirectAfterLogin', currentPath);
            window.location.href = '/login';
            return;
        }

        // í˜„ì¬ ë¡œê·¸ì¸ ìœ ì € ID
        const userIdStr = localStorage.getItem('userId');
        if (userIdStr) currentUserId = Number(userIdStr);

        // âœ… í—¤ë” ë‹‰ë„¤ì„: "ì‚¬ìš©ìë‹˜" ëŒ€ì‹  localStorage ê°’ ì‚¬ìš©
        const userMenuName = document.getElementById('user-menu-username');
        if (userMenuName) {
            const nickname =
                localStorage.getItem('userNickname') ||
                localStorage.getItem('username') ||
                'íšŒì›';
            userMenuName.textContent = nickname;
        }

        // ğŸ”´ í—¤ë”ì— ì •ì˜ëœ ì „ì—­ ì•Œë¦¼ ê´€ë ¨ í•¨ìˆ˜ê°€ ìˆìœ¼ë©´ í˜¸ì¶œ â†’ ë¹¨ê°„ ë°°ì§€ ê°±ì‹ 
        if (typeof checkPendingReviews === 'function') {
            try { await checkPendingReviews(); } catch (e) { console.error(e); }
        }
        if (typeof checkUpcomingSchedules === 'function') {
            try { await checkUpcomingSchedules(); } catch (e) { console.error(e); }
        }
        if (typeof updateGlobalBadge === 'function') {
            try { updateGlobalBadge(); } catch (e) { console.error(e); }
        }

        // ğŸ“¦ ìƒì„¸ ì •ë³´ ë° ì°¸ê°€ì ëª©ë¡ ë¡œë“œ + WebSocket ì—°ê²°
        await fetchMatchDetail();
        await fetchParticipantList();
        connectWebSocket();
    });

    /* =========================================================
       2. ì§€ë„ ì´ˆê¸°í™” í•¨ìˆ˜
    ========================================================= */
    function initMap(lat, lng, name) {
        if (window.kakao && kakao.maps) {
            const mapContainer = document.getElementById('map');
            const mapOption = {
                center: new kakao.maps.LatLng(lat, lng),
                level: 3
            };
            const map = new kakao.maps.Map(mapContainer, mapOption);
            const markerPosition = new kakao.maps.LatLng(lat, lng);

            const marker = new kakao.maps.Marker({
                position: markerPosition,
                map: map
            });

            const infowindow = new kakao.maps.InfoWindow({
                content: `<div style="padding:5px;font-size:12px;font-weight:bold;">${name}</div>`
            });
            infowindow.open(map, marker);

            console.log("Kakao Map initialized successfully.");
        } else {
            console.error("Kakao Map API is not loaded.");
        }
    }

    /* =========================================================
       3. ë°ì´í„° ë¡œë“œ í•¨ìˆ˜ (ì§€ë„ ì´ˆê¸°í™” í¬í•¨)
    ========================================================= */
    async function fetchMatchDetail() {
        try {
            const res = await fetch(`/api/matchrooms/${matchId}`);
            if (!res.ok) throw new Error('ê²½ê¸° ì •ë³´ ë¡œë“œ ì‹¤íŒ¨');
            currentMatchData = await res.json();

            document.getElementById('detail-datetime').textContent =
                `${currentMatchData.matchDate} ${currentMatchData.matchTime}`;
            document.getElementById('detail-match-type').textContent =
                `ê°œì¸ ë§¤ì¹­ (${currentMatchData.maxPlayers}ëª…)`;
            document.getElementById('detail-skill-level').textContent =
                currentMatchData.level;
            document.getElementById('max-players').textContent =
                currentMatchData.maxPlayers;

            const stadiumId = currentMatchData.stadiumId;
            const stadiumRes = await fetch(`/api/stadiums`);
            const allStadiums = await stadiumRes.json();
            const stadium = allStadiums.find(s => s.stadiumId === stadiumId);

            if (stadium) {
                document.getElementById('detail-location').textContent =
                    stadium.name + ' (' + stadium.address + ')';
                initMap(stadium.latitude, stadium.longitude, stadium.name);
            } else {
                document.getElementById('detail-location').textContent =
                    `êµ¬ì¥ ID ${stadiumId} ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`;
                document.getElementById('map').textContent =
                    'êµ¬ì¥ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ì–´ ì§€ë„ë¥¼ í‘œì‹œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
            }

            const statusEl = document.getElementById('match-status-display');
            if (currentMatchData.status === 'CLOSED') {
                statusEl.textContent = "(ëª¨ì§‘ ë§ˆê°)";
                statusEl.className = "match-status-label status-closed";
            } else {
                statusEl.textContent = "(ëª¨ì§‘ì¤‘)";
                statusEl.className = "match-status-label status-open";
            }
        } catch (err) {
            console.error(err);
            document.getElementById('map').textContent = 'ê²½ê¸° ì •ë³´ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ.';
        }
    }

    async function fetchParticipantList() {
        try {
            const res = await fetch(`/api/matchrooms/${matchId}/participants/all`);
            if (!res.ok) throw new Error('ì°¸ê°€ì ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨');
            const participants = await res.json();
            renderParticipantList(participants);
        } catch (err) {
            console.error(err);
        }
    }

    /* =========================================================
       4. í™”ë©´ ë Œë”ë§
    ========================================================= */
    function renderParticipantList(participants) {
        const listEl = document.getElementById('participant-list');
        listEl.innerHTML = '';

        const totalCount = participants.length;
        document.getElementById('current-players').textContent = totalCount;

        const amIHost =
            (currentMatchData && Number(currentMatchData.hostId) === currentUserId);
        const isClosed =
            (currentMatchData && currentMatchData.status === 'CLOSED');

        participants.forEach(user => {
            const li = document.createElement('li');

            const userPosition = user.position || 'ë¯¸ì •';

            let nameHtml = `<span class="user-info">${user.nickname}</span>`;
            if (user.role === 'Host')
                nameHtml += ` <span class="badge badge-host">ë°©ì¥</span>`;
            if (Number(user.userId) === currentUserId)
                nameHtml += ` <span class="badge badge-me">ë‚˜</span>`;

            const status = user.status || 'ëŒ€ê¸°';
            if (user.role === 'Player') {
                if (status === 'í™•ì •') {
                    nameHtml += ` <span class="badge badge-confirmed">í™•ì •</span>`;
                } else {
                    nameHtml += ` <span class="badge badge-waiting">ëŒ€ê¸°</span>`;
                }
            }

            let btnHtml = '';
            if (amIHost && user.role === 'Player' && !isClosed) {
                btnHtml = `
                    <div class="manage-btns">
                        ${status === 'ëŒ€ê¸°'
                    ? `<button class="btn-sm btn-approve" onclick="approveUser(${user.userId})">ìˆ˜ë½</button>`
                    : ''
                }
                        <button class="btn-sm btn-reject" onclick="rejectUser(${user.userId})">ê°•í‡´</button>
                    </div>
                `;
            }

            li.innerHTML = `
                <div class="user-row">
                    <div>${nameHtml}</div>
                    ${btnHtml}
                </div>
                <div class="user-meta">í¬ì§€ì…˜: ${userPosition}</div>
            `;
            listEl.appendChild(li);
        });

        renderMainButtons(participants, amIHost, isClosed);
    }

    function renderMainButtons(participants, amIHost, isClosed) {
        const container = document.getElementById('button-container');
        const loginPrompt = document.getElementById('login-prompt-msg');
        container.innerHTML = '';

        if (!currentUserId) {
            loginPrompt.style.display = 'block';
            return;
        }
        loginPrompt.style.display = 'none';

        if (isClosed) {
            container.innerHTML =
                `<button class="join-button btn-disabled" disabled>ëª¨ì§‘ì´ ë§ˆê°ë˜ì—ˆìŠµë‹ˆë‹¤</button>`;
            return;
        }

        if (amIHost) {
            container.innerHTML = `
                <button class="join-button btn-close" onclick="closeMatch()">
                    ğŸ“¢ ëª¨ì§‘ ë§ˆê° (ê²½ê¸° í™•ì •)
                </button>
            `;
            return;
        }

        const isJoined = participants.some(p => Number(p.userId) === currentUserId);

        if (isJoined) {
            container.innerHTML =
                `<button class="join-button btn-cancel" onclick="cancelMatch()">ì°¸ê°€ ì·¨ì†Œ</button>`;
        } else {
            const currentCount = participants.filter(p => p.role === 'Player').length;
            if (currentCount < currentMatchData.maxPlayers) {
                container.innerHTML =
                    `<button class="join-button btn-join" onclick="joinMatch()">ì°¸ê°€ ì‹ ì²­</button>`;
            } else {
                container.innerHTML =
                    `<button class="join-button btn-disabled" disabled>ì •ì› ì´ˆê³¼</button>`;
            }
        }
    }

    /* =========================================================
       5. ì•¡ì…˜ í•¨ìˆ˜ë“¤
    ========================================================= */
    // ì°¸ê°€ ì‹ ì²­
    window.joinMatch = async () => {
        if (!confirm("ì°¸ê°€ ì‹ ì²­í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (íšŒì› ê¸°ë³¸ í¬ì§€ì…˜ìœ¼ë¡œ ë“±ë¡ë©ë‹ˆë‹¤)")) return;

        const res = await fetch(`/api/matchrooms/${matchId}/join`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                userId: currentUserId
            })
        });

        if (res.ok) {
            alert("ì°¸ê°€ ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë°©ì¥ì˜ ìˆ˜ë½ì„ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.");
        } else {
            alert("ì°¸ê°€ ì‹ ì²­ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (ë°±ì—”ë“œ API í™•ì¸ í•„ìš”)");
        }
    };

    // ì°¸ê°€ ì·¨ì†Œ
    window.cancelMatch = async () => {
        if (!confirm("ì •ë§ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

        await fetch(`/api/matchrooms/${matchId}/cancel`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ userId: currentUserId })
        });
    };

    // [ë°©ì¥] ì°¸ê°€ì ìˆ˜ë½
    window.approveUser = async (targetId) => {
        if (!confirm("ì´ ì°¸ê°€ìë¥¼ ìˆ˜ë½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

        await fetch(`/api/matchrooms/${matchId}/approve`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ userId: targetId })
        });
    };

    // [ë°©ì¥] ì°¸ê°€ì ê°•í‡´
    window.rejectUser = async (targetId) => {
        if (!confirm("ì´ ì°¸ê°€ìë¥¼ ê°•í‡´í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

        await fetch(`/api/matchrooms/${matchId}/reject`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ userId: targetId })
        });
    };

    // [ë°©ì¥] ê²½ê¸° í™•ì • (ë§ˆê°)
    window.closeMatch = async () => {
        if (!confirm("ëª¨ì§‘ì„ ë§ˆê°í•˜ê³  ë§¤ì¹­ì„ í™•ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ë” ì´ìƒ ì°¸ê°€ìë¥¼ ë°›ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤)")) return;

        const res = await fetch(`/api/matchrooms/${matchId}/close`, { method: 'POST' });
        if (res.ok) {
            alert("ë§¤ì¹­ì´ í™•ì •ë˜ì—ˆìŠµë‹ˆë‹¤!");
            location.reload();
        }
    };

    /* =========================================================
       6. WebSocket (ì‹¤ì‹œê°„ ê°±ì‹ )
    ========================================================= */
    function connectWebSocket() {
        const socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);

        // localStorage ì—ì„œ JWT í† í° ì½ê¸°
        const token = localStorage.getItem('accessToken');

        // STOMP CONNECT í—¤ë” êµ¬ì„±
        const connectHeaders = {};
        if (token) {
            // JwtChannelInterceptor ì—ì„œ "Authorization" í—¤ë”ë¡œ ì½ëŠ” ê²½ìš°
            connectHeaders['Authorization'] = 'Bearer ' + token;
            // ë§Œì•½ ì¸í„°ì…‰í„°ì—ì„œ "authorization" ì†Œë¬¸ì í‚¤ë¡œ ì½ê³  ìˆë‹¤ë©´,
            // ìœ„ ëŒ€ì‹  ì•„ë˜ ì¤„ì„ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤.
            // connectHeaders['authorization'] = 'Bearer ' + token;
        } else {
            console.warn('WebSocket ì—°ê²° ì‹œ accessToken ì´ ì—†ìŒ');
        }

        stompClient.connect(
            connectHeaders,
            function onConnect() {
                console.log("WebSocket Connected");
                stompClient.subscribe(
                    `/topic/matchroom/${matchId}/participants`,
                    function () {
                        console.log("Update detected, refreshing list...");
                        fetchParticipantList();
                    }
                );
            },
            function onError(err) {
                console.error("WebSocket Error:", err);
            }
        );
    }
</script>
</body>
</html>
